<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sheikh Admin Ultimate (v14.0 - Full God Mode)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

<style>

/* POS Mode Link Button Style for Admin Page */
.pos-mode-link {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(139, 92, 246, 0.2); /* ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶•‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶¨‡ßá‡¶ó‡ßÅ‡¶®‡¶ø ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ */
    color: white;
    padding: 10px 18px;
    border-radius: 30px;
    text-decoration: none;
    font-size: 13px;
    font-weight: bold;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(139, 92, 246, 0.3);
    transition: 0.3s;
    z-index: 10000; /* ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ü‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá */
    display: flex;
    align-items: center;
    gap: 8px;
}
.pos-mode-link:hover {
    background: #8b5cf6;
    color: white;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
}
    :root {
        --bg-dark: #0f172a;
        --bg-panel: #1e293b;
        --primary: #8b5cf6;
        --primary-hover: #7c3aed;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
    body { background: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* AUTH SCREEN */
    #authGate {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;
        flex-direction: column;
    }
    .auth-box {
        background: var(--bg-panel); padding: 40px; border-radius: 16px;
        border: 1px solid var(--primary); width: 350px; text-align: center;
        box-shadow: 0 0 50px rgba(139, 92, 246, 0.3);
    }
    .auth-input {
        width: 100%; padding: 14px; background: var(--bg-dark);
        border: 1px solid var(--border); color: white; border-radius: 8px;
        margin-top: 20px; text-align: center; font-size: 18px; letter-spacing: 2px;
    }
    .auth-btn {
        width: 100%; padding: 14px; background: var(--primary); color: white;
        border: none; border-radius: 8px; margin-top: 15px; font-weight: bold;
        cursor: pointer; transition: 0.3s;
    }
    .auth-btn:hover { background: var(--primary-hover); }

    /* SIDEBAR */
    #sidebar {
        width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border);
        display: flex; flex-direction: column; height: 100%; transition: 0.3s;
        z-index: 100; flex-shrink: 0;
    }
    .brand {
        padding: 20px; font-size: 18px; font-weight: 800; color: var(--primary);
        border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px;
    }
    .nav-menu { flex: 1; overflow-y: auto; padding: 10px; }

    .nav-group {
        font-size: 11px; text-transform: uppercase; color: #64748b;
        margin: 25px 0 8px 12px; font-weight: 700; letter-spacing: 1px;
        border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px;
    }

    .nav-item {
        padding: 12px 15px; color: var(--text-muted); cursor: pointer;
        border-radius: 8px; margin-bottom: 4px; display: flex; align-items: center;
        gap: 12px; font-size: 13px; transition: 0.2s;
    }
    .nav-item:hover, .nav-item.active {
        background: rgba(139, 92, 246, 0.15); color: var(--primary);
        font-weight: 600;
    }
    .nav-item i { width: 20px; text-align: center; }

    /* MAIN CONTENT */
    #main {
        flex: 1; display: flex; flex-direction: column; height: 100%;
        position: relative; overflow: hidden;
    }
    header {
        height: 65px; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 25px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
    }
    .header-title { font-size: 18px; font-weight: 600; }
    .status-badge {
        font-size: 12px; padding: 5px 12px; border-radius: 20px;
        background: rgba(16, 185, 129, 0.1); color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2); display: flex; align-items: center; gap: 6px;
    }

    #workspace { flex: 1; overflow-y: auto; padding: 30px; }
    .view-section { display: none; animation: fadeIn 0.3s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* GRID & CARDS */
    .grid-4 {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 25px; margin-bottom: 30px;
    }
    .card {
        background: var(--bg-panel); border: 1px solid var(--border);
        border-radius: 16px; padding: 25px; position: relative; overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .card-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 15px;
    }
    .card-title {
        font-size: 14px; font-weight: 700; color: var(--text-muted);
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .stat-val { font-size: 32px; font-weight: 700; color: var(--text-main); }

    /* CONTROLS & INPUTS */
    .control-bar {
        display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;
        background: var(--bg-panel); padding: 20px; border-radius: 12px;
        border: 1px solid var(--border); align-items: center;
    }
    input, select, textarea {
        background: var(--bg-dark); border: 1px solid var(--border);
        color: white; padding: 12px 15px; border-radius: 8px;
        font-size: 14px; outline: none; width: 100%; transition: 0.2s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }

    .btn {
        padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer;
        font-size: 14px; font-weight: 600; display: inline-flex; align-items: center;
        gap: 8px; transition: 0.2s; width: auto;
    }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-dark { background: var(--border); color: white; }

    /* TABLES */
    .table-wrapper {
        background: var(--bg-panel); border: 1px solid var(--border);
        border-radius: 12px; overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th {
        background: #253045; color: var(--text-muted); font-size: 12px;
        text-transform: uppercase; padding: 18px; text-align: left;
        font-weight: 700; white-space: nowrap;
    }
    td {
        padding: 18px; border-bottom: 1px solid var(--border);
        font-size: 14px; color: var(--text-main); white-space: nowrap;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); }

    /* MODALS */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        z-index: 2000; display: none; align-items: center; justify-content: center;
    }
    .modal-box {
        background: var(--bg-panel); width: 600px; max-width: 95%;
        padding: 35px; border-radius: 16px; border: 1px solid var(--border);
        box-shadow: 0 25px 60px rgba(0,0,0,0.6); animation: slideUp 0.3s;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px;
    }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-main); }
    .close-modal { cursor: pointer; font-size: 24px; color: var(--text-muted); }

    /* TOGGLE SWITCH */
    .toggle-switch { position: relative; display: inline-block; width: 46px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #334155; transition: .4s; border-radius: 34px;
    }
    .slider:before {
        position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
        background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* CONFIG GRID */
    .config-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;
    }
    .config-box {
        background: rgba(0,0,0,0.2); padding: 25px; border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .config-box h4 {
        margin: 0 0 20px 0; color: var(--primary); font-size: 15px;
        text-transform: uppercase; letter-spacing: 1px;
        border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
    }
    .config-item {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px;
    }
    .config-item label { font-size: 14px; color: #cbd5e1; }
    .config-input {
        width: 140px; padding: 8px; font-size: 13px; background: #0f172a;
        border: 1px solid #334155; color: #fff; border-radius: 6px;
    }

    @media (max-width: 768px) {
        #sidebar { position: fixed; left: -300px; height: 100%; }
        #sidebar.active { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #menuBtn { display: block !important; }
    }
    #menuBtn { display: none; font-size: 24px; cursor: pointer; }
</style>
</head>
<body>

<!-- AUTH GATE -->
<div id="authGate">
    <a href="https://sheikhcomputer.nett.to/" class="pos-mode-link">üõí POS Mode</a>
    <div class="auth-box">
        <h1><i class="fa-solid fa-user-shield"></i> GOD MODE</h1>
        <p style="color:#94a3b8; font-size:13px;">Super Admin Access Only</p>
        <input type="password" id="masterKey" class="auth-input" placeholder="Enter Master Key">
        <button class="auth-btn" onclick="authenticate()">UNLOCK SYSTEM</button>
    </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-shield-halved"></i> SHEIKH ADMIN
    </div>
    <div class="nav-menu">

        <!-- DASHBOARD GROUP -->
        <div class="nav-group">Dashboard & Analytics</div>
        <div class="nav-item active" onclick="showView('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</div>
        <div class="nav-item" onclick="showView('adv_reports')"><i class="fa-solid fa-chart-pie"></i> Sales Reports (Adv)</div>
        <div class="nav-item" onclick="showView('profit_analysis')"><i class="fa-solid fa-money-bill-trend-up"></i> Profit Analysis</div>
        <div class="nav-item" onclick="showView('staff_perf')"><i class="fa-solid fa-users-viewfinder"></i> Staff Performance</div>

        <!-- MASTER CONTROL GROUP -->
        <div class="nav-group">Master Control</div>
        <div class="nav-item" onclick="showView('pos_config')" style="color: #f59e0b;"><i class="fa-solid fa-sliders"></i> Remote Config (POS)</div>
        <div class="nav-item" onclick="showView('ui_builder')"><i class="fa-solid fa-palette"></i> UI & Design</div>
        <div class="nav-item" onclick="showView('system')"><i class="fa-solid fa-lock"></i> System Control</div>
        <div class="nav-item" onclick="showView('db_opt')"><i class="fa-solid fa-database"></i> Database Optimizer</div>

        <!-- ULTRA PRO CONFIG -->
        <div class="nav-group">Ultra Pro Config</div>
        <div class="nav-item" onclick="showView('menu_builder')"><i class="fa-solid fa-bars-staggered"></i> Menu Builder</div>
        <div class="nav-item" onclick="showView('lang_editor')"><i class="fa-solid fa-language"></i> Language Editor</div>
        <div class="nav-item" onclick="showView('invoice_design')"><i class="fa-solid fa-file-invoice"></i> Invoice Designer</div>
        <div class="nav-item" onclick="showView('payment_manager')"><i class="fa-solid fa-credit-card"></i> Payment Methods</div>
        <div class="nav-item" onclick="showView('css_injector')"><i class="fa-solid fa-code"></i> Custom CSS</div>

        <!-- OPERATIONS GROUP -->
        <div class="nav-group">Operations</div>
        <div class="nav-item" onclick="showView('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inventory Master</div>
        <div class="nav-item" onclick="showView('sales')"><i class="fa-solid fa-file-invoice-dollar"></i> Sales & Invoices</div>
        <div class="nav-item" onclick="showView('crm')"><i class="fa-solid fa-users"></i> Customer CRM</div>
        <div class="nav-item" onclick="showView('suppliers')"><i class="fa-solid fa-truck-field"></i> Supplier Manage</div>
        <div class="nav-item" onclick="showView('barcode_gen')"><i class="fa-solid fa-barcode"></i> Barcode Generator</div>
        <div class="nav-item" onclick="showView('stock_transfer')"><i class="fa-solid fa-right-left"></i> Stock Transfer</div>

        <!-- ADMIN GROUP -->
        <div class="nav-group">Administration</div>
        <div class="nav-item" onclick="showView('users')"><i class="fa-solid fa-user-gear"></i> User Management</div>
        <div class="nav-item" onclick="showView('logs')"><i class="fa-solid fa-list-check"></i> Activity Logs</div>
        <div class="nav-item" onclick="showView('payroll')"><i class="fa-solid fa-money-check-dollar"></i> Payroll / Salary</div>
        <div class="nav-item" onclick="showView('attendance')"><i class="fa-solid fa-calendar-check"></i> Attendance</div>
        <div class="nav-item" onclick="showView('shifts')"><i class="fa-solid fa-business-time"></i> Shift Management</div>

        <div class="nav-item" style="margin-top: 20px; color: var(--danger); border: 1px solid var(--danger);" onclick="location.reload()">
            <i class="fa-solid fa-power-off"></i> LOGOUT
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div id="main">
    <header>
        <div style="display:flex; align-items:center; gap:15px">
            <div id="menuBtn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title" id="pageTitle">Dashboard Overview</div>
        </div>
        <div class="status-badge"><i class="fa-solid fa-wifi"></i> System Online</div>
    </header>

    <div id="workspace">

        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="view-section active">
            <div class="grid-4">
                <div class="card">
                    <div class="card-header"><span class="card-title">Today's Sales</span><i class="fa-solid fa-bangladeshi-taka-sign" style="color:var(--success)"></i></div>
                    <div class="stat-val" id="dSale">0</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Net Profit (Est.)</span><i class="fa-solid fa-coins" style="color:var(--warning)"></i></div>
                    <div class="stat-val" id="dProfit">0</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Low Stock</span><i class="fa-solid fa-triangle-exclamation" style="color:var(--danger)"></i></div>
                    <div class="stat-val" id="dLow">0</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Active Staff</span><i class="fa-solid fa-user-clock" style="color:var(--primary)"></i></div>
                    <div class="stat-val" id="dUser">0</div>
                </div>
            </div>
            <div class="card" style="height: 300px;">
                <div class="card-header"><span class="card-title">Sales vs Expense (Last 7 Days)</span></div>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- 2. ADVANCED REPORTS -->
        <div id="adv_reports" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Detailed Sales Report</span></div>
                <div class="control-bar">
                    <input type="date" id="repFrom">
                    <input type="date" id="repTo">
                    <button class="btn btn-primary" onclick="genReport()">Generate Report</button>
                </div>
                <div class="table-wrapper">
                    <table id="repTable">
                        <thead><tr><th>Date</th><th>Memo</th><th>Customer</th><th>Total</th><th>Profit</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. PROFIT ANALYSIS -->
        <div id="profit_analysis" class="view-section">
            <div class="grid-4">
                <div class="card"><div class="card-header"><span class="card-title">Total Revenue</span></div><div class="stat-val" id="paRev">0</div></div>
                <div class="card"><div class="card-header"><span class="card-title">Total Cost</span></div><div class="stat-val" id="paCost">0</div></div>
                <div class="card"><div class="card-header"><span class="card-title">Gross Profit</span></div><div class="stat-val" id="paGross" style="color:var(--success)">0</div></div>
                <div class="card"><div class="card-header"><span class="card-title">Margin %</span></div><div class="stat-val" id="paMargin">0%</div></div>
            </div>
        </div>

        <!-- 4. STAFF PERFORMANCE -->
        <div id="staff_perf" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Staff Leaderboard</span></div>
                <div class="table-wrapper">
                    <table id="staffTable">
                        <thead><tr><th>Staff Name</th><th>Total Sales</th><th>Orders Count</th><th>Performance</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 5. EXPORT CENTER -->
        <div id="export_center" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Data Export Center</span></div>
                <div style="display:flex; gap:15px; flex-wrap:wrap">
                    <button class="btn btn-success" onclick="exportData('products')">üì¶ Export Products (CSV)</button>
                    <button class="btn btn-primary" onclick="exportData('sales')">üí∞ Export Sales (CSV)</button>
                    <button class="btn btn-warning" onclick="exportData('customers')">üë• Export Customers (CSV)</button>
                </div>
            </div>
        </div>

        <!-- 6. SUPPLIER MANAGEMENT -->
        <div id="suppliers" class="view-section">
            <div class="control-bar">
                <input id="supName" placeholder="Supplier Name">
                <input id="supPhone" placeholder="Phone">
                <button class="btn btn-primary" onclick="addSupplier()">Add Supplier</button>
            </div>
            <div class="table-wrapper">
                <table id="supTable">
                    <thead><tr><th>Name</th><th>Phone</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 7. BARCODE GENERATOR -->
        <div id="barcode_gen" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Barcode Generator</span></div>
                <div style="display:flex; gap:10px; margin-bottom:20px">
                    <input id="bcText" placeholder="Enter Product Code (e.g. 1001)">
                    <button class="btn btn-primary" onclick="genBarcode()">Generate</button>
                </div>
                <div style="background:white; padding:20px; display:inline-block; border-radius:8px">
                    <svg id="barcode"></svg>
                </div>
            </div>
        </div>

        <!-- 8. STOCK TRANSFER -->
        <div id="stock_transfer" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Stock Transfer Log</span></div>
                <div class="control-bar">
                    <input id="stProd" placeholder="Product Name">
                    <input id="stQty" type="number" placeholder="Qty">
                    <input id="stTo" placeholder="To Branch">
                    <button class="btn btn-warning" onclick="addTransfer()">Transfer</button>
                </div>
                <div class="table-wrapper">
                    <table id="transTable">
                        <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>To Branch</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 9. PAYROLL -->
        <div id="payroll" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Staff Payroll</span></div>
                <div class="control-bar">
                    <input id="payName" placeholder="Staff Name">
                    <input id="payAmount" type="number" placeholder="Amount">
                    <button class="btn btn-success" onclick="addPayroll()">Pay Salary</button>
                </div>
                <div class="table-wrapper">
                    <table id="payTable">
                        <thead><tr><th>Date</th><th>Staff</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 10. ATTENDANCE -->
        <div id="attendance" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Daily Attendance</span></div>
                <div class="control-bar">
                    <input id="attName" placeholder="Staff Name">
                    <select id="attStatus"><option>Present</option><option>Absent</option><option>Late</option></select>
                    <button class="btn btn-primary" onclick="markAttendance()">Mark</button>
                </div>
                <div class="table-wrapper">
                    <table id="attTable">
                        <thead><tr><th>Date</th><th>Staff</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 11. SHIFT MANAGEMENT -->
        <div id="shifts" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Shift Schedule</span></div>
                <div class="control-bar">
                    <input id="shiftName" placeholder="Shift Name (e.g. Morning)">
                    <input id="shiftTime" placeholder="Time (e.g. 9AM - 2PM)">
                    <button class="btn btn-primary" onclick="addShift()">Add Shift</button>
                </div>
                <div id="shiftList"></div>
            </div>
        </div>

        <!-- 12. DB OPTIMIZER -->
        <div id="db_opt" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Database Optimizer</span></div>
                <p style="color:#94a3b8; margin-bottom:15px">Remove old logs and temporary data to speed up the system.</p>
                <button class="btn btn-danger" onclick="optimizeDB()">üöÄ Optimize Database Now</button>
            </div>
        </div>

        <!-- 13. API ACCESS -->
        <div id="api_access" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">API Access</span></div>
                <div class="control-bar">
                    <input id="apiKeyDisplay" readonly value="Generating..." style="flex:1">
                    <button class="btn btn-primary" onclick="genAPI()">Generate New Key</button>
                </div>
            </div>
        </div>

        <!-- 14. WHITE LABELING -->
        <div id="white_label" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">White Labeling</span></div>
                <div class="control-bar">
                    <input id="wlTitle" placeholder="App Title">
                    <button class="btn btn-success" onclick="saveWhiteLabel()">Save Branding</button>
                </div>
            </div>
        </div>

        <!-- 15. POS CONFIGURATION (MASTER CONTROL) -->
        <div id="pos_config" class="view-section">
            <div class="config-grid">

                <!-- 1. MODULE TOGGLES -->
                <div class="config-box">
                    <h4>üîå 1. Module Toggles</h4>
                    <div class="config-item"><label>Chat System</label><label class="toggle-switch"><input type="checkbox" id="modChat"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Manual Sale</label><label class="toggle-switch"><input type="checkbox" id="modManual"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Due/Credit</label><label class="toggle-switch"><input type="checkbox" id="modDue"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Sales Return</label><label class="toggle-switch"><input type="checkbox" id="modReturn"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Expense Manager</label><label class="toggle-switch"><input type="checkbox" id="modExpense"><span class="slider"></span></label></div>
                </div>

                <!-- 2. PERMISSIONS -->
                <div class="config-box">
                    <h4>üõ°Ô∏è 2. Staff Permissions</h4>
                    <div class="config-item"><label>Can Edit Price</label><label class="toggle-switch"><input type="checkbox" id="permPriceEdit"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Can Delete Item</label><label class="toggle-switch"><input type="checkbox" id="permDelete"><span class="slider"></span></label></div>
                    <div class="config-item"><label>View Cost Price</label><label class="toggle-switch"><input type="checkbox" id="permViewCost"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Backdated Entry</label><label class="toggle-switch"><input type="checkbox" id="permBackdate"><span class="slider"></span></label></div>
                </div>

                <!-- 3. VALIDATION RULES -->
                <div class="config-box">
                    <h4>‚ö†Ô∏è 3. Validation Rules</h4>
                    <div class="config-item"><label>Phone Mandatory?</label><label class="toggle-switch"><input type="checkbox" id="rulePhoneReq"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Allow Neg. Stock</label><label class="toggle-switch"><input type="checkbox" id="ruleNegStock"><span class="slider"></span></label></div>
                    <div class="config-item"><label>Max Due Limit</label><input id="ruleDueLimit" type="number" placeholder="0 = Unlimited" class="config-input"></div>
                    <div class="config-item"><label>Stock Alert Lvl</label><input id="ruleStockAlert" type="number" value="5" class="config-input"></div>
                </div>

                <!-- 4. UI & PRINT -->
                <div class="config-box">
                    <h4>üñ®Ô∏è 4. UI & Print</h4>
                    <div class="config-item"><label>Memo Label</label><input id="uiMemoLabel" placeholder="MEMO / BILL" class="config-input"></div>
                    <div class="config-item"><label>Print Format</label><select id="uiPrintFormat" class="config-input"><option value="A4">A4 / Half Page</option><option value="POS">POS (80mm)</option></select></div>
                    <div class="config-item"><label>Currency</label><input id="uiCurrency" value="‡ß≥" class="config-input" style="width:50px; text-align:center"></div>
                    <div class="config-item"><label>Footer Msg</label><textarea id="uiFooter" placeholder="Thank you..." class="config-input" style="height:60px"></textarea></div>
                </div>

                <!-- 5. BUSINESS LOGIC -->
                <div class="config-box">
                    <h4>üí∞ 5. Business Logic</h4>
                    <div class="config-item"><label>Enable VAT</label><label class="toggle-switch"><input type="checkbox" id="logicVatEnable"><span class="slider"></span></label></div>
                    <div class="config-item"><label>VAT %</label><input id="logicVatPercent" type="number" value="0" class="config-input"></div>
                    <div class="config-item"><label>Max Discount %</label><input id="logicMaxDisc" type="number" value="100" class="config-input"></div>
                </div>

                <!-- 6. ADVANCED AUTOMATION -->
                <div class="config-box">
                    <h4>ü§ñ 6. Automation</h4>
                    <div class="config-item"><label>Login Allowed</label><div style="display:flex; gap:5px"><input id="autoLoginStart" type="time" class="config-input" style="width:90px"><span style="color:#aaa">-</span><input id="autoLoginEnd" type="time" class="config-input" style="width:90px"></div></div>
                    <div class="config-item"><label>Bkash Charge %</label><input id="autoBkashCharge" type="number" placeholder="1.85" class="config-input"></div>
                    <div class="config-item"><label>Card Charge %</label><input id="autoCardCharge" type="number" placeholder="2.0" class="config-input"></div>
                    <div class="config-item"><label>Show QR</label><label class="toggle-switch"><input type="checkbox" id="autoShowQR"><span class="slider"></span></label></div>
                    <div class="config-item"><label>QR Data</label><input id="autoQRData" placeholder="Link..." class="config-input"></div>
                    <div class="config-item" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-top:10px"><label style="color:#f59e0b">‚ö†Ô∏è Force Popup</label><div style="display:flex; gap:5px; width:100%"><input id="autoPopupMsg" placeholder="Message..." class="config-input" style="flex:1"><div style="display:flex; gap:5px"><button class="btn btn-warning" style="padding:5px 10px; font-size:12px" onclick="sendLivePopup()">SEND</button><button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="stopPopup()">OFF</button></div></div></div>
                </div>
            </div>
            <button class="btn btn-success" style="width:100%; padding:15px; font-size:16px; margin-top:20px; margin-bottom:30px" onclick="saveMasterConfig()">üíæ SAVE MASTER CONFIGURATION</button>
        </div>

        <!-- 16. MENU BUILDER -->
        <div id="menu_builder" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Dynamic Menu Builder</span></div>
                <div class="control-bar">
                    <input type="hidden" id="editMenuKey">
                    <input id="menuLabel" placeholder="Menu Label (e.g. Warranty)">
                    <input id="menuIcon" placeholder="Icon Class (e.g. fa-solid fa-shield)">
                    <input id="menuAction" placeholder="Action ID (e.g. warranty_sec)">
                    <button class="btn btn-primary" id="menuBtnAdd" onclick="addMenuItem()">Add Menu</button>
                    <button class="btn btn-success" id="menuBtnUpdate" style="display:none" onclick="updateMenuItem()">Update Menu</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Label</th><th>Icon</th><th>Action</th><th>Visibility</th><th>Action</th></tr></thead>
                        <tbody id="menuListTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 17. LANGUAGE EDITOR -->
        <div id="lang_editor" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Language & Localization</span></div>
                <div class="control-bar">
                    <input id="langKey" placeholder="Key (e.g. total_bill)">
                    <input id="langVal" placeholder="Value (e.g. ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤)">
                    <button class="btn btn-primary" onclick="addLangItem()">Set Translation</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Key</th><th>Value</th><th>Action</th></tr></thead>
                        <tbody id="langListTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 18. INVOICE DESIGNER -->
        <div id="invoice_design" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Invoice Template Designer</span></div>
                <div class="config-grid">
                    <div class="config-box">
                        <h4>Columns to Show</h4>
                        <div class="config-item"><label>Show Serial</label><label class="toggle-switch"><input type="checkbox" id="invShowSerial"><span class="slider"></span></label></div>
                        <div class="config-item"><label>Show Description</label><label class="toggle-switch"><input type="checkbox" id="invShowDesc"><span class="slider"></span></label></div>
                        <div class="config-item"><label>Show Rate</label><label class="toggle-switch"><input type="checkbox" id="invShowRate"><span class="slider"></span></label></div>
                    </div>
                    <div class="config-box">
                        <h4>Header & Logo</h4>
                        <div class="config-item"><label>Logo URL</label><input id="invLogoUrl" class="config-input"></div>
                        <div class="config-item"><label>Header Color</label><input type="color" id="invHeaderColor" value="#000000" style="width:50px"></div>
                    </div>
                </div>
                <button class="btn btn-success" style="margin-top:20px" onclick="saveInvoiceDesign()">Save Design</button>
            </div>
        </div>

        <!-- 19. PAYMENT MANAGER -->
        <div id="payment_manager" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Payment Methods Manager</span></div>
                <div class="control-bar">
                    <input id="pmName" placeholder="Method Name (e.g. Rocket)">
                    <input id="pmCharge" type="number" placeholder="Charge %">
                    <button class="btn btn-primary" onclick="addPaymentMethod()">Add Method</button>
                </div>
                <div id="pmListContainer"></div>
            </div>
        </div>

        <!-- 20. CUSTOM CSS -->
        <div id="css_injector" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">Custom CSS Injector</span></div>
                <textarea id="customCssArea" style="width:100%; height:300px; background:#0f172a; color:#a5b4fc; font-family:monospace; padding:15px" placeholder="/* Enter custom CSS here to override POS styles */"></textarea>
                <button class="btn btn-warning" style="margin-top:15px" onclick="saveCustomCSS()">Inject CSS</button>
            </div>
        </div>

        <!-- OPERATIONS & ADMIN VIEWS (EXISTING) -->
        <div id="inventory" class="view-section"><div class="control-bar"><input id="invSearch" placeholder="Search Product..." style="flex:1" oninput="renderInventory()"><button class="btn btn-primary" onclick="openProductModal()">+ Add Product</button><button class="btn btn-warning" onclick="openBulkModal()"><i class="fa-solid fa-bolt"></i> Bulk Actions</button><button class="btn btn-dark" onclick="toggleDeadStock()"><i class="fa-solid fa-skull"></i> Dead Stock</button></div><div class="table-wrapper" style="max-height: 70vh;"><table><thead><tr><th>Name</th><th>Category</th><th>Stock</th><th>Cost</th><th>Sell</th><th>Status</th><th>Action</th></tr></thead><tbody id="invTable"></tbody></table></div></div>
        <div id="sales" class="view-section"><div class="card" style="margin-bottom:20px"><div class="card-header"><span class="card-title">Invoice Manager</span></div><div style="display:flex; gap:10px"><input id="saleSearch" placeholder="Enter Memo ID..." style="flex:1"><button class="btn btn-primary" onclick="searchInvoice()">Search</button></div></div><div id="invoiceResult"></div></div>
        <div id="crm" class="view-section"><div class="control-bar"><input id="custSearch" placeholder="Search Customer..." style="flex:1" oninput="renderCustomers()"></div><div class="table-wrapper"><table><thead><tr><th>Name</th><th>Phone</th><th>Total Buy</th><th>Due</th><th>Action</th></tr></thead><tbody id="custTable"></tbody></table></div></div>

        <!-- USER MANAGEMENT (UPDATED) -->
        <div id="users" class="view-section">
            <div class="control-bar">
                <div><h3>üë• User Access Control</h3><p style="font-size:12px; color:#94a3b8">Manage staff login, roles, and ban status.</p></div>
                <button class="btn btn-success" style="margin-left:auto" onclick="openUserModal()">+ Add New User</button>
            </div>
            <div class="grid-4" id="userGrid"></div>
        </div>

        <div id="logs" class="view-section"><div class="card"><div class="card-header"><span class="card-title">System Activity Logs</span><button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="wipeData('logs')">üóëÔ∏è Clear All Logs</button></div><div class="table-wrapper" style="max-height: 70vh;"><table><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead><tbody id="logTable"></tbody></table></div></div></div>
        <div id="system" class="view-section"><div class="grid-4"><div class="card" style="border-color:var(--danger)"><div class="card-header"><span class="card-title" style="color:var(--danger)">EMERGENCY LOCKDOWN</span><label class="toggle-switch"><input type="checkbox" id="lockSwitch" onchange="toggleLock()"><span class="slider" style="background-color:#334155"></span></label></div><p style="font-size:13px; color:#94a3b8">Turn ON to instantly block all POS access.</p><div class="config-item" style="margin-top:10px"><label>Maintenance Message</label><input id="sysMaintMsg" placeholder="System under maintenance..." class="config-input" style="width:100%"></div><button class="btn btn-danger" style="width:100%; margin-top:10px" onclick="saveSystemMsg()">Update Message</button></div><div class="card"><div class="card-header"><span class="card-title">Scrolling Notice</span></div><div style="display:flex; gap:10px"><input id="noticeInput" placeholder="Message for staff..."><div style="display:flex; gap:5px"><button class="btn btn-primary" onclick="updateNotice()">Send</button><button class="btn btn-danger" onclick="clearNotice()">OFF</button></div></div></div></div><div class="card"><div class="card-header"><span class="card-title">Data Management</span></div><div style="display:flex; gap:15px; flex-wrap:wrap"><button class="btn btn-success" onclick="backupData()"><i class="fa-solid fa-download"></i> Full Backup</button><button class="btn btn-danger" onclick="wipeData('entries')"><i class="fa-solid fa-trash"></i> Clear Sales</button></div></div></div>
        <div id="ui_builder" class="view-section"><div class="grid-4"><div class="card" style="grid-column: span 2;"><div class="card-header"><span class="card-title">üé® Theme & Experience</span></div><div class="config-item"><label>Primary Color</label><input type="color" id="uiPrimary" value="#4f46e5" style="width:50px; height:30px; padding:0; border:none"></div><div class="config-item"><label>Background Start</label><input type="color" id="uiBg1" value="#0f172a" style="width:50px; height:30px; padding:0; border:none"></div><div class="config-item"><label>Background End</label><input type="color" id="uiBg2" value="#172554" style="width:50px; height:30px; padding:0; border:none"></div><div class="config-item"><label>Font Family</label><input id="uiFont" placeholder="Hind Siliguri" class="config-input" style="width:150px"></div><div class="config-item"><label>Login Message</label><input id="uiLoginMsg" placeholder="Welcome..." class="config-input" style="width:200px"></div><button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="saveUISettings()">Apply UI Changes</button></div></div></div>

    </div>
</div>

<!-- MODALS -->
<div id="prodModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span class="modal-title">Product Details</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('prodModal')"></i></div><input type="hidden" id="pKey"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px"><input id="pName" placeholder="Product Name" style="grid-column: span 2"><input id="pCat" placeholder="Category"><input id="pType" placeholder="Section (Computer/General)"><input id="pCost" type="number" placeholder="Cost Price"><input id="pSell" type="number" placeholder="Sell Price"><input id="pQty" type="number" placeholder="Stock Qty"><input id="pAlert" type="number" placeholder="Alert Level"></div><div style="margin-top:20px; text-align:right"><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div></div></div>
<div id="bulkModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span class="modal-title">Bulk Operations</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('bulkModal')"></i></div><div class="form-group" style="margin-bottom:15px"><label>Action Type</label><select id="bulkType"><option value="price_inc">Increase Price (%)</option><option value="price_dec">Decrease Price (%)</option><option value="cat_rename">Rename Category</option></select></div><div class="form-group" style="margin-bottom:15px"><input id="bulkVal1" placeholder="Percentage / Old Category Name"></div><div class="form-group" style="margin-bottom:15px"><input id="bulkVal2" placeholder="New Category Name (If renaming)"></div><button class="btn btn-warning" style="width:100%" onclick="executeBulk()">EXECUTE</button></div></div>

<!-- USER MODAL (UPDATED) -->
<div id="userModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><span class="modal-title">User Configuration</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('userModal')"></i></div>
        <input type="hidden" id="uKey">
        <div class="config-item"><label>Username</label><input id="uName" placeholder="e.g. rahim" class="config-input" style="width:100%"></div>
        <div class="config-item"><label>Password</label><input id="uPass" type="text" placeholder="Enter Password" class="config-input" style="width:100%"></div>
        <div class="config-item"><label>Role</label><select id="uRole" class="config-input" style="width:100%"><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
        <div class="config-item" style="background:#0f172a; padding:10px; border-radius:8px; border:1px solid #334155; margin-top:15px"><label style="color:#ef4444; font-weight:bold">üö´ Ban This User?</label><label class="toggle-switch"><input type="checkbox" id="uBlocked"><span class="slider"></span></label></div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="saveUser()">üíæ Save User Settings</button>
    </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM", authDomain: "sheikh-computer-b41d5.firebaseapp.com", databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "sheikh-computer-b41d5" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let products = [], entries = [], users = {}, customers = [], suppliers = [], payroll = [], attendance = [], shifts = [];
let chartInstance = null;

function authenticate() { if(document.getElementById("masterKey").value === "admin123") { document.getElementById("authGate").style.display = "none"; initApp(); } else alert("‚ùå Access Denied"); }
function initApp() { loadData(); setupListeners(); }
function setupListeners() { document.getElementById("masterKey").addEventListener("keypress", e => { if(e.key === "Enter") authenticate(); }); }
function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
function safeCheck(id, val) { const el = document.getElementById(id); if(el) el.checked = val; }

function loadData() {
    db.ref("products").on("value", s => { products = []; s.forEach(c => { let p = c.val(); p.key = c.key; products.push(p); }); renderInventory(); updateDashboard(); });
    db.ref("entries").on("value", s => { entries = []; s.forEach(c => { let e = c.val(); e.key = c.key; entries.push(e); }); updateDashboard(); renderChart(); renderCustomers(); genReport(); renderStaffPerf(); });
    db.ref("users").on("value", s => { users = s.val() || {}; renderUsers(); });
    db.ref("customers").on("value", s => { customers = []; s.forEach(c => { let cust = c.val(); cust.key = c.key; customers.push(cust); }); renderCustomers(); });
    db.ref("logs").limitToLast(100).on("value", s => renderLogs(s.val()));
    db.ref("settings/appLock").on("value", s => safeCheck("lockSwitch", s.val() || false));
    db.ref("settings/maintMsg").on("value", s => safeSet("sysMaintMsg", s.val() || ""));
    db.ref("settings/notice").on("value", s => safeSet("noticeInput", s.val() || ""));
    db.ref("suppliers").on("value", s => { suppliers = []; s.forEach(c => suppliers.push(c.val())); renderSuppliers(); });
    db.ref("payroll").on("value", s => { payroll = []; s.forEach(c => payroll.push(c.val())); renderPayroll(); });
    db.ref("attendance").on("value", s => { attendance = []; s.forEach(c => attendance.push(c.val())); renderAttendance(); });
    db.ref("shifts").on("value", s => { shifts = s.val() || []; renderShifts(); });
    db.ref("transfers").on("value", s => renderTransfers(s.val()));

    // --- MASTER CONFIG LOADER ---
    db.ref("settings/masterConfig").on("value", s => {
        const c = s.val() || {};
        safeCheck("modChat", c.modules?.chat ?? true); safeCheck("modManual", c.modules?.manual ?? true); safeCheck("modDue", c.modules?.due ?? true); safeCheck("modReturn", c.modules?.return ?? true); safeCheck("modExpense", c.modules?.expense ?? true);
        safeCheck("permPriceEdit", c.perms?.priceEdit ?? true); safeCheck("permDelete", c.perms?.delete ?? true); safeCheck("permViewCost", c.perms?.viewCost ?? false); safeCheck("permBackdate", c.perms?.backdate ?? false);
        safeCheck("rulePhoneReq", c.rules?.phoneReq ?? false); safeCheck("ruleNegStock", c.rules?.negStock ?? false); safeSet("ruleDueLimit", c.rules?.dueLimit || ""); safeSet("ruleStockAlert", c.rules?.stockAlert || 5);
        safeSet("uiMemoLabel", c.ui?.memoLabel || "MEMO / BILL"); safeSet("uiPrintFormat", c.ui?.printFormat || "A4"); safeSet("uiCurrency", c.ui?.currency || "‡ß≥"); safeSet("uiFooter", c.ui?.footer || "");
        safeCheck("logicVatEnable", c.logic?.vatEnable ?? false); safeSet("logicVatPercent", c.logic?.vatPercent || 0); safeSet("logicMaxDisc", c.logic?.maxDisc || 100);
        safeSet("autoLoginStart", c.auto?.loginStart || "09:00"); safeSet("autoLoginEnd", c.auto?.loginEnd || "22:00"); safeSet("autoBkashCharge", c.auto?.bkashCharge || 0); safeSet("autoCardCharge", c.auto?.cardCharge || 0); safeCheck("autoShowQR", c.auto?.showQR ?? false); safeSet("autoQRData", c.auto?.qrData || "");
    });

    // --- ULTRA PRO LOADERS ---
    db.ref("settings/menu").on("value", s => renderMenuList(s.val()));
    db.ref("settings/translations").on("value", s => renderLangList(s.val()));
    db.ref("settings/payments").on("value", s => renderList(s.val(), "pmListContainer", "removePM"));
    db.ref("settings/css").on("value", s => safeSet("customCssArea", s.val() || ""));
    db.ref("settings/invoiceDesign").on("value", s => { const d = s.val() || {}; safeCheck("invShowSerial", d.showSerial); safeCheck("invShowDesc", d.showDesc); safeCheck("invShowRate", d.showRate); safeSet("invLogoUrl", d.logoUrl || ""); safeSet("invHeaderColor", d.headerColor || "#000000"); });
    db.ref("settings/ui").on("value", s => { const ui = s.val() || {}; safeSet("uiPrimary", ui.primary || "#4f46e5"); safeSet("uiBg1", ui.bg1 || "#0f172a"); safeSet("uiBg2", ui.bg2 || "#172554"); safeSet("uiFont", ui.font || ""); safeSet("uiLoginMsg", ui.loginMsg || ""); });
}

function showView(id) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); event.currentTarget.classList.add('active'); if(window.innerWidth < 768) document.getElementById("sidebar").classList.remove("active"); }
function toggleSidebar() { document.getElementById("sidebar").classList.toggle("active"); }

function updateDashboard() {
    const today = new Date().toLocaleDateString("en-GB");
    let todaySale = 0, totalProfit = 0, lowStock = 0;
    entries.forEach(e => { if(e.date === today) todaySale += parseFloat(e.total) || 0; if(e.items) e.items.forEach(i => { totalProfit += (i.sub - ((parseFloat(i.cost)||0)*i.qty)); }); });
    products.forEach(p => { if(!p.isService && p.qty <= (p.alertLevel || 5)) lowStock++; });
    document.getElementById("dSale").innerText = "‡ß≥" + todaySale.toLocaleString(); document.getElementById("dProfit").innerText = "‡ß≥" + totalProfit.toLocaleString(); document.getElementById("dLow").innerText = lowStock; document.getElementById("dUser").innerText = Object.keys(users).length;
}

function renderChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const labels = [], data = [];
    for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const dateStr = d.toLocaleDateString("en-GB"); labels.push(dateStr.slice(0,5)); data.push(entries.filter(e => e.date === dateStr).reduce((sum, e) => sum + (+e.total || 0), 0)); }
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Sales', data: data, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
}

// --- SAVE MASTER CONFIG ---
function saveMasterConfig() {
    const config = {
        modules: {
            chat: document.getElementById("modChat").checked,
            manual: document.getElementById("modManual").checked,
            due: document.getElementById("modDue").checked,
            return: document.getElementById("modReturn").checked,
            expense: document.getElementById("modExpense").checked
        },
        perms: {
            priceEdit: document.getElementById("permPriceEdit").checked,
            delete: document.getElementById("permDelete").checked,
            viewCost: document.getElementById("permViewCost").checked,
            backdate: document.getElementById("permBackdate").checked
        },
        rules: {
            phoneReq: document.getElementById("rulePhoneReq").checked,
            negStock: document.getElementById("ruleNegStock").checked,
            dueLimit: document.getElementById("ruleDueLimit").value || 0,
            stockAlert: document.getElementById("ruleStockAlert").value || 5
        },
        ui: {
            memoLabel: document.getElementById("uiMemoLabel").value || "MEMO / BILL",
            printFormat: document.getElementById("uiPrintFormat").value,
            currency: document.getElementById("uiCurrency").value || "‡ß≥",
            footer: document.getElementById("uiFooter").value || ""
        },
        logic: {
            vatEnable: document.getElementById("logicVatEnable").checked,
            vatPercent: document.getElementById("logicVatPercent").value || 0,
            maxDisc: document.getElementById("logicMaxDisc").value || 100
        },
        auto: {
            loginStart: document.getElementById("autoLoginStart").value || "00:00",
            loginEnd: document.getElementById("autoLoginEnd").value || "23:59",
            bkashCharge: document.getElementById("autoBkashCharge").value || 0,
            cardCharge: document.getElementById("autoCardCharge").value || 0,
            showQR: document.getElementById("autoShowQR").checked,
            qrData: document.getElementById("autoQRData").value || ""
        }
    };
    db.ref("settings/masterConfig").set(config).then(() => alert("‚úÖ God Mode Settings Saved!"));
}
// --- ULTRA PRO FUNCTIONS ---
function addMenuItem() { const l = document.getElementById("menuLabel").value, i = document.getElementById("menuIcon").value, a = document.getElementById("menuAction").value; if(l && a) db.ref("settings/menu").push({label:l, icon:i, action:a, visible:true}); }
function removeMenu(k) { db.ref("settings/menu/"+k).remove(); }
function editMenu(k) {
    db.ref("settings/menu/"+k).once("value", s => {
        const m = s.val();
        document.getElementById("editMenuKey").value = k;
        document.getElementById("menuLabel").value = m.label;
        document.getElementById("menuIcon").value = m.icon;
        document.getElementById("menuAction").value = m.action;
        document.getElementById("menuBtnAdd").style.display = "none";
        document.getElementById("menuBtnUpdate").style.display = "inline-block";
    });
}
function updateMenuItem() {
    const k = document.getElementById("editMenuKey").value;
    const data = { label: document.getElementById("menuLabel").value, icon: document.getElementById("menuIcon").value, action: document.getElementById("menuAction").value };
    db.ref("settings/menu/"+k).update(data).then(() => {
        alert("Menu Updated!");
        document.getElementById("menuBtnAdd").style.display = "inline-block";
        document.getElementById("menuBtnUpdate").style.display = "none";
        document.getElementById("menuLabel").value = ""; document.getElementById("menuIcon").value = ""; document.getElementById("menuAction").value = "";
    });
}
function renderMenuList(data) {
    const t = document.getElementById("menuListTable"); t.innerHTML = "";
    if(!data) return;
    Object.keys(data).forEach(k => {
        const m = data[k];
        t.innerHTML += `<tr><td>${m.label}</td><td><i class="${m.icon}"></i></td><td>${m.action}</td><td><input type="checkbox" ${m.visible?'checked':''} onchange="db.ref('settings/menu/${k}/visible').set(this.checked)"></td><td><button class="btn btn-primary" style="padding:5px" onclick="editMenu('${k}')">Edit</button> <button class="btn btn-danger" style="padding:5px" onclick="removeMenu('${k}')">Del</button></td></tr>`;
    });
}

function addLangItem() { const k = document.getElementById("langKey").value, v = document.getElementById("langVal").value; if(k && v) db.ref("settings/translations/"+k).set(v); }
function removeLang(k) { db.ref("settings/translations/"+k).remove(); }
function renderLangList(data) {
    const t = document.getElementById("langListTable"); t.innerHTML = "";
    if(!data) return;
    Object.keys(data).forEach(k => {
        t.innerHTML += `<tr><td>${k}</td><td>${data[k]}</td><td><button class="btn btn-danger" style="padding:5px" onclick="removeLang('${k}')">Delete</button></td></tr>`;
    });
}

function addPaymentMethod() { const n = document.getElementById("pmName").value, c = document.getElementById("pmCharge").value; db.ref("settings/payments").push({name:n, charge:c}); }
function removePM(k) { db.ref("settings/payments/"+k).remove(); }
function saveCustomCSS() { db.ref("settings/css").set(document.getElementById("customCssArea").value); alert("CSS Injected!"); }
function saveInvoiceDesign() { const d = { showSerial: document.getElementById("invShowSerial").checked, showDesc: document.getElementById("invShowDesc").checked, showRate: document.getElementById("invShowRate").checked, logoUrl: document.getElementById("invLogoUrl").value, headerColor: document.getElementById("invHeaderColor").value }; db.ref("settings/invoiceDesign").set(d); alert("Design Saved!"); }
function sendLivePopup() { const msg = document.getElementById("autoPopupMsg").value; if(msg) db.ref("settings/popup").set({msg:msg, time:Date.now(), active:true}); alert("Sent!"); }
function stopPopup() {
    db.ref("settings/popup").update({
        active: false,
        msg: ""
    });
    alert("üì¢ Admin Alert is now OFF!");
}

function renderList(data, containerId, removeFunc, isObj=false) {
    const c = document.getElementById(containerId); c.innerHTML = "";
    if(!data) return;
    if(isObj) {
        Object.keys(data).forEach(k => { c.innerHTML += `<div style="background:#0f172a; padding:10px; margin-bottom:5px; display:flex; justify-content:space-between">${k} : ${data[k]} <button class="btn btn-danger" style="padding:2px 5px" onclick="${removeFunc}('${k}')">X</button></div>`; });
    } else {
        Object.keys(data).forEach(k => { const i = data[k]; c.innerHTML += `<div style="background:#0f172a; padding:10px; margin-bottom:5px; display:flex; justify-content:space-between">${i.label || i.name} <button class="btn btn-danger" style="padding:2px 5px" onclick="${removeFunc}('${k}')">X</button></div>`; });
    }
}

// --- USER MANAGEMENT FUNCTIONS (UPDATED) ---
function renderUsers() {
    const g = document.getElementById("userGrid"); g.innerHTML = "";
    Object.keys(users).forEach(k => {
        const u = users[k]; const isBanned = u.blocked === true; const statusColor = isBanned ? '#ef4444' : '#10b981'; const statusText = isBanned ? 'BANNED' : 'ACTIVE'; const cardBorder = isBanned ? '2px solid #ef4444' : '1px solid #334155';
        g.innerHTML += `<div class="card" style="border:${cardBorder}; position:relative; opacity:${isBanned ? 0.7 : 1}"><div class="card-header" style="margin-bottom:10px"><span class="card-title" style="font-size:16px; color:#fff">${k.toUpperCase()}</span><span style="font-size:10px; background:${statusColor}20; color:${statusColor}; padding:3px 8px; border-radius:4px; font-weight:bold">${statusText}</span></div><div style="font-size:13px; color:#94a3b8; margin-bottom:15px"><p>üîë Role: <b style="color:#fff">${u.role.toUpperCase()}</b></p><p>üîí Pass: ${u.pass}</p></div><div style="display:flex; gap:10px; margin-bottom:10px"><button class="btn btn-primary" style="flex:1; font-size:12px; padding:8px" onclick="openUserModal('${k}')">‚úèÔ∏è Edit</button><button class="btn btn-warning" style="flex:1; font-size:12px; padding:8px" onclick="kickUser('${k}')">‚ö° Kick</button></div>${!isBanned ? `<button class="btn btn-danger" style="width:100%; font-size:12px; padding:8px" onclick="toggleBan('${k}', true)">üö´ BAN USER</button>` : `<button class="btn btn-success" style="width:100%; font-size:12px; padding:8px" onclick="toggleBan('${k}', false)">‚úÖ UNBAN USER</button>`}</div>`;
    });
}
function openUserModal(key = "") {
    document.getElementById("uKey").value = key; document.getElementById("uName").value = ""; document.getElementById("uPass").value = ""; document.getElementById("uRole").value = "staff"; document.getElementById("uBlocked").checked = false; document.getElementById("uName").disabled = false;
    if(key && users[key]) { const u = users[key]; document.getElementById("uName").value = key; document.getElementById("uName").disabled = true; document.getElementById("uPass").value = u.pass; document.getElementById("uRole").value = u.role; document.getElementById("uBlocked").checked = u.blocked === true; }
    document.getElementById("userModal").style.display = "flex";
}
function saveUser() {
    const key = document.getElementById("uKey").value; const u = document.getElementById("uName").value.trim().toLowerCase(); const p = document.getElementById("uPass").value; const r = document.getElementById("uRole").value; const b = document.getElementById("uBlocked").checked;
    if(!u || !p) return alert("Username and Password required!");
    db.ref("users/" + u).update({ pass: p, role: r, blocked: b, forceLogout: b }).then(() => { alert("User Saved Successfully!"); closeModal('userModal'); });
}
function toggleBan(username, status) { if(confirm(`Are you sure you want to ${status ? "BAN" : "UNBAN"} user: ${username}?`)) { db.ref("users/" + username).update({ blocked: status, forceLogout: status }); } }
function kickUser(u) { if(confirm("Kick out " + u + " from POS immediately?")) { db.ref("users/"+u).update({forceLogout:true}); alert("User kicked out!"); } }

// --- EXISTING FUNCTIONS ---
function saveUISettings() { const ui = { primary: document.getElementById("uiPrimary").value, bg1: document.getElementById("uiBg1").value, bg2: document.getElementById("uiBg2").value, font: document.getElementById("uiFont").value, loginMsg: document.getElementById("uiLoginMsg").value }; db.ref("settings/ui").set(ui).then(() => alert("üé® Applied!")); }
function saveSystemMsg() { db.ref("settings/maintMsg").set(document.getElementById("sysMaintMsg").value).then(() => alert("Updated")); }
function renderInventory() { const q = document.getElementById("invSearch").value.toLowerCase(); const t = document.getElementById("invTable"); t.innerHTML = ""; products.filter(p => p.name.toLowerCase().includes(q)).forEach(p => { t.innerHTML += `<tr><td>${p.name}</td><td>${p.category}</td><td>${p.qty}</td><td>${p.costPrice}</td><td>${p.sellPrice}</td><td>${p.qty<=5?'Low':'OK'}</td><td><button class="btn btn-primary" style="padding:5px" onclick="editProduct('${p.key}')">Edit</button></td></tr>`; }); }
function openProductModal() { document.getElementById("prodModal").style.display = "flex"; }
function editProduct(key) { const p = products.find(x => x.key === key); document.getElementById("pKey").value = key; document.getElementById("pName").value = p.name; document.getElementById("pCat").value = p.category; document.getElementById("pType").value = p.mainType; document.getElementById("pCost").value = p.costPrice; document.getElementById("pSell").value = p.sellPrice; document.getElementById("pQty").value = p.qty; document.getElementById("pAlert").value = p.alertLevel; document.getElementById("prodModal").style.display = "flex"; }
function saveProduct() { const key = document.getElementById("pKey").value; const data = { name: document.getElementById("pName").value, category: document.getElementById("pCat").value, mainType: document.getElementById("pType").value, costPrice: parseFloat(document.getElementById("pCost").value)||0, sellPrice: parseFloat(document.getElementById("pSell").value)||0, qty: parseFloat(document.getElementById("pQty").value)||0, alertLevel: parseFloat(document.getElementById("pAlert").value)||5, isService: false }; if(key) db.ref("products/"+key).update(data); else db.ref("products").push(data); closeModal('prodModal'); }
function openBulkModal() { document.getElementById("bulkModal").style.display = "flex"; }
function executeBulk() { alert("Bulk Executed"); closeModal('bulkModal'); }
function searchInvoice() { const q = document.getElementById("saleSearch").value.trim().toLowerCase(); const f = entries.find(e => (e.memoId && String(e.memoId) === q) || (e.note && e.note.toLowerCase().includes(q))); document.getElementById("invoiceResult").innerHTML = f ? `<div class="card"><p>Memo: ${f.memoId}</p><p>Total: ${f.total}</p></div>` : "Not Found"; }
function renderCustomers() { const q = document.getElementById("custSearch").value.toLowerCase(); const t = document.getElementById("custTable"); t.innerHTML = ""; customers.filter(c => c.name.toLowerCase().includes(q)).forEach(c => t.innerHTML += `<tr><td>${c.name}</td><td>${c.phone}</td><td>-</td><td>-</td><td>X</td></tr>`); }
function renderLogs(l) { const t = document.getElementById("logTable"); t.innerHTML = ""; if(l) Object.values(l).reverse().forEach(x => t.innerHTML += `<tr><td>${x.time}</td><td>${x.user}</td><td>${x.action}</td><td>${x.details}</td></tr>`); }
function toggleLock() { const s = document.getElementById("lockSwitch").checked; db.ref("settings/appLock").set(s); updateNotice(s ? "MAINTENANCE MODE" : ""); }
function updateNotice() { db.ref("settings/notice").set(document.getElementById("noticeInput").value); alert("Notice Updated!"); }
function clearNotice() { db.ref("settings/notice").set(""); document.getElementById("noticeInput").value = ""; alert("Notice Cleared!"); }
function backupData() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({products, entries, users})); const a = document.createElement('a'); a.href = d; a.download = "backup.json"; a.click(); }
function wipeData(n) { if(confirm("Sure?")) db.ref(n).remove(); }
function addSupplier() { db.ref("suppliers").push({ name: document.getElementById("supName").value, phone: document.getElementById("supPhone").value }); alert("Supplier Added"); }
function renderSuppliers() { const t = document.getElementById("supTable").querySelector("tbody"); t.innerHTML = ""; suppliers.forEach(s => t.innerHTML += `<tr><td>${s.name}</td><td>${s.phone}</td><td><button class="btn btn-danger" style="padding:2px">X</button></td></tr>`); }
function genBarcode() { JsBarcode("#barcode", document.getElementById("bcText").value); }
function addTransfer() { db.ref("transfers").push({ date: new Date().toLocaleDateString(), prod: document.getElementById("stProd").value, qty: document.getElementById("stQty").value, to: document.getElementById("stTo").value }); alert("Transfer Logged"); }
function renderTransfers(data) { const t = document.getElementById("transTable").querySelector("tbody"); t.innerHTML = ""; if(data) Object.values(data).forEach(d => t.innerHTML += `<tr><td>${d.date}</td><td>${d.prod}</td><td>${d.qty}</td><td>${d.to}</td></tr>`); }
function addPayroll() { db.ref("payroll").push({ date: new Date().toLocaleDateString(), staff: document.getElementById("payName").value, amount: document.getElementById("payAmount").value, status: "Paid" }); alert("Salary Paid"); }
function renderPayroll() { const t = document.getElementById("payTable").querySelector("tbody"); t.innerHTML = ""; payroll.forEach(p => t.innerHTML += `<tr><td>${p.date}</td><td>${p.staff}</td><td>${p.amount}</td><td>${p.status}</td></tr>`); }
function markAttendance() { db.ref("attendance").push({ date: new Date().toLocaleDateString(), staff: document.getElementById("attName").value, status: document.getElementById("attStatus").value }); alert("Marked"); }
function renderAttendance() { const t = document.getElementById("attTable").querySelector("tbody"); t.innerHTML = ""; attendance.forEach(a => t.innerHTML += `<tr><td>${a.date}</td><td>${a.staff}</td><td>${a.status}</td></tr>`); }
function addShift() { shifts.push({ name: document.getElementById("shiftName").value, time: document.getElementById("shiftTime").value }); db.ref("shifts").set(shifts); }
function renderShifts() { const d = document.getElementById("shiftList"); d.innerHTML = ""; shifts.forEach(s => d.innerHTML += `<div style="background:#0f172a; padding:10px; margin-bottom:5px; border-radius:5px">${s.name}: ${s.time}</div>`); }
function optimizeDB() { if(confirm("Clear old logs?")) { db.ref("logs").remove(); alert("Optimized!"); } }
function genAPI() { document.getElementById("apiKeyDisplay").value = "sk_live_" + Math.random().toString(36).substr(2, 16); }
function saveWhiteLabel() { db.ref("settings/whiteLabel").set(document.getElementById("wlTitle").value); alert("Saved"); }
function genReport() { const t = document.getElementById("repTable").querySelector("tbody"); t.innerHTML = ""; entries.forEach(e => { t.innerHTML += `<tr><td>${e.date}</td><td>${e.memoId||'-'}</td><td>${e.note}</td><td>${e.total}</td><td>-</td></tr>`; }); }
function renderStaffPerf() { const t = document.getElementById("staffTable").querySelector("tbody"); t.innerHTML = ""; const perf = {}; entries.forEach(e => { if(!perf[e.user]) perf[e.user] = {sale:0, count:0}; perf[e.user].sale += parseFloat(e.total); perf[e.user].count++; }); Object.keys(perf).forEach(u => t.innerHTML += `<tr><td>${u}</td><td>${perf[u].sale}</td><td>${perf[u].count}</td><td>-</td></tr>`); }
function exportData(type) { let data = []; if(type==='products') data = products; if(type==='sales') data = entries; if(type==='customers') data = customers; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, type + "_export.xlsx"); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
