<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sheikh Admin Ultimate (v7.0 Pro)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Excel Export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
    :root {
        --bg-dark: #0f172a;
        --bg-panel: #1e293b;
        --primary: #6366f1;
        --primary-hover: #4f46e5;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
    body { background: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

    /* --- SCROLLBAR --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* --- LOGIN OVERLAY --- */
    #authGate {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;
        flex-direction: column;
    }
    .auth-box { background: var(--bg-panel); padding: 40px; border-radius: 16px; border: 1px solid var(--primary); width: 350px; text-align: center; box-shadow: 0 0 50px rgba(99, 102, 241, 0.2); }
    .auth-box h1 { font-size: 24px; margin-bottom: 10px; background: linear-gradient(to right, #fff, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .auth-input { width: 100%; padding: 14px; background: var(--bg-dark); border: 1px solid var(--border); color: white; border-radius: 8px; margin-top: 20px; text-align: center; font-size: 18px; letter-spacing: 2px; }
    .auth-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; margin-top: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .auth-btn:hover { background: var(--primary-hover); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

    /* --- SIDEBAR --- */
    #sidebar { width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; transition: 0.3s; z-index: 100; }
    .brand { padding: 25px; font-size: 20px; font-weight: 800; color: var(--primary); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .nav-menu { flex: 1; overflow-y: auto; padding: 15px; }
    .nav-item { padding: 12px 15px; color: var(--text-muted); cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 12px; font-size: 14px; transition: 0.2s; }
    .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
    .nav-item i { width: 20px; text-align: center; }
    .nav-group { font-size: 11px; text-transform: uppercase; color: #64748b; margin: 15px 0 5px 10px; font-weight: 700; letter-spacing: 1px; }

    /* --- MAIN CONTENT --- */
    #main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
    header { height: 65px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); }
    .header-title { font-size: 18px; font-weight: 600; }
    .status-badge { font-size: 12px; padding: 5px 10px; border-radius: 20px; background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); display: flex; align-items: center; gap: 5px; }
    
    #workspace { flex: 1; overflow-y: auto; padding: 25px; }
    .view-section { display: none; animation: fadeIn 0.3s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- COMPONENTS --- */
    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 14px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    .stat-val { font-size: 28px; font-weight: 700; color: var(--text-main); }
    .stat-trend { font-size: 12px; margin-top: 5px; }
    .trend-up { color: var(--success); } .trend-down { color: var(--danger); }

    /* --- CONTROLS --- */
    .control-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: var(--bg-panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); align-items: center; }
    input, select { background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 10px 15px; border-radius: 8px; font-size: 13px; outline: none; }
    input:focus { border-color: var(--primary); }
    
    .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-dark { background: var(--border); color: white; }

    /* --- TABLES --- */
    .table-wrapper { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #253045; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding: 15px; text-align: left; font-weight: 600; }
    td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

    /* --- MODAL --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: var(--bg-panel); width: 500px; max-width: 95%; padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
    .modal-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
    .close-modal { cursor: pointer; font-size: 20px; color: var(--text-muted); }

    /* --- TOGGLE SWITCH --- */
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--danger); } /* Red for Danger/Lock */
    input:checked + .slider:before { transform: translateX(24px); }

    /* --- UI BUILDER STYLES --- */
    .ui-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; }
    .color-picker { width: 50px; height: 40px; padding: 0; border: none; cursor: pointer; }
    .sidebar-item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #0f172a; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        #sidebar { position: fixed; left: -270px; height: 100%; }
        #sidebar.active { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #menuBtn { display: block !important; }
    }
    #menuBtn { display: none; font-size: 24px; cursor: pointer; }
</style>
</head>
<body>

<!-- AUTH GATE -->
<div id="authGate">
    <div class="auth-box">
        <h1><i class="fa-solid fa-user-shield"></i> GOD MODE</h1>
        <p style="color:#94a3b8; font-size:13px;">Super Admin Access Only</p>
        <input type="password" id="masterKey" class="auth-input" placeholder="Enter Master Key">
        <button class="auth-btn" onclick="authenticate()">UNLOCK SYSTEM</button>
    </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-shield-halved"></i> SHEIKH ADMIN
    </div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="showView('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</div>
        
        <div class="nav-group">Operations</div>
        <div class="nav-item" onclick="showView('inventory')"><i class="fa-solid fa-boxes-stacked"></i> Inventory Master</div>
        <div class="nav-item" onclick="showView('sales')"><i class="fa-solid fa-file-invoice-dollar"></i> Sales & Invoices</div>
        <div class="nav-item" onclick="showView('crm')"><i class="fa-solid fa-users"></i> Customer CRM</div>
        
        <div class="nav-group">Administration</div>
        <div class="nav-item" onclick="showView('users')"><i class="fa-solid fa-user-gear"></i> User Management</div>
        <div class="nav-item" onclick="showView('system')"><i class="fa-solid fa-sliders"></i> System Control</div>
        
        <!-- NEW UI BUILDER MENU -->
        <div class="nav-item" onclick="showView('ui_builder')" style="color: #f59e0b;"><i class="fa-solid fa-palette"></i> UI Builder (v7)</div>
        
        <div class="nav-item" style="margin-top: 20px; color: var(--danger); border: 1px solid var(--danger);" onclick="location.reload()">
            <i class="fa-solid fa-lock"></i> LOCK PANEL
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div id="main">
    <header>
        <div style="display:flex; align-items:center; gap:15px">
            <div id="menuBtn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title" id="pageTitle">Dashboard Overview</div>
        </div>
        <div class="status-badge"><i class="fa-solid fa-wifi"></i> System Online</div>
    </header>

    <div id="workspace">
        
        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="view-section active">
            <div class="grid-4">
                <div class="card">
                    <div class="card-header"><span class="card-title">Today's Sales</span><i class="fa-solid fa-bangladeshi-taka-sign" style="color:var(--success)"></i></div>
                    <div class="stat-val" id="dSale">0</div>
                    <div class="stat-trend trend-up"><i class="fa-solid fa-arrow-trend-up"></i> Live Update</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Net Profit (Est.)</span><i class="fa-solid fa-coins" style="color:var(--warning)"></i></div>
                    <div class="stat-val" id="dProfit">0</div>
                    <div class="stat-trend" style="color:#94a3b8">Based on Cost Price</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Low Stock Items</span><i class="fa-solid fa-triangle-exclamation" style="color:var(--danger)"></i></div>
                    <div class="stat-val" id="dLow">0</div>
                    <div class="stat-trend trend-down">Action Needed</div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Active Staff</span><i class="fa-solid fa-user-clock" style="color:var(--primary)"></i></div>
                    <div class="stat-val" id="dUser">0</div>
                </div>
            </div>

            <div class="card" style="height: 300px;">
                <div class="card-header"><span class="card-title">Sales vs Expense (Last 7 Days)</span></div>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- 2. INVENTORY MASTER -->
        <div id="inventory" class="view-section">
            <div class="control-bar">
                <input id="invSearch" placeholder="Search Product..." style="flex:1" oninput="renderInventory()">
                <button class="btn btn-primary" onclick="openProductModal()">+ Add Product</button>
                <button class="btn btn-warning" onclick="openBulkModal()"><i class="fa-solid fa-bolt"></i> Bulk Actions</button>
                <button class="btn btn-dark" onclick="toggleDeadStock()"><i class="fa-solid fa-skull"></i> Dead Stock</button>
            </div>
            <div class="table-wrapper" style="max-height: 70vh; overflow-y: auto;">
                <table>
                    <thead><tr><th>Name</th><th>Category</th><th>Stock</th><th>Cost</th><th>Sell</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="invTable"></tbody>
                </table>
            </div>
        </div>

        <!-- 3. SALES & INVOICES -->
        <div id="sales" class="view-section">
            <div class="card" style="margin-bottom:20px">
                <div class="card-header"><span class="card-title">Invoice Manager</span></div>
                <div style="display:flex; gap:10px">
                    <input id="saleSearch" placeholder="Enter Memo ID (e.g. 1005), Name or Phone..." style="flex:1">
                    <button class="btn btn-primary" onclick="searchInvoice()">Search</button>
                </div>
            </div>
            <div id="invoiceResult"></div>
        </div>

        <!-- 4. CUSTOMER CRM -->
        <div id="crm" class="view-section">
            <div class="control-bar">
                <input id="custSearch" placeholder="Search Customer..." style="flex:1" oninput="renderCustomers()">
            </div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Name</th><th>Phone</th><th>Total Buy</th><th>Due</th><th>Action</th></tr></thead>
                    <tbody id="custTable"></tbody>
                </table>
            </div>
        </div>

        <!-- 5. USER MANAGEMENT -->
        <div id="users" class="view-section">
            <div class="control-bar">
                <h3>Staff Access Control</h3>
                <button class="btn btn-success" style="margin-left:auto" onclick="openUserModal()">+ New User</button>
            </div>
            <div class="grid-4" id="userGrid"></div>
        </div>

        <!-- 6. SYSTEM CONTROL -->
        <div id="system" class="view-section">
            <div class="grid-4">
                <div class="card" style="border-color:var(--danger)">
                    <div class="card-header">
                        <span class="card-title" style="color:var(--danger)">EMERGENCY LOCKDOWN</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="lockSwitch" onchange="toggleLock()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p style="font-size:13px; color:#94a3b8">Turn ON to instantly block all POS access. Staff will see "Maintenance Mode".</p>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">Scrolling Notice</span></div>
                    <div style="display:flex; gap:10px">
                        <input id="noticeInput" placeholder="Message for staff...">
                        <button class="btn btn-primary" onclick="updateNotice()">Send</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">Data Management</span></div>
                <div style="display:flex; gap:15px; flex-wrap:wrap">
                    <button class="btn btn-success" onclick="backupData()"><i class="fa-solid fa-download"></i> Full Backup (JSON)</button>
                    <button class="btn btn-danger" onclick="wipeData('entries')"><i class="fa-solid fa-trash"></i> Clear Sales History</button>
                    <button class="btn btn-danger" onclick="wipeData('logs')"><i class="fa-solid fa-trash"></i> Clear Logs</button>
                </div>
            </div>
        </div>

        <!-- 7. UI BUILDER (NEW v7 FEATURE) -->
        <div id="ui_builder" class="view-section">
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸŽ¨ POS Interface Customizer</span></div>
                
                <h4 style="margin-bottom:10px; color:var(--primary)">1. Theme & Fonts</h4>
                <div class="ui-row">
                    <div><label>Primary Color</label><input type="color" id="themePrimary" value="#4f46e5" class="color-picker"></div>
                    <div><label>BG Gradient Start</label><input type="color" id="themeBg1" value="#0f172a" class="color-picker"></div>
                    <div><label>BG Gradient End</label><input type="color" id="themeBg2" value="#172554" class="color-picker"></div>
                    <div style="flex:1"><label>Font Family (Google Fonts)</label><input id="themeFont" placeholder="e.g. Poppins, Hind Siliguri"></div>
                </div>

                <h4 style="margin-bottom:10px; color:var(--warning)">2. Sound Effects</h4>
                <div class="ui-row">
                    <label><input type="checkbox" id="sndSale"> Sale Success Sound</label>
                    <label><input type="checkbox" id="sndError"> Error/Warning Sound</label>
                    <label><input type="checkbox" id="sndMsg"> Chat Message Sound</label>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <h4 style="margin:0; color:var(--success)">3. Sidebar Menu Builder</h4>
                    <button class="btn btn-success" onclick="addSidebarItem()">+ Add Menu Item</button>
                </div>
                <div id="sidebarListContainer" style="margin-bottom:20px"></div>
                
                <button class="btn btn-primary" style="width:100%; padding:15px; font-size:16px" onclick="saveUISettings()">ðŸ’¾ PUBLISH CHANGES TO POS</button>
            </div>
        </div>

    </div>
</div>

<!-- MODALS -->

<!-- PRODUCT MODAL -->
<div id="prodModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><span class="modal-title">Product Details</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('prodModal')"></i></div>
        <input type="hidden" id="pKey">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
            <input id="pName" placeholder="Product Name" style="grid-column: span 2">
            <input id="pCat" placeholder="Category">
            <input id="pType" placeholder="Section (Computer/General)">
            <input id="pCost" type="number" placeholder="Cost Price">
            <input id="pSell" type="number" placeholder="Sell Price">
            <input id="pQty" type="number" placeholder="Stock Qty">
            <input id="pAlert" type="number" placeholder="Alert Level">
        </div>
        <div style="margin-top:20px; text-align:right">
            <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
        </div>
    </div>
</div>

<!-- BULK ACTION MODAL -->
<div id="bulkModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><span class="modal-title">Bulk Operations</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('bulkModal')"></i></div>
        <div class="form-group" style="margin-bottom:15px">
            <label>Action Type</label>
            <select id="bulkType">
                <option value="price_inc">Increase Price (%)</option>
                <option value="price_dec">Decrease Price (%)</option>
                <option value="cat_rename">Rename Category</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom:15px">
            <input id="bulkVal1" placeholder="Percentage / Old Category Name">
        </div>
        <div class="form-group" style="margin-bottom:15px">
            <input id="bulkVal2" placeholder="New Category Name (If renaming)">
        </div>
        <button class="btn btn-warning" style="width:100%" onclick="executeBulk()">EXECUTE</button>
    </div>
</div>

<!-- USER MODAL -->
<div id="userModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><span class="modal-title">User Details</span><i class="fa-solid fa-xmark close-modal" onclick="closeModal('userModal')"></i></div>
        <input type="hidden" id="uKey">
        <input id="uName" placeholder="Username (small letters)" style="margin-bottom:10px">
        <input id="uPass" placeholder="Password" style="margin-bottom:10px">
        <select id="uRole" style="margin-bottom:20px">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
        </select>
        <button class="btn btn-primary" style="width:100%" onclick="saveUser()">Save User</button>
    </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- GLOBAL STATE ---
let products = [];
let entries = [];
let users = {};
let customers = [];
let chartInstance = null;
let isDeadStockView = false;
let sidebarItems = []; // For UI Builder

// --- AUTHENTICATION ---
function authenticate() {
    const key = document.getElementById("masterKey").value;
    if(key === "admin123") { // MASTER KEY
        document.getElementById("authGate").style.display = "none";
        initApp();
    } else {
        alert("âŒ Access Denied");
    }
}

function initApp() {
    loadData();
    setupListeners();
}

function setupListeners() {
    // Allow Enter key to login
    document.getElementById("masterKey").addEventListener("keypress", function(event) {
        if (event.key === "Enter") authenticate();
    });
}

function loadData() {
    // Load Products
    db.ref("products").on("value", s => {
        products = [];
        s.forEach(c => { let p = c.val(); p.key = c.key; products.push(p); });
        renderInventory();
        updateDashboard();
    });

    // Load Entries
    db.ref("entries").on("value", s => {
        entries = [];
        s.forEach(c => { let e = c.val(); e.key = c.key; entries.push(e); });
        updateDashboard();
        renderChart();
        renderCustomers(); // Update CRM when entries change
    });

    // Load Users
    db.ref("users").on("value", s => {
        users = s.val() || {};
        renderUsers();
    });

    // Load Customers
    db.ref("customers").on("value", s => {
        customers = [];
        s.forEach(c => { let cust = c.val(); cust.key = c.key; customers.push(cust); });
        renderCustomers();
    });

    // Load Settings (Lock & UI)
    db.ref("settings/appLock").on("value", s => {
        document.getElementById("lockSwitch").checked = s.val() || false;
    });

    // Load UI Settings for Builder
    db.ref("settings/ui").on("value", s => {
        const data = s.val() || {};
        if(data.theme) {
            document.getElementById("themePrimary").value = data.theme.primary;
            document.getElementById("themeBg1").value = data.theme.bg1;
            document.getElementById("themeBg2").value = data.theme.bg2;
            document.getElementById("themeFont").value = data.theme.font;
        }
        if(data.sounds) {
            document.getElementById("sndSale").checked = data.sounds.sale;
            document.getElementById("sndError").checked = data.sounds.error;
            document.getElementById("sndMsg").checked = data.sounds.msg;
        }
        sidebarItems = data.sidebar || [];
        renderSidebarEditor();
    });
}

// --- NAVIGATION ---
function showView(id) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
    
    // Mobile Sidebar Close
    if(window.innerWidth < 768) document.getElementById("sidebar").classList.remove("active");
}

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("active");
}

// --- DASHBOARD LOGIC ---
function updateDashboard() {
    const today = new Date().toLocaleDateString("en-GB");
    let todaySale = 0, totalProfit = 0, lowStock = 0;

    entries.forEach(e => {
        if(e.date === today) todaySale += parseFloat(e.total) || 0;
        
        // Profit Calc (Approx)
        if(e.items) {
            e.items.forEach(i => {
                const cost = (parseFloat(i.cost) || 0) * i.qty;
                const sell = i.sub;
                totalProfit += (sell - cost);
            });
        }
    });

    products.forEach(p => {
        if(!p.isService && p.qty <= (p.alertLevel || 5)) lowStock++;
    });

    document.getElementById("dSale").innerText = "à§³" + todaySale.toLocaleString();
    document.getElementById("dProfit").innerText = "à§³" + totalProfit.toLocaleString();
    document.getElementById("dLow").innerText = lowStock;
    document.getElementById("dUser").innerText = Object.keys(users).length;
}

function renderChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const labels = [];
    const data = [];
    
    for(let i=6; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString("en-GB");
        labels.push(dateStr.slice(0,5));
        const dayTotal = entries.filter(e => e.date === dateStr).reduce((sum, e) => sum + (+e.total || 0), 0);
        data.push(dayTotal);
    }

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales',
                data: data,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

// --- INVENTORY LOGIC ---
function renderInventory() {
    const q = document.getElementById("invSearch").value.toLowerCase();
    const tbody = document.getElementById("invTable");
    tbody.innerHTML = "";
    
    let displayProducts = products;

    // Dead Stock Logic: Filter products not sold in last 30 days
    if(isDeadStockView) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const soldProductKeys = new Set();
        entries.forEach(e => {
            // Parse date dd/mm/yyyy
            const parts = e.date.split('/');
            const entryDate = new Date(parts[2], parts[1]-1, parts[0]);
            
            if(entryDate >= thirtyDaysAgo && e.items) {
                e.items.forEach(i => soldProductKeys.add(i.key));
            }
        });
        
        displayProducts = products.filter(p => !soldProductKeys.has(p.key) && !p.isService);
    }

    displayProducts.filter(p => p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q)).forEach(p => {
        const stockStatus = (!p.isService && p.qty <= (p.alertLevel||5)) 
            ? `<span class="badge badge-danger">Low</span>` 
            : `<span class="badge badge-success">OK</span>`;
            
        tbody.innerHTML += `
        <tr>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.isService ? 'Service' : p.qty}</td>
            <td>${p.costPrice}</td>
            <td>${p.sellPrice}</td>
            <td>${stockStatus}</td>
            <td>
                <button class="btn btn-primary" style="padding:5px" onclick="editProduct('${p.key}')"><i class="fa-solid fa-pen"></i></button>
                <button class="btn btn-danger" style="padding:5px" onclick="deleteProduct('${p.key}')"><i class="fa-solid fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

function toggleDeadStock() {
    isDeadStockView = !isDeadStockView;
    const btn = document.querySelector("button[onclick='toggleDeadStock()']");
    if(isDeadStockView) {
        btn.innerHTML = '<i class="fa-solid fa-list"></i> Show All';
        btn.classList.remove('btn-dark');
        btn.classList.add('btn-danger');
    } else {
        btn.innerHTML = '<i class="fa-solid fa-skull"></i> Dead Stock';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-dark');
    }
    renderInventory();
}

function openProductModal() {
    document.getElementById("pKey").value = "";
    document.getElementById("pName").value = "";
    document.getElementById("pCat").value = "";
    document.getElementById("pType").value = "";
    document.getElementById("pCost").value = "";
    document.getElementById("pSell").value = "";
    document.getElementById("pQty").value = "";
    document.getElementById("pAlert").value = "";
    document.getElementById("prodModal").style.display = "flex";
}

function editProduct(key) {
    const p = products.find(x => x.key === key);
    document.getElementById("pKey").value = key;
    document.getElementById("pName").value = p.name;
    document.getElementById("pCat").value = p.category;
    document.getElementById("pType").value = p.mainType;
    document.getElementById("pCost").value = p.costPrice;
    document.getElementById("pSell").value = p.sellPrice;
    document.getElementById("pQty").value = p.qty;
    document.getElementById("pAlert").value = p.alertLevel;
    document.getElementById("prodModal").style.display = "flex";
}

function saveProduct() {
    const key = document.getElementById("pKey").value;
    const data = {
        name: document.getElementById("pName").value,
        category: document.getElementById("pCat").value,
        mainType: document.getElementById("pType").value,
        costPrice: parseFloat(document.getElementById("pCost").value) || 0,
        sellPrice: parseFloat(document.getElementById("pSell").value) || 0,
        qty: parseFloat(document.getElementById("pQty").value) || 0,
        alertLevel: parseFloat(document.getElementById("pAlert").value) || 5,
        isService: false // Simplified for admin
    };

    if(key) db.ref("products/" + key).update(data);
    else db.ref("products").push(data);
    
    closeModal('prodModal');
}

function deleteProduct(key) {
    if(confirm("Delete this product permanently?")) db.ref("products/" + key).remove();
}

// --- BULK OPERATIONS ---
function openBulkModal() { document.getElementById("bulkModal").style.display = "flex"; }

function executeBulk() {
    const type = document.getElementById("bulkType").value;
    const val1 = document.getElementById("bulkVal1").value;
    const val2 = document.getElementById("bulkVal2").value;

    if(!confirm("Are you sure? This affects ALL products!")) return;

    if(type === 'price_inc' || type === 'price_dec') {
        const pct = parseFloat(val1);
        if(!pct) return alert("Invalid Percentage");
        
        products.forEach(p => {
            let newPrice = p.sellPrice;
            if(type === 'price_inc') newPrice += (p.sellPrice * (pct/100));
            else newPrice -= (p.sellPrice * (pct/100));
            db.ref("products/" + p.key).update({ sellPrice: Math.round(newPrice) });
        });
    } 
    else if (type === 'cat_rename') {
        if(!val1 || !val2) return alert("Enter Old and New Category Name");
        products.forEach(p => {
            if(p.category === val1) {
                db.ref("products/" + p.key).update({ category: val2 });
            }
        });
    }
    alert("Bulk Operation Completed!");
    closeModal('bulkModal');
}

// --- SALES & INVOICE ---
function searchInvoice() {
    const q = document.getElementById("saleSearch").value.trim().toLowerCase();
    const resDiv = document.getElementById("invoiceResult");
    resDiv.innerHTML = "";

    const found = entries.find(e => 
        (e.memoId && String(e.memoId) === q) || 
        (e.note && e.note.toLowerCase().includes(q)) ||
        (e.phone && e.phone.includes(q))
    );

    if(found) {
        resDiv.innerHTML = `
        <div class="card" style="border-color:var(--primary)">
            <div class="card-header"><span class="card-title">Invoice Found</span></div>
            <p><b>Memo:</b> ${found.memoId || 'N/A'}</p>
            <p><b>Customer:</b> ${found.note}</p>
            <p><b>Date:</b> ${found.date} (${found.time})</p>
            <p><b>Total:</b> à§³${found.total} | <b>Paid:</b> à§³${found.taken}</p>
            <div style="margin-top:15px; display:flex; gap:10px">
                <button class="btn btn-danger" onclick="deleteInvoice('${found.key}')">Delete Invoice</button>
                <button class="btn btn-dark" onclick="editInvoiceNote('${found.key}')">Edit Note</button>
            </div>
        </div>`;
    } else {
        resDiv.innerHTML = `<p style="color:var(--danger)">No invoice found!</p>`;
    }
}

function deleteInvoice(key) {
    if(confirm("Delete Invoice? Stock will NOT be restored automatically to prevent errors.")) {
        db.ref("entries/" + key).remove();
        document.getElementById("invoiceResult").innerHTML = "";
        alert("Deleted.");
    }
}

function editInvoiceNote(key) {
    const newNote = prompt("Enter new Customer Name/Note:");
    if(newNote) db.ref("entries/" + key).update({ note: newNote });
}

// --- CUSTOMER CRM (UPDATED) ---
function renderCustomers() {
    const q = document.getElementById("custSearch").value.toLowerCase();
    const tbody = document.getElementById("custTable");
    tbody.innerHTML = "";

    // Calculate Stats dynamically from entries
    let custStats = {};
    
    // Initialize from saved customers
    customers.forEach(c => {
        custStats[c.phone || c.name] = { name: c.name, phone: c.phone, total: 0, due: 0, key: c.key };
    });

    // Aggregate from entries
    entries.forEach(e => {
        const key = e.phone || e.note;
        if(!custStats[key]) custStats[key] = { name: e.note, phone: e.phone || "N/A", total: 0, due: 0 };
        
        custStats[key].total += parseFloat(e.total) || 0;
        custStats[key].due += parseFloat(e.loss) || 0;
    });

    Object.values(custStats).filter(c => c.name.toLowerCase().includes(q) || (c.phone && c.phone.includes(q))).forEach(c => {
        tbody.innerHTML += `
        <tr>
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>à§³${c.total.toLocaleString()}</td>
            <td style="color:${c.due > 0 ? 'var(--danger)' : 'var(--success)'}">à§³${c.due.toLocaleString()}</td>
            <td><button class="btn btn-danger" style="padding:2px 5px" onclick="deleteCustomer('${c.key}')">X</button></td>
        </tr>`;
    });
}

function deleteCustomer(key) {
    if(key && confirm("Remove customer from saved list? (History remains)")) {
        db.ref("customers/" + key).remove();
    }
}

// --- USER MANAGEMENT ---
function renderUsers() {
    const grid = document.getElementById("userGrid");
    grid.innerHTML = "";
    
    Object.keys(users).forEach(key => {
        const u = users[key];
        const isBlocked = u.blocked;
        grid.innerHTML += `
        <div class="card" style="opacity:${isBlocked ? 0.6 : 1}">
            <div class="card-header">
                <span class="card-title">${key.toUpperCase()}</span>
                <span class="badge ${isBlocked ? 'badge-danger' : 'badge-success'}">${isBlocked ? 'BLOCKED' : 'ACTIVE'}</span>
            </div>
            <p style="font-size:13px; color:#94a3b8">Role: ${u.role}</p>
            <p style="font-size:13px; color:#94a3b8; font-family:monospace">Pass: ${u.pass}</p>
            <div style="margin-top:15px; display:flex; gap:5px">
                <button class="btn btn-primary" style="flex:1; padding:5px" onclick="editUser('${key}')">Edit</button>
                <button class="btn ${isBlocked ? 'btn-success' : 'btn-danger'}" style="flex:1; padding:5px" onclick="toggleBlock('${key}', ${isBlocked})">
                    ${isBlocked ? 'Unban' : 'Ban'}
                </button>
            </div>
        </div>`;
    });
}

function openUserModal() {
    document.getElementById("uKey").value = "";
    document.getElementById("uName").value = "";
    document.getElementById("uName").disabled = false;
    document.getElementById("uPass").value = "";
    document.getElementById("userModal").style.display = "flex";
}

function editUser(key) {
    const u = users[key];
    document.getElementById("uKey").value = key;
    document.getElementById("uName").value = key;
    document.getElementById("uName").disabled = true;
    document.getElementById("uPass").value = u.pass;
    document.getElementById("uRole").value = u.role;
    document.getElementById("userModal").style.display = "flex";
}

function saveUser() {
    const key = document.getElementById("uKey").value;
    const user = document.getElementById("uName").value.toLowerCase().trim();
    const pass = document.getElementById("uPass").value;
    const role = document.getElementById("uRole").value;

    if(!user || !pass) return alert("Fill all fields");

    if(key) db.ref("users/" + key).update({ pass, role });
    else db.ref("users/" + user).set({ pass, role, blocked: false });
    
    closeModal('userModal');
}

function toggleBlock(key, status) {
    if(key === 'admin' || key === 'owner') return alert("Cannot block Admin/Owner");
    db.ref("users/" + key).update({ blocked: !status });
}

// --- SYSTEM CONTROL ---
function toggleLock() {
    const status = document.getElementById("lockSwitch").checked;
    db.ref("settings/appLock").set(status);
    if(status) updateNotice("âš ï¸ SYSTEM MAINTENANCE IN PROGRESS");
    else updateNotice("");
}

function updateNotice(msg) {
    const txt = msg || document.getElementById("noticeInput").value;
    db.ref("settings/notice").set(txt);
    if(!msg) alert("Notice Sent!");
}

function backupData() {
    const backup = { products, entries, users, customers };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", "Full_Backup_" + new Date().toISOString() + ".json");
    document.body.appendChild(dlAnchorElem);
    dlAnchorElem.click();
    dlAnchorElem.remove();
}

function wipeData(node) {
    if(confirm(`âš ï¸ DANGER: Wipe all ${node}? This cannot be undone!`)) {
        db.ref(node).remove();
        alert("Wiped.");
    }
}

// --- UI BUILDER LOGIC (NEW v7) ---
function renderSidebarEditor() {
    const div = document.getElementById("sidebarListContainer");
    div.innerHTML = "";
    sidebarItems.forEach((item, index) => {
        div.innerHTML += `
        <div class="sidebar-item-row">
            <span style="font-weight:bold; color:#94a3b8; width:20px">${index+1}.</span>
            <input value="${item.label}" placeholder="Label" style="flex:1; margin:0" onchange="updateItem(${index}, 'label', this.value)">
            <input value="${item.action}" placeholder="Action (JS)" style="flex:1; margin:0" onchange="updateItem(${index}, 'action', this.value)">
            <input type="color" value="${item.color || '#ffffff'}" class="color-picker" onchange="updateItem(${index}, 'color', this.value)">
            <button class="btn btn-danger" style="padding:5px 10px" onclick="deleteItem(${index})">X</button>
        </div>`;
    });
}

function addSidebarItem() {
    sidebarItems.push({ label: "New Menu", action: "showSection('dashboard')", color: "#ffffff" });
    renderSidebarEditor();
}

function updateItem(index, key, val) {
    sidebarItems[index][key] = val;
}

function deleteItem(index) {
    sidebarItems.splice(index, 1);
    renderSidebarEditor();
}

function saveUISettings() {
    const settings = {
        theme: {
            primary: document.getElementById("themePrimary").value,
            bg1: document.getElementById("themeBg1").value,
            bg2: document.getElementById("themeBg2").value,
            font: document.getElementById("themeFont").value
        },
        sounds: {
            sale: document.getElementById("sndSale").checked,
            error: document.getElementById("sndError").checked,
            msg: document.getElementById("sndMsg").checked
        },
        sidebar: sidebarItems
    };

    db.ref("settings/ui").set(settings).then(() => {
        alert("âœ… UI Settings Updated! POS will update instantly.");
    });
}

// --- UTILS ---
function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>