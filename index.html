<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø - ‡¶™‡ßç‡¶∞‡ßã</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* BASE STYLES */
        *{box-sizing:border-box;font-family:'Hind Siliguri', sans-serif}
        body{margin:0;background:#f4f7f6;color:#2c3e50}
        .en{font-family:Arial, sans-serif}
        
        /* HEADER */
        header{background:#27ae60;color:#fff;padding:15px;text-align:center;font-size:24px;font-weight:bold;display:none;position:fixed;top:0;width:100%;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        
        /* LOGIN */
        #loginDiv{max-width:400px;margin:120px auto;background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center}
        #loginDiv input {margin-bottom: 15px;}
        
        /* MAIN CONTAINER */
        #container{display:none;padding:20px;padding-top:90px;max-width:1250px;margin:auto}
        
        /* FORMS */
        .form-group {margin-bottom: 15px; text-align: left; position: relative;}
        .form-group label {display: block; font-weight: 600; margin-bottom: 5px; color: #34495e; font-size: 14px;}
        
        input,select,button{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;outline:none;transition:0.3s;font-size:15px}
        input:focus, select:focus{border-color:#27ae60; box-shadow: 0 0 5px rgba(39, 174, 96, 0.2);}
        button{background:#27ae60;color:#fff;font-weight:bold;border:none;cursor:pointer;font-size:16px; margin-top:5px;}
        button:hover{background:#219150}
        
        /* DASHBOARD CARDS */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;padding:25px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.05);border-top:5px solid #2ecc71; transition: transform 0.2s}
        .card:hover {transform: translateY(-5px);}
        .card b {font-size: 24px; display: block; margin-top: 5px;}
        
        /* SIDEBAR */
        #menuBtn{position:fixed;top:20px;left:20px;font-size:28px;color:#fff;cursor:pointer;display:none;z-index:1100}
        #sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#ffffff;transition:.3s;z-index:1200;padding-top:20px;box-shadow:5px 0 15px rgba(0,0,0,0.05)}
        #sidebar a{display:block;color:#34495e;text-decoration:none;padding:15px 25px;border-bottom:1px solid #f8f9fa;cursor:pointer;font-weight:600; transition: 0.2s}
        #sidebar a:hover{background:#f0fff4;color:#27ae60; padding-left: 30px;}
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;z-index:1150}
        
        /* SECTIONS & TABLES */
        .section{display:none;animation:fadeIn 0.4s ease-in-out}
        @keyframes fadeIn {from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)}}
        
        .table-box{background:#fff;border-radius:12px;overflow-x:auto;box-shadow:0 4px 10px rgba(0,0,0,0.03); border: 1px solid #eee;}
        table{width:100%;border-collapse:collapse;min-width:700px}
        th,td{padding:12px 15px;border-bottom:1px solid #f0f0f0;text-align:left}
        th{background:#f8f9fa;color:#555;font-weight:700;font-size:14px; text-transform: uppercase; letter-spacing: 0.5px;}
        tr:hover {background-color: #fbfbfb;}
        
        /* ACTION BUTTONS */
        .btn-action{padding:6px 10px; font-size:14px; margin:0 3px; border-radius:5px; width: auto; display: inline-block;}
        .btn-del{background:#ffebee; color:#c0392b; border: 1px solid #ffccd5;}
        .btn-del:hover{background:#c0392b; color: white;}
        .btn-edit{background:#fff8e1; color:#f39c12; border: 1px solid #ffe0b2;}
        .btn-edit:hover{background:#f39c12; color: white;}
        .btn-print{background:#e3f2fd; color:#2980b9; border: 1px solid #bbdefb;}
        .btn-print:hover{background:#2980b9; color: white;}
        
        /* CART & MISC */
        .cart-box {margin-top:20px; border:2px dashed #27ae60; padding:20px;border-radius:12px; background:#f9fff9}
        .cart-item {display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; font-size:15px; align-items: center;}
        
        .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;width:600px; max-width: 95%; padding:30px;z-index:1500;box-shadow:0 10px 40px rgba(0,0,0,0.2);border-radius:15px}
        .user-summary-box { background:#fff; padding:20px; border-radius:12px; margin-bottom:25px; border-left: 5px solid #8e44ad; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .low-stock { background-color: #fff0f0; color: #c0392b; font-weight: bold; }
        .service-badge { background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;}
        
        /* SEARCH RESULTS DROPDOWN */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .search-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-item:hover {
            background-color: #f8f9fa;
        }
        .search-item.active {
            background-color: #e8f5e9;
        }
        .search-item .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
        }
        .search-item .product-details {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
        }
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 2px;
        }
        .no-results {
            padding: 15px;
            text-align: center;
            color: #777;
            font-style: italic;
        }

        /* TEMPORARY MESSAGE */
        .temp-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #2ecc71;
            color: white;
            border-radius: 6px;
            z-index: 2000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* CUSTOMER MANAGEMENT */
        .customer-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #3498db;
        }
        .customer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }
        .due-alert {
            background: #fff0f0;
            border-left: 5px solid #e74c3c;
        }
        .paid-alert {
            background: #f0fff4;
            border-left: 5px solid #27ae60;
        }

        /* VALIDATION STYLES */
        .validation-warning {
            background: #fff8e1;
            border-left: 5px solid #f39c12;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        .validation-error {
            background: #ffebee;
            border-left: 5px solid #e74c3c;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        .validation-success {
            background: #e8f5e9;
            border-left: 5px solid #2ecc71;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        .phone-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        .due-warning {
            color: #e74c3c;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* A4 PRINT CSS - STRICT */
        @media print {
            @page { size: A4; margin: 0.8in; }
            body { margin: 0; padding: 0; background: white; font-family: 'Times New Roman', serif; }
            body * { visibility: hidden; }
            
            #memoModal, #memoModal * { visibility: visible !important; }
            #memoModal {
                display: block !important; 
                position: absolute; 
                left: 0; top: 0;
                width: 100% !important;
                margin: 0 !important; 
                padding: 0 !important; 
                transform: none !important; 
                box-shadow: none !important; 
                border: none !important;
                background: transparent !important;
            }
            
            /* Print Specific Typography */
            #memoModal h2 { font-size: 32px !important; margin-bottom: 5px; color: #000 !important; text-align: center; font-family: 'Hind Siliguri', sans-serif;}
            #memoModal p, #memoModal span { color: #000 !important; font-size: 14pt !important; }
            #memoModal .address { font-size: 14px !important; text-align: center; margin-bottom: 30px; }
            
            /* Print Meta Info */
            .memo-meta { display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            
            /* Print Table */
            #memoModal table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14pt; }
            #memoModal th { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #000; padding: 10px; font-weight: bold; text-align: center !important;}
            #memoModal td { border: 1px solid #000; padding: 10px; }
            
            /* Print Totals */
            .memo-total-area { margin-top: 30px; text-align: right; font-size: 16pt !important; }
            
            /* Signature */
            .signature-area { margin-top: 80px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .signature-box { text-align: center; width: 250px; }
            .signature-line { border-top: 1px solid #000; margin-top: 60px; padding-top: 10px; font-size: 14pt; }

            .noPrint { display: none !important; }
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#27ae60; margin-bottom: 20px;">‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ (Admin/Owner/Roky)">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:15px;margin-bottom:10px;border-bottom:2px solid #2ecc71; background: #f0fdf4;" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø / ‡¶∏‡ßá‡¶≤‡¶∏</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</a>
        <a onclick="showSection('customers')">üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
        <a onclick="logout()" style="color:#e74c3c; margin-top:20px; border-top:1px solid #eee;">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>

    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
            <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤ (‡ß≥)<br><b id="cTotal">0</b></div>
            <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡ß≥)<br><b id="cTaken">0</b></div>
            <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cDue">0</b></div>
        </div>

        <div class="user-summary-box">
            <h4 style="margin:0 0 15px 0; color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #eee;">
                <table class="en">
                    <thead><tr><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th><th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th><th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th></tr></thead>
                    <tbody id="userSummaryBody"><tr><td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr></tbody>
                </table>
            </div>
        </div>

        <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05">
            <canvas id="salesChart" height="80"></canvas>
        </div>
        
        <div class="table-box">
            <h4 style="padding:15px; margin:0; background: #f9f9f9; border-bottom: 1px solid #eee;">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
            <table class="en">
                <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="newEntry" class="section">
        <div style="max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05">
            <h3 style="margin-top:0; color:#2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
            
            <div class="form-group" style="background:#e8f5e9; padding:15px; border:1px dashed #27ae60; border-radius:8px">
                <label>üîç ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö (‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®):</label>
                <input id="searchSerial" type="text" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 101 ‡¶Ö‡¶•‡¶¨‡¶æ A4 Paper..." class="en" autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø: <span style="color:red">*</span></label>
                <select id="category" onchange="filterProducts()">
                    <option value="">=== ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡¶ï‡¶æ‡¶ú/‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="work" onchange="autoFillPrice()">
                    <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <div class="form-group"><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label><input id="qty" type="number" value="1" min="1" class="en" onkeydown="if(event.key === 'Enter'){ addToCart(); }"></div>
                <div class="form-group"><label>‡¶¶‡¶∞ (Rate ‡ß≥):</label><input id="rate" type="number" class="en"></div>
            </div>
            
            <button onclick="addToCart()" style="background:#3498db; margin-bottom:20px; padding: 12px;">‚¨áÔ∏è ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add)</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0; border-bottom:1px dashed #aaa; padding-bottom:5px">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                <div id="cartList"></div>
                
                <hr style="border:0; border-top:1px dashed #aaa; margin:15px 0">
                
                <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø -->
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd;">
                    <h4 style="margin-top:0; color:#2c3e50; font-size:16px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div class="form-group">
                            <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ: <span style="color:red">*</span></label>
                            <input id="note" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="checkCustomerName()">
                            <small style="color:#666;" id="nameHelp">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶π‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
                        </div>
                        <div class="form-group">
                            <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
                            <input id="phone" placeholder="017XXXXXXXX" class="en" 
                                   oninput="autoFillCustomerName(this.value)">
                            <small style="color:#666;" id="phoneHelp">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶∏‡¶¨‡ßá</small>
                        </div>
                    </div>
                    <div id="customerValidation" style="margin-top:10px;"></div>
                </div>
                
                <!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø -->
                <div style="background: #f0f0f0; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-top:0; color:#2c3e50; font-size:16px;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (Total):</label><input id="total" readonly class="en" value="0" style="background:#fff; font-weight:bold"></div>
                        <div class="form-group">
                            <label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (Paid):</label>
                            <input id="taken" type="number" class="en" oninput="validatePayment()">
                            <small style="color:#666;">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="color:#e74c3c">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</label>
                        <input id="due" readonly class="en" value="0" style="background:#fff; color:#e74c3c; font-weight:bold">
                        <div id="paymentValidation" style="margin-top:5px;"></div>
                    </div>
                </div>

                <!-- ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ -->
                <div id="finalWarning" style="display:none; margin-top:15px;"></div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                    <button onclick="validateAndSave(false)" style="background:#f39c12">üíæ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="validateAndSave(true)" style="background:#2ecc71">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory" class="section">
        <div style="max-width:900px;margin:auto;background:#fff;padding:30px;border-radius:15px">
            <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; color:#2c3e50">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px">
                <div class="form-group"><label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶° (Optional):</label><input id="stSerial" class="en" placeholder="Code/Serial"></div>
                <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><input id="stCategory" placeholder="Paper, Khata, Pen..."></div>
                <div class="form-group"><label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="stName" placeholder="Product Name"></div>
            </div>
            
            <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #90caf9;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="stIsService" style="width:20px; height:20px; margin:0" onchange="toggleStockInput()">
                    <label for="stIsService" style="margin:0; cursor:pointer; font-weight:bold; color:#1565c0">‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø, ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®, ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü)</label>
                </div>
                <small style="color:#555; padding-left:34px; display:block; margin-top:5px;">‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶≤‡ßá '‡¶∏‡ßç‡¶ü‡¶ï' ‡¶è‡¶¨‡¶Ç '‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ' ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</small>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end">
                <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label><input id="stQty" type="number" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (Cost):</label><input id="stCost" type="number" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (Sell):</label><input id="stSell" type="number" class="en" placeholder="0"></div>
                <button onclick="addNewProduct()" style="height:48px; margin-bottom:15px; width: 100px;">+ ‡¶∏‡ßá‡¶≠</button>
            </div>

            <div class="table-box" style="margin-top:25px">
                <table>
                    <thead><tr><th>Serial</th><th>Category</th><th>Name</th><th>Stock</th><th>Sell Price</th><th>Action</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div id="customers" class="section">
        <div style="max-width:1200px; margin:auto;">
            <h3 style="border-bottom:2px solid #3498db; padding-bottom:10px; color:#2c3e50; margin-top:0">üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
            
            <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® -->
            <div style="background:#e8f5e9; padding:20px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin-top:0;">üîç ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®)</h4>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                        <input type="text" id="searchCustomerInput" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 017... ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡¶π‡¶ø‡¶Æ..." style="width:100%;">
                    </div>
                    <button onclick="searchCustomer()" style="width:120px; height:46px; margin-top:20px;">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <small style="color:#666; display:block; margin-top:10px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</small>
            </div>
            
            <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ -->
            <div id="customerDetails" style="display:none; background:#fff; padding:25px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h4 style="margin:0; color:#3498db;" id="customerNameTitle">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:flex; gap:10px;">
                        <button onclick="printCustomerReceipt()" style="background:#3498db; padding:8px 16px; width:auto;">üñ®Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶∂‡¶ø‡¶¶</button>
                        <button onclick="addPayment()" style="background:#2ecc71; padding:8px 16px; width:auto;">üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ</button>
                        <button onclick="clearCustomerSearch()" style="background:#e74c3c; padding:8px 16px; width:auto;">‚úñÔ∏è ‡¶¨‡¶®‡ßç‡¶ß</button>
                    </div>
                </div>
                
                <div id="customerInfo"></div>
            </div>
            
            <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ -->
            <div id="customerHistorySection" style="display:none; margin-bottom:30px;">
                <h4 style="border-bottom:1px solid #eee; padding-bottom:8px;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h4>
                <div class="table-box">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç</th>
                                <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</th>
                                <th>‡¶ú‡¶Æ‡¶æ</th>
                                <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="customerTransactions"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶∏‡¶¨ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ -->
            <div class="table-box">
                <h4 style="padding:15px; margin:0; background:#f9f9f9; border-bottom:1px solid #eee;">‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡¶π)</h4>
                <table>
                    <thead>
                        <tr>
                            <th>‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</th>
                            <th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</th>
                            <th>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                            <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="allCustomers">
                        <tr><td colspan="7" style="text-align:center; padding:20px; color:#777;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="noPrint" style="max-width: 1000px; margin: auto; background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05">
            <h3 style="text-align:center; margin-top:0">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</h3>
            
            <div style="display:flex; gap:10px; margin-bottom: 20px; justify-content: center; background: #f9f9f9; padding: 20px; border-radius: 10px;">
                <input type="date" id="sDate" class="en" style="margin:0; max-width: 200px;">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 25px">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom: 20px;">
                <button onclick="loadReportData()" style="background:#7f8c8d">‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                <button onclick="downloadExcel()" style="background:#2ecc71">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button onclick="window.print()" style="background:#9b59b6;">üñ®Ô∏è ‡¶™‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>
            
            <div class="table-box" style="border:1px solid #ddd">
                <table class="en">
                    <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0; color:#2ecc71; font-weight: 800; font-size: 28px;">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:5px 0 0 0; color:#555">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
    </div>
    
    <div class="memo-meta en" style="margin-top:30px;">
        <div style="text-align:left; float:left; width: 50%;">
            <p style="margin:4px"><strong>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç:</strong> <span id="mId"></span></p>
            <p style="margin:4px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:4px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right; float:right; width: 50%;">
            <p style="margin:4px"><strong>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</strong> <span id="mNote"></span></p>
            <p style="margin:4px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
        
    <table style="width:100%; border-collapse:collapse; margin-top:20px">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd; padding:10px; text-align:left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd; padding:10px; text-align:center; width:100px">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                <th style="border:1px solid #ddd; padding:10px; text-align:right; width:150px">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    
    <div class="memo-total-area en" style="margin-top:25px; text-align:right">
        <p style="margin:5px">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥<b id="mTotal"></b></p>
        <p style="margin:5px">‡¶®‡¶ó‡¶¶ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®: ‡ß≥<span id="mPaid"></span></p>
        <p style="margin:5px; font-size: 18px;">‡¶¨‡¶æ‡¶ï‡¶ø (Due): ‡ß≥<b id="mDueDisplay" style="color:red"></b></p>
    </div>
    
    <div class="signature-area" style="margin-top: 80px; display: flex; justify-content: space-between;">
        <div class="signature-box" style="text-align:center; width:200px">
            <p class="signature-line" style="border-top:1px solid #000; padding-top:10px; margin-top:40px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
        <div class="signature-box" style="text-align:center; width:200px">
            <p style="margin:0; font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000; padding-top:10px; margin-top:5px">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    
    <div style="margin-top:40px; text-align:center; border-top:1px dashed #ccc; padding-top:20px" class="noPrint">
        <button onclick="window.print()" style="width:auto; padding:10px 30px; font-size: 16px;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (A4)</button>
        <button onclick="closeModal('memoModal')" style="background:#e74c3c; width:auto; padding:10px 30px; font-size: 16px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="editModal" class="modal" style="width:400px">
    <h3 style="margin-top:0; color:#f39c12">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="editNote"></div>
    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label><input id="editPhone" class="en"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="editTotal" type="number" class="en"></div>
        <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£:</label><input id="editTaken" type="number" class="en"></div>
    </div>
    <button onclick="updateEntry()" style="background:#f39c12; margin-top:15px">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button onclick="closeModal('editModal')" style="background:#e74c3c">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
</div>

<!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ -->
<div id="paymentModal" class="modal" style="width:450px">
    <h3 style="margin-top:0; color:#2ecc71">üíµ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</h3>
    <div class="form-group">
        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="payCustomerName" readonly style="background:#f5f5f5">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
        <input id="payCustomerPhone" readonly style="background:#f5f5f5">
    </div>
    <div class="form-group">
        <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø:</label>
        <input id="payCurrentDue" readonly style="background:#f5f5f5; color:#e74c3c; font-weight:bold">
    </div>
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
        <input id="payAmount" type="number" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="en">
    </div>
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
        <input id="payDate" type="date" class="en" value="">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
        <input id="payComment" placeholder="‡¶â‡¶¶‡¶æ: ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø">
    </div>
    <div style="display:flex; gap:10px; margin-top:20px">
        <button onclick="processPayment()" style="background:#2ecc71; flex:1">üíæ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal('paymentModal')" style="background:#e74c3c; width:100px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE VARIABLES ---
let currentUser = "";
let allProducts = [];
let cart = [];
let salesChart = null;
let searchResultsDiv = null;
let searchTimer = null;
let selectedSearchIndex = -1;
let currentCustomerData = null;
let customerCache = {}; // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá
let existingCustomers = {}; // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï

// --- SEARCH FUNCTIONALITY ---
function setupSearchFunctionality() {
    const searchInput = document.getElementById('searchSerial');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();
        
        if (!query) {
            hideSearchResults();
            return;
        }
        
        searchTimer = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    searchInput.addEventListener('keydown', function(e) {
        const results = searchResultsDiv.querySelectorAll('.search-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (selectedSearchIndex < results.length - 1) {
                selectedSearchIndex++;
                updateSearchSelection();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (selectedSearchIndex > 0) {
                selectedSearchIndex--;
                updateSearchSelection();
            }
        } else if (e.key === 'Enter' && selectedSearchIndex >= 0) {
            e.preventDefault();
            const selectedItem = results[selectedSearchIndex];
            if (selectedItem) {
                const productKey = selectedItem.getAttribute('data-key');
                selectProductFromSearch(productKey);
            }
        } else if (e.key === 'Escape') {
            hideSearchResults();
        }
    });
    
    // ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
    document.addEventListener('click', function(e) {
        if (!searchResultsDiv.contains(e.target) && e.target !== searchInput) {
            hideSearchResults();
        }
    });
}

function performSearch(query) {
    if (!query) {
        hideSearchResults();
        return;
    }
    
    const lowerQuery = query.toLowerCase();
    const results = [];
    
    allProducts.forEach(product => {
        let score = 0;
        let matchText = '';
        
        // ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö
        if (product.serial && product.serial.toLowerCase().includes(lowerQuery)) {
            score += 10;
            matchText = product.serial;
        }
        
        // ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö
        if (product.name && product.name.toLowerCase().includes(lowerQuery)) {
            score += 5;
            matchText = product.name;
        }
        
        // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö
        if (product.category && product.category.toLowerCase().includes(lowerQuery)) {
            score += 3;
        }
        
        if (score > 0) {
            results.push({
                product: product,
                score: score,
                matchText: matchText
            });
        }
    });
    
    // ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®
    results.sort((a, b) => b.score - a.score);
    
    displaySearchResults(results, query);
}

function displaySearchResults(results, query) {
    searchResultsDiv.innerHTML = '';
    
    if (results.length === 0) {
        searchResultsDiv.innerHTML = '<div class="no-results">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</div>';
        searchResultsDiv.style.display = 'block';
        return;
    }
    
    const limitedResults = results.slice(0, 10);
    
    limitedResults.forEach(result => {
        const product = result.product;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'search-item';
        itemDiv.setAttribute('data-key', product.key);
        
        const name = highlightMatch(product.name, query);
        const serial = product.serial ? `<span style="color:#27ae60; font-weight:bold">${product.serial}</span>` : '';
        const stockInfo = product.isService ? 
            '<span class="service-badge">Service</span>' : 
            `<span style="color:${product.qty < 5 ? '#e74c3c' : '#27ae60'}">‡¶∏‡ßç‡¶ü‡¶ï: ${product.qty}</span>`;
        
        itemDiv.innerHTML = `
            <div class="product-name">${serial} ${name}</div>
            <div class="product-details">
                <span>${product.category}</span>
                <span>${stockInfo} | ‡ß≥${product.sellPrice}</span>
            </div>
        `;
        
        itemDiv.addEventListener('click', () => {
            selectProductFromSearch(product.key);
        });
        
        itemDiv.addEventListener('mouseenter', () => {
            const allItems = searchResultsDiv.querySelectorAll('.search-item');
            allItems.forEach(item => item.classList.remove('active'));
            itemDiv.classList.add('active');
            selectedSearchIndex = Array.from(allItems).indexOf(itemDiv);
        });
        
        searchResultsDiv.appendChild(itemDiv);
    });
    
    searchResultsDiv.style.display = 'block';
    selectedSearchIndex = -1;
}

function highlightMatch(text, query) {
    if (!query || !text) return text;
    
    const lowerText = text.toLowerCase();
    const lowerQuery = query.toLowerCase();
    const index = lowerText.indexOf(lowerQuery);
    
    if (index === -1) return text;
    
    const before = text.substring(0, index);
    const match = text.substring(index, index + query.length);
    const after = text.substring(index + query.length);
    
    return `${before}<span class="highlight">${match}</span>${after}`;
}

function hideSearchResults() {
    searchResultsDiv.style.display = 'none';
    selectedSearchIndex = -1;
}

function updateSearchSelection() {
    const results = searchResultsDiv.querySelectorAll('.search-item');
    results.forEach(item => item.classList.remove('active'));
    
    if (selectedSearchIndex >= 0 && selectedSearchIndex < results.length) {
        results[selectedSearchIndex].classList.add('active');
        results[selectedSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function selectProductFromSearch(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if (!product) return;
    
    const catSelect = document.getElementById("category");
    if (catSelect.value === "") {
        if (confirm(`"${product.name}" ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ${product.category} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            catSelect.value = product.category;
        } else {
            hideSearchResults();
            return;
        }
    } else if (catSelect.value !== product.category) {
        if (!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø "${catSelect.options[catSelect.selectedIndex].text}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®,\n‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${product.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            hideSearchResults();
            return;
        }
        catSelect.value = product.category;
    }
    
    setTimeout(() => {
        filterProducts().then(() => {
            const workSelect = document.getElementById("work");
            
            for(let i = 0; i < workSelect.options.length; i++) {
                if(workSelect.options[i].value === product.key) {
                    workSelect.selectedIndex = i;
                    
                    document.getElementById("rate").value = product.sellPrice;
                    document.getElementById("qty").value = 1;
                    
                    setTimeout(() => {
                        document.getElementById("qty").focus();
                        document.getElementById("qty").select();
                    }, 50);
                    
                    showTempMessage(`${product.serial ? product.serial + ' - ' : ''}${product.name} ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
                    
                    document.getElementById("searchSerial").value = "";
                    hideSearchResults();
                    break;
                }
            }
        });
    }, 100);
}

// --- INITIALIZATION ---
window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
    
    searchResultsDiv = document.getElementById("searchResults");
    setupSearchFunctionality();
    
    // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤‡ßá
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    
    // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
    loadExistingCustomers();
};

// ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡ßã‡¶°
function loadExistingCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        existingCustomers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            const name = entry.note;
            
            if (phone && name && name !== "General Customer") {
                existingCustomers[phone] = name;
                customerCache[phone] = name;
            }
        });
        
        console.log("Loaded", Object.keys(existingCustomers).length, "existing customers");
    });
}

// --- AUTHENTICATION ---
function login(){
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();
    const users = {admin:"123", owner:"456", roky:"789"};
    
    if(users[u] === p){ 
        localStorage.setItem("loggedInUser", u); 
        setupUser(u); 
    } else { 
        alert("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); 
    }
}

function setupUser(u) {
    currentUser = u; 
    document.getElementById("loginDiv").style.display = "none"; 
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "block"; 
    document.getElementById("menuBtn").style.display = "block";
    
    const userRole = u === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : (u === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
    document.getElementById("userShow").innerHTML = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <b style="text-transform:uppercase">${u}</b> (${userRole})`;
    
    loadAllProducts(); 
    loadEntries(); 
    showSection('dashboard');
    loadAllCustomers();
}

function logout() { 
    localStorage.removeItem("loggedInUser"); 
    location.reload(); 
}

// --- CUSTOMER AUTO-FILL SYSTEM ---
function autoFillCustomerName(phoneInput) {
    const phone = phoneInput.trim();
    const noteInput = document.getElementById("note");
    const validationDiv = document.getElementById("customerValidation");
    
    if (!phone || phone.length < 7) {
        validationDiv.innerHTML = "";
        return;
    }
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)
    const cleanPhone = phone.replace(/\D/g, '');
    
    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
    if (customerCache[cleanPhone]) {
        noteInput.value = customerCache[cleanPhone];
        showValidationMessage("‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: " + customerCache[cleanPhone], "success");
        return;
    }
    
    // Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        let foundName = "";
        let foundCount = 0;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone && entry.phone.includes(cleanPhone) && entry.note && entry.note !== "General Customer") {
                foundName = entry.note;
                foundCount++;
            }
        });
        
        if (foundName) {
            customerCache[cleanPhone] = foundName;
            noteInput.value = foundName;
            showValidationMessage(`‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (${foundCount} ‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ): ${foundName}`, "success");
        } else {
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï
            showValidationMessage("üÜï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï, ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®", "warning");
            noteInput.focus();
        }
    });
}

function checkCustomerName() {
    const name = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const validationDiv = document.getElementById("customerValidation");
    
    if (!name) {
        validationDiv.innerHTML = "";
        return;
    }
    
    if (phone && phone.length >= 7) {
        const cleanPhone = phone.replace(/\D/g, '');
        customerCache[cleanPhone] = name;
        showValidationMessage("‚úÖ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
    } else {
        showValidationMessage("üì± ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶™‡¶∞‡ßá ‡¶∏‡¶π‡¶ú‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®", "warning");
    }
}

function showValidationMessage(message, type) {
    const validationDiv = document.getElementById("customerValidation");
    validationDiv.innerHTML = `<div class="validation-${type}">${message}</div>`;
}

// --- PAYMENT VALIDATION ---
function validatePayment() {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const validationDiv = document.getElementById("paymentValidation");
    const finalWarning = document.getElementById("finalWarning");
    
    document.getElementById("due").value = due;
    
    // ‡¶™‡¶∞‡¶ø‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    validationDiv.innerHTML = "";
    finalWarning.innerHTML = "";
    finalWarning.style.display = "none";
    
    if (due === 0) {
        validationDiv.innerHTML = `<div class="validation-success">‚úÖ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶π‡ßü‡ßá‡¶õ‡ßá</div>`;
    } else if (due > 0) {
        validationDiv.innerHTML = `<div class="validation-warning">‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due}</div>`;
    } else if (due < 0) {
        validationDiv.innerHTML = `<div class="validation-error">‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due}</div>`;
    }
    
    // ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ
    if (due > 0 && taken === 0) {
        validationDiv.innerHTML = `<div class="validation-error due-warning">üö® ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due}</div>`;
    }
}

// --- FINAL VALIDATION BEFORE SAVE ---
function validateAndSave(showMemoFlag) {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const note = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const finalWarning = document.getElementById("finalWarning");
    
    let warnings = [];
    let errors = [];
    
    // ‡¶®‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï
    if (!note || note === "") {
        errors.push("‚ùå ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");
    }
    
    // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ö‡ßá‡¶ï
    if (taken === 0 && due > 0) {
        errors.push("üö® ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø!");
    }
    
    if (due < 0) {
        errors.push("‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá!");
    }
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
    if (phone) {
        const cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.length < 7) {
            warnings.push("üì± ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß≠ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)");
        }
        
        // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® ‡¶ö‡ßá‡¶ï
        if (existingCustomers[cleanPhone] && existingCustomers[cleanPhone] !== note) {
            warnings.push(`üìû ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞: ${existingCustomers[cleanPhone]}`);
        }
    }
    
    // ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ
    if (due > 0) {
        if (!phone || phone === "") {
            errors.push("üö® ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®)");
        }
        
        warnings.push(`‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due}`);
    }
    
    // ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    if (errors.length > 0 || warnings.length > 0) {
        let warningHTML = "";
        
        if (errors.length > 0) {
            warningHTML += `<div class="validation-error" style="margin-bottom:10px;">
                <strong>‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:</strong><br>${errors.join('<br>')}
            </div>`;
        }
        
        if (warnings.length > 0) {
            warningHTML += `<div class="validation-warning">
                <strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong><br>${warnings.join('<br>')}
            </div>`;
        }
        
        finalWarning.innerHTML = warningHTML;
        finalWarning.style.display = "block";
        
        // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã error ‡¶•‡¶æ‡¶ï‡ßá
        if (errors.length > 0) {
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            let errorMessage = "‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶Ü‡¶õ‡ßá:\n\n" + errors.join('\n') + "\n\n";
            
            if (warnings.length > 0) {
                errorMessage += "‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:\n" + warnings.join('\n') + "\n\n";
            }
            
            errorMessage += "‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?";
            
            if (!confirm(errorMessage)) {
                return; // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶¨‡¶≤‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ
            }
        }
    }
    
    // ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    saveBulkEntry(showMemoFlag);
}

// --- PRODUCT & STOCK MANAGEMENT ---
function loadAllProducts(){
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        const stockBody = document.getElementById("stockBody");
        stockBody.innerHTML = "";
        const categories = new Set();
        
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key;
            allProducts.push(p);
            categories.add(p.category);
            
            let stockDisplay = "";
            let rowClass = "";
            
            if(p.isService) {
                stockDisplay = `<span class="service-badge">Service</span>`;
            } else {
                stockDisplay = `${p.qty} ${p.qty < 5 ? '‚ö†Ô∏è' : ''}`;
                if(p.qty < 5) rowClass = "low-stock";
            }
            
            const btnDel = `<button class="btn-action btn-del" onclick="delProduct('${p.key}')">üóëÔ∏è</button>`;
            
            stockBody.innerHTML += `<tr class="${rowClass}">
                <td>${p.serial || '-'}</td>
                <td>${p.category}</td>
                <td>${p.name}</td>
                <td>${stockDisplay}</td>
                <td>${p.sellPrice}</td>
                <td>${btnDel}</td>
            </tr>`;
        });
        
        const catSelect = document.getElementById("category");
        catSelect.innerHTML = "<option value=''>=== ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>";
        
        const sortedCategories = Array.from(categories).sort();
        sortedCategories.forEach(c => { 
            catSelect.innerHTML += `<option value="${c}">${c}</option>`; 
        });
        
        filterProducts();
    });
}

function toggleStockInput(){
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    
    if(isService){
        qtyInput.value = ""; qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; qtyInput.disabled = true; qtyInput.style.background = "#eee";
        costInput.value = ""; costInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; costInput.disabled = true; costInput.style.background = "#eee";
    } else {
        qtyInput.disabled = false; qtyInput.placeholder = "Qty"; qtyInput.style.background = "#fff";
        costInput.disabled = false; costInput.placeholder = "Cost"; costInput.style.background = "#fff";
    }
}

function addNewProduct(){
    const serial = document.getElementById("stSerial").value.trim();
    const cat = document.getElementById("stCategory").value.trim();
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    
    if(!cat || !name || !sell) return alert("Category, Name ‡¶è‡¶¨‡¶Ç Sell Price ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
    
    const newProd = { serial, category: cat, name, qty, isService, costPrice: cost, sellPrice: sell };
    
    db.ref("products").push(newProd).then(()=>{
        showTempMessage(isService ? "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!" : "‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        
        document.getElementById("stSerial").value = "";
        document.getElementById("stCategory").value = "";
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stIsService").checked = false;
        toggleStockInput();
    });
}

function delProduct(key){
    if(currentUser === 'owner' || currentUser === 'admin'){ 
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) db.ref("products/"+key).remove(); 
    } else { 
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§"); 
    }
}

// --- SALES & CART LOGIC ---
function filterProducts(){
    const cat = document.getElementById("category").value;
    const workSelect = document.getElementById("work");
    
    if (workSelect.value !== "") {
        workSelect.value = "";
        document.getElementById("rate").value = "";
    }
    
    workSelect.innerHTML = "<option value=''>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>";
    
    const filtered = cat ? allProducts.filter(p => p.category === cat) : [];
    
    if (cat && filtered.length === 0) {
        workSelect.innerHTML = "<option value=''>‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á</option>";
    } else if (cat) {
        filtered.sort((a, b) => {
            const serialA = a.serial || "999999";
            const serialB = b.serial || "999999";
            return serialA.localeCompare(serialB, undefined, {numeric: true});
        });
        
        filtered.forEach(p => { 
            const displayText = p.serial ? `${p.serial} - ${p.name}` : p.name;
            workSelect.innerHTML += `<option value="${p.key}" data-price="${p.sellPrice}">${displayText}</option>`; 
        });
    }
    
    return new Promise(resolve => setTimeout(resolve, 50));
}

function autoFillPrice(){
    const workSelect = document.getElementById("work");
    const selectedOption = workSelect.options[workSelect.selectedIndex];
    if(selectedOption && selectedOption.value){
        document.getElementById("rate").value = selectedOption.getAttribute("data-price") || "";
        document.getElementById("qty").focus();
    }
}

function addToCart(){
    const catSelect = document.getElementById("category");
    if (catSelect.value === "") {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        catSelect.focus();
        return;
    }
    
    const workSelect = document.getElementById("work");
    const pKey = workSelect.value;
    const pNameRaw = workSelect.options[workSelect.selectedIndex]?.text;
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    
    if(!pKey || pKey === "") {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        workSelect.focus();
        return;
    }
    
    if(!r || r <= 0) {
        alert("‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®!");
        document.getElementById("rate").focus();
        return;
    }
    
    if(q <= 0) {
        alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        document.getElementById("qty").focus();
        return;
    }
    
    const stockItem = allProducts.find(p => p.key === pKey);
    const pName = stockItem ? stockItem.name : pNameRaw;

    if (stockItem && catSelect.value !== stockItem.category) {
        alert(`‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${stockItem.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ü‡¶™‡¶®‡¶ø "${catSelect.options[catSelect.selectedIndex].text}" ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!`);
        return;
    }

    if(stockItem && !stockItem.isService && stockItem.qty < q) { 
        if(!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á! (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${stockItem.qty})‡•§ \n‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
    }
    
    cart.push({ 
        key: pKey, 
        work: pName, 
        qty: q, 
        rate: r, 
        sub: q * r, 
        isService: stockItem ? stockItem.isService : false 
    });
    
    renderCart(); 
    document.getElementById("qty").value=1; 
    document.getElementById("searchSerial").focus();
}

function renderCart(){
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    
    let grandTotal = 0;
    
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `
            <div class="cart-item">
                <span>${index+1}. ${item.work} <small>(${item.qty} x ${item.rate})</small></span>
                <span>
                    <b>‡ß≥${item.sub}</b> 
                    <span onclick="removeCart(${index})" style="color:#e74c3c;cursor:pointer;margin-left:10px;font-weight:bold" title="Remove">√ó</span>
                </span>
            </div>`;
    });
    
    document.getElementById("total").value = grandTotal; 
    calcDue();
}

function removeCart(index){ 
    cart.splice(index,1); 
    renderCart(); 
}

function calcDue(){ 
    const t = parseFloat(document.getElementById("total").value) || 0;
    const k = parseFloat(document.getElementById("taken").value) || 0;
    document.getElementById("due").value = t - k;
}

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            db.ref("products/" + cItem.key).update({ qty: newQty });
        }
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
    
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    const dueVal = totalVal - takenVal;
    const note = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
    const cleanPhone = phone.replace(/\D/g, '');
    
    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    if (cleanPhone && note) {
        customerCache[cleanPhone] = note;
        existingCustomers[cleanPhone] = note;
    }
    
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: dueVal,
        user: currentUser,
        note: note || "General Customer",
        phone: cleanPhone || ""
    };
    
    db.ref("entries").push(entryData).then((snap) => {
        deductStock(cart);
        
        if(showMemoFlag) {
             entryData.key = snap.key;
             showMemo(entryData);
        } else {
             showTempMessage("‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
        
        // UI ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        cart = []; 
        renderCart(); 
        document.getElementById("note").value = ""; 
        document.getElementById("phone").value = ""; 
        document.getElementById("taken").value = ""; 
        document.getElementById("due").value = "0";
        document.getElementById("customerValidation").innerHTML = "";
        document.getElementById("paymentValidation").innerHTML = "";
        document.getElementById("finalWarning").innerHTML = "";
        document.getElementById("finalWarning").style.display = "none";
        
        document.getElementById("searchSerial").focus();
        
        // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        loadAllCustomers();
    });
}

// --- CUSTOMER MANAGEMENT SYSTEM ---
function searchCustomer() {
    const query = document.getElementById("searchCustomerInput").value.trim();
    if (!query) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    showTempMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...", "info");
    
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        const customers = {};
        let found = false;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone || "";
            const note = entry.note || "";
            
            // ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
            if (phone.includes(query) || note.toLowerCase().includes(query.toLowerCase())) {
                found = true;
                
                if (!customers[phone]) {
                    customers[phone] = {
                        name: note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: "",
                        transactions: []
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                customers[phone].transactions.push({
                    key: key,
                    date: entry.date,
                    time: entry.time,
                    total: entry.total,
                    paid: entry.taken,
                    due: entry.loss,
                    items: entry.items,
                    user: entry.user
                });
            }
        });
        
        if (!found) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        const customerList = Object.values(customers);
        if (customerList.length === 1) {
            // ‡¶è‡¶ï‡¶ú‡¶®‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶π‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            currentCustomerData = customerList[0];
            showCustomerDetails(currentCustomerData);
        } else {
            // ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶π‡¶≤‡ßá ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            showCustomerList(customerList);
        }
    });
}

function showCustomerList(customers) {
    // ‡¶õ‡ßã‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.width = '500px';
    modal.style.zIndex = '2000';
    
    let html = '<h3 style="margin-top:0; color:#3498db;">‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</h3>';
    html += '<p style="margin-bottom:15px;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</p>';
    html += '<div style="max-height:300px; overflow-y:auto; margin-bottom:20px;">';
    
    customers.forEach((customer, index) => {
        html += `
            <div style="padding:12px; border-bottom:1px solid #eee; cursor:pointer; border-radius:5px; margin-bottom:5px; background:#f8f9fa;"
                 onclick="selectCustomerFromList('${customer.phone}')"
                 onmouseover="this.style.background='#e8f5e9'" 
                 onmouseout="this.style.background='#f8f9fa'">
                <div style="font-weight:bold; color:#2c3e50;">${customer.name}</div>
                <div style="font-size:14px; color:#666;">
                    <span>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${customer.phone || '‡¶®‡ßá‡¶á'}</span> | 
                    <span>‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</span> | 
                    <span>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    html += '<button onclick="closeCustomerListModal()" style="background:#e74c3c;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>';
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
    
    // ‡¶™‡¶ú‡¶ø‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.display = 'block';
    
    // ‡¶ì‡¶≠‡¶æ‡¶∞‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    document.getElementById("overlay").style.display = "block";
    
    // ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    window.closeCustomerListModal = function() {
        if (modal.parentNode) {
            document.body.removeChild(modal);
        }
        document.getElementById("overlay").style.display = "none";
    };
}

function selectCustomerFromList(phone) {
    // ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶∏‡¶∞‡¶æ‡¶®
    if (typeof closeCustomerListModal === 'function') {
        closeCustomerListModal();
    }
    
    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        let foundCustomer = null;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone) {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: "",
                        transactions: []
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                customers[phone].transactions.push({
                    key: key,
                    date: entry.date,
                    time: entry.time,
                    total: entry.total,
                    paid: entry.taken,
                    due: entry.loss,
                    items: entry.items,
                    user: entry.user
                });
            }
        });
        
        if (customers[phone]) {
            currentCustomerData = customers[phone];
            showCustomerDetails(currentCustomerData);
        }
    });
}

function showCustomerDetails(customer) {
    currentCustomerData = customer;
    
    document.getElementById("customerDetails").style.display = "block";
    document.getElementById("customerHistorySection").style.display = "block";
    document.getElementById("customerNameTitle").innerText = customer.name;
    
    const infoDiv = document.getElementById("customerInfo");
    infoDiv.innerHTML = `
        <div class="customer-summary ${customer.totalDue > 0 ? 'due-alert' : 'paid-alert'}">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px;">
                <div>
                    <strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong><br>
                    <span style="font-size:18px; font-weight:bold;">${customer.name}</span>
                </div>
                <div>
                    <strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</strong><br>
                    <span style="font-size:18px; color:#3498db;">${customer.phone || "‡¶®‡ßá‡¶á"}</span>
                </div>
            </div>
            
            <div class="customer-stats">
                <div class="stat-box">
                    <div style="font-size:14px; color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</div>
                    <div class="stat-value" style="color:#2c3e50;">‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:14px; color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</div>
                    <div class="stat-value" style="color:#27ae60;">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:14px; color:#666;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</div>
                    <div class="stat-value" style="color:${customer.totalDue > 0 ? '#e74c3c' : '#2ecc71'};">‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</div>
                </div>
            </div>
            
            <div style="margin-top:15px; color:#666; font-size:14px;">
                <span>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ: ${customer.lastDate || "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á"}</span>
                <span style="float:right;">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span>
            </div>
        </div>
    `;
    
    // ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    displayCustomerTransactions(customer.transactions || []);
}

function displayCustomerTransactions(transactions) {
    const tbody = document.getElementById("customerTransactions");
    tbody.innerHTML = "";
    
    if (transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#777;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>`;
        return;
    }
    
    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®)
    transactions.sort((a, b) => {
        const dateA = a.date ? a.date.split('/').reverse().join('-') : '1970-01-01';
        const dateB = b.date ? b.date.split('/').reverse().join('-') : '1970-01-01';
        return new Date(dateB) - new Date(dateA);
    });
    
    transactions.forEach(trans => {
        const itemSummary = trans.items && Array.isArray(trans.items) 
            ? trans.items.slice(0, 2).map(i => `${i.work}`).join(', ') + (trans.items.length > 2 ? '...' : '')
            : "‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶£‡ßç‡¶Ø";
        
        tbody.innerHTML += `
            <tr>
                <td>${trans.date || ''}<br><small>${trans.time || ''}</small></td>
                <td><small>${trans.key ? trans.key.slice(-6).toUpperCase() : ''}</small></td>
                <td>${itemSummary}</td>
                <td>‡ß≥${trans.total || '0'}</td>
                <td style="color:#27ae60; font-weight:bold">‡ß≥${trans.paid || '0'}</td>
                <td style="color:${trans.due > 0 ? '#e74c3c' : '#27ae60'}">‡ß≥${trans.due || '0'}</td>
                <td class="noPrint">
                    <button class="btn-action btn-print" onclick="viewMemo('${trans.key}')" title="‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®">üñ®Ô∏è</button>
                </td>
            </tr>
        `;
    });
}

function loadAllCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            
            if (phone && entry.note && entry.note !== "General Customer") {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: ""
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
            }
        });
        
        displayAllCustomersTable(customers);
    });
}

function displayAllCustomersTable(customers) {
    const tbody = document.getElementById("allCustomers");
    tbody.innerHTML = "";
    
    const customerList = Object.values(customers);
    
    if (customerList.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#777;">‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
        return;
    }
    
    // ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® (‡¶¨‡ßá‡¶∂‡¶ø ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá)
    customerList.sort((a, b) => (b.totalDue || 0) - (a.totalDue || 0));
    
    customerList.forEach(customer => {
        tbody.innerHTML += `
            <tr style="${customer.totalDue > 0 ? 'background:#fff8f8' : ''}">
                <td><strong>${customer.name}</strong></td>
                <td>${customer.phone}</td>
                <td>‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</td>
                <td style="color:#27ae60">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</td>
                <td style="color:${customer.totalDue > 0 ? '#e74c3c' : '#27ae60'}; font-weight:bold">
                    ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'} ${customer.totalDue > 0 ? '‚ö†Ô∏è' : '‚úÖ'}
                </td>
                <td>${customer.lastDate || 'N/A'}</td>
                <td class="noPrint">
                    <button onclick="viewCustomerDetail('${customer.phone}')" style="padding:5px 10px; font-size:12px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;">
                        ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </button>
                </td>
            </tr>
        `;
    });
}

function viewCustomerDetail(phone) {
    document.getElementById("searchCustomerInput").value = phone;
    searchCustomer();
}

function clearCustomerSearch() {
    document.getElementById("customerDetails").style.display = "none";
    document.getElementById("customerHistorySection").style.display = "none";
    document.getElementById("searchCustomerInput").value = "";
    currentCustomerData = null;
}

function printCustomerReceipt() {
    if (!currentCustomerData || !currentCustomerData.transactions || currentCustomerData.transactions.length === 0) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á!");
        return;
    }
    
    // ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    const latestTrans = currentCustomerData.transactions[0];
    viewMemo(latestTrans.key);
}

function addPayment() {
    if (!currentCustomerData) {
        alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®!");
        return;
    }
    
    // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    document.getElementById("payCustomerName").value = currentCustomerData.name;
    document.getElementById("payCustomerPhone").value = currentCustomerData.phone;
    document.getElementById("payCurrentDue").value = currentCustomerData.totalDue ? currentCustomerData.totalDue.toFixed(2) : '0.00';
    document.getElementById("payAmount").value = "";
    document.getElementById("payComment").value = "‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø";
    
    // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    
    document.getElementById("paymentModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function processPayment() {
    const amount = parseFloat(document.getElementById("payAmount").value);
    const date = document.getElementById("payDate").value;
    const comment = document.getElementById("payComment").value || "‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ";
    
    if (!amount || amount <= 0) {
        alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    if (!currentCustomerData) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        return;
    }
    
    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (DD/MM/YYYY)
    const formattedDate = date.split('-').reverse().join('/');
    
    const paymentEntry = {
        date: formattedDate,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: [{ 
            work: comment, 
            qty: 1, 
            rate: amount, 
            sub: amount 
        }],
        total: amount,
        taken: amount,
        loss: 0,
        user: currentUser,
        note: `${currentCustomerData.name} - ${comment}`,
        phone: currentCustomerData.phone,
        isPayment: true
    };
    
    db.ref("entries").push(paymentEntry).then(() => {
        showTempMessage(`‚úÖ ‡ß≥${amount} ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
        closeModal('paymentModal');
        
        // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
        searchCustomer();
        loadAllCustomers();
    });
}

// --- TEMPORARY MESSAGE FUNCTION ---
function showTempMessage(message, type = "success") {
    const existingMsg = document.querySelector('.temp-message');
    if (existingMsg) {
        existingMsg.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => existingMsg.remove(), 300);
    }
    
    const msgDiv = document.createElement("div");
    msgDiv.className = "temp-message";
    msgDiv.textContent = message;
    msgDiv.style.background = type === "success" ? "#2ecc71" : 
                              type === "error" ? "#e74c3c" : 
                              type === "info" ? "#3498db" : "#f39c12";
    
    document.body.appendChild(msgDiv);
    
    setTimeout(() => {
        if (msgDiv.parentNode) {
            msgDiv.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => {
                if (msgDiv.parentNode) msgDiv.remove();
            }, 300);
        }
    }, 3000);
}

// --- MEMO & PRINTING ---
function viewMemo(key) { 
    db.ref("entries/" + key).once("value", s => { 
        if(s.val()) {
            let data = s.val();
            data.key = key;
            showMemo(data); 
        }
    }); 
}

function showMemo(e){
    document.getElementById("mId").innerText = (e.key ? e.key.slice(-6).toUpperCase() : '---');
    document.getElementById("mDate").innerText = (e.date || '') + " " + (e.time || '');
    document.getElementById("mUser").innerText = e.user || '';
    document.getElementById("mNote").innerText = e.note || '';
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total || '0';
    document.getElementById("mPaid").innerText = e.taken || '0';
    document.getElementById("mDueDisplay").innerText = e.loss || '0';
    
    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => {
            mItems.innerHTML += `
            <tr>
                <td style="border:1px solid #ddd; padding:8px">${i.work || ''}</td>
                <td style="text-align:center; border:1px solid #ddd; padding:8px">${i.qty || '0'}</td>
                <td style="text-align:right; border:1px solid #ddd; padding:8px">${i.sub || '0'}</td>
            </tr>`;
        });
    } else {
        mItems.innerHTML += `<tr><td>${e.work || ''}</td><td>-</td><td>${e.total || '0'}</td></tr>`;
    }
    
    const signs = {
        owner: ["Toosher Ahmed", "01913-812765"], 
        admin: ["Arafat Sikder", "016749-44985"], 
        roky: ["Roky", "01878-149052"]
    };
    
    const s = signs[e.user] || [e.user ? e.user.toUpperCase() : '', ""];
    document.getElementById("signatureName").innerText = s[0];
    
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(id) { 
    document.getElementById(id).style.display="none"; 
    document.getElementById("overlay").style.display="none"; 
}

// --- EDITING & DELETING ---
function openEdit(key) {
    db.ref("entries/" + key).once("value", s => {
        const d = s.val();
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note || '';
        document.getElementById("editPhone").value = d.phone || '';
        document.getElementById("editTotal").value = d.total || 0;
        document.getElementById("editTaken").value = d.taken || 0;
        
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    
    db.ref("entries/" + key).update({ 
        note: document.getElementById("editNote").value, 
        phone: document.getElementById("editPhone").value, 
        total: t, 
        taken: k, 
        loss: t - k
    }).then(() => { 
        showTempMessage("‚úÖ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal("editModal"); 
        loadAllCustomers(); // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    });
}

function delEntry(key){ 
    db.ref("entries/"+key).once("value", s => { 
        const entry = s.val();
        
        if(entry.user !== currentUser && currentUser !== 'admin' && currentUser !== 'owner') {
             return alert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!");
        }
        
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            
            if(entry.items && Array.isArray(entry.items)){
                entry.items.forEach(item => {
                    if(item.key && !item.isService){
                         const prod = allProducts.find(p => p.key === item.key);
                         if(prod){
                             const currentQty = parseFloat(prod.qty) || 0;
                             const returnQty = parseFloat(item.qty) || 0;
                             db.ref("products/" + item.key).update({ qty: currentQty + returnQty });
                         }
                    }
                });
            }
            
            db.ref("entries/"+key).remove();
            showTempMessage("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "error");
            loadAllCustomers(); // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        }
    }); 
}

// --- REPORTING & CHARTS ---
function loadEntries(){ 
    db.ref("entries").limitToLast(100).on("value", s => renderTable(s.val(), "tableBody")); 
}

function renderTable(data, tableId = "tableBody"){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    
    if(!data) { 
        if(tableId === "reportTableBody") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>"; 
        return; 
    }
    
    let totalSales=0, totalTaken=0, totalDue=0;
    let dailyData = {};
    
    const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
    
    entriesArr.forEach(e => {
        const total = parseFloat(e.total) || 0;
        const taken = parseFloat(e.taken) || 0;
        const loss = parseFloat(e.loss) || 0;
        
        totalSales += total; 
        totalTaken += taken; 
        totalDue += loss;
        
        const itemSummary = (e.items && Array.isArray(e.items)) 
            ? e.items.map(i => `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work} (${i.qty})</span>`).join(" ") 
            : e.work;
            
        const phone = e.phone || "-";
        
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${e.key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${e.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = `<button class="btn-action btn-del" onclick="delEntry('${e.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>`;
        
        tbody.innerHTML+=`
        <tr>
            <td style="font-size:13px">${e.date || ''}<br>${e.time || ''}</td>
            <td style="font-size:13px"><b>${e.note || ''}</b><br>${itemSummary}</td>
            <td class="en">${phone}</td>
            <td>${total}</td>
            <td style="color:#27ae60;font-weight:bold">${taken}</td>
            <td style="color:#e74c3c">${loss}</td>
            <td style="text-transform:capitalize">${e.user || ''}</td>
            <td class="noPrint" style="white-space:nowrap">${btnMemo}${btnEdit}${btnDel}</td>
        </tr>`;
        
        if (e.date) {
            dailyData[e.date] = (dailyData[e.date]||0) + total;
        }
    });
    
    if(tableId === "tableBody") { 
        document.getElementById("cCount").innerText = entriesArr.length; 
        document.getElementById("cTotal").innerText = totalSales.toFixed(2); 
        document.getElementById("cTaken").innerText = totalTaken.toFixed(2); 
        document.getElementById("cDue").innerText = totalDue.toFixed(2); 
        
        updateChart(dailyData); 
        renderUserStats(data); 
    }
}

function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {}; 
    let hasData = false;
    
    ['admin', 'owner', 'roky'].forEach(u => stats[u] = {total:0, taken:0, due:0});
    
    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            if(e.date === today) {
                hasData = true; 
                const u = e.user ? e.user.toLowerCase() : '';
                if(!stats[u]) stats[u] = {total:0, taken:0, due:0};
                stats[u].total += (parseFloat(e.total) || 0); 
                stats[u].taken += (parseFloat(e.taken) || 0); 
                stats[u].due += (parseFloat(e.loss) || 0);
            }
        });
    }
    
    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    
    if(!hasData) { 
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`; 
        return; 
    }
    
    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) { 
            tbody.innerHTML += `
            <tr>
                <td style="text-transform:capitalize; font-weight:bold">${u}</td>
                <td>${stats[u].total.toFixed(2)}</td>
                <td style="color:#27ae60; font-weight:bold">${stats[u].taken.toFixed(2)}</td>
                <td style="color:#e74c3c">${stats[u].due.toFixed(2)}</td>
            </tr>`; 
        }
    });
}

function updateChart(data){
    const sortedDates = Object.keys(data).sort((a,b) => {
        const [d1,m1,y1] = a.split('/'); 
        const [d2,m2,y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    });
    
    const labels = sortedDates.slice(-10);
    const values = labels.map(d => data[d]);
    
    if(salesChart) salesChart.destroy();
    
    const ctx = document.getElementById('salesChart');
    if(ctx) { 
        salesChart = new Chart(ctx, { 
            type: 'bar', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (‡¶ü‡¶æ‡¶ï‡¶æ)', 
                    data: values, 
                    backgroundColor: '#2ecc71',
                    borderRadius: 5
                }] 
            }, 
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } } 
            } 
        }); 
    }
}

// --- UTILITIES ---
function showSection(id){ 
    document.querySelectorAll('.section').forEach(s=>s.style.display="none"); 
    document.getElementById(id).style.display="block"; 
    closeSidebar(); 
    
    if (id === 'customers') {
        loadAllCustomers();
    }
}
function closeSidebar(){ 
    document.getElementById("sidebar").style.left="-300px"; 
    document.getElementById("overlay").style.display="none"; 
}
function openSidebar(){ 
    document.getElementById("sidebar").style.left="0"; 
    document.getElementById("overlay").style.display="block"; 
}

function searchByDate(){ 
    if(!document.getElementById("sDate").value) return alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
    const d = document.getElementById("sDate").value.split("-").reverse().join("/");
    
    db.ref("entries").orderByChild("date").equalTo(d).once("value", s => { 
        renderTable(s.val(), "reportTableBody"); 
    }); 
}

function loadReportData() { 
    db.ref("entries").once("value", s => renderTable(s.val(), "reportTableBody")); 
}

function downloadExcel(){
    db.ref("entries").once("value", s => {
        const d = s.val(); 
        if(!d) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
        
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤,‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞\n";
        
        Object.keys(d).forEach(k => { 
            const e = d[k]; 
            const items = (e.items && Array.isArray(e.items)) 
                ? e.items.map(i=>`${i.work} (${i.qty}pc)`).join(" + ") 
                : e.work;
            
            const safeNote = e.note ? e.note.replace(/,/g, " ") : '';
            
            csv += `${e.date || ''},${e.time || ''},${safeNote},${e.phone||'-'},"${items}",${e.total || 0},${e.taken || 0},${e.loss || 0},${e.user || ''}\n`; 
        });
        
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); 
        link.download = `Report_${new Date().toLocaleDateString()}.csv`; 
        link.click();
    });
}
</script>
</body>
</html>
