<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sheikh Photocopy PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- EXCEL & CSV LIBRARY (SheetJS) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* --- PREMIUM THEME (3D GRADIENT EDITION) --- */
:root {
    --primary: #4f46e5;
    --primary-dark: #3730a3;
    --accent: #06b6d4;
    --bg-gradient: linear-gradient(135deg, #0f172a 0%, #172554 100%);
    --sidebar-bg: rgba(15, 23, 42, 0.98);
    --text-main: #1e293b;
    --text-light: #64748b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
}

/* LIGHT THEME SUPPORT */
body.light-theme {
    --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --sidebar-bg: #ffffff;
    --text-main: #0f172a;
}
body.light-theme #sidebar { border-right: 1px solid #cbd5e1; }
body.light-theme #sidebar a { color: #475569; }
body.light-theme #sidebar a:hover { background: #f1f5f9; color: var(--primary); }
body.light-theme #userShow { color: #334155; border-bottom: 1px solid #e2e8f0; }
body.light-theme .sidebar-footer { background: #f8fafc; border-top: 1px solid #e2e8f0; }
body.light-theme .footer-label { color: #64748b; }
body.light-theme .footer-val { color: #0f172a; }

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { 
    font-family: 'Hind Siliguri', sans-serif; 
    background: var(--bg-gradient); 
    color: var(--text-main); 
    font-size: 15px; 
    min-height: 100vh;
    background-attachment: fixed;
}
.en { font-family: 'Poppins', sans-serif; }

/* --- CUSTOM SCROLLBAR --- */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

/* --- TOAST --- */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
.toast { 
    min-width: 300px; margin-bottom: 12px; background: #fff; padding: 16px 20px; 
    border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
    display: flex; align-items: center; justify-content: space-between; 
    animation: slideIn 0.3s ease-out forwards; border-left: 6px solid #333; font-weight: 600; 
}
.toast.success { border-left-color: var(--success); color: var(--success); }
.toast.error { border-left-color: var(--danger); color: var(--danger); }
.toast.warning { border-left-color: var(--warning); color: #d97706; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }

/* --- HEADER (Mobile Only) --- */
header {
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    color: #fff; padding: 15px; text-align: center; font-size: 20px; font-weight: 700;
    display: none; position: fixed; top: 0; width: 100%; z-index: 1000;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

/* --- LOGIN SCREEN --- */
#loginDiv {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(160deg, #2dd4bf 0%, #3b82f6 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 2000;
}
.login-card {
    background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 100%);
    width: 90%; max-width: 400px;
    padding: 40px 30px;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.5);
    text-align: center;
}
.login-title { font-size: 26px; font-weight: 700; color: #10b981; margin-bottom: 5px; }
.login-title span { color: #3b82f6; }
.login-subtitle { font-size: 13px; color: #9ca3af; margin-bottom: 30px; font-family: 'Poppins', sans-serif; }
.login-label { display: block; text-align: left; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px; }
.login-input { width: 100%; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; margin-bottom: 20px; background: #fff; color: #333; transition: 0.2s; }
.login-input:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
.login-btn { width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 10px; }
.login-btn:hover { background: #059669; }
.login-footer { margin-top: 25px; font-size: 11px; color: #9ca3af; line-height: 1.5; }

/* --- LAYOUT --- */
#container { display: none; padding: 20px; padding-left: 300px; max-width: 1600px; margin: auto; transition: 0.3s; }

/* --- SIDEBAR --- */
#menuBtn { position: fixed; top: 15px; left: 15px; font-size: 24px; color: #fff; cursor: pointer; display: none; z-index: 1100; background: var(--primary); padding: 5px 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
#sidebar {
    position: fixed; top: 0; left: 0; width: 280px; height: 100%;
    background: var(--sidebar-bg); backdrop-filter: blur(15px);
    border-right: 1px solid rgba(255,255,255,0.1);
    transition: .3s; z-index: 1200; padding-top: 0;
    display: flex; flex-direction: column;
    box-shadow: 5px 0 25px rgba(0,0,0,0.3);
}
.sidebar-header {
    padding: 30px 20px; background: linear-gradient(to right, var(--primary), var(--accent));
    color: #fff; font-size: 22px; font-weight: 800; text-align: center;
    letter-spacing: 1px; margin-bottom: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
#userShow {
    text-align: center; padding: 15px; color: #cbd5e1; font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
}
#sidebar a {
    display: block; color: #94a3b8; text-decoration: none; padding: 14px 25px;
    cursor: pointer; font-weight: 500; transition: 0.3s; border-left: 4px solid transparent;
    font-size: 15px;
}
#sidebar a:hover { background: rgba(255,255,255,0.05); color: #fff; border-left-color: var(--accent); padding-left: 30px; }

/* --- SIDEBAR FOOTER --- */
.sidebar-footer {
    margin-top: auto; padding: 20px 25px; 
    border-top: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.2);
}
.footer-item { margin-bottom: 15px; }
.footer-item:last-child { margin-bottom: 0; }
.footer-label { color: #94a3b8; font-size: 12px; display: block; margin-bottom: 2px; }
.footer-val { color: #fff; font-size: 14px; font-weight: 600; }
.status-online { color: #10b981; font-weight: bold; display: flex; align-items: center; gap: 5px; }
.status-offline { color: #ef4444; font-weight: bold; display: flex; align-items: center; gap: 5px; }

#overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); display: none; z-index: 1150; }

/* --- CARDS & SECTIONS --- */
.section { display: none; animation: fadeIn 0.5s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.card-glass, .card, .table-box, .modal {
    background: linear-gradient(160deg, #ffffff 40%, #f0f9ff 100%);
    border-radius: 16px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.5);
    position: relative;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}
.card-glass { padding: 25px; margin-bottom: 25px; }

/* --- DASHBOARD STATS --- */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
.card { padding: 25px; text-align: center; border-bottom: 4px solid transparent; }
.card:hover { transform: translateY(-8px); box-shadow: 0 20px 35px rgba(0,0,0,0.15); }
.card b { font-size: 28px; display: block; margin-top: 10px; color: var(--text-main); }
.card span { font-size: 13px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }

/* --- FORMS & INPUTS --- */
.form-group { margin-bottom: 18px; text-align: left; }
.form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-main); font-size: 14px; }
input, select, button {
    width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid #cbd5e1;
    outline: none; transition: 0.3s; font-size: 15px; background: #f8fafc;
}
input:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
input.invalid { border-color: var(--danger); background: #fef2f2; }
input.valid { border-color: var(--success); background: #f0fdf4; }

button {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff; font-weight: 600; border: none; cursor: pointer; font-size: 16px;
    padding: 14px; margin-top: 5px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}
button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4); }

/* --- TABLES --- */
.table-box { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 700px; }
th, td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; text-align: left; }
th { background: rgba(248, 250, 252, 0.8); color: var(--text-light); font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; }
tr:hover { background-color: rgba(241, 245, 249, 0.5); }

/* --- ACTION BUTTONS --- */
.btn-action { padding: 6px 12px; font-size: 14px; margin: 0 3px; border-radius: 6px; width: auto; display: inline-block; box-shadow: none; }
.btn-view { background: #e0f2fe; color: #0284c7; } .btn-view:hover { background: #0284c7; color: #fff; }
.btn-edit { background: #fef3c7; color: #d97706; } .btn-edit:hover { background: #d97706; color: #fff; }
.btn-print { background: #f3e8ff; color: #9333ea; } .btn-print:hover { background: #9333ea; color: #fff; }
.btn-delete { background: #fee2e2; color: #dc2626; } .btn-delete:hover { background: #dc2626; color: #fff; }

/* --- CART & SEARCH --- */
.cart-box { margin-top: 25px; border: 2px dashed var(--primary); padding: 25px; border-radius: 16px; background: #f5f3ff; }
.cart-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); align-items: center; }
.live-search-results { position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 12px; max-height: 300px; overflow-y: auto; width: 100%; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; margin-top: 5px; }
.search-item { padding: 12px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
.search-item:hover { background: #f8fafc; padding-left: 25px; }

/* --- MODAL --- */
.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 550px; max-width: 95%; padding: 30px; z-index: 1500; max-height: 90vh; overflow-y: auto; }
.detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
.detail-label { font-weight: 600; color: var(--text-light); }
.detail-val { color: var(--text-main); font-weight: 600; }

/* --- RESPONSIVE --- */
@media (max-width: 768px) {
    #sidebar { left: -300px; }
    #container { padding-left: 20px; }
    #menuBtn { display: block; }
    header { display: block; }
    #container { padding-top: 80px; }
}

/* --- PRINT SETTINGS (UPDATED TO A5) --- */
@media print {
    @page { 
        size: A5 portrait; /* CHANGED: A4 -> A5 */
        margin: 0; 
    }
    
    html, body {
        width: 100%;
        height: 100%;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important; 
        background: #fff !important;
    }

    /* Hide everything else */
    body * { visibility: hidden; }
    
    /* Show only the Memo Modal */
    #memoModal, #memoModal * { 
        visibility: visible !important; 
    }
    
    #memoModal { 
        display: block !important; 
        position: absolute; 
        left: 0; 
        top: 0; 
        width: 100% !important; 
        max-width: 100% !important; 
        height: auto !important;
        margin: 0 !important; 
        padding: 10mm !important; /* Adjusted padding for A5 */
        transform: none !important; 
        box-shadow: none !important; 
        border: none !important; 
        background: transparent !important; 
    }
    
    /* Ensure table fits */
    #memoModal table {
        width: 100% !important;
        border-collapse: collapse;
    }
    
    .noPrint { display: none !important; }
}

/* --- FLOATING PROFILE BUTTON --- */
#profileBtn {
    position: fixed; top: 15px; right: 15px; z-index: 1201;
    background: var(--primary); color: #fff; padding: 8px 12px;
    border-radius: 30px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;
}
#profileMenu {
    position: fixed; top: 60px; right: 15px; width: 220px;
    background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: none; z-index: 1202; overflow: hidden;
}
.p-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; color: #333; transition: 0.2s; }
.p-item:hover { background: #f8fafc; color: var(--primary); }

/* --- GLOBAL STOCK ALERT --- */
#globalStockAlert {
    position: fixed; bottom: 20px; right: 20px; z-index: 1300;
    background: #ef4444; color: #fff; padding: 12px 20px;
    border-radius: 50px; cursor: pointer; box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
    display: none; align-items: center; gap: 10px; font-weight: bold;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}
</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<header id="header">Sheikh Photocopy PRO</header>
<div id="menuBtn" onclick="openSidebar()">тШ░</div>

<!-- PROFILE BUTTON -->
<div id="profileBtn" onclick="toggleProfile()">
    <span id="pIcon">ЁЯСд</span> <span id="pName">User</span>
</div>

<!-- PROFILE MENU -->
<div id="profileMenu">
    <div class="p-item" onclick="openProfileModal()">ЁЯСд ржЖржорж╛рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓</div>
    <div class="p-item" onclick="openSettingsModal()">тЪЩя╕П рж╕рзЗржЯрж┐ржВрж╕</div>
    <div class="p-item" onclick="exportDataCSV()">ЁЯУД ржбрж╛ржЯрж╛ ржПржХрзНрж╕ржкрзЛрж░рзНржЯ (CSV)</div>
    <div class="p-item" onclick="backupFullData()">ЁЯТ╛ ржбрж╛ржЯрж╛ ржмрзНржпрж╛ржХржЖржк (Full)</div>
    <div class="p-item" onclick="logout()" style="color:red; border-top:1px solid #f1f5f9; margin-top:5px">ЁЯЪк рж▓ржЧржЖржЙржЯ</div>
</div>

<!-- GLOBAL STOCK ALERT BUTTON -->
<div id="globalStockAlert" onclick="showShortageModal()">
    тЪая╕П <span id="alertText">Stock Alert</span>
</div>

<div id="overlay" onclick="closeSidebar(); closeProfile(); closeModal('shortageModal'); closeModal('quickStockModal'); closeModal('userProfileModal'); closeModal('appSettingsModal')"></div>

<!-- LOGIN SCREEN -->
<div id="loginDiv">
    <div class="login-card">
        <h2 class="login-title">рж╢рзЗржЦ ржлржЯрзЛржХржкрж┐ <span>PRO</span></h2>
        <p class="login-subtitle">v3.1.0 (Premium UI) | рзирзж-рзжрзз-рзирзжрзирзм</p>

        <label class="login-label">ЁЯСд ржЗржЙржЬрж╛рж░ржирзЗржо</label>
        <input id="uName" class="login-input" placeholder="ржЗржЙржЬрж╛рж░ржирзЗржо">

        <label class="login-label">ЁЯФТ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб</label>
        <input id="uPass" type="password" class="login-input" placeholder="тАвтАвтАвтАвтАвтАвтАвтАв" onkeydown="if(event.key==='Enter') login()">

        <button onclick="login()" class="login-btn">тЮЬ рж▓ржЧржЗржи ржХрж░рзБржи</button>

        <p class="login-footer">тД╣я╕П рж╕ржХрж▓ ржЗржЙржЬрж╛рж░рзЗрж░ ржПржХржЗ ржПржХрзНрж╕рзЗрж╕ | ржбрзЗржнрзЗрж▓ржкрж╛рж░: ржЖрж░рж╛ржлрж╛ржд рж╕рж┐ржХржжрж╛рж░</p>
    </div>
</div>

<div id="container">
    <div id="sidebar">
        <div class="sidebar-header">Sheikh Photocopy</div>
        <div style="text-align:right;padding:10px 20px;font-size:24px;cursor:pointer;color:#ef4444; display:none" onclick="closeSidebar()" id="closeBtn">тЬХ</div>
        <div id="userShow"></div>
        <a onclick="showSection('dashboard')">ЁЯПа ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</a>
        <a onclick="showSection('newEntry')">ЁЯУЭ ржирждрзБржи ржПржирзНржЯрзНрж░рж┐ / рж╕рзЗрж▓рж╕</a>
        <a onclick="showSection('customerManager')">ЁЯСе ржХрж╛рж╕рзНржЯржорж╛рж░ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ</a>
        <a onclick="showSection('inventory')">ЁЯУж рж╕рзНржЯржХ ржУ ржмрж┐ржнрж╛ржЧ</a>
        <a onclick="showSection('expenseManager')">ЁЯТ╕ ржЦрж░ржЪ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ</a>
        <a onclick="showSection('analytics')">ЁЯУИ ржкрзНрж░ржлрж┐ржЯ ржУ ржЕрзНржпрж╛ржирж╛рж▓рж┐ржЯрж┐ржХрзНрж╕</a>
        <a onclick="showSection('reports')">ЁЯУК рж░рж┐ржкрзЛрж░рзНржЯ ржУ ржкрзНрж░рж┐ржирзНржЯ</a>
        <a onclick="logout()" style="color:#ef4444; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1);">ЁЯЪк рж▓ржЧржЖржЙржЯ</a>
        
        <!-- SIDEBAR FOOTER -->
        <div class="sidebar-footer">
            <div class="footer-item">
                <span class="footer-label">ржЕржирж▓рж╛ржЗржи рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕</span>
                <div id="connectionStatus" class="footer-val status-online">тЧП ржЕржирж▓рж╛ржЗржи</div>
            </div>
            <div class="footer-item">
                <span class="footer-label">рж╕ржВрж╕рзНржХрж░ржг</span>
                <div class="footer-val en">v3.1.0 (Premium UI)</div>
            </div>
            <div class="footer-item">
                <span class="footer-label">ржбрзЗржнрзЗрж▓ржкрж╛рж░: ржЖрж░рж╛ржлрж╛ржд рж╕рж┐ржХржжрж╛рж░</span>
                <div class="footer-val en">рзжрззрзмрзнрзкрзп-рзкрзкрзпрзорзл</div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-bottom-color:#3b82f6">
                <span>ржорзЛржЯ ржПржирзНржЯрзНрж░рж┐</span>
                <b id="cCount" style="color:#3b82f6">0</b>
            </div>
            <div class="card" style="border-bottom-color:#10b981">
                <span>рж╕рж░рзНржмржорзЛржЯ рж╕рзЗрж▓ (рз│)</span>
                <b id="cTotal" style="color:#10b981">0</b>
            </div>
            <div class="card" style="border-bottom-color:#f59e0b">
                <span>ржиржЧржж ржХрзНржпрж╛рж╢ (рз│)</span>
                <b id="cTaken" style="color:#f59e0b">0</b>
            </div>
            <div class="card" style="border-bottom-color:#ef4444">
                <span>ржорзЛржЯ ржмрж╛ржХрж┐ (рз│)</span>
                <b id="cDue" style="color:#ef4444">0</b>
            </div>
        </div>

        <div class="card-glass">
            <h4 style="margin:0 0 20px 0; color:var(--primary); font-size:18px;">ЁЯУЕ ржЖржЬржХрзЗрж░ ржжрж┐ржирзЗрж░ ржЗржЙржЬрж╛рж░ рж╣рж┐рж╕рж╛ржм</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #e2e8f0;">
                <table class="en">
                    <thead><tr><th>ржЗржЙржЬрж╛рж░</th><th>ржорзЛржЯ ржХрж╛ржЬ (рз│)</th><th>ржиржЧржж ржЧрзНрж░рж╣ржг (рз│)</th><th>ржмрж╛ржХрж┐ (рз│)</th></tr></thead>
                    <tbody id="userSummaryBody"><tr><td colspan="4" style="text-align:center">ржЖржЬржХрзЗрж░ ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="card-glass">
            <h4 style="margin:0 0 20px 0; color:var(--text-main)">ЁЯУК ржЧржд рзн ржжрж┐ржирзЗрж░ рж╕рзЗрж▓рж╕ ржЪрж╛рж░рзНржЯ</h4>
            <canvas id="salesChart" height="80"></canvas>
        </div>
        
        <div class="table-box">
            <h4 style="padding:20px; margin:0; background: transparent; border-bottom: 1px solid #f1f5f9; color:var(--text-main)">рж╕рж╛ржорзНржкрзНрж░рждрж┐ржХ ржХрж╛рж░рзНржпржХрзНрж░ржо (рж╢рзЗрж╖ рзлрзжржЯрж┐)</h4>
            <table class="en">
                <thead><tr><th>Memo</th><th>рж╕ржорзЯ</th><th>ржмрж┐ржмрж░ржг/ржХрж╛рж╕рзНржЯржорж╛рж░</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржорзЛржЯ</th><th>ржиржЧржж</th><th>ржмрж╛ржХрж┐</th><th>ржЗржЙржЬрж╛рж░</th><th class="noPrint">ржЕрзНржпрж╛ржХрж╢ржи</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- NEW ENTRY (3-STEP) -->
    <div id="newEntry" class="section">
        <div class="card-glass" style="max-width:700px; margin:auto;">
            <h3 style="color:var(--primary);">ржирждрзБржи ржнрж╛ржЙржЪрж╛рж░ рждрзИрж░рж┐</h3>
            
            <div class="form-group" style="position: relative;">
                <label>ЁЯФН рж╕рзНржорж╛рж░рзНржЯ рж╕рж╛рж░рзНржЪ (рж╕рж┐рж░рж┐рзЯрж╛рж▓, ржирж╛ржо ржмрж╛ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐):</label>
                <input id="searchSerial" placeholder="ржЙржжрж╛рж╣рж░ржг: 101, A4 Paper, Pen..." class="en" autocomplete="off" style="padding: 16px; border-color: #94a3b8;">
                <div id="liveSearchResults" class="live-search-results"></div>
            </div>

            <!-- 3-STEP DROPDOWN LAYOUT -->
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
                <div class="form-group">
                    <label>рзз. ржмрж┐ржнрж╛ржЧ (Section):</label>
                    <select id="sectionSelect" onchange="updateCategories()" style="background:#fffbeb; border-color:#fcd34d; font-weight:bold;">
                        <option value="">рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржи...</option>
                        <option value="General">ЁЯЫНя╕П General</option>
                        <option value="Computer">ЁЯТ╗ Computer</option>
                        <option value="Photocopy">ЁЯУД Photocopy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>рзи. ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐:</label>
                    <select id="categorySelect" onchange="loadProductsByCategory()" style="background:#f0fdf4; border-color:#10b981; font-weight:600;">
                        <option value="">-- ржЖржЧрзЗ ржмрж┐ржнрж╛ржЧ ржжрж┐ржи --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>рзй. ржкржгрзНржп/ржХрж╛ржЬ:</label>
                    <select id="productSelect" onchange="productSelectedFromDropdown()">
                        <option value="">-- ржЖржЧрзЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржжрж┐ржи --</option>
                    </select>
                    <input type="hidden" id="selectedProductKey">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="form-group">
                    <label>ржкрж░рж┐ржорж╛ржг (Qty):</label>
                    <input id="qty" type="number" value="1" min="1" class="en" oninput="checkStockLive()" onkeydown="if(event.key === 'Enter'){ addToCart(); }">
                    <span id="stockLiveMsg" class="error-msg" style="color:red; font-size:12px"></span>
                </div>
                <div class="form-group"><label>ржжрж░ (Rate рз│):</label><input id="rate" type="number" min="0" class="en"></div>
            </div>
            
            <button onclick="addToCart()" style="background: linear-gradient(to right, #3b82f6, #2563eb); margin-bottom:25px; padding: 14px;">тмЗя╕П рж▓рж┐рж╕рзНржЯрзЗ ржпрзЛржЧ ржХрж░рзБржи (Add)</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 15px 0; border-bottom:1px dashed #10b981; padding-bottom:10px; color: #047857;">ржЕрж░рзНржбрж╛рж░ рж▓рж┐рж╕рзНржЯ:</h4>
                <div id="cartList"></div>
                
                <hr style="border:0; border-top:1px dashed #cbd5e1; margin:20px 0">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div class="form-group">
                        <label>ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржирж╛ржо (ржЦрж╛рж▓рж┐ ржерж╛ржХрж▓рзЗ 'General Customer'):</label>
                        <input id="note" placeholder="ржирж╛ржо рж▓рж┐ржЦрзБржи (ржРржЪрзНржЫрж┐ржХ)...">
                    </div>
                    <div class="form-group">
                        <label>ржорзЛржмрж╛ржЗрж▓ (рззрзз ржбрж┐ржЬрж┐ржЯ):</label>
                        <input id="phone" placeholder="017xxxxxxxx" class="en" maxlength="11" oninput="validatePhoneLive(this)">
                        <span id="phoneError" class="error-msg" style="color:red; font-size:12px; display:none">ржнрзБрж▓ ржиржорзНржмрж░!</span>
                        <small style="color:#64748b; display:block; margin-top:5px;">рж╕рж╛ржЬрзЗрж╢ржи: <span id="phoneSuggestion"></span></small>
                    </div>
                </div>
                
                <div style="background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                        <!-- UPDATED: Removed readonly, added oninput="calcDue()" for manual discount -->
                        <div class="form-group"><label>ржорзЛржЯ ржмрж┐рж▓ (Total):</label><input id="total" class="en" value="0" oninput="calcDue()" style="background:#fff; font-weight:bold; font-size: 18px; color: var(--text-main);"></div>
                        <div class="form-group"><label>ржиржЧржж ржЬржорж╛ (Paid):</label><input id="taken" type="number" min="0" class="en" oninput="calcDue()" style="font-size: 18px;"></div>
                    </div>
                    <div class="form-group">
                        <label id="dueLabel" style="color:#ef4444">ржмрж╛ржХрж┐ (Due):</label>
                        <input id="due" readonly class="en" value="0" style="background:#fef2f2; color:#ef4444; font-weight:bold; font-size: 18px;">
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:25px">
                    <button onclick="saveBulkEntry(false)" style="background: linear-gradient(to right, #f59e0b, #d97706)">ЁЯТ╛ рж╢рзБржзрзБ рж╕рзЗржн ржХрж░рзБржи</button>
                    <button onclick="saveBulkEntry(true)" style="background: linear-gradient(to right, #10b981, #059669)">ЁЯЦия╕П рж╕рзЗржн ржУ ржкрзНрж░рж┐ржирзНржЯ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOMER MANAGEMENT -->
    <div id="customerManager" class="section">
        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom:25px;">
                <h3 style="margin:0; color:var(--text-main)">ЁЯСе ржХрж╛рж╕рзНржЯржорж╛рж░ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ</h3>
                <div style="display:flex; gap:10px">
                    <button onclick="downloadExcel('customer')" style="width:auto; background:#10b981; padding:10px 20px;">ЁЯУК Excel</button>
                    <button onclick="openAddCustomerModal()" style="width:auto; background:var(--primary); padding:10px 20px;">+ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>ЁЯФН ржХрж╛рж╕рзНржЯржорж╛рж░ ржЦрзБржБржЬрзБржи (ржирж╛ржо ржмрж╛ ржорзЛржмрж╛ржЗрж▓):</label>
                <input id="custSearch" placeholder="Search..." class="en" oninput="filterCustomerTable()" style="padding: 14px;">
            </div>

            <div class="table-box">
                <table class="en">
                    <thead>
                        <tr>
                            <th>ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржирж╛ржо</th>
                            <th>ржорзЛржмрж╛ржЗрж▓</th>
                            <th>ржорзЛржЯ ржХрж╛ржЬ (рз│)</th>
                            <th>ржорзЛржЯ ржЬржорж╛ (рз│)</th>
                            <th>ржмрж░рзНрждржорж╛ржи ржмрж╛ржХрж┐ (рз│)</th>
                            <th>ржЕрзНржпрж╛ржХрж╢ржи</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- INVENTORY -->
    <div id="inventory" class="section">
        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom: 25px;">
                <h3 style="margin:0; color:var(--text-main);">ЁЯУж рж╕рзНржЯржХ ржУ ржмрж┐ржнрж╛ржЧ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ</h3>
                <button onclick="downloadExcel('stock')" style="width:auto; background:#10b981; padding:10px 20px;">ЁЯУК Excel</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px">
                 <div class="form-group">
                    <label>рж╕рзЗржХрж╢ржи/ржмрж┐ржнрж╛ржЧ (Main Type):</label>
                    <select id="stMainType" style="background:#fffbeb; font-weight:bold; border-color: #fcd34d;">
                        <option value="General">ЁЯЫНя╕П ржЬрзЗржирж╛рж░рзЗрж▓ рж╕рзЗрж▓рж╕ (ржкржгрзНржп/ржЦрж╛рждрж╛/ржХрж▓ржо)</option>
                        <option value="Computer">ЁЯТ╗ ржХржорзНржкрж┐ржЙржЯрж╛рж░ рж╕рж╛ржЗржб (ржкрзНрж░рж┐ржирзНржЯ/ржЯрж╛ржЗржк)</option>
                        <option value="Photocopy">ЁЯУД ржлржЯрзЛржХржкрж┐ рж╕рж╛ржЗржб</option>
                    </select>
                </div>
                <div class="form-group"><label>рж╕рж┐рж░рж┐рзЯрж╛рж▓ ржХрзЛржб (Auto):</label><input id="stSerial" class="en" placeholder="Auto Generated" readonly style="background:#f1f5f9; cursor:not-allowed"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px">
                <div class="form-group"><label>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐:</label><input id="stCategory" placeholder="Paper, Khata, Pen..."></div>
                <div class="form-group"><label>ржкржгрзНржпрзЗрж░ ржирж╛ржо:</label><input id="stName" placeholder="Product Name"></div>
            </div>
            
            <div style="background:#eff6ff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #bfdbfe;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="stIsService" style="width:20px; height:20px; margin:0" onchange="toggleStockInput()">
                    <label for="stIsService" style="margin:0; cursor:pointer; font-weight:bold; color:#1d4ed8">ржПржЯрж┐ ржПржХржЯрж┐ рж╕рзЗржмрж╛/рж╕рж╛рж░рзНржнрж┐рж╕ (рж╕рзНржЯржХ ржорзЗржЗржиржЯрзЗржЗржи рж╣ржмрзЗ ржирж╛)</label>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:15px; align-items:end">
                <div class="form-group"><label>рж╕рзНржЯржХ (Qty):</label><input id="stQty" type="number" min="0" class="en" placeholder="0"></div>
                <div class="form-group"><label>рж╕рждрж░рзНржХрждрж╛ рж▓рзЗржнрзЗрж▓:</label><input id="stAlert" type="number" min="0" class="en" placeholder="5"></div>
                <div class="form-group"><label>ржХрзЗржирж╛ ржжрж╛ржо:</label><input id="stCost" type="number" min="0" class="en" placeholder="0"></div>
                <div class="form-group"><label>ржмрж┐ржХрзНрж░рзЯ ржорзВрж▓рзНржп:</label><input id="stSell" type="number" min="0" class="en" placeholder="0"></div>
                <button onclick="addNewProduct()" style="height:48px; margin-bottom:18px; width: 90px; background: var(--text-main);">+ рж╕рзЗржн</button>
            </div>

            <div class="table-box" style="margin-top:30px">
                <table>
                    <thead><tr><th>Type</th><th>Serial</th><th>Category</th><th>Name</th><th>Stock</th><th>Alert</th><th>Cost Price</th><th>Sell Price</th><th>Action</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- EXPENSE MANAGEMENT -->
    <div id="expenseManager" class="section">
        <div class="card-glass" style="max-width:900px; margin:auto">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom: 25px;">
                <h3 style="margin:0; color:#ef4444;">ЁЯТ╕ ржЦрж░ржЪ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ</h3>
                <button onclick="downloadExcel('expense')" style="width:auto; background:#10b981; padding:10px 20px;">ЁЯУК Excel</button>
            </div>
            
            <div style="background:#fef2f2; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #fecaca; text-align:center">
                <h4 style="margin:0; color:#b91c1c; font-size: 20px;">ржорзЛржЯ ржЦрж░ржЪ: рз│ <span id="totalExpenseDisplay">0</span></h4>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap:15px; align-items:end; margin-bottom:25px;">
                <div class="form-group"><label>ржЦрж░ржЪрзЗрж░ ржмрж┐ржмрж░ржг:</label><input id="expDesc" placeholder="ржпрзЗржоржи: ржжрзЛржХрж╛ржи ржнрж╛рзЬрж╛, ржирж╛рж╕рзНрждрж╛..."></div>
                <div class="form-group"><label>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐:</label>
                    <select id="expCat">
                        <option value="Shop Rent">ржжрзЛржХрж╛ржи ржнрж╛рзЬрж╛</option>
                        <option value="Electricity">ржмрж┐ржжрзНржпрзБрзО ржмрж┐рж▓</option>
                        <option value="Transport">ржпрж╛рждрж╛рзЯрж╛ржд</option>
                        <option value="Food">ржЦрж╛ржмрж╛рж░/ржирж╛рж╕рзНрждрж╛</option>
                        <option value="Other">ржЕржирзНржпрж╛ржирзНржп</option>
                    </select>
                </div>
                <div class="form-group"><label>ржЯрж╛ржХрж╛:</label><input id="expAmount" type="number" class="en" placeholder="0"></div>
                <button onclick="saveExpense()" style="height:48px; margin-bottom:18px; width: 90px; background:#ef4444">+ рж╕рзЗржн</button>
            </div>

            <div class="table-box">
                <table class="en">
                    <thead><tr><th>рждрж╛рж░рж┐ржЦ</th><th>ржмрж┐ржмрж░ржг</th><th>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐</th><th>ржЯрж╛ржХрж╛</th><th>ржЕрзНржпрж╛ржХрж╢ржи</th></tr></thead>
                    <tbody id="expenseBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- BUSINESS ANALYTICS -->
    <div id="analytics" class="section">
        <div class="card-glass">
            <h3 style="margin-top:0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; color: var(--text-main)">ЁЯУИ ржкрзНрж░ржлрж┐ржЯ ржУ рж▓рж╕ ржЕрзНржпрж╛ржирж╛рж▓рж┐ржЯрж┐ржХрзНрж╕</h3>
            <div style="display:flex; gap:15px; justify-content:center; align-items:center; margin-bottom:25px; background:#f8fafc; padding:20px; border-radius:12px;">
                <select id="anMonth" class="en" style="width:160px">
                    <option value="0">All Months</option>
                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
                <select id="anYear" class="en" style="width:110px">
                    <option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
                </select>
                <button onclick="generateAnalytics()" style="margin:0; width:auto; padding:12px 25px; background: var(--text-main);">рж╣рж┐рж╕рж╛ржм ржжрзЗржЦрзБржи</button>
            </div>

            <div class="stats en" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="card" style="border-bottom: 4px solid #3b82f6;">
                    <span>TOTAL SALES</span>
                    <b id="anaSale">0</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #94a3b8;">
                    <span>PRODUCT COST</span>
                    <b id="anaCost" style="color:#64748b">0</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #f59e0b;">
                    <span>GROSS PROFIT</span>
                    <b id="anaGross" style="color:#d97706">0</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #ef4444;">
                    <span>TOTAL EXPENSE</span>
                    <b id="anaExpense" style="color:#b91c1c">0</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #10b981; background:#f0fdf4; transform: scale(1.02);">
                    <span id="netProfitTitle">NET PROFIT</span>
                    <b id="anaNet" style="font-size: 28px;">0</b>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:25px; margin-top:30px;">
                <div style="flex:1; min-width:320px">
                    <h4 style="margin:0 0 15px 0; color: var(--text-main)">ЁЯУК ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржЕржирзБржпрж╛рзЯрзА рж╕рзЗрж▓рж╕ ржмрзНрж░рзЗржХржбрж╛ржЙржи</h4>
                    <div class="table-box">
                        <table class="en">
                            <thead>
                                <tr>
                                    <th>ржмрж┐ржнрж╛ржЧ (Category)</th>
                                    <th style="text-align:right">ржорзЛржЯ рж╕рзЗрж▓</th>
                                    <th style="text-align:right">ржЦрж░ржЪ (Cost)</th>
                                    <th style="text-align:right">рж▓рж╛ржн (Profit)</th>
                                </tr>
                            </thead>
                            <tbody id="anaTableBody">
                                <tr><td colspan="4" style="text-align:center">ржбрж╛ржЯрж╛ рж▓рзЛржб ржХрж░рзБржи...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="flex:1; min-width:320px">
                    <h4 style="margin:0 0 15px 0; color:#ef4444">ЁЯУЙ ржЦрж░ржЪрзЗрж░ ржЦрж╛рждрж╕ржорзВрж╣ (ржмрзНрж░рзЗржХржбрж╛ржЙржи)</h4>
                    <div class="table-box" style="max-height: 250px; overflow-y:auto;">
                        <table class="en">
                            <thead><tr><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
                            <tbody id="anaExpBreakdown"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:15px; margin-bottom:20px;">
                 <h3 style="margin:0; color: var(--text-main)">ЁЯУж рж╕рзНржЯржХ ржмрзНржпрж╛рж▓рзЗржирзНрж╕ ржУ ржнрзНржпрж╛рж▓рзБрзЯрзЗрж╢ржи</h3>
                 <button onclick="toggleShortageOnly()" id="shortageBtn" style="width:auto; background:#f59e0b;">тЪая╕П рж╢рзБржзрзБ рж╢рж░рзНржЯрзЗржЬ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрзБржи</button>
            </div>
            
            <div class="stats en" style="margin-bottom:20px;">
                 <div class="card" style="background:#f0fdf4; border:1px solid #10b981">
                    <span>ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ ржнрзНржпрж╛рж▓рзБ (ржХрзЗржирж╛ ржжрж╛ржорзЗ)</span>
                    <b id="stockValue">0</b>
                 </div>
            </div>

            <div class="table-box">
                <table class="en">
                    <thead>
                        <tr>
                            <th>ржкржгрзНржп</th>
                            <th>рж╕рзЗржХрж╢ржи</th>
                            <th>рж╕рзНржЯржХ</th>
                            <th>ржХрзЗржирж╛ ржжрж╛ржо</th>
                            <th>ржорзЛржЯ ржнрзНржпрж╛рж▓рзБ</th>
                            <th>рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕</th>
                        </tr>
                    </thead>
                    <tbody id="stockValuationBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="section">
        <div class="card-glass">
            <h3 style="text-align:center; margin-top:0; color: var(--text-main)">рж░рж┐ржкрзЛрж░рзНржЯ рж╕рзЗржирзНржЯрж╛рж░</h3>
            
            <div style="display:flex; gap:15px; margin-bottom: 25px; justify-content: center; background: #f8fafc; padding: 25px; border-radius: 12px;">
                <input type="date" id="sDate" class="en" style="margin:0; max-width: 220px;">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 30px; background: var(--text-main);">рждрж╛рж░рж┐ржЦ ржЕржирзБржпрж╛рзЯрзА ржЦрзБржБржЬрзБржи</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom: 25px;">
                <button onclick="loadReportData()" style="background:#64748b">рж╕ржХрж▓ ржбрж╛ржЯрж╛ ржжрзЗржЦрзБржи</button>
                <button onclick="downloadExcel('report')" style="background:#10b981;">ЁЯУК Download Excel</button>
                <button onclick="window.print()" style="background:#8b5cf6;">ЁЯЦия╕П ржкрзЗржЬ ржкрзНрж░рж┐ржирзНржЯ</button>
            </div>
            
            <div class="table-box" style="border:1px solid #e2e8f0">
                <table class="en">
                    <thead><tr><th>Memo/ID</th><th>рж╕ржорзЯ</th><th>ржмрж┐ржмрж░ржг/ржХрж╛рж╕рзНржЯржорж╛рж░</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржорзЛржЯ</th><th>ржиржЧржж</th><th>ржмрж╛ржХрж┐</th><th>ржЗржЙржЬрж╛рж░</th><th class="noPrint">ржЕрзНржпрж╛ржХрж╢ржи</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SHORTAGE MODAL -->
<div id="shortageModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#ef4444;">тЪая╕П рж╕рзНржЯржХ рж╢рж░рзНржЯрзЗржЬ рж▓рж┐рж╕рзНржЯ</h3>
        <button onclick="closeModal('shortageModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">├Ч</button>
    </div>
    <div class="table-box">
        <table class="en">
            <thead><tr><th>ржкржгрзНржп</th><th>ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ</th><th>ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ рж▓рзЗржнрзЗрж▓</th></tr></thead>
            <tbody id="shortageModalBody"></tbody>
        </table>
    </div>
</div>

<!-- QUICK STOCK ADD MODAL -->
<div id="quickStockModal" class="modal" style="width:400px">
    <div style="text-align:center; margin-bottom:20px">
        <h3 style="color:#ef4444; margin:0">тЪая╕П рж╕рзНржЯржХ рж╢рзЗрж╖!</h3>
        <p style="color:#64748b; margin-top:5px">ржПржЗ ржкржгрзНржпржЯрж┐ ржмрж┐ржХрзНрж░рж┐ ржХрж░рж╛рж░ ржорждрзЛ ржкрж░рзНржпрж╛ржкрзНржд рж╕рзНржЯржХ ржирзЗржЗред</p>
    </div>
    
    <div style="background:#fef2f2; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #fecaca">
        <p style="margin:0; font-weight:bold; color:#333">ржкржгрзНржп: <span id="qsName"></span></p>
        <p style="margin:5px 0 0 0; color:#ef4444">ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ: <span id="qsCurrent"></span></p>
    </div>

    <input type="hidden" id="qsKey">
    <div class="form-group">
        <label>ржирждрзБржи рж╕рзНржЯржХ ржпрзЛржЧ ржХрж░рзБржи (Add Qty):</label>
        <input id="qsAddQty" type="number" class="en" placeholder="Example: 10, 20..." style="font-size:18px; font-weight:bold">
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
        <button onclick="closeModal('quickStockModal')" style="background:#94a3b8">ржмрж╛рждрж┐рж▓</button>
        <button onclick="saveQuickStock()" style="background:#10b981">рж╕рзНржЯржХ ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
    </div>
</div>

<!-- USER PROFILE MODAL -->
<div id="userProfileModal" class="modal" style="text-align:center">
    <div style="width:80px; height:80px; background:var(--primary); color:#fff; font-size:32px; font-weight:bold; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;" id="modalProfileInit">U</div>
    <h2 id="modalProfileName" style="margin-bottom:5px">User Name</h2>
    <p id="modalProfileRole" style="color:var(--text-light); margin-bottom:20px">Role</p>
    
    <div style="background:#f0fdf4; padding:15px; border-radius:10px; text-align:left; margin-bottom:20px; border:1px solid #bbf7d0">
        <h4 style="margin:0 0 10px 0; color:#15803d">ЁЯУЕ ржЖржЬржХрзЗрж░ ржЖржорж▓ржирж╛ржорж╛ (Today's Report)</h4>
        <p style="margin:5px 0"><strong>ржорзЛржЯ ржПржирзНржЯрзНрж░рж┐:</strong> <span id="upCount">0</span> ржЯрж┐</p>
        <p style="margin:5px 0"><strong>ржорзЛржЯ рж╕рзЗрж▓:</strong> рз│ <span id="upTotal">0</span></p>
    </div>
    
    <div style="background:#f8fafc; padding:15px; border-radius:10px; text-align:left; margin-bottom:20px">
        <p><strong>Status:</strong> <span style="color:#10b981">Active</span></p>
        <p style="font-size:12px; color:#ef4444; margin-top:5px">тД╣я╕П ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржПржбржорж┐ржирзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзБржиред</p>
    </div>
    <button onclick="closeModal('userProfileModal')" style="background:#94a3b8">ржмржирзНржз ржХрж░рзБржи</button>
</div>

<!-- SETTINGS MODAL -->
<div id="appSettingsModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--text-main);">тЪЩя╕П рж╕рзЗржЯрж┐ржВрж╕</h3>
        <button onclick="closeModal('appSettingsModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">├Ч</button>
    </div>

    <h4 style="margin-bottom:15px; color:var(--text-light)">ЁЯОи ржерж┐ржо ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи</h4>
    <div style="display:flex; gap:10px; margin-bottom:20px">
        <button onclick="setTheme('dark')" style="background:#0f172a; border:2px solid #334155">Dark Mode</button>
        <button onclick="setTheme('light')" style="background:#f1f5f9; color:#333; border:2px solid #cbd5e1">Light Mode</button>
    </div>

    <h4 style="margin:25px 0 15px 0; color:var(--text-light)">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ рж╣рзЗржбрж╛рж░ рж╕рзЗржЯржЖржк</h4>
    <div class="form-group">
        <label>ржжрзЛржХрж╛ржирзЗрж░ ржирж╛ржо (ржорзЗржорзЛрждрзЗ ржжрзЗржЦрж╛ржмрзЗ):</label>
        <input id="shopNameInput" placeholder="Sheikh Photocopy & Stationery">
    </div>
    <div class="form-group">
        <label>ржарж┐ржХрж╛ржирж╛:</label>
        <input id="shopAddressInput" placeholder="Kashiani, Gopalganj">
    </div>
    <button onclick="saveSettings()" style="width:100%; background:var(--primary)">рж╕рзЗржн ржХрж░рзБржи</button>
</div>

<!-- VIEW DETAILS MODAL -->
<div id="viewDetailsModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--text-main);">ЁЯУЛ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</h3>
        <button onclick="closeModal('viewDetailsModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">├Ч</button>
    </div>
    
    <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
        <div class="detail-row"><span class="detail-label">ржорзЗржорзЛ ржиржорзНржмрж░:</span> <span class="detail-val" id="vId" style="font-size:18px; font-weight:bold; color:#10b981"></span></div>
        <div class="detail-row"><span class="detail-label">рждрж╛рж░рж┐ржЦ ржУ рж╕ржорзЯ:</span> <span class="detail-val" id="vDate"></span></div>
        <div class="detail-row"><span class="detail-label">ржПржирзНржЯрзНрж░рж┐ ржХрж░рзЗржЫрзЗржи:</span> <span class="detail-val" id="vUser" style="text-transform:capitalize"></span></div>
    </div>

    <div style="background:#eff6ff; padding:20px; border-radius:12px; margin-bottom:20px;">
        <div class="detail-row"><span class="detail-label">ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржирж╛ржо:</span> <span class="detail-val" id="vName"></span></div>
        <div class="detail-row"><span class="detail-label">ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░:</span> <span class="detail-val" id="vPhone"></span></div>
    </div>

    <h4 style="margin:0 0 15px 0; color:var(--text-light);">ЁЯЫТ ржЖржЗржЯрзЗржо рж▓рж┐рж╕рзНржЯ:</h4>
    <div class="table-box" style="box-shadow:none; border:1px solid #e2e8f0; margin-bottom:20px;">
        <table class="en">
            <thead><tr><th>ржмрж┐ржмрж░ржг</th><th style="text-align:center">Qty</th><th style="text-align:right">ржорзЛржЯ</th></tr></thead>
            <tbody id="vItemsBody"></tbody>
        </table>
    </div>

    <div style="background:#fffbeb; padding:20px; border-radius:12px; border:1px solid #fcd34d">
        <div class="detail-row"><span class="detail-label">ржорзЛржЯ ржмрж┐рж▓ (Total):</span> <span class="detail-val" style="font-weight:bold">рз│ <span id="vTotal"></span></span></div>
        <div class="detail-row"><span class="detail-label">ржиржЧржж ржЬржорж╛ (Paid):</span> <span class="detail-val" style="color:#10b981; font-weight:bold">рз│ <span id="vPaid"></span></span></div>
        <div class="detail-row"><span class="detail-label">ржмрж╛ржХрж┐ (Due):</span> <span class="detail-val" style="color:#ef4444; font-weight:bold">рз│ <span id="vDue"></span></span></div>
    </div>

    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('viewDetailsModal')" style="background:#94a3b8; width:auto;">ржмржирзНржз ржХрж░рзБржи</button>
    </div>
</div>

<!-- CUSTOMER ADD/EDIT MODAL -->
<div id="customerModal" class="modal">
    <h3 style="margin-top:0; color:var(--primary); border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">ЁЯСд ржХрж╛рж╕рзНржЯржорж╛рж░ рждржерзНржп</h3>
    <input type="hidden" id="custKey">
    
    <div class="form-group">
        <label>ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржирж╛ржо:</label>
        <input id="custName" placeholder="ржирж╛ржо рж▓рж┐ржЦрзБржи...">
    </div>
    <div class="form-group">
        <label>ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░:</label>
        <input id="custPhone" class="en" maxlength="11" placeholder="017xxxxxxxx">
    </div>

    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('customerModal')" style="background:#94a3b8; width:auto; margin-right:10px">ржмрж╛рждрж┐рж▓</button>
        <button onclick="saveCustomer()" style="background:var(--primary); width:auto;">ЁЯТ╛ рж╕рзЗржн ржХрж░рзБржи</button>
    </div>
</div>

<!-- CUSTOMER HISTORY MODAL -->
<div id="customerHistoryModal" class="modal" style="width:750px">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#3b82f6;">ЁЯУЬ ржХрж╛рж╕рзНржЯржорж╛рж░ рж╣рж┐рж╕рзНржЯрзНрж░рж┐</h3>
        <button onclick="closeModal('customerHistoryModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">├Ч</button>
    </div>
    
    <div style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:20px; font-weight:bold; color:var(--text-main)">
        ржХрж╛рж╕рзНржЯржорж╛рж░: <span id="histName"></span> | ржорзЛржмрж╛ржЗрж▓: <span id="histPhone" class="en"></span>
    </div>

    <div class="table-box" style="max-height:450px; overflow-y:auto">
        <table class="en">
            <thead><tr><th>Memo</th><th>рждрж╛рж░рж┐ржЦ</th><th>ржмрж┐ржмрж░ржг</th><th>ржорзЛржЯ</th><th>ржЬржорж╛</th><th>ржмрж╛ржХрж┐</th></tr></thead>
            <tbody id="histBody"></tbody>
        </table>
    </div>
</div>

<!-- MEMO MODAL (PRINT ONLY) -->
<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0; color:#10b981; font-weight: 800; font-size: 24px;" id="printShopName">рж╢рзЗржЦ ржлржЯрзЛржХржкрж┐ ржПржирзНржб рж╕рзНржЯрзЗрж╢ржирж╛рж░рж┐</h2>
        <p class="address" style="margin:5px 0 0 0; color:#555; font-size: 13px;" id="printShopAddress">ржХрж╛рж╢рж┐рзЯрж╛ржирзА ржЙржкржЬрзЗрж▓рж╛ ржкрж░рж┐рж╖ржжрзЗрж░ рж╕рж╛ржоржирзЗ, ржХрж╛рж╢рж┐рзЯрж╛ржирзА, ржЧрзЛржкрж╛рж▓ржЧржЮрзНржЬред</p>
    </div>
    
    <div class="memo-meta en" style="margin-top:20px; font-size: 13px;">
        <div style="text-align:left; float:left; width: 50%;">
            <p style="margin:2px"><strong>ржорзЗржорзЛ ржиржВ:</strong> <span id="mId" style="font-weight:bold; font-size:16px"></span></p>
            <p style="margin:2px"><strong>рждрж╛рж░рж┐ржЦ:</strong> <span id="mDate"></span></p>
            <p style="margin:2px"><strong>рждрзИрж░рж┐ ржХрж░рзЗржЫрзЗржи:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right; float:right; width: 50%;">
            <p style="margin:2px"><strong>ржХрж╛рж╕рзНржЯржорж╛рж░:</strong> <span id="mNote"></span></p>
            <p style="margin:2px"><strong>ржорзЛржмрж╛ржЗрж▓:</strong> <span id="mPhoneDisp"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
        
    <table style="width:100%; border-collapse:collapse; margin-top:15px; font-size: 13px;">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd; padding:6px; text-align:left">ржмрж┐ржмрж░ржг</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width:60px">Qty</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width:80px">ржЯрж╛ржХрж╛</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    
    <div class="memo-total-area en" style="margin-top:15px; text-align:right; font-size: 14px;">
        <p style="margin:3px">ржорзЛржЯ ржЯрж╛ржХрж╛: рз│<b id="mTotal"></b></p>
        <p style="margin:3px">ржиржЧржж ржкрзНрж░ржжрж╛ржи: рз│<span id="mPaid"></span></p>
        <p style="margin:3px; font-size: 16px;">ржмрж╛ржХрж┐ (Due): рз│<b id="mDueDisplay" style="color:red"></b></p>
    </div>
    
    <div class="signature-area" style="margin-top: 60px; display: flex; justify-content: space-between; font-size: 12px;">
        <div class="signature-box" style="text-align:center; width:120px">
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:30px">ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ рж╕рзНржмрж╛ржХрзНрж╖рж░</p>
        </div>
        <div class="signature-box" style="text-align:center; width:120px">
            <p style="margin:0; font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:5px">ржХрж░рзНрждрзГржкржХрзНрж╖рзЗрж░ рж╕рзНржмрж╛ржХрзНрж╖рж░</p>
        </div>
    </div>
    
    <div style="margin-top:30px; text-align:center; border-top:1px dashed #ccc; padding-top:15px" class="noPrint">
        <button onclick="window.print()" style="width:auto; padding:8px 20px; font-size: 14px;">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзБржи</button>
        <button onclick="closeModal('memoModal')" style="background:#ef4444; width:auto; padding:8px 20px; font-size: 14px;">ржмржирзНржз ржХрж░рзБржи</button>
    </div>
</div>

<!-- ENTRY EDIT MODAL -->
<div id="editEntryModal" class="modal">
    <h3 style="margin-top:0; color:#f59e0b; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">тЬПя╕П ржПржирзНржЯрзНрж░рж┐ ржПржбрж┐ржЯ ржХрж░рзБржи</h3>
    <input type="hidden" id="editEntryKey">
    
    <div class="form-group">
        <label>ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржирж╛ржо:</label>
        <input id="editEntryNote">
    </div>
    <div class="form-group">
        <label>ржорзЛржмрж╛ржЗрж▓:</label>
        <input id="editEntryPhone" class="en" maxlength="11">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
        <div class="form-group">
            <label>ржорзЛржЯ ржЯрж╛ржХрж╛ (Total):</label>
            <input id="editEntryTotal" type="number" class="en" oninput="calcEditDue()">
        </div>
        <div class="form-group">
            <label>ржиржЧржж ржЧрзНрж░рж╣ржг (Paid):</label>
            <input id="editEntryTaken" type="number" class="en" oninput="calcEditDue()">
        </div>
    </div>
    <div class="form-group">
        <label>ржмрж╛ржХрж┐ (Due):</label>
        <input id="editEntryDue" readonly class="en" style="background:#fef2f2; color:#ef4444; font-weight:bold">
    </div>

    <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f1f5f9; padding-top:20px;">
        <button onclick="deleteFromEdit()" style="background:#ef4444; width:auto;">ЁЯЧСя╕П ржбрж┐рж▓рж┐ржЯ ржХрж░рзБржи</button>
        <div>
            <button onclick="closeModal('editEntryModal')" style="background:#94a3b8; width:auto; margin-right:10px">ржмрж╛рждрж┐рж▓</button>
            <button onclick="saveEditEntry()" style="background:var(--primary); width:auto;">ЁЯТ╛ ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
        </div>
    </div>
</div>

<!-- PRODUCT EDIT MODAL -->
<div id="editProductModal" class="modal">
    <h3 style="margin-top:0; color:#3b82f6; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">ЁЯУж ржкржгрзНржп ржПржбрж┐ржЯ ржХрж░рзБржи</h3>
    <input type="hidden" id="editProdKey">
    
    <div class="form-group"><label>ржкржгрзНржпрзЗрж░ ржирж╛ржо:</label><input id="editProdName"></div>
    <div class="form-group"><label>ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐:</label><input id="editProdCat"></div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
        <div class="form-group"><label>рж╕рзНржЯржХ (Qty):</label><input id="editProdQty" type="number" class="en"></div>
        <div class="form-group"><label>рж╕рждрж░рзНржХрждрж╛ рж▓рзЗржнрзЗрж▓:</label><input id="editProdAlert" type="number" class="en"></div>
        <div class="form-group"><label>ржмрж┐ржХрзНрж░рзЯ ржорзВрж▓рзНржп:</label><input id="editProdSell" type="number" class="en"></div>
    </div>

    <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f1f5f9; padding-top:20px;">
        <button onclick="deleteProductFromEdit()" style="background:#ef4444; width:auto;">ЁЯЧСя╕П ржбрж┐рж▓рж┐ржЯ ржХрж░рзБржи</button>
        <div>
            <button onclick="closeModal('editProductModal')" style="background:#94a3b8; width:auto; margin-right:10px">ржмрж╛рждрж┐рж▓</button>
            <button onclick="saveEditProduct()" style="background:var(--primary); width:auto;">ЁЯТ╛ ржЖржкржбрзЗржЯ ржХрж░рзБржи</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- SOUND EFFECTS ---
function playSound(type) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);

    if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    } else if (type === 'error') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'warning') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(300, ctx.currentTime);
        gain.gain.setValueAtTime(0.05, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        osc.start();
        osc.stop(ctx.currentTime + 0.2);
    }
}

// --- STATE VARIABLES ---
let currentUser = "";
let allProducts = [];
let allEntries = []; 
let allCustomers = [];
let allExpenses = [];
let cart = [];
let salesChart = null;
let isShortageView = false;
let customerStats = []; 

// --- INITIALIZATION ---
window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
    
    const d = new Date();
    document.getElementById("anMonth").value = d.getMonth() + 1;
    document.getElementById("anYear").value = d.getFullYear();
    document.getElementById("sDate").valueAsDate = new Date();
    
    // Load Theme & Settings
    const savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);
    loadShopSettings();
    
    updateOnlineStatus();
};

// --- ONLINE STATUS CHECKER ---
function updateOnlineStatus() {
    const statusEl = document.getElementById('connectionStatus');
    if(navigator.onLine) {
        statusEl.innerHTML = 'тЧП ржЕржирж▓рж╛ржЗржи';
        statusEl.className = 'footer-val status-online';
    } else {
        statusEl.innerHTML = 'тЧП ржЕржлрж▓рж╛ржЗржи';
        statusEl.className = 'footer-val status-offline';
        showToast("ржЗржирзНржЯрж╛рж░ржирзЗржЯ рж╕ржВржпрзЛржЧ ржмрж┐ржЪрзНржЫрж┐ржирзНржи! ЁЯФ┤", "error");
    }
}
window.addEventListener('online', () => { updateOnlineStatus(); showToast("ржЗржирзНржЯрж╛рж░ржирзЗржЯ ржХрж╛ржирзЗржХрж╢ржи ржЖржЫрзЗ ЁЯЯв", "success"); });
window.addEventListener('offline', updateOnlineStatus);

// --- TOAST NOTIFICATION SYSTEM ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'тЬЕ';
    if(type === 'error') icon = 'тЭМ';
    if(type === 'warning') icon = 'тЪая╕П';
    
    toast.innerHTML = `<span>${icon} ${message}</span>`;
    container.appendChild(toast);
    
    playSound(type); 
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => { toast.remove(); }, 300);
    }, 3000);
}

// --- AUTHENTICATION ---
function login(){
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();
    const users = {admin:"123", owner:"456", roky:"789"};
    
    if(users[u] === p){ 
        localStorage.setItem("loggedInUser", u); 
        showToast(`рж╕рзНржмрж╛ржЧрждржо, ${u.toUpperCase()}!`, "success"); 
        setTimeout(() => setupUser(u), 1000); 
    } else { 
        showToast("ржнрзБрж▓ ржЗржЙржЬрж╛рж░ржирзЗржо ржмрж╛ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб!", "error");
    }
}

function setupUser(u) {
    currentUser = u; 
    document.getElementById("loginDiv").style.display = "none"; 
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "block"; 
    document.getElementById("menuBtn").style.display = "block";
    document.getElementById("profileBtn").style.display = "flex"; 
    
    const userRole = u === 'admin' ? 'ржЕрзНржпрж╛ржбржорж┐ржи' : (u === 'owner' ? 'ржорж╛рж▓рж┐ржХ' : 'рж╕рзЗржирж╛ржкрждрж┐');
    document.getElementById("userShow").innerHTML = `рж╕рзНржмрж╛ржЧрждржо, <b style="text-transform:uppercase; color:#fff">${u}</b> (${userRole})`;
    document.getElementById("pName").innerText = u.toUpperCase(); 
    
    // Update Profile Modal Info
    document.getElementById("modalProfileName").innerText = u.toUpperCase();
    document.getElementById("modalProfileRole").innerText = userRole;
    document.getElementById("modalProfileInit").innerText = u.charAt(0).toUpperCase();
    
    loadAllProducts(); 
    loadEntries(); 
    loadAllCustomers();
    loadExpenses();
    showSection('dashboard');
    setupLiveSearch();
}

function logout() { 
    localStorage.removeItem("loggedInUser"); 
    location.reload(); 
}

// --- PROFILE & SETTINGS LOGIC ---
function toggleProfile() {
    const menu = document.getElementById("profileMenu");
    const overlay = document.getElementById("overlay");
    if(menu.style.display === "block") {
        menu.style.display = "none";
        overlay.style.display = "none";
    } else {
        menu.style.display = "block";
        overlay.style.display = "block";
    }
}
function closeProfile() {
    document.getElementById("profileMenu").style.display = "none";
}

function openProfileModal() {
    closeProfile();
    
    // Calculate Today's Stats for Current User
    const today = new Date().toLocaleDateString("en-GB");
    let count = 0;
    let total = 0;
    
    allEntries.forEach(e => {
        if(e.user === currentUser && e.date === today) {
            count++;
            total += parseFloat(e.total) || 0;
        }
    });
    
    document.getElementById("upCount").innerText = count;
    document.getElementById("upTotal").innerText = total.toLocaleString();
    
    document.getElementById("userProfileModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function openSettingsModal() {
    closeProfile();
    document.getElementById("appSettingsModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    
    // Load current settings
    document.getElementById("shopNameInput").value = localStorage.getItem("shopName") || "Sheikh Photocopy & Stationery";
    document.getElementById("shopAddressInput").value = localStorage.getItem("shopAddress") || "Kashiani, Gopalganj";
}

function saveSettings() {
    const name = document.getElementById("shopNameInput").value;
    const addr = document.getElementById("shopAddressInput").value;
    
    localStorage.setItem("shopName", name);
    localStorage.setItem("shopAddress", addr);
    
    loadShopSettings();
    showToast("рж╕рзЗржЯрж┐ржВрж╕ рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ!", "success");
    closeModal("appSettingsModal");
}

function loadShopSettings() {
    const name = localStorage.getItem("shopName") || "Sheikh Photocopy & Stationery";
    const addr = localStorage.getItem("shopAddress") || "Kashiani, Gopalganj";
    
    document.getElementById("printShopName").innerText = name;
    document.getElementById("printShopAddress").innerText = addr;
}

function setTheme(themeName) {
    const body = document.body;
    if(themeName === 'light') {
        body.classList.add('light-theme');
    } else {
        body.classList.remove('light-theme');
    }
    localStorage.setItem("theme", themeName);
}

// --- CATEGORY & DROPDOWN ---
function updateCategories() {
    const section = document.getElementById("sectionSelect").value;
    const catSelect = document.getElementById("categorySelect");
    const prodSelect = document.getElementById("productSelect");
    
    catSelect.innerHTML = '<option value="">ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржи...</option>';
    prodSelect.innerHTML = '<option value="">-- ржЖржЧрзЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржжрж┐ржи --</option>';
    
    if(!section) {
        catSelect.innerHTML = '<option value="">-- ржЖржЧрзЗ ржмрж┐ржнрж╛ржЧ ржжрж┐ржи --</option>';
        return;
    }
    
    const filtered = allProducts.filter(p => p.mainType === section);
    const uniqueCategories = [...new Set(filtered.map(p => p.category))].filter(Boolean).sort();
    
    uniqueCategories.forEach(c => {
        catSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
}

function loadProductsByCategory() {
    const selectedCat = document.getElementById("categorySelect").value;
    const selectedSection = document.getElementById("sectionSelect").value;
    const prodSelect = document.getElementById("productSelect");
    
    prodSelect.innerHTML = '<option value="">ржкржгрзНржп рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржи...</option>';
    if (!selectedCat) {
        prodSelect.innerHTML = '<option value="">-- ржЖржЧрзЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржжрж┐ржи --</option>';
        return;
    }
    
    const filteredProducts = allProducts.filter(p => p.category === selectedCat && p.mainType === selectedSection);
    
    filteredProducts.forEach(p => {
        prodSelect.innerHTML += `<option value="${p.key}">${p.name} (рж╕рзНржЯржХ: ${p.isService ? 'Service' : p.qty})</option>`;
    });
}

function productSelectedFromDropdown() {
    const prodKey = document.getElementById("productSelect").value;
    if (!prodKey) return;
    selectProductFromSearch(prodKey);
}

// --- LIVE SEARCH ---
function setupLiveSearch() {
    const searchInput = document.getElementById("searchSerial");
    const liveResults = document.getElementById("liveSearchResults");
    
    searchInput.addEventListener('input', function(e) {
        const query = this.value.trim();
        if(query.length === 0) {
            liveResults.style.display = 'none';
            return;
        }
        
        const productResults = allProducts.filter(p => 
            (p.serial && String(p.serial).toLowerCase().includes(query.toLowerCase())) ||
            (p.name && p.name.toLowerCase().includes(query.toLowerCase())) ||
            (p.category && p.category.toLowerCase().includes(query.toLowerCase()))
        );
        
        if(productResults.length > 0) {
            let html = '';
            productResults.forEach(p => {
                const alertLevel = p.alertLevel || 5; 
                const isLowStock = !p.isService && p.qty <= alertLevel;
                const typeIcon = p.mainType === 'Computer' ? 'ЁЯТ╗' : (p.mainType === 'Photocopy' ? 'ЁЯУД' : 'ЁЯЫНя╕П');

                html += `
                <div class="search-item" onclick="selectProductFromSearch('${p.key}')">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main)">${typeIcon} ${p.name}</div>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <span class="serial" style="color:#64748b; font-size:12px">${p.serial || 'No Serial'}</span>
                            <span class="category" style="background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:12px">${p.category}</span>
                            ${!p.isService ? `<span class="stock" style="font-size:12px">рж╕рзНржЯржХ: ${p.qty}</span>` : '<span class="category" style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:12px">Service</span>'}
                            ${isLowStock ? '<span style="color:#ef4444; font-size:11px; font-weight:bold">тЪая╕П рж▓рзЛ рж╕рзНржЯржХ</span>' : ''}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:bold; color:#10b981">рз│${p.sellPrice}</div>
                    </div>
                </div>`;
            });
            liveResults.innerHTML = html;
            liveResults.style.display = 'block';
        } else {
            liveResults.innerHTML = '<div class="search-item" style="color:#666; justify-content:center;">ржХрзЛржирзЛ ржкржгрзНржп ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐</div>';
            liveResults.style.display = 'block';
        }
    });
    
    document.addEventListener('click', function(e) {
        if(!searchInput.contains(e.target) && !liveResults.contains(e.target)) {
            liveResults.style.display = 'none';
        }
    });
}

function selectProductFromSearch(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if(!product) return;
    
    const typeName = product.mainType === 'Computer' ? 'Computer Side' : (product.mainType === 'Photocopy' ? 'Photocopy Side' : 'General Sales');
    const msg = `ржкржгрзНржп: ${product.name}\nржмрж┐ржнрж╛ржЧ: ${typeName}\nржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐: ${product.category}\n\nржЖржкржирж┐ ржХрж┐ ржПржЯрж┐ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рждрзЗ ржЪрж╛ржи?`;
    
    if(!confirm(msg)) return;

    document.getElementById('selectedProductKey').value = productKey;
    
    const sectionSelect = document.getElementById("sectionSelect");
    const catSelect = document.getElementById("categorySelect");
    const prodSelect = document.getElementById("productSelect");
    
    sectionSelect.value = product.mainType;
    updateCategories(); 
    catSelect.value = product.category;
    loadProductsByCategory(); 
    prodSelect.value = productKey;

    document.getElementById('rate').value = product.sellPrice;
    document.getElementById('qty').value = 1;
    document.getElementById('liveSearchResults').style.display = 'none';
    document.getElementById('searchSerial').value = '';
    document.getElementById('stockLiveMsg').innerText = "";
    
    setTimeout(() => {
        document.getElementById('qty').focus();
        document.getElementById('qty').select();
        checkStockLive(); 
    }, 100);
}

// --- PRODUCT & STOCK ---
function loadAllProducts(){
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        let maxSerial = 0;
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key;
            allProducts.push(p);
            
            const s = parseInt(p.serial);
            if(!isNaN(s) && s > maxSerial) maxSerial = s;
        });
        
        document.getElementById("stSerial").value = maxSerial + 1;
        
        updateStockTable();
        updateStockValuationTable();
        checkGlobalStockStatus(); 
    });
}

function checkGlobalStockStatus() {
    const shortages = allProducts.filter(p => !p.isService && p.qty <= (p.alertLevel || 5));
    const alertBtn = document.getElementById("globalStockAlert");
    const alertText = document.getElementById("alertText");
    
    if (shortages.length > 0) {
        alertBtn.style.display = "flex";
        alertText.innerText = `${shortages.length} Items Low Stock`;
    } else {
        alertBtn.style.display = "none";
    }
}

function showShortageModal() {
    const shortages = allProducts.filter(p => !p.isService && p.qty <= (p.alertLevel || 5));
    const tbody = document.getElementById("shortageModalBody");
    tbody.innerHTML = "";
    
    shortages.forEach(p => {
        tbody.innerHTML += `
        <tr>
            <td>${p.name} <br><small style="color:#666">${p.category}</small></td>
            <td style="color:#ef4444; font-weight:bold">${p.qty}</td>
            <td>${p.alertLevel || 5}</td>
        </tr>`;
    });
    
    document.getElementById("shortageModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// --- QUICK STOCK ADD LOGIC ---
function openQuickStockModal(key, name, currentQty) {
    document.getElementById("qsKey").value = key;
    document.getElementById("qsName").innerText = name;
    document.getElementById("qsCurrent").innerText = currentQty;
    document.getElementById("qsAddQty").value = "";
    
    document.getElementById("quickStockModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    document.getElementById("qsAddQty").focus();
}

function saveQuickStock() {
    const key = document.getElementById("qsKey").value;
    const addQty = parseFloat(document.getElementById("qsAddQty").value);
    
    if(!addQty || addQty <= 0) return showToast("рж╕ржарж┐ржХ ржкрж░рж┐ржорж╛ржг ржжрж┐ржи!", "error");
    
    const product = allProducts.find(p => p.key === key);
    if(!product) return;
    
    const newTotal = parseFloat(product.qty) + addQty;
    
    db.ref("products/" + key).update({ qty: newTotal }).then(() => {
        showToast("рж╕рзНржЯржХ ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ! ржПржЦржи ржмрж┐ржХрзНрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред", "success");
        closeModal("quickStockModal");
        checkStockLive();
    });
}

function toggleStockInput(){
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    const alertInput = document.getElementById("stAlert");
    
    if(isService){
        qtyInput.value = ""; qtyInput.placeholder = "ржкрзНрж░ржпрзЛржЬрзНржп ржирзЯ"; qtyInput.disabled = true; qtyInput.style.background = "#f1f5f9";
        alertInput.disabled = true; alertInput.style.background = "#f1f5f9";
        costInput.disabled = true; costInput.style.background = "#f1f5f9"; costInput.value = "";
    } else {
        qtyInput.disabled = false; qtyInput.placeholder = "Qty"; qtyInput.style.background = "#fff";
        alertInput.disabled = false; alertInput.style.background = "#fff";
        costInput.disabled = false; costInput.placeholder = "Cost"; costInput.style.background = "#fff";
    }
}

function addNewProduct(){
    const serial = document.getElementById("stSerial").value.trim();
    const mainType = document.getElementById("stMainType").value;
    const cat = document.getElementById("stCategory").value.trim();
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    const alertLvl = parseFloat(document.getElementById("stAlert").value) || 5;
    
    let qty = 0, cost = 0;
    
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    
    if(!cat || !name || !sell) return showToast("Category, Name ржПржмржВ Sell Price ржЕржмрж╢рзНржпржЗ ржжрж┐рждрзЗ рж╣ржмрзЗ!", "error");
    if(sell < 0 || cost < 0 || qty < 0) return showToast("ржирзЗржЧрзЗржЯрж┐ржн рж╕ржВржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ ржпрж╛ржмрзЗ ржирж╛!", "error");

    const newProd = { serial, mainType, category: cat, name, qty, isService, costPrice: cost, sellPrice: sell, alertLevel: alertLvl };
    
    db.ref("products").push(newProd).then(()=>{
        showToast("рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрзБржХрзНржд рж╣рзЯрзЗржЫрзЗ!", "success");
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stAlert").value = "";
    });
}

function updateStockTable() {
    const stockBody = document.getElementById("stockBody");
    stockBody.innerHTML = "";
    
    allProducts.forEach(p => {
        const stockDisplay = p.isService ? `<span class="service-badge" style="background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px; font-size:11px">Service</span>` : p.qty;
        const typeBadge = p.mainType === 'Computer' ? 'ЁЯТ╗ Comp' : (p.mainType === 'Photocopy' ? 'ЁЯУД Photo' : 'ЁЯЫНя╕П Gen');
        const alertDisplay = p.isService ? '-' : (p.alertLevel || 5);
        
        stockBody.innerHTML += `<tr>
            <td><small>${typeBadge}</small></td>
            <td>${p.serial || '-'}</td>
            <td>${p.category}</td>
            <td>${p.name}</td>
            <td>${stockDisplay}</td>
            <td>${alertDisplay}</td>
            <td>${p.costPrice || 0}</td>
            <td>${p.sellPrice}</td>
            <td>
                <button class="btn-action btn-edit" onclick="openProductEdit('${p.key}')">тЬПя╕П</button>
            </td>
        </tr>`;
    });
}

// --- PRODUCT EDIT LOGIC ---
function openProductEdit(key) {
    const p = allProducts.find(x => x.key === key);
    if(!p) return;
    
    document.getElementById("editProdKey").value = key;
    document.getElementById("editProdName").value = p.name;
    document.getElementById("editProdCat").value = p.category;
    document.getElementById("editProdQty").value = p.qty;
    document.getElementById("editProdSell").value = p.sellPrice;
    document.getElementById("editProdAlert").value = p.alertLevel || 5;
    
    if(p.isService) {
        document.getElementById("editProdQty").disabled = true;
        document.getElementById("editProdQty").value = "";
        document.getElementById("editProdAlert").disabled = true;
    } else {
        document.getElementById("editProdQty").disabled = false;
        document.getElementById("editProdAlert").disabled = false;
    }
    
    document.getElementById("editProductModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveEditProduct() {
    const key = document.getElementById("editProdKey").value;
    const name = document.getElementById("editProdName").value;
    const cat = document.getElementById("editProdCat").value;
    const sell = parseFloat(document.getElementById("editProdSell").value);
    const qty = parseFloat(document.getElementById("editProdQty").value) || 0;
    const alertLvl = parseFloat(document.getElementById("editProdAlert").value) || 5;
    
    db.ref("products/" + key).update({
        name: name,
        category: cat,
        sellPrice: sell,
        qty: qty,
        alertLevel: alertLvl
    }).then(() => {
        showToast("ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ!", "success");
        closeModal("editProductModal");
    });
}

function deleteProductFromEdit() {
    const key = document.getElementById("editProdKey").value;
    if(currentUser === 'owner' || currentUser === 'admin'){ 
        if(confirm("рж╕рждрж░рзНржХрждрж╛: ржЖржЗржЯрзЗржоржЯрж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рждрзЗ ржЪрж╛ржи?")) {
            db.ref("products/"+key).remove();
            closeModal("editProductModal");
            showToast("ржбрж┐рж▓рж┐ржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ", "warning");
        }
    } else { 
        showToast("рж╢рзБржзрзБржорж╛рждрзНрж░ ржорж╛рж▓рж┐ржХ ржмрж╛ ржПржбржорж┐ржи ржбрж┐рж▓рж┐ржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред", "error"); 
    }
}

// --- SALES & CART ---
function checkStockLive() {
    const productKey = document.getElementById("selectedProductKey").value;
    const qtyInput = document.getElementById("qty");
    const msgSpan = document.getElementById("stockLiveMsg");
    
    if(!productKey) return;
    
    const product = allProducts.find(p => p.key === productKey);
    if(!product || product.isService) {
        msgSpan.style.display = "none";
        return;
    }
    
    const reqQty = parseFloat(qtyInput.value) || 0;
    if(reqQty > product.qty) {
        msgSpan.innerText = `тЪая╕П рж╕рзНржЯржХ ржирзЗржЗ! ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ: ${product.qty}`;
        msgSpan.style.display = "block";
        qtyInput.classList.add("invalid");
    } else {
        msgSpan.style.display = "none";
        qtyInput.classList.remove("invalid");
    }
}

function addToCart(){
    const productKey = document.getElementById("selectedProductKey").value;
    if(!productKey) return showToast("ржкрзНрж░ржержорзЗ ржПржХржЯрж┐ ржкржгрзНржп рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржи!", "error");
    
    const product = allProducts.find(p => p.key === productKey);
    if(!product) return showToast("ржкржгрзНржп ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐!", "error");
    
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    
    if(!r || r <= 0) return showToast("ржжрж░ рж╕ржарж┐ржХ ржжрж┐ржи", "error");
    if(q <= 0) return showToast("ржкрж░рж┐ржорж╛ржг ржЕржирзНрждржд рзз рж╣рждрзЗ рж╣ржмрзЗ", "error");
    
    if(!product.isService) {
        let currentCartQty = 0;
        const existingItemIndex = cart.findIndex(item => item.key === productKey);
        if(existingItemIndex !== -1) {
            currentCartQty = cart[existingItemIndex].qty;
        }

        const totalReq = currentCartQty + q;

        if(product.qty <= 0 || totalReq > product.qty) {
            playSound('error');
            if(currentCartQty > 0) {
                showToast(`тЭМ ржХрж╛рж░рзНржЯрзЗ ржЗрждрж┐ржоржзрзНржпрзЗ ${currentCartQty}ржЯрж┐ ржЖржЫрзЗред рж╕рзНржЯржХрзЗ ржЖржЫрзЗ ${product.qty}ржЯрж┐ред`, "error");
            } else {
                openQuickStockModal(product.key, product.name, product.qty);
            }
            return; 
        }
        
        if((product.qty - totalReq) <= (product.alertLevel || 5)) {
            showToast("тЪая╕П рж╕рждрж░рзНржХрждрж╛: ржПржЗ ржкржгрзНржпрзЗрж░ рж╕рзНржЯржХ ржЦрзБржм ржХржорзЗ ржпрж╛ржЪрзНржЫрзЗ!", "warning");
        }
    }
    
    const existingItemIndex = cart.findIndex(item => item.key === productKey);
    
    if(existingItemIndex !== -1) {
        cart[existingItemIndex].qty += q;
        cart[existingItemIndex].sub = cart[existingItemIndex].qty * cart[existingItemIndex].rate;
    } else {
        cart.push({ 
            key: productKey, 
            work: product.name, 
            category: product.category,
            mainType: product.mainType || "General",
            cost: product.costPrice || 0,
            qty: q, 
            rate: r, 
            sub: q * r, 
            isService: product.isService 
        });
    }
    
    renderCart(); 
    document.getElementById("selectedProductKey").value = "";
    document.getElementById("sectionSelect").value = "";
    document.getElementById("categorySelect").innerHTML = '<option value="">-- ржЖржЧрзЗ ржмрж┐ржнрж╛ржЧ ржжрж┐ржи --</option>';
    document.getElementById("productSelect").innerHTML = '<option value="">-- ржЖржЧрзЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржжрж┐ржи --</option>';
    document.getElementById("rate").value = "";
    document.getElementById("qty").value = 1;
    document.getElementById("stockLiveMsg").style.display = "none";
    document.getElementById("qty").classList.remove("invalid");
    document.getElementById("searchSerial").focus();
    showToast("ржХрж╛рж░рзНржЯрзЗ ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗ", "success");
}

function renderCart(){
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    
    let grandTotal = 0;
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `
            <div class="cart-item">
                <div>
                    <div style="font-weight:bold; color:var(--text-main)">${item.work}</div>
                    <div style="font-size:12px; color:#64748b">${item.mainType} | ${item.qty} x рз│${item.rate}</div>
                </div>
                <div>
                    <b style="color:var(--primary)">рз│${item.sub}</b> 
                    <span onclick="removeCart(${index})" style="color:#ef4444;cursor:pointer;margin-left:10px;font-weight:bold">тЬХ</span>
                </div>
            </div>`;
    });
    document.getElementById("total").value = grandTotal; 
    calcDue();
}

function removeCart(index){ 
    cart.splice(index,1); 
    renderCart(); 
}

function calcDue(){ 
    const t = parseFloat(document.getElementById("total").value) || 0;
    const k = parseFloat(document.getElementById("taken").value) || 0;
    const diff = t - k;
    
    const dueLabel = document.getElementById("dueLabel");
    const dueInput = document.getElementById("due");
    
    if(diff < 0) {
        dueLabel.innerText = "ржлрзЗрж░ржд (Change):";
        dueLabel.style.color = "#10b981";
        dueInput.style.color = "#10b981";
        dueInput.style.background = "#f0fdf4";
        dueInput.value = Math.abs(diff);
    } else {
        dueLabel.innerText = "ржмрж╛ржХрж┐ (Due):";
        dueLabel.style.color = "#ef4444";
        dueInput.style.color = "#ef4444";
        dueInput.style.background = "#fef2f2";
        dueInput.value = diff;
    }
}

function validatePhoneLive(input) {
    const val = input.value.replace(/\D/g, '');
    input.value = val;
    
    const errorSpan = document.getElementById("phoneError");
    const bdPhoneRegex = /^01[3-9][0-9]{8}$/;
    
    if(val.length > 0) {
        if(!val.startsWith("01")) {
            errorSpan.style.display = "block";
            input.classList.add("invalid");
            input.classList.remove("valid");
        } else if(val.length === 11) {
            if(bdPhoneRegex.test(val)) {
                errorSpan.style.display = "none";
                input.classList.remove("invalid");
                input.classList.add("valid");
                autoFormatPhone(input);
            } else {
                errorSpan.style.display = "block";
                input.classList.add("invalid");
            }
        } else {
            errorSpan.style.display = "none";
            input.classList.remove("invalid");
            input.classList.remove("valid");
        }
    } else {
        errorSpan.style.display = "none";
        input.classList.remove("invalid");
    }
}

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            db.ref("products/" + cItem.key).update({ qty: newQty });
        }
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return showToast("ржХрж╛рж░рзНржЯ ржЦрж╛рж▓рж┐!", "error");
    
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    let noteVal = document.getElementById("note").value.trim();
    const phoneVal = document.getElementById("phone").value.trim();
    
    if(!noteVal) noteVal = "General Customer";
    
    if(phoneVal.length > 0) {
        const bdPhoneRegex = /^01[3-9][0-9]{8}$/;
        if(!bdPhoneRegex.test(phoneVal)) {
            showToast("тЭМ ржнрзБрж▓ ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░! рззрзз ржбрж┐ржЬрж┐ржЯ рж╣рждрзЗ рж╣ржмрзЗред", "error");
            return;
        }
    }
    
    const now = new Date();
    const isoDate = now.toISOString().split('T')[0];
    
    let actualDue = totalVal - takenVal;
    if(actualDue < 0) actualDue = 0;
    
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"), 
        isoDate: isoDate, 
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: actualDue, 
        user: currentUser,
        note: noteVal,
        phone: phoneVal
    };
    
    if(phoneVal) {
        const customerExists = allCustomers.some(c => c.phone === phoneVal);
        if(!customerExists) {
            db.ref("customers").push({ name: noteVal, phone: phoneVal });
        }
    }
    
    db.ref("entries").push(entryData).then((snap) => {
        deductStock(cart);
        if(showMemoFlag) {
             entryData.key = snap.key;
             showMemo(entryData);
             // REMOVED AUTO PRINT TIMEOUT
        } else {
             showToast("тЬЕ рж╕ржлрж▓ржнрж╛ржмрзЗ рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ!", "success");
        }
        cart = []; 
        renderCart(); 
        document.getElementById("note").value = ""; 
        document.getElementById("phone").value = ""; 
        document.getElementById("taken").value = ""; 
        document.getElementById("due").value = "0";
        document.getElementById("phoneSuggestion").textContent = "";
        document.getElementById("phone").classList.remove("valid");
    });
}

// --- EXPENSE MANAGEMENT ---
function saveExpense() {
    const desc = document.getElementById("expDesc").value.trim();
    const cat = document.getElementById("expCat").value;
    const amount = parseFloat(document.getElementById("expAmount").value);
    
    if(!desc && isNaN(amount)) {
        showToast("тЪая╕П ржмрж┐ржмрж░ржг ржПржмржВ ржЯрж╛ржХрж╛рж░ ржкрж░рж┐ржорж╛ржг ржжрж┐ржи!", "error");
        return;
    }
    if(!desc) {
        showToast("тЪая╕П ржЦрж░ржЪрзЗрж░ ржмрж┐ржмрж░ржг рж▓рж┐ржЦрзБржи!", "error");
        return;
    }
    if(isNaN(amount) || amount <= 0) {
        showToast("тЪая╕П рж╕ржарж┐ржХ ржЯрж╛ржХрж╛рж░ ржкрж░рж┐ржорж╛ржг ржжрж┐ржи!", "error");
        return;
    }
    
    const expenseData = {
        date: new Date().toLocaleDateString("en-GB"),
        desc: desc,
        category: cat,
        amount: amount,
        user: currentUser
    };
    
    db.ref("expenses").push(expenseData).then(() => {
        showToast("ржЦрж░ржЪ рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ!", "success");
        document.getElementById("expDesc").value = "";
        document.getElementById("expAmount").value = "";
    });
}

function loadExpenses() {
    db.ref("expenses").on("value", s => {
        allExpenses = [];
        let totalExp = 0;
        const tbody = document.getElementById("expenseBody");
        tbody.innerHTML = "";
        
        s.forEach(c => {
            let e = c.val();
            e.key = c.key;
            allExpenses.push(e);
            totalExp += parseFloat(e.amount) || 0;
            
            tbody.innerHTML += `
            <tr>
                <td>${e.date}</td>
                <td>${e.desc}</td>
                <td>${e.category}</td>
                <td>${e.amount}</td>
                <td><button class="btn-action btn-delete" onclick="deleteExpense('${e.key}')">ЁЯЧСя╕П</button></td>
            </tr>`;
        });
        document.getElementById("totalExpenseDisplay").innerText = totalExp;
        
        if(document.getElementById("analytics").style.display === "block") {
            generateAnalytics();
        }
    });
}

function deleteExpense(key) {
    if(confirm("ржЦрж░ржЪржЯрж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рждрзЗ ржЪрж╛ржи?")) {
        db.ref("expenses/"+key).remove();
        showToast("ржЦрж░ржЪ ржбрж┐рж▓рж┐ржЯ рж╣рзЯрзЗржЫрзЗ", "warning");
    }
}

// --- ANALYTICS ---
function generateAnalytics() {
    const month = parseInt(document.getElementById("anMonth").value);
    const year = parseInt(document.getElementById("anYear").value);
    
    let totalSale = 0;
    let totalProductCost = 0;
    
    let cats = {
        "General": {sale:0, cost:0},
        "Computer": {sale:0, cost:0},
        "Photocopy": {sale:0, cost:0},
        "Other": {sale:0, cost:0}
    };
    
    allEntries.forEach(entry => {
        const [d, m, y] = entry.date.split('/'); 
        
        if(parseInt(y) !== year) return;
        if(month !== 0 && parseInt(m) !== month) return;
        
        if(entry.items && Array.isArray(entry.items)) {
            entry.items.forEach(item => {
                const iSale = parseFloat(item.sub) || 0;
                const iCost = (parseFloat(item.cost) || 0) * (parseFloat(item.qty) || 0);
                
                let type = item.mainType || "Other";
                if(!cats[type]) type = "Other";
                
                cats[type].sale += iSale;
                cats[type].cost += iCost;
                
                totalSale += iSale;
                totalProductCost += iCost;
            });
        } else {
            const iSale = parseFloat(entry.total) || 0;
            cats["Other"].sale += iSale;
            totalSale += iSale;
        }
    });

    let totalExpense = 0;
    let expenseByCat = {};

    allExpenses.forEach(exp => {
        const [d, m, y] = exp.date.split('/');
        
        if(parseInt(y) !== year) return;
        if(month !== 0 && parseInt(m) !== month) return;

        const amount = parseFloat(exp.amount) || 0;
        totalExpense += amount;

        if(!expenseByCat[exp.category]) expenseByCat[exp.category] = 0;
        expenseByCat[exp.category] += amount;
    });
    
    const grossProfit = totalSale - totalProductCost;
    const netProfit = grossProfit - totalExpense;
    
    document.getElementById("anaSale").innerText = totalSale.toLocaleString();
    document.getElementById("anaCost").innerText = totalProductCost.toLocaleString();
    document.getElementById("anaGross").innerText = grossProfit.toLocaleString();
    document.getElementById("anaExpense").innerText = totalExpense.toLocaleString();
    
    const netEl = document.getElementById("anaNet");
    const netTitle = document.getElementById("netProfitTitle");
    
    netEl.innerText = netProfit.toLocaleString();
    
    if(netProfit < 0) {
        netTitle.innerText = "NET LOSS тЪая╕П";
        netTitle.style.color = "#ef4444";
        netEl.style.color = "#ef4444";
    } else {
        netTitle.innerText = "NET PROFIT";
        netTitle.style.color = "#64748b";
        netEl.style.color = "#10b981";
    }

    const tbody = document.getElementById("anaTableBody");
    tbody.innerHTML = "";
    Object.keys(cats).forEach(key => {
        if(cats[key].sale > 0 || cats[key].cost > 0) {
            const p = cats[key].sale - cats[key].cost;
            tbody.innerHTML += `
            <tr>
                <td>${key}</td>
                <td style="text-align:right">${cats[key].sale.toLocaleString()}</td>
                <td style="text-align:right">${cats[key].cost.toLocaleString()}</td>
                <td style="text-align:right; font-weight:bold; color:${p>=0?'#10b981':'#ef4444'}">${p.toLocaleString()}</td>
            </tr>`;
        }
    });

    const expBody = document.getElementById("anaExpBreakdown");
    if(expBody) {
        expBody.innerHTML = "";
        if(totalExpense === 0) {
            expBody.innerHTML = "<tr><td colspan='2' style='text-align:center; color:#aaa'>ржПржЗ ржорж╛рж╕рзЗ ржХрзЛржирзЛ ржЦрж░ржЪ ржирзЗржЗ</td></tr>";
        } else {
            Object.keys(expenseByCat).forEach(cat => {
                expBody.innerHTML += `
                <tr>
                    <td>${cat}</td>
                    <td style="text-align:right; font-weight:bold">рз│ ${expenseByCat[cat].toLocaleString()}</td>
                </tr>`;
            });
        }
    }
}

// --- STOCK VALUATION ---
function updateStockValuationTable() {
    const tbody = document.getElementById("stockValuationBody");
    tbody.innerHTML = "";
    let totalVal = 0;
    
    allProducts.forEach(p => {
        if(p.isService) return; 
        
        const cost = parseFloat(p.costPrice) || 0;
        const qty = parseFloat(p.qty) || 0;
        const val = cost * qty;
        totalVal += val;
        
        const alertLevel = p.alertLevel || 5;
        const isLow = qty <= alertLevel;
        
        if(isShortageView && !isLow) return;

        tbody.innerHTML += `
        <tr class="${isLow ? 'low-stock' : ''}">
            <td>${p.name}</td>
            <td>${p.mainType || '-'}</td>
            <td>${qty}</td>
            <td>${cost}</td>
            <td>${val.toFixed(0)}</td>
            <td>${isLow ? 'тЪая╕П Shortage' : 'OK'}</td>
        </tr>`;
    });
    
    document.getElementById("stockValue").innerText = "рз│ " + totalVal.toLocaleString();
}

function toggleShortageOnly() {
    isShortageView = !isShortageView;
    const btn = document.getElementById("shortageBtn");
    btn.innerText = isShortageView ? "ЁЯУЛ рж╕ржм ржкржгрзНржп ржжрзЗржЦрзБржи" : "тЪая╕П рж╢рзБржзрзБ рж╢рж░рзНржЯрзЗржЬ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрзБржи";
    updateStockValuationTable();
}

// --- MEMO & PRINT ---
function showMemo(e){
    const memoId = e.key ? e.key.slice(-4).toUpperCase() : '---';
    document.getElementById("mId").innerText = memoId;
    document.getElementById("mDate").innerText = e.date + " " + e.time;
    document.getElementById("mUser").innerText = e.user;
    document.getElementById("mNote").innerText = e.note;
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total;
    document.getElementById("mPaid").innerText = e.taken;
    
    const due = e.total - e.taken;
    if(due < 0) {
        document.getElementById("mDueDisplay").innerText = "0 (ржлрзЗрж░ржд: " + Math.abs(due) + ")";
    } else {
        document.getElementById("mDueDisplay").innerText = due;
    }
    
    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => {
            mItems.innerHTML += `
            <tr>
                <td style="border:1px solid #ddd; padding:6px">${i.work}</td>
                <td style="text-align:center; border:1px solid #ddd; padding:6px">${i.qty}</td>
                <td style="text-align:right; border:1px solid #ddd; padding:6px">${i.sub}</td>
            </tr>`;
        });
    }
    
    const signs = { owner: ["Toosher Ahmed", "01913-812765"], admin: ["Arafat Sikder", "016749-44985"], roky: ["Roky", "01878-149052"] };
    const s = signs[e.user] || [e.user.toUpperCase(), ""];
    document.getElementById("signatureName").innerText = s[0];
    
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

// --- NEW VIEW DETAILS LOGIC ---
function viewMemo(key){
    const entry = allEntries.find(e => e.key === key);
    if(!entry) return showToast("рждржерзНржп ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐!", "error");
    
    document.getElementById("vId").innerText = entry.key.slice(-4).toUpperCase();
    document.getElementById("vDate").innerText = entry.date + " " + entry.time;
    document.getElementById("vUser").innerText = entry.user;
    document.getElementById("vName").innerText = entry.note;
    document.getElementById("vPhone").innerText = entry.phone || "N/A";
    
    const tbody = document.getElementById("vItemsBody");
    tbody.innerHTML = "";
    
    if(entry.items && Array.isArray(entry.items)){
        entry.items.forEach(i => {
            tbody.innerHTML += `
            <tr>
                <td>${i.work} <br><small style="color:#777">${i.category}</small></td>
                <td style="text-align:center">${i.qty}</td>
                <td style="text-align:right">${i.sub}</td>
            </tr>`;
        });
    }
    
    document.getElementById("vTotal").innerText = entry.total;
    document.getElementById("vPaid").innerText = entry.taken;
    
    const due = entry.total - entry.taken;
    if(due < 0) {
        document.getElementById("vDue").innerText = "0 (ржлрзЗрж░ржд: " + Math.abs(due) + ")";
        document.getElementById("vDue").style.color = "green";
    } else {
        document.getElementById("vDue").innerText = due;
        document.getElementById("vDue").style.color = "red";
    }
    
    document.getElementById("viewDetailsModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function printEntry(key) {
    const entry = allEntries.find(e => e.key === key);
    if(entry) {
        showMemo(entry);
        // REMOVED AUTO PRINT TIMEOUT
    }
}

function closeModal(id) { document.getElementById(id).style.display="none"; document.getElementById("overlay").style.display="none"; }

// --- EDIT ENTRY LOGIC ---
function openEditModal(key) {
    const entry = allEntries.find(e => e.key === key);
    if(!entry) return;
    
    document.getElementById("editEntryKey").value = key;
    document.getElementById("editEntryNote").value = entry.note;
    document.getElementById("editEntryPhone").value = entry.phone || "";
    document.getElementById("editEntryTotal").value = entry.total;
    document.getElementById("editEntryTaken").value = entry.taken;
    calcEditDue();
    
    document.getElementById("editEntryModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function calcEditDue() {
    const t = parseFloat(document.getElementById("editEntryTotal").value) || 0;
    const p = parseFloat(document.getElementById("editEntryTaken").value) || 0;
    document.getElementById("editEntryDue").value = t - p;
}

function saveEditEntry() {
    const key = document.getElementById("editEntryKey").value;
    const note = document.getElementById("editEntryNote").value;
    const phone = document.getElementById("editEntryPhone").value;
    const total = parseFloat(document.getElementById("editEntryTotal").value);
    const taken = parseFloat(document.getElementById("editEntryTaken").value);
    const loss = total - taken;
    
    db.ref("entries/" + key).update({
        note: note,
        phone: phone,
        total: total,
        taken: taken,
        loss: loss
    }).then(() => {
        showToast("ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ!", "success");
        closeModal("editEntryModal");
    });
}

function deleteFromEdit() {
    const key = document.getElementById("editEntryKey").value;
    if(confirm("рж╕рждрж░рзНржХрждрж╛: ржПржЗ ржПржирзНржЯрзНрж░рж┐ ржбрж┐рж▓рж┐ржЯ ржХрж░рж▓рзЗ рж╕рзНржЯржХ рж░рж┐рж╕рзНржЯрзЛрж░ рж╣ржмрзЗред ржЖржкржирж┐ ржХрж┐ ржирж┐рж╢рзНржЪрж┐ржд?")) {
        db.ref("entries/"+key).once("value", s => { 
            const entry = s.val();
            if(entry.items) entry.items.forEach(i => {
                if(!i.isService) {
                     const p = allProducts.find(x => x.key === i.key);
                     if(p) db.ref("products/"+i.key).update({qty: (parseFloat(p.qty)||0) + parseFloat(i.qty)});
                }
            });
            db.ref("entries/"+key).remove();
            closeModal("editEntryModal");
            showToast("ржПржирзНржЯрзНрж░рж┐ ржбрж┐рж▓рж┐ржЯ рж╣рзЯрзЗржЫрзЗ", "warning");
        });
    }
}

// --- REPORTING CORE ---
function loadEntries(){ 
    db.ref("entries").on("value", s => {
        const val = s.val();
        allEntries = [];
        if(val) {
             Object.keys(val).forEach(k => {
                 let e = val[k]; e.key = k;
                 allEntries.push(e);
             });
        }
        
        const recent = allEntries.slice(-50).reverse();
        renderTable(recent, "tableBody");
        generateAnalytics();
        updateUserSummary();
        renderChart();
        loadCustomerManager(); 
    }); 
}

function renderTable(data, tableId){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    if(!data || data.length === 0) { tbody.innerHTML = "<tr><td colspan='9' style='text-align:center'>ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ</td></tr>"; return; }
    
    let totalSales=0, totalTaken=0, totalDue=0;
    
    data.forEach(e => {
        totalSales += +e.total || 0; 
        totalTaken += +e.taken || 0; 
        totalDue += +e.loss || 0;
        
        const itemSummary = (e.items && Array.isArray(e.items)) 
            ? e.items.map(i => `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work}</span>`).join(" ") 
            : e.work;
            
        const memoNo = e.key.slice(-4).toUpperCase();

        const btnView = `<button class="btn-action btn-view" onclick="viewMemo('${e.key}')" title="ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрзБржи">ЁЯСБя╕П</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEditModal('${e.key}')" title="ржПржбрж┐ржЯ">тЬПя╕П</button>`;
        const btnPrint = `<button class="btn-action btn-print" onclick="printEntry('${e.key}')" title="ржкрзНрж░рж┐ржирзНржЯ">ЁЯЦия╕П</button>`;
        
        tbody.innerHTML+=`
        <tr>
            <td style="font-weight:bold; color:#10b981">${memoNo}</td>
            <td style="font-size:13px">${e.date}<br>${e.time}</td>
            <td style="font-size:13px"><b>${e.note}</b><br>${itemSummary}</td>
            <td class="en">${e.phone||"-"}</td>
            <td>${e.total}</td>
            <td style="color:#10b981;font-weight:bold">${e.taken}</td>
            <td style="color:#ef4444">${e.loss}</td>
            <td style="text-transform:capitalize">${e.user}</td>
            <td class="noPrint" style="white-space:nowrap">${btnView}${btnEdit}${btnPrint}</td>
        </tr>`;
    });
    
    if(tableId === "tableBody") { 
        document.getElementById("cCount").innerText = allEntries.length; 
        document.getElementById("cTotal").innerText = totalSales; 
        document.getElementById("cTaken").innerText = totalTaken; 
        document.getElementById("cDue").innerText = totalDue; 
    }
}

function searchByDate() {
    const d = document.getElementById("sDate").value; 
    if(!d) return showToast("рждрж╛рж░рж┐ржЦ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзБржи", "error");
    
    const filtered = allEntries.filter(e => {
        if(e.isoDate) return e.isoDate === d;
        const parts = e.date.split('/');
        const iso = `${parts[2]}-${parts[1]}-${parts[0]}`;
        return iso === d;
    });
    
    renderTable(filtered, "reportTableBody");
}

function loadReportData() {
    renderTable(allEntries.slice().reverse(), "reportTableBody");
}

function updateUserSummary() {
    const today = new Date().toLocaleDateString("en-GB");
    const todayEntries = allEntries.filter(e => e.date === today);
    
    const users = {};
    
    todayEntries.forEach(e => {
        const u = e.user || "Unknown";
        if(!users[u]) users[u] = { total: 0, cash: 0, due: 0 };
        users[u].total += (+e.total || 0);
        users[u].cash += (+e.taken || 0);
        users[u].due += (+e.loss || 0);
    });
    
    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    
    if(Object.keys(users).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ржЖржЬржХрзЗрж░ ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ</td></tr>';
        return;
    }
    
    Object.keys(users).forEach(u => {
        tbody.innerHTML += `
        <tr>
            <td style="text-transform:capitalize; font-weight:bold">${u}</td>
            <td>${users[u].total}</td>
            <td style="color:#10b981">${users[u].cash}</td>
            <td style="color:#ef4444">${users[u].due}</td>
        </tr>`;
    });
}

function renderChart() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    const labels = [];
    const dataPoints = [];
    
    for(let i=6; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString("en-GB");
        labels.push(dateStr.slice(0,5)); 
        
        const dayTotal = allEntries
            .filter(e => e.date === dateStr)
            .reduce((sum, e) => sum + (+e.total || 0), 0);
        dataPoints.push(dayTotal);
    }

    if(salesChart) salesChart.destroy();
    
    salesChart = new Chart(ctx, {
        type: 'line', // Changed to Line for better look
        data: {
            labels: labels,
            datasets: [{
                label: 'ржбрзЗржЗрж▓рж┐ рж╕рзЗрж▓ (рз│)',
                data: dataPoints,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4 // Smooth curve
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// --- CUSTOMER MANAGEMENT LOGIC ---
function loadCustomerManager() {
    const stats = {};
    
    allCustomers.forEach(c => {
        const key = c.phone || c.name;
        stats[key] = {
            name: c.name,
            phone: c.phone || "N/A",
            total: 0,
            paid: 0,
            due: 0,
            dbKey: c.key 
        };
    });

    allEntries.forEach(e => {
        const key = e.phone ? e.phone : e.note;
        
        if(!stats[key]) {
            stats[key] = {
                name: e.note,
                phone: e.phone || "N/A",
                total: 0,
                paid: 0,
                due: 0,
                dbKey: null 
            };
        }
        
        stats[key].total += (parseFloat(e.total) || 0);
        stats[key].paid += (parseFloat(e.taken) || 0);
        stats[key].due += (parseFloat(e.loss) || 0);
    });
    
    customerStats = Object.values(stats);
    renderCustomerTable(customerStats);
}

function renderCustomerTable(data) {
    const tbody = document.getElementById("customerTableBody");
    tbody.innerHTML = "";
    
    if(data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>ржХрзЛржирзЛ ржХрж╛рж╕рзНржЯржорж╛рж░ ржбрж╛ржЯрж╛ ржирзЗржЗ</td></tr>";
        return;
    }
    
    data.forEach(c => {
        const safeName = c.name.replace(/'/g, "\\'");
        const safePhone = c.phone === "N/A" ? "" : c.phone;
        const dbKey = c.dbKey || "";

        tbody.innerHTML += `
        <tr>
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.total}</td>
            <td style="color:#10b981">${c.paid}</td>
            <td style="color:#ef4444; font-weight:bold">${c.due}</td>
            <td>
                <button class="btn-action btn-view" onclick="viewCustomerHistory('${safePhone}', '${safeName}')" title="рж╣рж┐рж╕рзНржЯрзНрж░рж┐ ржжрзЗржЦрзБржи">ЁЯСБя╕П</button>
                <button class="btn-action btn-edit" onclick="openEditCustomerModal('${dbKey}', '${safeName}', '${safePhone}')" title="ржПржбрж┐ржЯ ржХрж░рзБржи">тЬПя╕П</button>
            </td>
        </tr>`;
    });
}

function filterCustomerTable() {
    const q = document.getElementById("custSearch").value.toLowerCase();
    const filtered = customerStats.filter(c => 
        c.name.toLowerCase().includes(q) || 
        c.phone.includes(q)
    );
    renderCustomerTable(filtered);
}

// --- CUSTOMER ADD/EDIT/VIEW FUNCTIONS ---

function openAddCustomerModal() {
    document.getElementById("custKey").value = "";
    document.getElementById("custName").value = "";
    document.getElementById("custPhone").value = "";
    document.getElementById("customerModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function openEditCustomerModal(key, name, phone) {
    if(!key) {
        if(confirm("ржПржЗ ржХрж╛рж╕рзНржЯржорж╛рж░ржЯрж┐ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ рж╕рзЗржн ржХрж░рж╛ ржирзЗржЗред ржЖржкржирж┐ ржХрж┐ ржПржХрзЗ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржн ржХрж░рждрзЗ ржЪрж╛ржи?")) {
            openAddCustomerModal();
            document.getElementById("custName").value = name;
            document.getElementById("custPhone").value = phone;
        }
        return;
    }
    document.getElementById("custKey").value = key;
    document.getElementById("custName").value = name;
    document.getElementById("custPhone").value = phone;
    document.getElementById("customerModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveCustomer() {
    const key = document.getElementById("custKey").value;
    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();

    if(!name) return showToast("ржирж╛ржо ржЕржмрж╢рзНржпржЗ ржжрж┐рждрзЗ рж╣ржмрзЗ!", "error");

    const data = { name: name, phone: phone };

    if(key) {
        db.ref("customers/" + key).update(data).then(() => {
            showToast("ржХрж╛рж╕рзНржЯржорж╛рж░ рждржерзНржп ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ!", "success");
            closeModal("customerModal");
        });
    } else {
        db.ref("customers").push(data).then(() => {
            showToast("ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ ржпрзБржХрзНржд рж╣рзЯрзЗржЫрзЗ!", "success");
            closeModal("customerModal");
        });
    }
}

function viewCustomerHistory(phone, name) {
    document.getElementById("histName").innerText = name;
    document.getElementById("histPhone").innerText = phone || "N/A";
    
    const tbody = document.getElementById("histBody");
    tbody.innerHTML = "";

    const history = allEntries.filter(e => {
        if(phone && phone !== "N/A") return e.phone === phone;
        return e.note === name;
    }).reverse(); 

    if(history.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>ржХрзЛржирзЛ рж▓рзЗржиржжрзЗржи ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐</td></tr>";
    } else {
        history.forEach(e => {
            const items = e.items ? e.items.map(i => i.work).join(", ") : e.work;
            const memoNo = e.key.slice(-4).toUpperCase();
            tbody.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:#10b981">${memoNo}</td>
                <td style="font-size:13px">${e.date}</td>
                <td style="font-size:13px">${items}</td>
                <td>${e.total}</td>
                <td style="color:#10b981">${e.taken}</td>
                <td style="color:#ef4444">${e.loss}</td>
            </tr>`;
        });
    }

    document.getElementById("customerHistoryModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// --- NEW BACKUP & CSV FUNCTIONS ---

function exportDataCSV() {
    if(allEntries.length === 0) {
        showToast("ржПржХрзНрж╕ржкрзЛрж░рзНржЯ ржХрж░рж╛рж░ ржорждрзЛ ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ!", "error");
        return;
    }

    const data = allEntries.map(e => {
        const itemsStr = (e.items && Array.isArray(e.items)) 
            ? e.items.map(i => `${i.work} (${i.qty})`).join("; ") 
            : e.work;

        return {
            "Memo No": e.key ? e.key.slice(-4).toUpperCase() : '',
            "Date": e.date,
            "Time": e.time,
            "Customer Name": e.note,
            "Phone": e.phone || "",
            "Items": itemsStr,
            "Total Amount": e.total,
            "Paid Amount": e.taken,
            "Due Amount": e.loss,
            "Served By": e.user
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const csvOutput = XLSX.utils.sheet_to_csv(ws);
    
    const blob = new Blob([csvOutput], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "Sales_Report_" + new Date().toISOString().slice(0,10) + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast("CSV ржлрж╛ржЗрж▓ ржбрж╛ржЙржирж▓рзЛржб рж╣рзЯрзЗржЫрзЗ!", "success");
}

function backupFullData() {
    const fullBackup = {
        meta: {
            app: "Sheikh Photocopy PRO",
            version: "3.1.0",
            backupDate: new Date().toLocaleString(),
            exportedBy: currentUser
        },
        products: allProducts,
        entries: allEntries,
        customers: allCustomers,
        expenses: allExpenses
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullBackup, null, 2));
    
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "Full_Backup_" + new Date().toISOString().slice(0,10) + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();

    showToast("рж╕ржорзНржкрзВрж░рзНржг ржбрж╛ржЯрж╛ржмрзЗрж╕ ржмрзНржпрж╛ржХржЖржк ржирзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗ! ЁЯТ╛", "success");
}

// --- EXCEL DOWNLOAD FUNCTION ---
function downloadExcel(type) {
    let data = [];
    let filename = "";

    if (type === 'report') {
        filename = "Sales_Report_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allEntries.map(e => {
            const itemsStr = (e.items && Array.isArray(e.items)) 
                ? e.items.map(i => `${i.work} (${i.qty})`).join(", ") 
                : e.work;
            return {
                "Date": e.date,
                "Time": e.time,
                "Memo No": e.key.slice(-4).toUpperCase(),
                "Customer": e.note,
                "Phone": e.phone || "",
                "Items": itemsStr,
                "Total (Tk)": e.total,
                "Paid (Tk)": e.taken,
                "Due (Tk)": e.loss,
                "User": e.user
            };
        });
    } 
    else if (type === 'stock') {
        filename = "Stock_Inventory_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allProducts.map(p => ({
            "Serial": p.serial || "",
            "Section": p.mainType,
            "Category": p.category,
            "Product Name": p.name,
            "Stock Qty": p.isService ? "Service" : p.qty,
            "Cost Price": p.costPrice || 0,
            "Sell Price": p.sellPrice,
            "Alert Level": p.alertLevel || 5
        }));
    }
    else if (type === 'expense') {
        filename = "Expense_List_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allExpenses.map(e => ({
            "Date": e.date,
            "Description": e.desc,
            "Category": e.category,
            "Amount (Tk)": e.amount,
            "User": e.user
        }));
    }
    else if (type === 'customer') {
        filename = "Customer_List_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = customerStats.map(c => ({
            "Customer Name": c.name,
            "Phone": c.phone,
            "Total Work (Tk)": c.total,
            "Total Paid (Tk)": c.paid,
            "Current Due (Tk)": c.due
        }));
    }

    if(data.length === 0) {
        showToast("ржХрзЛржирзЛ ржбрж╛ржЯрж╛ ржирзЗржЗ!", "error");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename + ".xlsx");
    showToast("Excel ржбрж╛ржЙржирж▓рзЛржб рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрзЗ...", "success");
}

// --- UTILS ---
function showSection(id){ 
    document.querySelectorAll('.section').forEach(s=>s.style.display="none"); 
    document.getElementById(id).style.display="block"; 
    closeSidebar(); 
    if(id === 'analytics') generateAnalytics();
    if(id === 'customerManager') loadCustomerManager();
}
function closeSidebar(){ document.getElementById("sidebar").style.left="-300px"; document.getElementById("overlay").style.display="none"; }
function openSidebar(){ document.getElementById("sidebar").style.left="0"; document.getElementById("overlay").style.display="block"; }

function autoFormatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if(value.length >= 3) {
        const c = allCustomers.find(c => c.phone && c.phone.includes(value));
        if(c) { document.getElementById('note').value = c.name; document.getElementById('phoneSuggestion').innerText = c.name; }
    }
}
function loadAllCustomers() { 
    db.ref("customers").on("value", s => { 
        allCustomers = []; 
        s.forEach(c => {
            let cust = c.val();
            cust.key = c.key; // Save DB key
            allCustomers.push(cust);
        }); 
        if(document.getElementById("customerManager").style.display === "block") {
            loadCustomerManager();
        }
    }); 
}

// --- REFRESH WARNING (ADDED) ---
window.onbeforeunload = function() {
    if (cart.length > 0) {
        return "ржХрж╛рж░рзНржЯрзЗ ржкржгрзНржп ржЖржЫрзЗред ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржжрж┐рж▓рзЗ ржбрж╛ржЯрж╛ ржорзБржЫрзЗ ржпрж╛ржмрзЗред";
    }
};
</script>
</body>
</html>
