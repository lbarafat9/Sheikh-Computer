<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø - ‡¶™‡ßç‡¶∞‡ßã</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        body {
            margin: 0;
            background: #f4f7f6;
            color: #2c3e50;
        }
        
        .en {
            font-family: Arial, sans-serif;
        }
        
        header {
            background: #27ae60;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
        }
        
        #loginDiv {
            max-width: 400px;
            margin: 120px auto;
            background: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.1);
            text-align: center;
        }
        
        #loginDiv input {
            margin-bottom: 15px;
        }
        
        #container {
            display: none;
            padding: 20px;
            padding-top: 90px;
            max-width: 1250px;
            margin: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
            position: relative;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 14px;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            outline: none;
            transition: .3s;
            font-size: 15px;
        }
        
        input:focus, select:focus {
            border-color: #27ae60;
            box-shadow: 0 0 5px rgba(39,174,96,.2);
        }
        
        button {
            background: #27ae60;
            color: #fff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 5px;
        }
        
        button:hover {
            background: #219150;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,.05);
            border-top: 5px solid #2ecc71;
            transition: .2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card b {
            font-size: 24px;
            display: block;
            margin-top: 5px;
        }
        
        #menuBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 28px;
            color: #fff;
            cursor: pointer;
            display: none;
            z-index: 1100;
        }
        
        #sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: #fff;
            transition: .3s;
            z-index: 1200;
            padding-top: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,.05);
        }
        
        #sidebar a {
            display: block;
            color: #34495e;
            text-decoration: none;
            padding: 15px 25px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: .2s;
        }
        
        #sidebar a:hover {
            background: #f0fff4;
            color: #27ae60;
            padding-left: 30px;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            z-index: 1150;
        }
        
        .section {
            display: none;
            animation: fadeIn .4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table-box {
            background: #fff;
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,.03);
            border: 1px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }
        
        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            color: #555;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        
        tr:hover {
            background-color: #fbfbfb;
        }
        
        .btn-action {
            padding: 6px 10px;
            font-size: 14px;
            margin: 0 3px;
            border-radius: 5px;
            width: auto;
            display: inline-block;
        }
        
        .btn-del {
            background: #ffebee;
            color: #c0392b;
            border: 1px solid #ffccd5;
        }
        
        .btn-del:hover {
            background: #c0392b;
            color: #fff;
        }
        
        .btn-edit {
            background: #fff8e1;
            color: #f39c12;
            border: 1px solid #ffe0b2;
        }
        
        .btn-edit:hover {
            background: #f39c12;
            color: #fff;
        }
        
        .btn-print {
            background: #e3f2fd;
            color: #2980b9;
            border: 1px solid #bbdefb;
        }
        
        .btn-print:hover {
            background: #2980b9;
            color: #fff;
        }
        
        .cart-box {
            margin-top: 20px;
            border: 2px dashed #27ae60;
            padding: 20px;
            border-radius: 12px;
            background: #f9fff9;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            background: #fff;
            width: 600px;
            max-width: 95%;
            padding: 30px;
            z-index: 1500;
            box-shadow: 0 10px 40px rgba(0,0,0,.2);
            border-radius: 15px;
        }
        
        .user-summary-box {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #8e44ad;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
        }
        
        .low-stock {
            background-color: #fff0f0;
            color: #c0392b;
            font-weight: bold;
        }
        
        .service-badge {
            background: #3498db;
            color: #fff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            z-index: 1000;
            display: none;
        }
        
        .search-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background .2s;
        }
        
        .search-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-item.active {
            background-color: #e8f5e9;
        }
        
        .search-item .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .search-item .product-details {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .no-results {
            padding: 15px;
            text-align: center;
            color: #777;
            font-style: italic;
        }
        
        .temp-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #2ecc71;
            color: #fff;
            border-radius: 6px;
            z-index: 2000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
            animation: slideIn .3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .customer-summary {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
            border-left: 5px solid #3498db;
        }
        
        .customer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }
        
        .due-alert {
            background: #fff0f0;
            border-left: 5px solid #e74c3c;
        }
        
        .paid-alert {
            background: #f0fff4;
            border-left: 5px solid #27ae60;
        }
        
        .validation-warning {
            background: #fff8e1;
            border-left: 5px solid #f39c12;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .validation-error {
            background: #ffebee;
            border-left: 5px solid #e74c3c;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .validation-success {
            background: #e8f5e9;
            border-left: 5px solid #2ecc71;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .phone-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .due-warning {
            color: #e74c3c;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        /* ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï CSS */
        #stockBody tr.low-stock {
            animation: pulseWarning 2s infinite;
        }
        
        @keyframes pulseWarning {
            0%, 100% { background-color: #fff0f0; }
            50% { background-color: #ffe0e0; }
        }
        
        #stockBody tr.low-stock:hover {
            background-color: #ffd9d9 !important;
        }
        
        @media (max-width: 768px) {
            .table-box {
                overflow-x: auto;
            }
            table {
                min-width: 800px;
            }
            
            /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            .mobile-stock-form .form-row {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .mobile-stock-form .form-group {
                margin-bottom: 10px;
            }
            
            .mobile-stock-form button {
                height: 50px;
                margin-top: 10px;
            }
        }
        
        @media print {
            @page {
                size: A4;
                margin: .8in;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: #fff;
                font-family: 'Times New Roman', serif;
            }
            
            body * {
                visibility: hidden;
            }
            
            #memoModal, #memoModal * {
                visibility: visible !important;
            }
            
            #memoModal {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                box-shadow: none !important;
                border: none !important;
                background: transparent !important;
            }
            
            #memoModal h2 {
                font-size: 32px !important;
                margin-bottom: 5px;
                color: #000 !important;
                text-align: center;
                font-family: 'Hind Siliguri', sans-serif;
            }
            
            #memoModal p, #memoModal span {
                color: #000 !important;
                font-size: 14pt !important;
            }
            
            #memoModal .address {
                font-size: 14px !important;
                text-align: center;
                margin-bottom: 30px;
            }
            
            .memo-meta {
                display: flex;
                justify-content: space-between;
                margin-bottom: 25px;
                border-bottom: 2px solid #000;
                padding-bottom: 15px;
            }
            
            #memoModal table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 14pt;
            }
            
            #memoModal th {
                background: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #000;
                padding: 10px;
                font-weight: bold;
                text-align: center !important;
            }
            
            #memoModal td {
                border: 1px solid #000;
                padding: 10px;
            }
            
            .memo-total-area {
                margin-top: 30px;
                text-align: right;
                font-size: 16pt !important;
            }
            
            .signature-area {
                margin-top: 80px;
                display: flex;
                justify-content: space-between;
                page-break-inside: avoid;
            }
            
            .signature-box {
                text-align: center;
                width: 250px;
            }
            
            .signature-line {
                border-top: 1px solid #000;
                margin-top: 60px;
                padding-top: 10px;
                font-size: 14pt;
            }
            
            .noPrint {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#27ae60;margin-bottom:20px">‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ (Admin/Owner/Roky)">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:15px;margin-bottom:10px;border-bottom:2px solid #2ecc71;background:#f0fdf4" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø / ‡¶∏‡ßá‡¶≤‡¶∏</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</a>
        <a onclick="showSection('customers')">üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
        <a onclick="logout()" style="color:#e74c3c;margin-top:20px;border-top:1px solid #eee">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>

    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
            <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤ (‡ß≥)<br><b id="cTotal">0</b></div>
            <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡ß≥)<br><b id="cTaken">0</b></div>
            <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cDue">0</b></div>
        </div>
        <div class="user-summary-box">
            <h4 style="margin:0 0 15px 0;color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
            <div class="table-box" style="box-shadow:none;border:1px solid #eee">
                <table class="en">
                    <thead>
                        <tr>
                            <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th>
                            <th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th>
                            <th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th>
                        </tr>
                    </thead>
                    <tbody id="userSummaryBody">
                        <tr>
                            <td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05)">
            <canvas id="salesChart" height="80"></canvas>
        </div>
        <div class="table-box">
            <h4 style="padding:15px;margin:0;background:#f9f9f9;border-bottom:1px solid #eee">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
            <table class="en">
                <thead>
                    <tr>
                        <th>‡¶∏‡¶Æ‡ßü</th>
                        <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                        <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                        <th>‡¶Æ‡ßã‡¶ü</th>
                        <th>‡¶®‡¶ó‡¶¶</th>
                        <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                        <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                        <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="newEntry" class="section">
        <div style="max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0;color:#2c3e50;border-bottom:2px solid #eee;padding-bottom:10px">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
            <div class="form-group" style="background:#e8f5e9;padding:15px;border:1px dashed #27ae60;border-radius:8px">
                <label>üîç ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö (‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®):</label>
                <input id="searchSerial" type="text" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 101 ‡¶Ö‡¶•‡¶¨‡¶æ A4 Paper..." class="en" autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø: <span style="color:red">*</span></label>
                <select id="category" onchange="filterProducts()">
                    <option value="">=== ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>
                </select>
            </div>
            <div class="form-group">
                <label>‡¶ï‡¶æ‡¶ú/‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="work" onchange="autoFillPrice()">
                    <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                    <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label>
                    <input id="qty" type="number" value="1" min="1" class="en" onkeydown="if(event.key==='Enter'){addToCart();}">
                </div>
                <div class="form-group">
                    <label>‡¶¶‡¶∞ (Rate ‡ß≥):</label>
                    <input id="rate" type="number" class="en">
                </div>
            </div>
            <button onclick="addToCart()" style="background:#3498db;margin-bottom:20px;padding:12px">‚¨áÔ∏è ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add)</button>
            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0;border-bottom:1px dashed #aaa;padding-bottom:5px">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                <div id="cartList"></div>
                <hr style="border:0;border-top:1px dashed #aaa;margin:15px 0">
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #ddd">
                    <h4 style="margin-top:0;color:#2c3e50;font-size:16px">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div class="form-group">
                            <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ: <span style="color:red">*</span></label>
                            <input id="note" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="checkCustomerName()">
                            <small style="color:#666" id="nameHelp">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶π‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
                        </div>
                        <div class="form-group">
                            <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
                            <input id="phone" placeholder="017-XXXX-XXXX" class="en" 
                                   maxlength="13"
                                   pattern="[0-9\-]*"
                                   title="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: 017-XXXX-XXXX">
                            <small style="color:#666" id="phoneHelp">‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶∏‡¶¨‡ßá</small>
                        </div>
                    </div>
                    <div id="customerValidation" style="margin-top:10px"></div>
                </div>
                <div style="background:#f0f0f0;padding:15px;border-radius:8px">
                    <h4 style="margin-top:0;color:#2c3e50;font-size:16px">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div class="form-group">
                            <label>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (Total):</label>
                            <input id="total" readonly class="en" value="0" style="background:#fff;font-weight:bold">
                        </div>
                        <div class="form-group">
                            <label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (Paid):</label>
                            <input id="taken" type="number" class="en" oninput="validatePayment()">
                            <small style="color:#666">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶® ‡¶ï‡¶ø‡¶®‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="color:#e74c3c">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</label>
                        <input id="due" readonly class="en" value="0" style="background:#fff;color:#e74c3c;font-weight:bold">
                        <div id="paymentValidation" style="margin-top:5px"></div>
                    </div>
                </div>
                <div id="finalWarning" style="display:none;margin-top:15px"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px">
                    <button onclick="validateAndSave(false)" style="background:#f39c12">üíæ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="validateAndSave(true)" style="background:#2ecc71">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div id="inventory" class="section">
        <div style="max-width:1000px;margin:auto;background:#fff;padding:30px;border-radius:15px">
            <h3 style="border-bottom:2px solid #eee;padding-bottom:10px;color:#2c3e50">üì¶ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            
            <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶´‡¶∞‡ßç‡¶Æ - ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® -->
            <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:25px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#3498db">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                
                <!-- ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∏‡¶æ‡¶∞‡¶ø: ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø, ‡¶®‡¶æ‡¶Æ -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px">
                    <div class="form-group">
                        <label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶°:</label>
                        <input id="stSerial" class="en" placeholder="P-001, S-002">
                    </div>
                    <div class="form-group">
                        <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                        <select id="stCategory">
                            <option value="">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú/‡¶™‡ßá‡¶™‡¶æ‡¶∞</option>
                            <option value="Pen">‡¶ï‡¶≤‡¶Æ/‡¶™‡ßá‡¶®</option>
                            <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ/‡¶®‡ßã‡¶ü‡¶¨‡ßÅ‡¶ï</option>
                            <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                            <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                            <option value="Stationery">‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</option>
                            <option value="Online">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</option>
                            <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
                        <input id="stName" placeholder="A4 Paper, Matador Pen, Student Khata">
                    </div>
                </div>
                
                <!-- ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ö‡ßá‡¶ï‡¶¨‡¶ï‡ßç‡¶∏ -->
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #90caf9">
                    <div style="display:flex;align-items:center;gap:10px">
                        <input type="checkbox" id="stIsService" style="width:20px;height:20px;margin:0" onchange="toggleStockInput()">
                        <label for="stIsService" style="margin:0;cursor:pointer;font-weight:bold;color:#1565c0">
                            ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø, ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®, ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü)
                        </label>
                    </div>
                    <small style="color:#555;padding-left:34px;display:block;margin-top:5px">
                        ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶≤‡ßá '‡¶∏‡ßç‡¶ü‡¶ï', '‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ' ‡¶è‡¶¨‡¶Ç '‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï' ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§
                    </small>
                </div>
                
                <!-- ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶∞‡¶ø: ‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï (‡¶â‡¶™‡¶∞‡ßá) -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
                    <div class="form-group">
                        <label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                        <input id="stQty" type="number" class="en" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï:</label>
                        <input id="stMinStock" type="number" class="en" placeholder="5" min="1" value="5">
                        <small style="color:#666;font-size:12px">‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶§ ‡¶π‡¶≤‡ßá ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶¨‡ßá</small>
                    </div>
                </div>
                
                <!-- ‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶∞‡¶ø: ‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡¶®‡¶ø‡¶ö‡ßá) -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
                    <div class="form-group">
                        <label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (‡ß≥):</label>
                        <input id="stCost" type="number" class="en" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥):</label>
                        <input id="stSell" type="number" class="en" placeholder="0" min="0">
                    </div>
                </div>
                
                <!-- ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® - ‡¶®‡¶ø‡¶ö‡ßá ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá -->
                <div style="display:flex;justify-content:flex-end;margin-top:10px">
                    <button onclick="addNewProduct()" style="width:150px;height:50px;background:#2ecc71;font-size:16px;font-weight:bold">
                        ‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
                
                <!-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ -->
                <div style="background:#fff8e1;padding:10px;border-radius:5px;border-left:4px solid #f39c12;margin-top:15px">
                    <small style="color:#666">
                        <strong>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶ø‡¶ï‡¶æ:</strong><br>
                        ‚Ä¢ ‡¶ï‡¶æ‡¶ó‡¶ú: ‡ß® ‡¶∞‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶æ‡¶á‡¶ú)<br>
                        ‚Ä¢ ‡¶ï‡¶≤‡¶Æ: ‡ß®‡ß¶‡¶ü‡¶ø‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°)<br>
                        ‚Ä¢ ‡¶ñ‡¶æ‡¶§‡¶æ: ‡ßß‡ß¶‡¶ü‡¶ø‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶æ‡¶á‡¶ú)<br>
                        ‚Ä¢ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏: ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü
                    </small>
                </div>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö -->
            <div style="display:flex;gap:10px;margin-bottom:20px;align-items:flex-end">
                <div style="flex:1">
                    <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞:</label>
                    <select id="filterCategory" style="width:100%" onchange="filterStockTable()">
                        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>
                        <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú</option>
                        <option value="Pen">‡¶ï‡¶≤‡¶Æ</option>
                        <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ</option>
                        <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                        <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                        <option value="Stationery">‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</option>
                        <option value="Online">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®:</label>
                    <input type="text" id="stockSearch" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                           style="width:100%" onkeyup="filterStockTable()">
                </div>
                <button onclick="exportStockToExcel()" style="height:46px;background:#27ae60;width:120px">
                    üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤
                </button>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
            <div class="table-box" style="margin-top:25px">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-bottom:1px solid #eee">
                    <h4 style="margin:0">‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</h4>
                    <div style="color:#666;font-size:14px">
                        ‡¶Æ‡ßã‡¶ü ‡¶™‡¶£‡ßç‡¶Ø: <span id="totalProducts">0</span> | 
                        ‡¶ï‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï: <span id="lowStockCount" style="color:#e74c3c;font-weight:bold">0</span>
                    </div>
                </div>
                <table style="min-width:900px">
                    <thead>
                        <tr>
                            <th width="80">‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</th>
                            <th width="120">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th>
                            <th>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                            <th width="80">‡¶∏‡ßç‡¶ü‡¶ï</th>
                            <th width="80">‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ</th>
                            <th width="100">‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ</th>
                            <th width="100">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th width="150" class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="stockBody" class="en">
                        <tr>
                            <td colspan="8" style="text-align:center;padding:30px;color:#777">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø -->
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-top:30px">
                <div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #2ecc71">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶™‡¶£‡ßç‡¶Ø ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</div>
                    <div style="font-size:24px;font-weight:bold;color:#27ae60">‡ß≥<span id="totalStockValue">0</span></div>
                </div>
                <div style="background:#fff8e1;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #f39c12">
                    <div style="font-size:14px;color:#666">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</div>
                    <div style="font-size:24px;font-weight:bold;color:#f39c12"><span id="totalItemsCount">0</span></div>
                </div>
                <div style="background:#ffebee;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #e74c3c">
                    <div style="font-size:14px;color:#666">‡¶ï‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï</div>
                    <div style="font-size:24px;font-weight:bold;color:#e74c3c"><span id="lowStockItems">0</span></div>
                </div>
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #3498db">
                    <div style="font-size:14px;color:#666">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</div>
                    <div style="font-size:24px;font-weight:bold;color:#3498db"><span id="serviceItemsCount">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="customers" class="section">
        <div style="max-width:1200px;margin:auto">
            <h3 style="border-bottom:2px solid #3498db;padding-bottom:10px;color:#2c3e50;margin-top:0">üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
            <div style="background:#e8f5e9;padding:20px;border-radius:10px;margin-bottom:20px">
                <h4 style="margin-top:0">üîç ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®)</h4>
                <div style="display:flex;gap:10px;align-items:flex-end">
                    <div style="flex:1">
                        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                        <input type="text" id="searchCustomerInput" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 017... ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡¶π‡¶ø‡¶Æ..." style="width:100%">
                    </div>
                    <button onclick="searchCustomer()" style="width:120px;height:46px;margin-top:20px">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                <small style="color:#666;display:block;margin-top:10px">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</small>
            </div>
            <div id="customerDetails" style="display:none;background:#fff;padding:25px;border-radius:10px;margin-bottom:20px;border:1px solid #ddd;box-shadow:0 4px 6px rgba(0,0,0,.05)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h4 style="margin:0;color:#3498db" id="customerNameTitle">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:flex;gap:10px">
                        <button onclick="printCustomerReceipt()" style="background:#3498db;padding:8px 16px;width:auto">üñ®Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶∂‡¶ø‡¶¶</button>
                        <button onclick="addPayment()" style="background:#2ecc71;padding:8px 16px;width:auto">üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ</button>
                        <button onclick="clearCustomerSearch()" style="background:#e74c3c;padding:8px 16px;width:auto">‚úñÔ∏è ‡¶¨‡¶®‡ßç‡¶ß</button>
                    </div>
                </div>
                <div id="customerInfo"></div>
            </div>
            <div id="customerHistorySection" style="display:none;margin-bottom:30px">
                <h4 style="border-bottom:1px solid #eee;padding-bottom:8px">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h4>
                <div class="table-box">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç</th>
                                <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</th>
                                <th>‡¶ú‡¶Æ‡¶æ</th>
                                <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="customerTransactions"></tbody>
                    </table>
                </div>
            </div>
            <div class="table-box">
                <h4 style="padding:15px;margin:0;background:#f9f9f9;border-bottom:1px solid #eee">‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡¶π)</h4>
                <table>
                    <thead>
                        <tr>
                            <th>‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</th>
                            <th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</th>
                            <th>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                            <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="allCustomers">
                        <tr>
                            <td colspan="7" style="text-align:center;padding:20px;color:#777">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="noPrint" style="max-width:1000px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="text-align:center;margin-top:0">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</h3>
            <div style="display:flex;gap:10px;margin-bottom:20px;justify-content:center;background:#f9f9f9;padding:20px;border-radius:10px">
                <input type="date" id="sDate" class="en" style="margin:0;max-width:200px">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 25px">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px">
                <button onclick="loadReportData()" style="background:#7f8c8d">‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                <button onclick="downloadExcel()" style="background:#2ecc71">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button onclick="window.print()" style="background:#9b59b6">üñ®Ô∏è ‡¶™‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>
            <div class="table-box" style="border:1px solid #ddd">
                <table class="en">
                    <thead>
                        <tr>
                            <th>‡¶∏‡¶Æ‡ßü</th>
                            <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                            <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                            <th>‡¶Æ‡ßã‡¶ü</th>
                            <th>‡¶®‡¶ó‡¶¶</th>
                            <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                            <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                            <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0;color:#2ecc71;font-weight:800;font-size:28px">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:5px 0 0 0;color:#555">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
    </div>
    <div class="memo-meta en" style="margin-top:30px">
        <div style="text-align:left;float:left;width:50%">
            <p style="margin:4px"><strong>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç:</strong> <span id="mId"></span></p>
            <p style="margin:4px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:4px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right;float:right;width:50%">
            <p style="margin:4px"><strong>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</strong> <span id="mNote"></span></p>
            <p style="margin:4px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
    <table style="width:100%;border-collapse:collapse;margin-top:20px">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd;padding:10px;text-align:left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd;padding:10px;text-align:center;width:100px">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                <th style="border:1px solid #ddd;padding:10px;text-align:right;width:150px">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    <div class="memo-total-area en" style="margin-top:25px;text-align:right">
        <p style="margin:5px">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥<b id="mTotal"></b></p>
        <p style="margin:5px">‡¶®‡¶ó‡¶¶ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®: ‡ß≥<span id="mPaid"></span></p>
        <p style="margin:5px;font-size:18px">‡¶¨‡¶æ‡¶ï‡¶ø (Due): ‡ß≥<b id="mDueDisplay" style="color:red"></b></p>
    </div>
    <div class="signature-area" style="margin-top:80px;display:flex;justify-content:space-between">
        <div class="signature-box" style="text-align:center;width:200px">
            <p class="signature-line" style="border-top:1px solid #000;padding-top:10px;margin-top:40px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
        <div class="signature-box" style="text-align:center;width:200px">
            <p style="margin:0;font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000;padding-top:10px;margin-top:5px">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    <div style="margin-top:40px;text-align:center;border-top:1px dashed #ccc;padding-top:20px" class="noPrint">
        <button onclick="window.print()" style="width:auto;padding:10px 30px;font-size:16px">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (A4)</button>
        <button onclick="closeModal('memoModal')" style="background:#e74c3c;width:auto;padding:10px 30px;font-size:16px">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="editModal" class="modal" style="width:400px">
    <h3 style="margin-top:0;color:#f39c12">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    <div class="form-group">
        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editNote">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
        <input id="editPhone" class="en">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="form-group">
            <label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</label>
            <input id="editTotal" type="number" class="en">
        </div>
        <div class="form-group">
            <label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£:</label>
            <input id="editTaken" type="number" class="en">
        </div>
    </div>
    <button onclick="updateEntry()" style="background:#f39c12;margin-top:15px">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button onclick="closeModal('editModal')" style="background:#e74c3c">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
</div>

<div id="paymentModal" class="modal" style="width:450px">
    <h3 style="margin-top:0;color:#2ecc71">üíµ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</h3>
    <div class="form-group">
        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="payCustomerName" readonly style="background:#f5f5f5">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
        <input id="payCustomerPhone" readonly style="background:#f5f5f5">
    </div>
    <div class="form-group">
        <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø:</label>
        <input id="payCurrentDue" readonly style="background:#f5f5f5;color:#e74c3c;font-weight:bold">
    </div>
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
        <input id="payAmount" type="number" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="en">
    </div>
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
        <input id="payDate" type="date" class="en" value="">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
        <input id="payComment" placeholder="‡¶â‡¶¶‡¶æ: ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø">
    </div>
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="processPayment()" style="background:#2ecc71;flex:1">üíæ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal('paymentModal')" style="background:#e74c3c;width:100px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="editStockModal" class="modal" style="width:600px">
    <h3 style="margin-top:0;color:#3498db">‚úèÔ∏è ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editStockKey">
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
        <div class="form-group">
            <label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶°:</label>
            <input id="editSerial" class="en">
        </div>
        <div class="form-group">
            <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
            <select id="editCategory">
                <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú/‡¶™‡ßá‡¶™‡¶æ‡¶∞</option>
                <option value="Pen">‡¶ï‡¶≤‡¶Æ/‡¶™‡ßá‡¶®</option>
                <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ/‡¶®‡ßã‡¶ü‡¶¨‡ßÅ‡¶ï</option>
                <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                <option value="Stationery">‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</option>
                <option value="Online">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</option>
                <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editName">
    </div>
    
    <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:15px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <input type="checkbox" id="editIsService" style="width:20px;height:20px;margin:0" onchange="toggleEditStockInput()">
            <label for="editIsService" style="margin:0;cursor:pointer;font-weight:bold;color:#1565c0">
                ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏
            </label>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
            <div class="form-group">
                <label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                <input id="editQty" type="number" class="en" placeholder="0" min="0">
            </div>
            <div class="form-group">
                <label>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï:</label>
                <input id="editMinStock" type="number" class="en" placeholder="5" min="1" value="5">
            </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="form-group">
                <label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (‡ß≥):</label>
                <input id="editCost" type="number" class="en" placeholder="0" min="0">
            </div>
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥):</label>
                <input id="editSell" type="number" class="en" placeholder="0" min="0">
            </div>
        </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="updateStockItem()" style="background:#2ecc71;flex:1">üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal('editStockModal')" style="background:#e74c3c;width:100px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="editCustomerModal" class="modal" style="width:500px">
    <h3 style="margin-top:0;color:#3498db">‚úèÔ∏è ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editCustomerPhone">
    
    <div class="form-group">
        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editCustomerName">
    </div>
    
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input id="editCustomerMobile" class="en">
    </div>
    
    <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px">
        <h4 style="margin-top:0;margin-bottom:10px;color:#666">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="form-group" style="margin:0">
                <label>‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö:</label>
                <input id="editCustomerTotal" readonly style="background:#fff">
            </div>
            <div class="form-group" style="margin:0">
                <label>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ:</label>
                <input id="editCustomerPaid" readonly style="background:#fff;color:#27ae60">
            </div>
            <div class="form-group" style="margin:0">
                <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø:</label>
                <input id="editCustomerDue" readonly style="background:#fff;color:#e74c3c">
            </div>
            <div class="form-group" style="margin:0">
                <label>‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®:</label>
                <input id="editCustomerTransactions" readonly style="background:#fff">
            </div>
        </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="updateCustomer()" style="background:#2ecc71;flex:1">üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="deleteCustomer()" style="background:#e74c3c;width:120px">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
        <button onclick="closeModal('editCustomerModal')" style="background:#95a5a6;width:100px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global Variables
let currentUser = "";
let allProducts = [];
let cart = [];
let salesChart = null;
let searchResultsDiv = null;
let searchTimer = null;
let selectedSearchIndex = -1;
let currentCustomerData = null;
let customerCache = {};
let existingCustomers = {};
let inactivityTimer;

// ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function formatPhoneNumber(phone) {
    const clean = phone.replace(/\D/g, '');
    
    // ‡¶Ø‡¶¶‡¶ø ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶π‡ßü (017XXXXXXXX)
    if (clean.length === 11 && clean.startsWith("01")) {
        // ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017-XXXX-XXXX
        return clean.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    // ‡¶Ø‡¶¶‡¶ø ‡ßß‡ß¶ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶π‡ßü (1XXXXXXXXX)
    else if (clean.length === 10 && clean.startsWith("1")) {
        const formatted = "0" + clean;
        return formatted.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    // ‡¶Ø‡¶¶‡¶ø ‡ßß‡ß© ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶π‡ßü (88017XXXXXXXX)
    else if (clean.length === 13 && clean.startsWith("880")) {
        const formatted = "0" + clean.slice(3);
        return formatted.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    
    return clean;
}

// Customer Auto-Fill System
function autoFillCustomerName(phoneInput) {
    const phone = phoneInput.trim();
    const noteInput = document.getElementById("note");
    const validationDiv = document.getElementById("customerValidation");
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
    const numbers = phone.replace(/\D/g, '');
    
    // ‡¶Ø‡¶¶‡¶ø ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡¶Æ ‡¶π‡ßü, ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡ßã ‡¶®‡¶æ
    if (numbers.length < 11) {
        validationDiv.innerHTML = "";
        return;
    }
    
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶®‡¶ø‡¶®
    const cleanPhone = numbers.substring(0, 11);
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    let formattedPhone = formatPhoneNumber(cleanPhone);
    
    // ‡¶´‡ßã‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    document.getElementById("phone").value = formattedPhone;
    
    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
    if (customerCache[cleanPhone]) {
        noteInput.value = customerCache[cleanPhone];
        showValidationMessage("‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: " + customerCache[cleanPhone], "success");
        noteInput.focus();
        noteInput.select();
        return;
    }
    
    // Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        let foundName = ""; let foundCount = 0;
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const entryPhone = entry.phone || "";
            
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            const entryPhoneClean = entryPhone.replace(/\D/g, '');
            
            if (entryPhoneClean === cleanPhone && entry.note && entry.note !== "General Customer") {
                foundName = entry.note; foundCount++;
            }
        });
        
        if (foundName) {
            customerCache[cleanPhone] = foundName;
            noteInput.value = foundName;
            showValidationMessage(`‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (${foundCount} ‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ): ${foundName}`, "success");
            noteInput.focus();
            noteInput.select();
        } else {
            showValidationMessage("üÜï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï, ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®", "warning");
            noteInput.focus();
            noteInput.select();
        }
    });
}

// Search Functionality
function setupSearchFunctionality() {
    const searchInput = document.getElementById('searchSerial');
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();
        if (!query) { hideSearchResults(); return; }
        searchTimer = setTimeout(() => performSearch(query), 300);
    });
    searchInput.addEventListener('keydown', function(e) {
        const results = searchResultsDiv.querySelectorAll('.search-item');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (selectedSearchIndex < results.length - 1) {
                selectedSearchIndex++; updateSearchSelection();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (selectedSearchIndex > 0) {
                selectedSearchIndex--; updateSearchSelection();
            }
        } else if (e.key === 'Enter' && selectedSearchIndex >= 0) {
            e.preventDefault();
            const selectedItem = results[selectedSearchIndex];
            if (selectedItem) {
                const productKey = selectedItem.getAttribute('data-key');
                selectProductFromSearch(productKey);
            }
        } else if (e.key === 'Escape') {
            hideSearchResults();
        }
    });
    document.addEventListener('click', function(e) {
        if (!searchResultsDiv.contains(e.target) && e.target !== searchInput) {
            hideSearchResults();
        }
    });
}

function performSearch(query) {
    if (!query) { hideSearchResults(); return; }
    const lowerQuery = query.toLowerCase();
    const results = [];
    allProducts.forEach(product => {
        let score = 0; let matchText = '';
        if (product.serial && product.serial.toLowerCase().includes(lowerQuery)) {
            score += 10; matchText = product.serial;
        }
        if (product.name && product.name.toLowerCase().includes(lowerQuery)) {
            score += 5; matchText = product.name;
        }
        if (product.category && product.category.toLowerCase().includes(lowerQuery)) {
            score += 3;
        }
        if (score > 0) {
            results.push({ product: product, score: score, matchText: matchText });
        }
    });
    results.sort((a, b) => b.score - a.score);
    displaySearchResults(results, query);
}

function displaySearchResults(results, query) {
    searchResultsDiv.innerHTML = '';
    if (results.length === 0) {
        searchResultsDiv.innerHTML = '<div class="no-results">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</div>';
        searchResultsDiv.style.display = 'block'; return;
    }
    const limitedResults = results.slice(0, 10);
    limitedResults.forEach(result => {
        const product = result.product;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'search-item';
        itemDiv.setAttribute('data-key', product.key);
        const name = highlightMatch(product.name, query);
        const serial = product.serial ? `<span style="color:#27ae60; font-weight:bold">${product.serial}</span>` : '';
        // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶π‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá "Service" ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá, ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá ‡¶®‡¶æ
        const stockInfo = product.isService ? 'Service' : `<span style="color:${product.qty < 5 ? '#e74c3c' : '#27ae60'}">${product.qty}</span>`;
        itemDiv.innerHTML = `<div class="product-name">${serial} ${name}</div><div class="product-details"><span>${product.category}</span><span>‡¶∏‡ßç‡¶ü‡¶ï: ${stockInfo} | ‡ß≥${product.sellPrice}</span></div>`;
        itemDiv.addEventListener('click', () => selectProductFromSearch(product.key));
        itemDiv.addEventListener('mouseenter', () => {
            const allItems = searchResultsDiv.querySelectorAll('.search-item');
            allItems.forEach(item => item.classList.remove('active'));
            itemDiv.classList.add('active');
            selectedSearchIndex = Array.from(allItems).indexOf(itemDiv);
        });
        searchResultsDiv.appendChild(itemDiv);
    });
    searchResultsDiv.style.display = 'block';
    selectedSearchIndex = -1;
}

function highlightMatch(text, query) {
    if (!query || !text) return text;
    const lowerText = text.toLowerCase();
    const lowerQuery = query.toLowerCase();
    const index = lowerText.indexOf(lowerQuery);
    if (index === -1) return text;
    const before = text.substring(0, index);
    const match = text.substring(index, index + query.length);
    const after = text.substring(index + query.length);
    return `${before}<span class="highlight">${match}</span>${after}`;
}

function hideSearchResults() {
    searchResultsDiv.style.display = 'none';
    selectedSearchIndex = -1;
}

function updateSearchSelection() {
    const results = searchResultsDiv.querySelectorAll('.search-item');
    results.forEach(item => item.classList.remove('active'));
    if (selectedSearchIndex >= 0 && selectedSearchIndex < results.length) {
        results[selectedSearchIndex].classList.add('active');
        results[selectedSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function selectProductFromSearch(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if (!product) return;
    const catSelect = document.getElementById("category");
    if (catSelect.value === "") {
        if (confirm(`"${product.name}" ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ${product.category} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            catSelect.value = product.category;
        } else { hideSearchResults(); return; }
    } else if (catSelect.value !== product.category) {
        if (!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø "${catSelect.options[catSelect.selectedIndex].text}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®,\n‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${product.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            hideSearchResults(); return;
        }
        catSelect.value = product.category;
    }
    setTimeout(() => {
        filterProducts().then(() => {
            const workSelect = document.getElementById("work");
            for(let i = 0; i < workSelect.options.length; i++) {
                if(workSelect.options[i].value === product.key) {
                    workSelect.selectedIndex = i;
                    document.getElementById("rate").value = product.sellPrice;
                    document.getElementById("qty").value = 1;
                    setTimeout(() => {
                        document.getElementById("qty").focus();
                        document.getElementById("qty").select();
                    }, 50);
                    showTempMessage(`${product.serial ? product.serial + ' - ' : ''}${product.name} ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
                    document.getElementById("searchSerial").value = "";
                    hideSearchResults(); break;
                }
            }
        });
    }, 100);
}

// Initialization
window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
    searchResultsDiv = document.getElementById("searchResults");
    setupSearchFunctionality();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    loadExistingCustomers();
    setupAutoLogout();
    checkDuePayments();
    setInterval(checkLowStock, 60 * 60 * 1000);
    
    // ‡¶´‡ßã‡¶® ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
    const phoneInput = document.getElementById("phone");
    phoneInput.addEventListener('input', function(e) {
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®
        let value = this.value.replace(/\D/g, '');
        
        // ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶®‡¶æ
        if (value.length > 11) {
            value = value.substring(0, 11);
        }
        
        // ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        if (value.length >= 11) {
            this.value = formatPhoneNumber(value);
            
            // ‡¶Ö‡¶ü‡ßã‡¶´‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
            autoFillCustomerName(this.value);
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ò‡¶∞‡ßá focus ‡¶ï‡¶∞‡ßÅ‡¶®
            setTimeout(() => {
                const noteInput = document.getElementById("note");
                if (noteInput.value && noteInput.value.trim() !== "") {
                    noteInput.focus();
                    noteInput.select();
                }
            }, 100);
        } else {
            this.value = value;
        }
    });
    
    // ‡¶´‡ßã‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá paste ‡¶π‡¶≤‡ßá
    phoneInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pastedText.replace(/\D/g, '');
        
        if (numbers.length >= 11) {
            const formatted = formatPhoneNumber(numbers.substring(0, 11));
            this.value = formatted;
            
            // ‡¶Ö‡¶ü‡ßã‡¶´‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
            autoFillCustomerName(formatted);
            
            setTimeout(() => {
                const noteInput = document.getElementById("note");
                if (noteInput.value && noteInput.value.trim() !== "") {
                    noteInput.focus();
                    noteInput.select();
                }
            }, 100);
        } else {
            this.value = numbers;
        }
    });
};

function loadExistingCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        existingCustomers = {};
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone; const name = entry.note;
            if (phone && name && name !== "General Customer") {
                existingCustomers[phone] = name;
                customerCache[phone] = name;
            }
        });
    });
}

// Authentication
function login(){
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();
    const users = {admin:"123", owner:"456", roky:"789"};
    if(users[u] === p){ 
        localStorage.setItem("loggedInUser", u); 
        setupUser(u); 
    } else { 
        alert("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); 
    }
}

function setupUser(u) {
    currentUser = u; 
    document.getElementById("loginDiv").style.display = "none"; 
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "block"; 
    document.getElementById("menuBtn").style.display = "block";
    const userRole = u === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : (u === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
    document.getElementById("userShow").innerHTML = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <b style="text-transform:uppercase">${u}</b> (${userRole})`;
    loadAllProducts(); loadEntries(); showSection('dashboard'); loadAllCustomers();
}

function logout() { 
    localStorage.removeItem("loggedInUser"); 
    location.reload(); 
}

function validatePhoneNumber(phone) {
    const cleanPhone = phone.replace(/\D/g, '');
    const patterns = [
        /^01[3-9]\d{8}$/,      // 013-019 (11 digits)
        /^1[3-9]\d{8}$/,       // 13-19 (10 digits - without 0)
        /^8801[3-9]\d{8}$/,    // 88013-88019 (13 digits)
    ];
    for (let pattern of patterns) {
        if (pattern.test(cleanPhone)) {
            return { isValid: true, formatted: formatPhoneNumber(cleanPhone), raw: cleanPhone };
        }
    }
    return { isValid: false, message: "‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017XXXXXXXX" };
}

function checkCustomerName() {
    const name = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const validationDiv = document.getElementById("customerValidation");
    
    if (!name) {
        validationDiv.innerHTML = "";
        return;
    }
    
    if (phone && phone.length >= 7) {
        const cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.length >= 11) {
            customerCache[cleanPhone] = name;
            showValidationMessage("‚úÖ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
        } else {
            showValidationMessage("üì± ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡ßü (‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)", "warning");
        }
    } else {
        showValidationMessage("üì± ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶™‡¶∞‡ßá ‡¶∏‡¶π‡¶ú‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®", "warning");
    }
}

function showValidationMessage(message, type) {
    const validationDiv = document.getElementById("customerValidation");
    validationDiv.innerHTML = `<div class="validation-${type}">${message}</div>`;
}

// Payment Validation
function validatePayment() {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const phone = document.getElementById("phone").value.trim();
    const validationDiv = document.getElementById("paymentValidation");
    const finalWarning = document.getElementById("finalWarning");
    
    document.getElementById("due").value = due;
    validationDiv.innerHTML = "";
    finalWarning.innerHTML = "";
    finalWarning.style.display = "none";
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
    if (phone && phone !== "") {
        const phoneValidation = validatePhoneNumber(phone);
        if (!phoneValidation.isValid && due > 0) {
            validationDiv.innerHTML = `<div class="validation-error">${phoneValidation.message}</div>`;
        } else if (phoneValidation.isValid) {
            document.getElementById("phone").value = phoneValidation.formatted;
        }
    }
    
    if (due === 0) {
        validationDiv.innerHTML = `<div class="validation-success">‚úÖ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶π‡ßü‡ßá‡¶õ‡ßá</div>`;
    } else if (due > 0) {
        validationDiv.innerHTML = `<div class="validation-warning">‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due}</div>`;
    } else if (due < 0) {
        validationDiv.innerHTML = `<div class="validation-error">‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due}</div>`;
    }
    
    if (due > 0 && taken === 0) {
        validationDiv.innerHTML = `<div class="validation-error due-warning">üö® ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due}</div>`;
    }
}

// Final Validation Before Save
function validateAndSave(showMemoFlag) {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const note = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const finalWarning = document.getElementById("finalWarning");
    
    let warnings = []; let errors = [];
    
    // ‡¶®‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï
    if (!note || note === "") {
        errors.push("‚ùå ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");
    }
    
    // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ö‡ßá‡¶ï
    if (taken === 0 && due > 0) {
        errors.push("üö® ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø!");
    }
    if (due < 0) {
        errors.push("‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá!");
    }
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
    if (phone && phone !== "") {
        const phoneValidation = validatePhoneNumber(phone);
        if (!phoneValidation.isValid) {
            if (due > 0) {
                errors.push("üö® ‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®");
            } else {
                warnings.push("üì± ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü (‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017XXXXXXXX)");
            }
        }
        
        // ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶´‡ßã‡¶® ‡¶ö‡ßá‡¶ï
        if (phoneValidation.isValid && existingCustomers[phoneValidation.raw] && existingCustomers[phoneValidation.raw] !== note) {
            warnings.push(`üìû ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞: ${existingCustomers[phoneValidation.raw]}`);
        }
    }
    
    // ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ
    if (due > 0) {
        if (!phone || phone === "") {
            errors.push("üö® ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®)");
        }
        warnings.push(`‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due}`);
    }
    
    // ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    if (errors.length > 0 || warnings.length > 0) {
        let warningHTML = "";
        if (errors.length > 0) {
            warningHTML += `<div class="validation-error" style="margin-bottom:10px;"><strong>‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:</strong><br>${errors.join('<br>')}</div>`;
        }
        if (warnings.length > 0) {
            warningHTML += `<div class="validation-warning"><strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong><br>${warnings.join('<br>')}</div>`;
        }
        finalWarning.innerHTML = warningHTML;
        finalWarning.style.display = 'block';
        
        // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã error ‡¶•‡¶æ‡¶ï‡ßá
        if (errors.length > 0) {
            let errorMessage = "‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶Ü‡¶õ‡ßá:\n\n" + errors.join('\n') + "\n\n";
            if (warnings.length > 0) {
                errorMessage += "‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:\n" + warnings.join('\n') + "\n\n";
            }
            errorMessage += "‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?";
            if (!confirm(errorMessage)) { return; }
        }
    }
    
    // ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    saveBulkEntry(showMemoFlag);
}

// ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function loadAllProducts(){
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        const stockBody = document.getElementById("stockBody");
        stockBody.innerHTML = "";
        const categories = new Set();
        
        let totalStockValue = 0;
        let totalItems = 0;
        let lowStockCount = 0;
        let serviceItems = 0;
        
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key;
            allProducts.push(p);
            categories.add(p.category);
            
            // ‡¶∏‡ßç‡¶ü‡¶ï ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
            if(!p.isService && p.qty && p.costPrice) {
                totalStockValue += (p.qty * p.costPrice);
                totalItems++;
            }
            if(p.isService) serviceItems++;
            
            let stockDisplay = "";
            let minStock = p.minStock || 5;
            let rowClass = "";
            
            // ‡¶≤‡ßã ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ö‡ßá‡¶ï (‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
            if(!p.isService) {
                if(p.qty <= minStock) {
                    rowClass = "low-stock";
                    lowStockCount++;
                    
                    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
                    if(p.category === "Paper" && p.qty <= 2) {
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">${p.qty} ‚ö†Ô∏è (‡¶ï‡¶æ‡¶ó‡¶ú ‡¶ï‡¶Æ!)</span>`;
                    } else if(p.category === "Pen" && p.qty <= 20) {
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">${p.qty} ‚ö†Ô∏è (‡¶ï‡¶≤‡¶Æ ‡¶ï‡¶Æ!)</span>`;
                    } else if(p.category === "Khata" && p.qty <= 10) {
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">${p.qty} ‚ö†Ô∏è (‡¶ñ‡¶æ‡¶§‡¶æ ‡¶ï‡¶Æ!)</span>`;
                    } else if(p.qty <= minStock) {
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">${p.qty} ‚ö†Ô∏è</span>`;
                    } else {
                        stockDisplay = p.qty;
                    }
                } else {
                    stockDisplay = p.qty;
                }
            } else {
                stockDisplay = `Service`;
            }
            
            // ‡¶è‡¶°‡¶ø‡¶ü ‡¶ì ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
            const btnEdit = `<button class="btn-action btn-edit" onclick="editStockItem('${p.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
            const btnDel = currentUser === 'owner' || currentUser === 'admin' 
                ? `<button class="btn-action btn-del" onclick="delProduct('${p.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">üóëÔ∏è</button>`
                : `<button class="btn-action btn-del" disabled title="‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï/‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá" style="opacity:0.5">üóëÔ∏è</button>`;
            
            stockBody.innerHTML += `<tr class="${rowClass}">
                <td>${p.serial || '-'}</td>
                <td>${p.category}</td>
                <td>${p.name}</td>
                <td style="text-align:center">${stockDisplay}</td>
                <td style="text-align:center">${!p.isService ? (p.minStock || 5) : '-'}</td>
                <td style="text-align:right">${!p.isService ? (p.costPrice || '0') : '-'}</td>
                <td style="text-align:right">${p.sellPrice}</td>
                <td class="noPrint" style="text-align:center">${btnEdit} ${btnDel}</td>
            </tr>`;
        });
        
        // ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        document.getElementById("totalProducts").innerText = allProducts.length;
        document.getElementById("lowStockCount").innerText = lowStockCount;
        document.getElementById("totalStockValue").innerText = totalStockValue.toFixed(2);
        document.getElementById("totalItemsCount").innerText = totalItems;
        document.getElementById("lowStockItems").innerText = lowStockCount;
        document.getElementById("serviceItemsCount").innerText = serviceItems;
        
        // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        const catSelect = document.getElementById("category");
        catSelect.innerHTML = "<option value=''>=== ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>";
        const sortedCategories = Array.from(categories).sort();
        sortedCategories.forEach(c => { 
            catSelect.innerHTML += `<option value="${c}">${c}</option>`; 
        });
        filterProducts();
        
        // ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶ö‡ßá‡¶ï
        checkLowStock();
    });
}

function editStockItem(key) {
    const product = allProducts.find(p => p.key === key);
    if(!product) return;
    
    document.getElementById("editStockKey").value = key;
    document.getElementById("editSerial").value = product.serial || "";
    document.getElementById("editCategory").value = product.category || "";
    document.getElementById("editName").value = product.name || "";
    document.getElementById("editIsService").checked = product.isService || false;
    document.getElementById("editQty").value = product.qty || 0;
    document.getElementById("editCost").value = product.costPrice || 0;
    document.getElementById("editSell").value = product.sellPrice || 0;
    document.getElementById("editMinStock").value = product.minStock || 5;
    
    toggleEditStockInput();
    document.getElementById("editStockModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function toggleEditStockInput() {
    const isService = document.getElementById("editIsService").checked;
    document.getElementById("editQty").disabled = isService;
    document.getElementById("editCost").disabled = isService;
    document.getElementById("editMinStock").disabled = isService;
    
    if(isService) {
        document.getElementById("editQty").style.background = "#eee";
        document.getElementById("editCost").style.background = "#eee";
        document.getElementById("editMinStock").style.background = "#eee";
    } else {
        document.getElementById("editQty").style.background = "#fff";
        document.getElementById("editCost").style.background = "#fff";
        document.getElementById("editMinStock").style.background = "#fff";
    }
}

function updateStockItem() {
    const key = document.getElementById("editStockKey").value;
    const serial = document.getElementById("editSerial").value.trim();
    const category = document.getElementById("editCategory").value;
    const name = document.getElementById("editName").value.trim();
    const isService = document.getElementById("editIsService").checked;
    const qty = parseFloat(document.getElementById("editQty").value) || 0;
    const costPrice = parseFloat(document.getElementById("editCost").value) || 0;
    const sellPrice = parseFloat(document.getElementById("editSell").value) || 0;
    const minStock = parseFloat(document.getElementById("editMinStock").value) || 5;
    
    if(!category || !name || !sellPrice) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø, ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
    }
    
    const updates = {
        serial: serial,
        category: category,
        name: name,
        isService: isService,
        sellPrice: sellPrice,
        minStock: minStock
    };
    
    if(!isService) {
        updates.qty = qty;
        updates.costPrice = costPrice;
    } else {
        updates.qty = 0;
        updates.costPrice = 0;
    }
    
    db.ref("products/" + key).update(updates).then(() => {
        showTempMessage("‚úÖ ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal('editStockModal');
    });
}

function filterStockTable() {
    const categoryFilter = document.getElementById("filterCategory").value.toLowerCase();
    const searchTerm = document.getElementById("stockSearch").value.toLowerCase();
    const rows = document.querySelectorAll("#stockBody tr");
    
    let visibleCount = 0;
    let lowStockVisible = 0;
    
    rows.forEach(row => {
        if(row.cells.length < 3) return;
        
        const category = row.cells[1].textContent.toLowerCase();
        const name = row.cells[2].textContent.toLowerCase();
        const serial = row.cells[0].textContent.toLowerCase();
        
        const categoryMatch = !categoryFilter || category.includes(categoryFilter);
        const searchMatch = !searchTerm || 
            name.includes(searchTerm) || 
            serial.includes(searchTerm) ||
            category.includes(searchTerm);
        
        if(categoryMatch && searchMatch) {
            row.style.display = "";
            visibleCount++;
            
            // ‡¶≤‡ßã ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∞‡ßã ‡¶ö‡ßá‡¶ï
            if(row.classList.contains("low-stock")) {
                lowStockVisible++;
            }
        } else {
            row.style.display = "none";
        }
    });
    
    document.getElementById("totalProducts").innerText = visibleCount;
    document.getElementById("lowStockCount").innerText = lowStockVisible;
}

function checkLowStock() {
    let lowStockItems = [];
    let criticalItems = [];
    
    allProducts.forEach(p => {
        if(!p.isService) {
            const minStock = p.minStock || 5;
            const currentStock = p.qty || 0;
            
            if(currentStock <= minStock) {
                // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶™‡ßç‡¶∞‡¶æ‡ßü‡¶∞‡¶ø‡¶ü‡¶ø
                let priority = 1; // Normal priority
                
                if(p.category === "Paper" && currentStock <= 2) {
                    priority = 3; // High priority
                } else if(p.category === "Pen" && currentStock <= 10) {
                    priority = 2; // Medium priority
                } else if(p.category === "Khata" && currentStock <= 5) {
                    priority = 2; // Medium priority
                }
                
                const itemInfo = {
                    name: p.name,
                    stock: currentStock,
                    min: minStock,
                    category: p.category,
                    priority: priority
                };
                
                lowStockItems.push(itemInfo);
                
                if(priority === 3) {
                    criticalItems.push(`${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${currentStock}, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø: ${p.category})`);
                }
            }
        }
    });
    
    if(lowStockItems.length > 0) {
        // ‡¶™‡ßç‡¶∞‡¶æ‡ßü‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
        lowStockItems.sort((a, b) => b.priority - a.priority);
        
        let alertMessage = "‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:\n\n";
        
        lowStockItems.forEach(item => {
            let emoji = "‚ö†Ô∏è";
            if(item.priority === 3) emoji = "üö®";
            if(item.priority === 2) emoji = "‚ö†Ô∏è";
            
            alertMessage += `${emoji} ${item.name} - ‡¶∏‡ßç‡¶ü‡¶ï: ${item.stock} (‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ: ${item.min})\n`;
        });
        
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡ßç‡¶∞‡¶ø‡¶ü‡¶ø‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
        if(criticalItems.length > 0) {
            showTempMessage(`üö® ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ: ${criticalItems.length}‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡¶∂‡ßá‡¶∑!`, "error");
            
            // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï/‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶ï‡ßç‡¶∞‡¶ø‡¶ü‡¶ø‡¶ï‡¶æ‡¶≤ ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü
            if(currentUser === 'owner' || currentUser === 'admin') {
                setTimeout(() => {
                    if(confirm(alertMessage + "\n\n‡¶∏‡ßç‡¶ü‡¶ï ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶®‡¶ø‡¶∂‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                        // ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
                        console.log("‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ...");
                    }
                }, 1000);
            }
        }
    }
}

function exportStockToExcel() {
    let csv = "\ufeff‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤,‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø,‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ,‡¶∏‡ßç‡¶ü‡¶ï,‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï,‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ,‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø,‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏\n";
    
    allProducts.forEach(p => {
        const isService = p.isService ? "‡¶π‡ßç‡¶Ø‡¶æ‡¶Å" : "‡¶®‡¶æ";
        const minStock = p.minStock || 5;
        const costPrice = p.isService ? "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü" : (p.costPrice || "0");
        
        csv += `"${p.serial || ''}","${p.category || ''}","${p.name || ''}",${p.qty || 0},${minStock},${costPrice},${p.sellPrice || 0},${isService}\n`;
    });
    
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
    link.download = `‡¶∏‡ßç‡¶ü‡¶ï_‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü_${new Date().toLocaleDateString('bn-BD')}.csv`;
    link.click();
}

function toggleStockInput() {
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    const minStockInput = document.getElementById("stMinStock");
    
    if(isService) {
        qtyInput.value = ""; 
        qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; 
        qtyInput.disabled = true; 
        qtyInput.style.background = "#eee";
        
        costInput.value = ""; 
        costInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; 
        costInput.disabled = true; 
        costInput.style.background = "#eee";
        
        minStockInput.value = ""; 
        minStockInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; 
        minStockInput.disabled = true; 
        minStockInput.style.background = "#eee";
    } else {
        qtyInput.disabled = false; 
        qtyInput.placeholder = "Qty"; 
        qtyInput.style.background = "#fff";
        
        costInput.disabled = false; 
        costInput.placeholder = "Cost"; 
        costInput.style.background = "#fff";
        
        minStockInput.disabled = false; 
        minStockInput.placeholder = "Min Stock"; 
        minStockInput.style.background = "#fff";
        minStockInput.value = "5";
    }
}

function addNewProduct() {
    const serial = document.getElementById("stSerial").value.trim();
    const cat = document.getElementById("stCategory").value;
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    const minStock = parseFloat(document.getElementById("stMinStock").value) || 5;
    
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    
    if(!cat || cat === "" || !name || !sell) {
        alert("Category, Name ‡¶è‡¶¨‡¶Ç Sell Price ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
    }
    
    const newProd = { 
        serial, 
        category: cat, 
        name, 
        qty, 
        isService, 
        costPrice: cost, 
        sellPrice: sell,
        minStock: minStock
    };
    
    db.ref("products").push(newProd).then(() => {
        showTempMessage(isService ? "‚úÖ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!" : "‚úÖ ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        
        // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
        document.getElementById("stSerial").value = "";
        document.getElementById("stCategory").value = "";
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stMinStock").value = "5";
        document.getElementById("stIsService").checked = false;
        toggleStockInput();
    });
}

function delProduct(key){
    if(currentUser === 'owner' || currentUser === 'admin'){ 
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) db.ref("products/"+key).remove(); 
    } else { 
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§"); 
    }
}

// Sales & Cart Logic
function filterProducts(){
    const cat = document.getElementById("category").value;
    const workSelect = document.getElementById("work");
    if (workSelect.value !== "") {
        workSelect.value = "";
        document.getElementById("rate").value = "";
    }
    workSelect.innerHTML = "<option value=''>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>";
    const filtered = cat ? allProducts.filter(p => p.category === cat) : [];
    if (cat && filtered.length === 0) {
        workSelect.innerHTML = "<option value=''>‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á</option>";
    } else if (cat) {
        filtered.sort((a, b) => {
            const serialA = a.serial || "999999";
            const serialB = b.serial || "999999";
            return serialA.localeCompare(serialB, undefined, {numeric: true});
        });
        filtered.forEach(p => { 
            const displayText = p.serial ? `${p.serial} - ${p.name}` : p.name;
            workSelect.innerHTML += `<option value="${p.key}" data-price="${p.sellPrice}">${displayText}</option>`; 
        });
    }
    return new Promise(resolve => setTimeout(resolve, 50));
}

function autoFillPrice(){
    const workSelect = document.getElementById("work");
    const selectedOption = workSelect.options[workSelect.selectedIndex];
    if(selectedOption && selectedOption.value){
        document.getElementById("rate").value = selectedOption.getAttribute("data-price") || "";
        document.getElementById("qty").focus();
    }
}

function addToCart(){
    const catSelect = document.getElementById("category");
    if (catSelect.value === "") {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        catSelect.focus(); return;
    }
    const workSelect = document.getElementById("work");
    const pKey = workSelect.value;
    const pNameRaw = workSelect.options[workSelect.selectedIndex]?.text;
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    if(!pKey || pKey === "") { alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!"); workSelect.focus(); return; }
    if(!r || r <= 0) { alert("‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®!"); document.getElementById("rate").focus(); return; }
    if(q <= 0) { alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!"); document.getElementById("qty").focus(); return; }
    const stockItem = allProducts.find(p => p.key === pKey);
    const pName = stockItem ? stockItem.name : pNameRaw;
    if (stockItem && catSelect.value !== stockItem.category) {
        alert(`‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${stockItem.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ü‡¶™‡¶®‡¶ø "${catSelect.options[catSelect.selectedIndex].text}" ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!`);
        return;
    }
    if(stockItem && !stockItem.isService && stockItem.qty < q) { 
        if(!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á! (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${stockItem.qty})‡•§ \n‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
    }
    cart.push({ 
        key: pKey, 
        work: pName, 
        qty: q, 
        rate: r, 
        sub: q * r, 
        isService: stockItem ? stockItem.isService : false 
    });
    renderCart(); 
    document.getElementById("qty").value=1; 
    document.getElementById("searchSerial").focus();
}

function renderCart(){
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    let grandTotal = 0;
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `<div class="cart-item"><span>${index+1}. ${item.work} <small>(${item.qty} x ${item.rate})</small></span><span><b>‡ß≥${item.sub}</b> <span onclick="removeCart(${index})" style="color:#e74c3c;cursor:pointer;margin-left:10px;font-weight:bold" title="Remove">√ó</span></span></div>`;
    });
    document.getElementById("total").value = grandTotal; 
    calcDue();
}

function removeCart(index){ 
    cart.splice(index,1); 
    renderCart(); 
}

function calcDue(){ 
    const t = parseFloat(document.getElementById("total").value) || 0;
    const k = parseFloat(document.getElementById("taken").value) || 0;
    document.getElementById("due").value = t - k;
}

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            db.ref("products/" + cItem.key).update({ qty: newQty });
        }
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    const dueVal = totalVal - takenVal;
    const note = document.getElementById("note").value.trim();
    const phone = document.getElementById("phone").value.trim();
    
    // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
    const cleanPhone = phone.replace(/\D/g, '');
    
    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    if (cleanPhone && note) {
        customerCache[cleanPhone] = note;
        existingCustomers[cleanPhone] = note;
    }
    
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: dueVal,
        user: currentUser,
        note: note || "General Customer",
        phone: cleanPhone || ""
    };
    
    db.ref("entries").push(entryData).then((snap) => {
        deductStock(cart);
        if(showMemoFlag) {
             entryData.key = snap.key;
             showMemo(entryData);
        } else {
             showTempMessage("‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
        // UI ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        cart = []; 
        renderCart(); 
        document.getElementById("note").value = ""; 
        document.getElementById("phone").value = ""; 
        document.getElementById("taken").value = ""; 
        document.getElementById("due").value = "0";
        document.getElementById("customerValidation").innerHTML = "";
        document.getElementById("paymentValidation").innerHTML = "";
        document.getElementById("finalWarning").innerHTML = "";
        document.getElementById("finalWarning").style.display = "none";
        document.getElementById("searchSerial").focus();
        // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        loadAllCustomers();
    });
}

// Customer Management System
function searchCustomer() {
    const query = document.getElementById("searchCustomerInput").value.trim();
    if (!query) { alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!"); return; }
    showTempMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...", "info");
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) { alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!"); return; }
        const customers = {}; let found = false;
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone || ""; const note = entry.note || "";
            if (phone.includes(query) || note.toLowerCase().includes(query.toLowerCase())) {
                found = true;
                if (!customers[phone]) {
                    customers[phone] = {
                        name: note, phone: phone, totalSpent: 0, totalPaid: 0, totalDue: 0,
                        lastDate: "", transactions: []
                    };
                }
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                customers[phone].transactions.push({
                    key: key, date: entry.date, time: entry.time, total: entry.total,
                    paid: entry.taken, due: entry.loss, items: entry.items, user: entry.user
                });
            }
        });
        if (!found) { alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!"); return; }
        const customerList = Object.values(customers);
        if (customerList.length === 1) {
            currentCustomerData = customerList[0]; showCustomerDetails(currentCustomerData);
        } else { showCustomerList(customerList); }
    });
}

function showCustomerList(customers) {
    const modal = document.createElement('div'); modal.className = 'modal'; modal.style.width = '500px'; modal.style.zIndex = '2000';
    let html = '<h3 style="margin-top:0;color:#3498db;">‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</h3>';
    html += '<p style="margin-bottom:15px;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</p>';
    html += '<div style="max-height:300px;overflow-y:auto;margin-bottom:20px;">';
    customers.forEach((customer, index) => {
        html += `<div style="padding:12px;border-bottom:1px solid #eee;cursor:pointer;border-radius:5px;margin-bottom:5px;background:#f8f9fa;" onclick="selectCustomerFromList('${customer.phone}')" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='#f8f9fa'"><div style="font-weight:bold;color:#2c3e50;">${customer.name}</div><div style="font-size:14px;color:#666;"><span>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${customer.phone || '‡¶®‡ßá‡¶á'}</span> | <span>‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</span> | <span>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span></div></div>`;
    });
    html += '</div><button onclick="closeCustomerListModal()" style="background:#e74c3c;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>';
    modal.innerHTML = html; document.body.appendChild(modal);
    modal.style.position = 'fixed'; modal.style.top = '50%'; modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)'; modal.style.display = 'block';
    document.getElementById("overlay").style.display = "block";
    window.closeCustomerListModal = function() {
        if (modal.parentNode) { document.body.removeChild(modal); }
        document.getElementById("overlay").style.display = "none";
    };
}

function selectCustomerFromList(phone) {
    if (typeof closeCustomerListModal === 'function') { closeCustomerListModal(); }
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        const customers = {}; let foundCustomer = null;
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone) {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note, phone: phone, totalSpent: 0, totalPaid: 0, totalDue: 0,
                        lastDate: "", transactions: []
                    };
                }
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                customers[phone].transactions.push({
                    key: key, date: entry.date, time: entry.time, total: entry.total,
                    paid: entry.taken, due: entry.loss, items: entry.items, user: entry.user
                });
            }
        });
        if (customers[phone]) {
            currentCustomerData = customers[phone]; showCustomerDetails(currentCustomerData);
        }
    });
}

function showCustomerDetails(customer) {
    currentCustomerData = customer;
    document.getElementById("customerDetails").style.display = "block";
    document.getElementById("customerHistorySection").style.display = "block";
    document.getElementById("customerNameTitle").innerText = customer.name;
    const infoDiv = document.getElementById("customerInfo");
    infoDiv.innerHTML = `<div class="customer-summary ${customer.totalDue > 0 ? 'due-alert' : 'paid-alert'}"><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px;"><div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong><br><span style="font-size:18px;font-weight:bold;">${customer.name}</span></div><div><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</strong><br><span style="font-size:18px;color:#3498db;">${customer.phone || "‡¶®‡ßá‡¶á"}</span></div></div><div class="customer-stats"><div class="stat-box"><div style="font-size:14px;color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</div><div class="stat-value" style="color:#2c3e50;">‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</div></div><div class="stat-box"><div style="font-size:14px;color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</div><div class="stat-value" style="color:#27ae60;">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</div></div><div class="stat-box"><div style="font-size:14px;color:#666;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</div><div class="stat-value" style="color:${customer.totalDue > 0 ? '#e74c3c' : '#2ecc71'};">‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</div></div></div><div style="margin-top:15px;color:#666;font-size:14px;"><span>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ: ${customer.lastDate || "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á"}</span><span style="float:right;">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span></div></div>`;
    displayCustomerTransactions(customer.transactions || []);
}

function displayCustomerTransactions(transactions) {
    const tbody = document.getElementById("customerTransactions");
    tbody.innerHTML = "";
    if (transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>`;
        return;
    }
    transactions.sort((a, b) => {
        const dateA = a.date ? a.date.split('/').reverse().join('-') : '1970-01-01';
        const dateB = b.date ? b.date.split('/').reverse().join('-') : '1970-01-01';
        return new Date(dateB) - new Date(dateA);
    });
    transactions.forEach(trans => {
        const itemSummary = trans.items && Array.isArray(trans.items) 
            ? trans.items.slice(0, 2).map(i => `${i.work}`).join(', ') + (trans.items.length > 2 ? '...' : '')
            : "‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶£‡ßç‡¶Ø";
        tbody.innerHTML += `<tr><td>${trans.date || ''}<br><small>${trans.time || ''}</small></td><td><small>${trans.key ? trans.key.slice(-6).toUpperCase() : ''}</small></td><td>${itemSummary}</td><td>‡ß≥${trans.total || '0'}</td><td style="color:#27ae60;font-weight:bold">‡ß≥${trans.paid || '0'}</td><td style="color:${trans.due > 0 ? '#e74c3c' : '#27ae60'}">‡ß≥${trans.due || '0'}</td><td class="noPrint"><button class="btn-action btn-print" onclick="viewMemo('${trans.key}')" title="‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®">üñ®Ô∏è</button></td></tr>`;
    });
}

function loadAllCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        const customers = {};
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            if (phone && entry.note && entry.note !== "General Customer") {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note, phone: phone, totalSpent: 0, totalPaid: 0, totalDue: 0, lastDate: ""
                    };
                }
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
            }
        });
        displayAllCustomersTable(customers);
    });
}

function displayAllCustomersTable(customers) {
    const tbody = document.getElementById("allCustomers");
    tbody.innerHTML = "";
    const customerList = Object.values(customers);
    if (customerList.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
        return;
    }
    customerList.sort((a, b) => (b.totalDue || 0) - (a.totalDue || 0));
    customerList.forEach(customer => {
        // ‡¶è‡¶°‡¶ø‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ø‡ßã‡¶ó
        const btnEdit = `<button class="btn-action btn-edit" onclick="editCustomer('${customer.phone}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = currentUser === 'owner' || currentUser === 'admin' 
            ? `<button class="btn-action btn-del" onclick="deleteCustomerConfirm('${customer.phone}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">üóëÔ∏è</button>`
            : `<button class="btn-action btn-del" disabled title="‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï/‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá" style="opacity:0.5">üóëÔ∏è</button>`;
        
        tbody.innerHTML += `<tr style="${customer.totalDue > 0 ? 'background:#fff8f8' : ''}">
            <td><strong>${customer.name}</strong></td>
            <td>${customer.phone}</td>
            <td>‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</td>
            <td style="color:#27ae60">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</td>
            <td style="color:${customer.totalDue > 0 ? '#e74c3c' : '#27ae60'};font-weight:bold">‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'} ${customer.totalDue > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</td>
            <td>${customer.lastDate || 'N/A'}</td>
            <td class="noPrint" style="text-align:center">${btnEdit} ${btnDel}</td>
        </tr>`;
    });
}

function editCustomer(phone) {
    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        let customerInfo = {
            name: "",
            phone: phone,
            totalSpent: 0,
            totalPaid: 0,
            totalDue: 0,
            transactions: 0
        };
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone) {
                if (!customerInfo.name && entry.note && entry.note !== "General Customer") {
                    customerInfo.name = entry.note;
                }
                customerInfo.totalSpent += parseFloat(entry.total) || 0;
                customerInfo.totalPaid += parseFloat(entry.taken) || 0;
                customerInfo.totalDue += parseFloat(entry.loss) || 0;
                customerInfo.transactions++;
            }
        });
        
        if (!customerInfo.name) {
            alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        // ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        document.getElementById("editCustomerPhone").value = phone;
        document.getElementById("editCustomerName").value = customerInfo.name;
        document.getElementById("editCustomerMobile").value = phone;
        document.getElementById("editCustomerTotal").value = customerInfo.totalSpent.toFixed(2);
        document.getElementById("editCustomerPaid").value = customerInfo.totalPaid.toFixed(2);
        document.getElementById("editCustomerDue").value = customerInfo.totalDue.toFixed(2);
        document.getElementById("editCustomerTransactions").value = customerInfo.transactions;
        
        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        document.getElementById("editCustomerModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

function updateCustomer() {
    const oldPhone = document.getElementById("editCustomerPhone").value;
    const newName = document.getElementById("editCustomerName").value.trim();
    const newPhone = document.getElementById("editCustomerMobile").value.trim();
    
    if (!newName) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
    }
    
    if (newPhone && newPhone !== oldPhone) {
        // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        const phoneValidation = validatePhoneNumber(newPhone);
        if (!phoneValidation.isValid) {
            alert("‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017XXXXXXXX");
            return;
        }
    }
    
    if (!confirm("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        return;
    }
    
    // ‡¶∏‡¶ï‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        const updates = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === oldPhone) {
                updates[`${key}/note`] = newName;
                if (newPhone && newPhone !== oldPhone) {
                    updates[`${key}/phone`] = newPhone.replace(/\D/g, '');
                }
            }
        });
        
        // ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        db.ref("entries").update(updates).then(() => {
            showTempMessage("‚úÖ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            closeModal('editCustomerModal');
            loadAllCustomers();
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
            if (document.getElementById("customerDetails").style.display === "block") {
                searchCustomer();
            }
        });
    });
}

function deleteCustomerConfirm(phone) {
    if (!confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶¨‡ßá!\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
        return;
    }
    
    // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        let customerName = "";
        let entryCount = 0;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone && entry.note && entry.note !== "General Customer") {
                if (!customerName) customerName = entry.note;
                entryCount++;
            }
        });
        
        if (entryCount === 0) {
            alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        if (confirm(`‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ${customerName} (${phone}) - ${entryCount}‡¶ü‡¶ø ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶¨‡ßá!\n\n‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            deleteCustomer(phone);
        }
    });
}

function deleteCustomer(phone) {
    showTempMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "info");
    
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val(); if (!data) return;
        const updates = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone) {
                updates[key] = null; // ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø null ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            }
        });
        
        // ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        db.ref("entries").update(updates).then(() => {
            showTempMessage("‚úÖ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            closeModal('editCustomerModal');
            loadAllCustomers();
            
            // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
            document.getElementById("customerDetails").style.display = "none";
            document.getElementById("customerHistorySection").style.display = "none";
        });
    });
}

function viewCustomerDetail(phone) {
    document.getElementById("searchCustomerInput").value = phone;
    searchCustomer();
}

function clearCustomerSearch() {
    document.getElementById("customerDetails").style.display = "none";
    document.getElementById("customerHistorySection").style.display = "none";
    document.getElementById("searchCustomerInput").value = "";
    currentCustomerData = null;
}

function printCustomerReceipt() {
    if (!currentCustomerData || !currentCustomerData.transactions || currentCustomerData.transactions.length === 0) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á!"); return;
    }
    const latestTrans = currentCustomerData.transactions[0];
    viewMemo(latestTrans.key);
}

function addPayment() {
    if (!currentCustomerData) { alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®!"); return; }
    document.getElementById("payCustomerName").value = currentCustomerData.name;
    document.getElementById("payCustomerPhone").value = currentCustomerData.phone;
    document.getElementById("payCurrentDue").value = currentCustomerData.totalDue ? currentCustomerData.totalDue.toFixed(2) : '0.00';
    document.getElementById("payAmount").value = "";
    document.getElementById("payComment").value = "‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø";
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    document.getElementById("paymentModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function processPayment() {
    const amount = parseFloat(document.getElementById("payAmount").value);
    const date = document.getElementById("payDate").value;
    const comment = document.getElementById("payComment").value || "‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ";
    if (!amount || amount <= 0) { alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!"); return; }
    if (!currentCustomerData) { alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!"); return; }
    const formattedDate = date.split('-').reverse().join('/');
    const paymentEntry = {
        date: formattedDate, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP, items: [{ work: comment, qty: 1, rate: amount, sub: amount }],
        total: amount, taken: amount, loss: 0, user: currentUser,
        note: `${currentCustomerData.name} - ${comment}`, phone: currentCustomerData.phone, isPayment: true
    };
    db.ref("entries").push(paymentEntry).then(() => {
        showTempMessage(`‚úÖ ‡ß≥${amount} ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
        closeModal('paymentModal');
        searchCustomer(); loadAllCustomers();
    });
}

// Temporary Message Function
function showTempMessage(message, type = "success") {
    const existingMsg = document.querySelector('.temp-message');
    if (existingMsg) {
        existingMsg.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => existingMsg.remove(), 300);
    }
    const msgDiv = document.createElement("div");
    msgDiv.className = "temp-message";
    msgDiv.textContent = message;
    msgDiv.style.background = type === "success" ? "#2ecc71" : type === "error" ? "#e74c3c" : type === "info" ? "#3498db" : "#f39c12";
    document.body.appendChild(msgDiv);
    setTimeout(() => {
        if (msgDiv.parentNode) {
            msgDiv.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => { if (msgDiv.parentNode) msgDiv.remove(); }, 300);
        }
    }, 3000);
}

// Memo & Printing
function viewMemo(key) { 
    db.ref("entries/" + key).once("value", s => { 
        if(s.val()) { let data = s.val(); data.key = key; showMemo(data); }
    }); 
}

function showMemo(e){
    document.getElementById("mId").innerText = (e.key ? e.key.slice(-6).toUpperCase() : '---');
    document.getElementById("mDate").innerText = (e.date || '') + " " + (e.time || '');
    document.getElementById("mUser").innerText = e.user || '';
    document.getElementById("mNote").innerText = e.note || '';
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total || '0';
    document.getElementById("mPaid").innerText = e.taken || '0';
    document.getElementById("mDueDisplay").innerText = e.loss || '0';
    const mItems = document.getElementById("mItems"); mItems.innerHTML = "";
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => {
            mItems.innerHTML += `<tr><td style="border:1px solid #ddd;padding:8px">${i.work || ''}</td><td style="text-align:center;border:1px solid #ddd;padding:8px">${i.qty || '0'}</td><td style="text-align:right;border:1px solid #ddd;padding:8px">${i.sub || '0'}</td></tr>`;
        });
    } else {
        mItems.innerHTML += `<tr><td>${e.work || ''}</td><td>-</td><td>${e.total || '0'}</td></tr>`;
    }
    const signs = { owner: ["Toosher Ahmed", "01913-812765"], admin: ["Arafat Sikder", "016749-44985"], roky: ["Roky", "01878-149052"] };
    const s = signs[e.user] || [e.user ? e.user.toUpperCase() : '', ""];
    document.getElementById("signatureName").innerText = s[0];
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(id) { 
    document.getElementById(id).style.display="none"; 
    document.getElementById("overlay").style.display="none"; 
}

// Editing & Deleting
function openEdit(key) {
    db.ref("entries/" + key).once("value", s => {
        const d = s.val();
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note || '';
        document.getElementById("editPhone").value = d.phone || '';
        document.getElementById("editTotal").value = d.total || 0;
        document.getElementById("editTaken").value = d.taken || 0;
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    db.ref("entries/" + key).update({ 
        note: document.getElementById("editNote").value, 
        phone: document.getElementById("editPhone").value, 
        total: t, taken: k, loss: t - k
    }).then(() => { 
        showTempMessage("‚úÖ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); closeModal("editModal"); loadAllCustomers();
    });
}

function delEntry(key){ 
    db.ref("entries/"+key).once("value", s => { 
        const entry = s.val();
        if(entry.user !== currentUser && currentUser !== 'admin' && currentUser !== 'owner') {
             return alert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!");
        }
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            if(entry.items && Array.isArray(entry.items)){
                entry.items.forEach(item => {
                    if(item.key && !item.isService){
                         const prod = allProducts.find(p => p.key === item.key);
                         if(prod){
                             const currentQty = parseFloat(prod.qty) || 0;
                             const returnQty = parseFloat(item.qty) || 0;
                             db.ref("products/" + item.key).update({ qty: currentQty + returnQty });
                         }
                    }
                });
            }
            db.ref("entries/"+key).remove();
            showTempMessage("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "error");
            loadAllCustomers();
        }
    }); 
}

// Reporting & Charts
function loadEntries(){ 
    db.ref("entries").limitToLast(100).on("value", s => renderTable(s.val(), "tableBody")); 
}

function renderTable(data, tableId = "tableBody"){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    if(!data) { 
        if(tableId === "reportTableBody") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>"; 
        return; 
    }
    let totalSales=0, totalTaken=0, totalDue=0;
    let dailyData = {};
    const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
    entriesArr.forEach(e => {
        const total = parseFloat(e.total) || 0;
        const taken = parseFloat(e.taken) || 0;
        const loss = parseFloat(e.loss) || 0;
        totalSales += total; totalTaken += taken; totalDue += loss;
        const itemSummary = (e.items && Array.isArray(e.items)) 
            ? e.items.map(i => `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work} (${i.qty})</span>`).join(" ") 
            : e.work;
        const phone = e.phone || "-";
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${e.key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${e.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = `<button class="btn-action btn-del" onclick="delEntry('${e.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>`;
        tbody.innerHTML+=`<tr><td style="font-size:13px">${e.date || ''}<br>${e.time || ''}</td><td style="font-size:13px"><b>${e.note || ''}</b><br>${itemSummary}</td><td class="en">${phone}</td><td>${total}</td><td style="color:#27ae60;font-weight:bold">${taken}</td><td style="color:#e74c3c">${loss}</td><td style="text-transform:capitalize">${e.user || ''}</td><td class="noPrint" style="white-space:nowrap">${btnMemo}${btnEdit}${btnDel}</td></tr>`;
        if (e.date) { dailyData[e.date] = (dailyData[e.date]||0) + total; }
    });
    if(tableId === "tableBody") { 
        document.getElementById("cCount").innerText = entriesArr.length; 
        document.getElementById("cTotal").innerText = totalSales.toFixed(2); 
        document.getElementById("cTaken").innerText = totalTaken.toFixed(2); 
        document.getElementById("cDue").innerText = totalDue.toFixed(2); 
        updateChart(dailyData); renderUserStats(data); 
    }
}

function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {}; let hasData = false;
    ['admin', 'owner', 'roky'].forEach(u => stats[u] = {total:0, taken:0, due:0});
    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            if(e.date === today) {
                hasData = true; 
                const u = e.user ? e.user.toLowerCase() : '';
                if(!stats[u]) stats[u] = {total:0, taken:0, due:0};
                stats[u].total += (parseFloat(e.total) || 0); 
                stats[u].taken += (parseFloat(e.taken) || 0); 
                stats[u].due += (parseFloat(e.loss) || 0);
            }
        });
    }
    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    if(!hasData) { 
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`; 
        return; 
    }
    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) { 
            tbody.innerHTML += `<tr><td style="text-transform:capitalize;font-weight:bold">${u}</td><td>${stats[u].total.toFixed(2)}</td><td style="color:#27ae60;font-weight:bold">${stats[u].taken.toFixed(2)}</td><td style="color:#e74c3c">${stats[u].due.toFixed(2)}</td></tr>`; 
        }
    });
}

function updateChart(data){
    const sortedDates = Object.keys(data).sort((a,b) => {
        const [d1,m1,y1] = a.split('/'); 
        const [d2,m2,y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    });
    const labels = sortedDates.slice(-10);
    const values = labels.map(d => data[d]);
    if(salesChart) salesChart.destroy();
    const ctx = document.getElementById('salesChart');
    if(ctx) { 
        salesChart = new Chart(ctx, { 
            type: 'bar', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (‡¶ü‡¶æ‡¶ï‡¶æ)', 
                    data: values, 
                    backgroundColor: '#2ecc71',
                    borderRadius: 5
                }] 
            }, 
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } } 
            } 
        }); 
    }
}

// New Features Added
function checkDuePayments() {
    db.ref("entries").once("value", snapshot => {
        let totalDue = 0;
        let customersWithDue = [];
        snapshot.forEach(child => {
            const entry = child.val();
            if (entry.loss > 0) {
                totalDue += entry.loss;
                if (entry.note && entry.note !== "General Customer") {
                    customersWithDue.push(`${entry.note}: ‡ß≥${entry.loss}`);
                }
            }
        });
        if (totalDue > 0) {
            console.log(`‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${totalDue}`);
            console.log(`‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: ${customersWithDue.length}`);
        }
    });
}

function setupAutoLogout() {
    ['click', 'keypress', 'mousemove'].forEach(event => {
        document.addEventListener(event, () => {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (confirm("30 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶á‡¶®‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠! ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                    logout();
                }
            }, 30 * 60 * 1000); // 30 minutes
        });
    });
}

// Utilities
function showSection(id){ 
    document.querySelectorAll('.section').forEach(s=>s.style.display="none"); 
    document.getElementById(id).style.display="block"; 
    closeSidebar(); 
    if (id === 'customers') { loadAllCustomers(); }
}

function closeSidebar(){ 
    document.getElementById("sidebar").style.left="-300px"; 
    document.getElementById("overlay").style.display="none"; 
}

function openSidebar(){ 
    document.getElementById("sidebar").style.left="0"; 
    document.getElementById("overlay").style.display="block"; 
}

function searchByDate(){ 
    if(!document.getElementById("sDate").value) return alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
    const d = document.getElementById("sDate").value.split("-").reverse().join("/");
    db.ref("entries").orderByChild("date").equalTo(d).once("value", s => { 
        renderTable(s.val(), "reportTableBody"); 
    }); 
}

function loadReportData() { 
    db.ref("entries").once("value", s => renderTable(s.val(), "reportTableBody")); 
}

function downloadExcel(){
    db.ref("entries").once("value", s => {
        const d = s.val(); 
        if(!d) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤,‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞\n";
        Object.keys(d).forEach(k => { 
            const e = d[k]; 
            const items = (e.items && Array.isArray(e.items)) 
                ? e.items.map(i=>`${i.work} (${i.qty}pc)`).join(" + ") 
                : e.work;
            const safeNote = e.note ? e.note.replace(/,/g, " ") : '';
            csv += `${e.date || ''},${e.time || ''},${safeNote},${e.phone||'-'},"${items}",${e.total || 0},${e.taken || 0},${e.loss || 0},${e.user || ''}\n`; 
        });
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); 
        link.download = `Report_${new Date().toLocaleDateString()}.csv`; 
        link.click();
    });
}
</script>
</body>
</html>
