<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{box-sizing:border-box;font-family:'Hind Siliguri', sans-serif}
        body{margin:0;background:#f4f7f6;color:#2c3e50}
        .en{font-family:Arial, sans-serif}
        
        header{background:#2ecc71;color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:bold;display:none;position:fixed;top:0;width:100%;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        
        #loginDiv{max-width:400px;margin:120px auto;background:#fff;padding:35px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center}
        #container{display:none;padding:20px;padding-top:85px;max-width:1200px;margin:auto}
        
        .form-group {margin-bottom: 12px; text-align: left;}
        .form-group label {display: block; font-weight: 600; margin-bottom: 4px; color: #34495e; font-size: 14px;}
        
        input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;outline:none;transition:0.3s;font-size:15px}
        input:focus{border-color:#2ecc71}
        button{background:#2ecc71;color:#fff;font-weight:bold;border:none;cursor:pointer;font-size:16px; margin-top:5px;}
        button:hover{background:#27ae60}
        
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
        .card{background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.05);border-top:4px solid #2ecc71}
        
        #menuBtn{position:fixed;top:18px;left:20px;font-size:28px;color:#fff;cursor:pointer;display:none;z-index:1100}
        #sidebar{position:fixed;top:0;left:-280px;width:280px;height:100%;background:#ffffff;transition:.3s;z-index:1200;padding-top:20px;box-shadow:2px 0 10px rgba(0,0,0,0.1)}
        #sidebar a{display:block;color:#34495e;text-decoration:none;padding:15px 25px;border-bottom:1px solid #f1f1f1;cursor:pointer;font-weight:600}
        #sidebar a:hover{background:#f9f9f9;color:#2ecc71}
        
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:1150}
        .section{display:none;animation:fadeIn 0.5s}
        @keyframes fadeIn {from{opacity:0} to{opacity:1}}
        
        .table-box{background:#fff;border-radius:12px;overflow-x:auto;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
        table{width:100%;border-collapse:collapse;min-width:600px}
        th,td{padding:12px;border-bottom:1px solid #f0f0f0;text-align:left}
        th{background:#f9f9f9;color:#7f8c8d;font-size:13px}
        
        .btn-action{padding:5px 8px; font-size:14px; margin:0 2px; border-radius:4px;}
        .btn-del{background:#e74c3c; color:white;}
        .btn-edit{background:#f39c12; color:white;}
        .btn-print{background:#3498db; color:white;}
        
        .cart-box {margin-top:20px; border:2px dashed #2ecc71; padding:15px; border-radius:12px; background:#f9fff9}
        .cart-item {display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px}
        
        .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;width:350px;padding:20px;z-index:1500;box-shadow:0 0 100px rgba(0,0,0,0.5);border-radius:10px}
        .chart-container{background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05)}

        /* New Style for User Summary */
        .user-summary-box { background:#fff; padding:15px; border-radius:12px; margin-bottom:25px; border-left: 5px solid #9b59b6; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .low-stock { color: #e74c3c; font-weight: bold; }

        @media print{
            body *{visibility:hidden}
            #memoModal, #memoModal *{visibility:visible}
            #memoModal{position:absolute;left:0;top:0;transform:none;box-shadow:none;width:100%;display:block!important}
            .noPrint{display:none!important}
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#2ecc71">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:10px;margin-bottom:10px;border-bottom:2px solid #2ecc71" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø (‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø)</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßç‡¶ü‡¶ï</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</a>
        <a onclick="logout()" style="color:#ff7675">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>

    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
            <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü (‡ß≥)<br><b id="cTotal">0</b></div>
            <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)<br><b id="cTaken">0</b></div>
            <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cLoss">0</b></div>
        </div>

        <div class="user-summary-box">
            <h4 style="margin:0 0 10px 0; color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #eee;">
                <table class="en">
                    <thead>
                        <tr>
                            <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th>
                            <th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th>
                            <th>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá (‡ß≥)</th>
                        </tr>
                    </thead>
                    <tbody id="userSummaryBody">
                        <tr><td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="chart-container"><canvas id="salesChart" height="100"></canvas></div>
        
        <div class="table-box">
            <h4 style="padding:15px; margin:0">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</h4>
            <table class="en">
                <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="newEntry" class="section">
        <div style="max-width:550px;margin:auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0; color:#2c3e50">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
            
            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                <div style="display:flex;gap:5px">
                    <select id="category" onchange="catChange()"></select>
                    <button onclick="deleteCategory()" class="btn-action btn-del" style="margin-top:0;">üóëÔ∏è</button>
                </div>
            </div>

            <div class="form-group">
                <label>‡¶ï‡¶æ‡¶ú/‡¶™‡¶£‡ßç‡¶Ø:</label>
                <div style="display:flex;gap:5px">
                    <select id="work" disabled onchange="workChange()"></select>
                    <button onclick="deleteWork()" class="btn-action btn-del" style="margin-top:0;">üóëÔ∏è</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <div class="form-group"><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label><input id="qty" type="number" value="1" min="1" class="en"></div>
                <div class="form-group"><label>‡¶¶‡¶∞ (‡ß≥):</label><input id="rate" type="number" class="en"></div>
            </div>
            
            <button onclick="addToCart()" style="background:#3498db; margin-bottom:15px">üõí ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0; border-bottom:1px dashed #ccc; padding-bottom:5px">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                <div id="cartList"></div>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="note" placeholder="‡¶®‡¶æ‡¶Æ..."></div>
                    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label><input id="phone" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞..." class="en"></div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="form-group"><label>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</label><input id="total" readonly class="en" value="0" style="background:#f0f0f0"></div>
                    <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£:</label><input id="taken" type="number" class="en" oninput="calcLoss()"></div>
                </div>
                 <div class="form-group"><label>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="loss" readonly class="en" value="0" style="background:#f0f0f0"></div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px">
                    <button onclick="saveBulkEntry(false)" style="background:#f39c12">üíæ ‡¶∏‡ßá‡¶≠</button>
                    <button onclick="saveBulkEntry(true)" style="background:#2ecc71">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶Æ‡ßá‡¶Æ‡ßã</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory" class="section">
        <div style="max-width:600px;margin:auto;background:#fff;padding:25px;border-radius:15px">
            <h3>‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            <div style="display:flex;gap:10px">
                <input id="itemName" placeholder="‡¶Æ‡¶æ‡¶≤‡¶æ‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input id="itemStock" type="number" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                <button onclick="addStock()" style="width:auto;padding:0 20px">‡¶Ø‡ßã‡¶ó</button>
            </div>
            <div class="table-box" style="margin-top:20px">
                <table>
                    <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶∏‡ßç‡¶ü‡¶ï</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="noPrint" style="max-width: 900px; margin: auto; background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="text-align:center; margin-top:0">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö</h3>
            <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; margin-bottom: 20px">
                <input type="date" id="sDate" class="en" style="margin:0">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 25px">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px">
                <button onclick="loadReportData()" style="background:#95a5a6">‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="downloadExcel()" style="background:#27ae60">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤</button>
                <button onclick="window.print()" style="background:#9b59b6;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>
            
            <div class="table-box" style="margin-top:25px; border:1px solid #eee">
                <table class="en">
                    <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h3 style="margin:0; color:#2ecc71">‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞</h3>
        <p style="font-size:11px;margin:2px">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
        <hr>
    </div>
    <div style="font-size:13px; text-align:left" class="en">
        <p>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="mDate"></span> | ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <span id="mUser"></span></p>
        <p>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: <b id="mNote"></b> <span id="mPhoneDisp"></span></p>
        <table style="width:100%; font-size:12px; border-top:1px solid #000; margin-top:10px">
            <thead style="border-bottom:1px solid #ddd"><tr><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th style="text-align:right">‡¶ü‡¶æ‡¶ï‡¶æ</th></tr></thead>
            <tbody id="mItems"></tbody>
        </table>
        <hr>
        <div style="text-align:right">
            <p>‡¶Æ‡ßã‡¶ü: ‡ß≥<b id="mTotal" style="font-size:15px"></b></p>
            <p>‡¶®‡¶ó‡¶¶: ‡ß≥<span id="mPaid"></span></p>
            <p>‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥<b id="mDue"></b></p>
        </div>
    </div>
    
    <div style="margin-top: 40px; display: flex; justify-content: flex-end;">
        <div style="text-align: center; width: 150px;">
            <p style="margin: 0; font-size: 11px; font-weight: bold;" id="signatureName" class="en"></p>
            <p style="margin: 0; font-size: 10px;" id="signatureContact" class="en"></p>
            <div style="border-top: 1px solid #000; margin-top: 5px;"></div>
            <p style="margin: 0; font-size: 9px; color: #7f8c8d;">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    
    <hr>
    <p style="text-align:center; font-size:10px">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶®!</p>
    <button onclick="window.print()" class="noPrint">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
    <button onclick="closeModal('memoModal')" class="noPrint" style="background:#7f8c8d">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="editModal" class="modal">
    <h3 style="margin-top:0; color:#f39c12">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    <div class="form-group">
        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editNote">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
        <input id="editPhone" class="en">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="editTotal" type="number" class="en"></div>
        <div class="form-group"><label>‡¶®‡¶ó‡¶¶:</label><input id="editTaken" type="number" class="en"></div>
    </div>
    <button onclick="updateEntry()" style="background:#f39c12; margin-top:15px">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button onclick="closeModal('editModal')" style="background:#e74c3c">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain:"sheikh-computer-b41d5.firebaseapp.com",
    databaseURL:"https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:"sheikh-computer-b41d5"
});
const db=firebase.database();
let user="", rates={}, cart=[], salesChart=null;

window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
};

function login(){
    const u=uName.value.toLowerCase().trim(), p=uPass.value.trim();
    const users={admin:"123",owner:"456",roky:"789"};
    if(users[u]===p){ localStorage.setItem("loggedInUser", u); setupUser(u); }
    else alert("‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø!");
}

function setupUser(u) {
    user = u; loginDiv.style.display="none"; container.style.display="block";
    header.style.display="block"; menuBtn.style.display="block";
    userShow.innerHTML=`‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <b>${u.toUpperCase()}</b>`;
    loadRates(); loadEntries(); loadStock(); showSection('dashboard');
}

function loadRates(){
    db.ref("rates").on("value", s => {
        const defaultRates = {"‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü": {"A4 ‡¶∏‡¶æ‡¶¶‡¶æ-‡¶ï‡¶æ‡¶≤‡ßã": 10}, "‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø": {"‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ï‡¶™‡¶ø": 5}};
        const dbData = s.val() || {};
        rates = { ...defaultRates, ...dbData };
        let catHtml = "<option value=''>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü</option>";
        Object.keys(rates).forEach(c => catHtml += `<option>${c}</option>`);
        catHtml += `<option value="add">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>`;
        category.innerHTML = catHtml;
    });
}

function catChange(){
    if(category.value==="add"){
        const c=prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ:"); 
        if(c) db.ref("rates/"+c).set({"‡¶®‡¶§‡ßÅ‡¶®":0}); 
        else category.value = ""; return;
    }
    work.innerHTML="<option value=''>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü</option>";
    if(category.value && rates[category.value]){
        Object.keys(rates[category.value]).forEach(w=>work.innerHTML+=`<option>${w}</option>`);
        work.innerHTML+=`<option value="add">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶ú</option>`;
        work.disabled=false;
    } else { work.disabled=true; }
}

function workChange(){
    if(work.value==="add"){
        const w=prompt("‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:"), r=prompt("‡¶¶‡¶∞:");
        if(w && r) db.ref(`rates/${category.value}/${w}`).set(+r||0); 
        else work.value = ""; return;
    }
    if(category.value && rates[category.value]) rate.value=rates[category.value][work.value]||0;
}

function deleteCategory(){ if(confirm("‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) db.ref("rates/"+category.value).remove(); }
function deleteWork(){ if(confirm("‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) db.ref(`rates/${category.value}/${work.value}`).remove(); }

function addToCart(){
    if(!work.value || !rate.value) return alert("‡¶ï‡¶æ‡¶ú ‡¶ì ‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®");
    const q = parseFloat(qty.value);
    if(q <= 0) return alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
    cart.push({ work: work.value, qty: q, rate: +rate.value, sub: q * +rate.value });
    renderCart(); qty.value=1; 
}

function renderCart(){
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    let grandTotal = 0;
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `<div class="cart-item"><span>${item.work} (${item.qty} x ${item.rate})</span><span><b>‡ß≥${item.sub}</b> <span onclick="removeCart(${index})" style="color:red;cursor:pointer">√ó</span></span></div>`;
    });
    total.value = grandTotal; calcLoss();
}

function removeCart(index){ cart.splice(index,1); renderCart(); }
function calcLoss(){ loss.value = (parseFloat(total.value) || 0) - (parseFloat(taken.value) || 0); }

function deductStock(cartItems) {
    db.ref("inventory").once("value", s => {
        const stockData = s.val();
        if(!stockData) return;
        cartItems.forEach(cItem => {
            const key = Object.keys(stockData).find(k => stockData[k].name === cItem.work);
            if(key) {
                const newQty = parseFloat(stockData[key].qty) - parseFloat(cItem.qty);
                db.ref("inventory/" + key).update({ qty: newQty });
            }
        });
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return;
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        items: cart,
        total: +total.value,
        taken: +taken.value || 0,
        loss: +loss.value || 0,
        user: user,
        note: note.value || "General Customer",
        phone: phone.value || ""
    };
    db.ref("entries").push(entryData).then(() => {
        deductStock(cart);
        if(showMemoFlag) showMemo(entryData);
        else alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        cart = []; renderCart(); note.value = ""; phone.value = ""; taken.value = ""; loss.value="0";
    });
}

function viewMemo(key) {
    db.ref("entries/" + key).once("value", s => {
        if(s.val()) showMemo(s.val());
    });
}

function showMemo(e){
    document.getElementById("mDate").innerText = e.date;
    document.getElementById("mUser").innerText = e.user;
    document.getElementById("mNote").innerText = e.note;
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total;
    document.getElementById("mPaid").innerText = e.taken;
    document.getElementById("mDue").innerText = e.loss;
    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => mItems.innerHTML += `<tr><td>${i.work}</td><td>${i.qty}</td><td style="text-align:right">${i.sub}</td></tr>`);
    } else {
        mItems.innerHTML += `<tr><td>${e.work}</td><td>-</td><td style="text-align:right">${e.total}</td></tr>`;
    }
    let signs = {owner:["Toosher Ahmed","01913-812765"], admin:["Arafat Sikder","016749-44985"], roky:["Roky","01878-149052"]};
    let s = signs[e.user] || [e.user.toUpperCase(), ""];
    document.getElementById("signatureName").innerText = s[0];
    document.getElementById("signatureContact").innerText = s[1];
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(id) {
    document.getElementById(id).style.display="none";
    document.getElementById("overlay").style.display="none";
}

function openEdit(key) {
    db.ref("entries/" + key).once("value", s => {
        const d = s.val();
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note;
        document.getElementById("editPhone").value = d.phone;
        document.getElementById("editTotal").value = d.total;
        document.getElementById("editTaken").value = d.taken;
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    db.ref("entries/" + key).update({
        note: document.getElementById("editNote").value,
        phone: document.getElementById("editPhone").value,
        total: t,
        taken: k,
        loss: t - k
    }).then(() => { alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); closeModal("editModal"); });
}

// *** Calculate and Render User Summary ***
function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {};
    let hasData = false;

    // Default users
    ['admin', 'owner', 'roky'].forEach(u => stats[u] = {total:0, taken:0, loss:0});

    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            // Only process TODAY's data for this summary
            if(e.date === today) {
                hasData = true;
                const u = e.user.toLowerCase();
                if(!stats[u]) stats[u] = {total:0, taken:0, loss:0};
                stats[u].total += (+e.total || 0);
                stats[u].taken += (+e.taken || 0);
                stats[u].loss += (+e.loss || 0);
            }
        });
    }

    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";

    if(!hasData) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`;
        return;
    }

    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) { // Only show users with activity
            tbody.innerHTML += `<tr>
                <td style="text-transform:capitalize; font-weight:bold">${u}</td>
                <td>${stats[u].total}</td>
                <td style="color:#27ae60; font-weight:bold">${stats[u].taken}</td>
                <td style="color:#e74c3c">${stats[u].loss}</td>
            </tr>`;
        }
    });
}

function renderTable(data, tableId = "tableBody"){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    if(!data) {
        if(tableId === "reportTableBody") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>";
        return;
    }
    
    let t=0, k=0, l=0, dailyData={};
    Object.keys(data).reverse().forEach(key=>{
        const e = data[key];
        t += +e.total || 0; k += +e.taken || 0; l += +e.loss || 0;
        const itemNames = (e.items && Array.isArray(e.items)) ? e.items.map(i => i.work).join(", ") : e.work;
        const phone = e.phone || "-";
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = (user === e.user) ? `<button class="btn-action btn-del" onclick="delEntry('${key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>` : ``;
        
        tbody.innerHTML+=`<tr><td>${e.time}</td><td style="font-size:12px"><b>${e.note}</b><br>${itemNames}</td><td class="en">${phone}</td><td>${e.total}</td><td>${e.taken}</td><td>${e.loss}</td><td>${e.user}</td><td class="noPrint" style="display:flex">${btnMemo}${btnEdit}${btnDel}</td></tr>`;
        dailyData[e.date] = (dailyData[e.date]||0) + (+e.total||0);
    });
    
    if(tableId === "tableBody") {
        cCount.innerText=Object.keys(data).length; cTotal.innerText=t; cTaken.innerText=k; cLoss.innerText=l;
        updateChart(dailyData);
        // *** Trigger User Stats Update ***
        renderUserStats(data);
    }
}

function updateChart(data){
    const labels = Object.keys(data).slice(-7); const values = Object.values(data).slice(-7);
    if(salesChart) salesChart.destroy();
    const ctx = document.getElementById('salesChart');
    if(ctx) { salesChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Sales', data: values, borderColor: '#2ecc71', tension: 0.3, fill:true, backgroundColor:'rgba(46,204,113,0.1)' }] }, options: { responsive: true, plugins: { legend: { display: false } } } }); }
}

function delEntry(key){ 
    db.ref("entries/"+key).once("value", s => {
        if(s.val().user !== user) return alert("‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!");
        if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) db.ref("entries/"+key).remove();
    });
}
function addStock(){ if(itemName.value && itemStock.value) { db.ref("inventory").push({name:itemName.value, qty:itemStock.value}); itemName.value=""; itemStock.value=""; } }

function loadStock(){ 
    db.ref("inventory").on("value", s=>{ 
        stockBody.innerHTML=""; 
        const d = s.val(); 
        if(d) Object.keys(d).forEach(k=>{ 
            const q = d[k].qty;
            const lowClass = q < 5 ? "low-stock" : ""; // Warning if less than 5
            stockBody.innerHTML+=`<tr class="${lowClass}">
                <td>${d[k].name}</td>
                <td>${q} ${q < 5 ? '‚ö†Ô∏è' : ''}</td>
                <td><button class="btn-action btn-del" onclick="delInv('${k}')">üóëÔ∏è</button></td>
            </tr>`; 
        }); 
    }); 
}

function delInv(k){ if(user==='owner' && confirm("‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) db.ref("inventory/"+k).remove(); }
function loadEntries(){ db.ref("entries").on("value", s => renderTable(s.val(), "tableBody")); }
function showSection(id){ document.querySelectorAll('.section').forEach(s=>s.style.display="none"); document.getElementById(id).style.display="block"; closeSidebar(); }
function closeSidebar(){ sidebar.style.left="-280px"; overlay.style.display="none"; }
function openSidebar(){ sidebar.style.left="0"; overlay.style.display="block"; }
function logout() { localStorage.removeItem("loggedInUser"); location.reload(); }

function searchByDate(){ 
    if(!sDate.value) return; 
    const d = sDate.value.split("-").reverse().join("/"); 
    db.ref("entries").orderByChild("date").equalTo(d).once("value",s=>{ renderTable(s.val(), "reportTableBody"); }); 
}
function loadReportData() { db.ref("entries").once("value", s => renderTable(s.val(), "reportTableBody")); }
function downloadExcel(){
    db.ref("entries").once("value", s => {
        const d = s.val(); if(!d) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü,‡¶®‡¶ó‡¶¶,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞\n";
        Object.keys(d).forEach(k => { 
            const e = d[k]; 
            const items = (e.items && Array.isArray(e.items)) ? e.items.map(i=>`${i.work}(${i.qty})`).join("+") : e.work;
            csv += `${e.date},${e.time},${e.note},${e.phone||'-'},"${items}",${e.total},${e.taken},${e.loss},${e.user}\n`; 
        });
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "report.csv"; link.click();
    });
}
</script>
</body>
</html>
