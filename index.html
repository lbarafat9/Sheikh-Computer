<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø - ‡¶™‡ßç‡¶∞‡ßã</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* BASE STYLES */
        *{box-sizing:border-box;font-family:'Hind Siliguri', sans-serif}
        body{margin:0;background:#f4f7f6;color:#2c3e50}
        .en{font-family:Arial, sans-serif}
        
        /* HEADER */
        header{background:#27ae60;color:#fff;padding:15px;text-align:center;font-size:24px;font-weight:bold;display:none;position:fixed;top:0;width:100%;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        
        /* LOGIN */
        #loginDiv{max-width:400px;margin:120px auto;background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center}
        #loginDiv input {margin-bottom: 15px;}
        
        /* MAIN CONTAINER */
        #container{display:none;padding:20px;padding-top:90px;max-width:1250px;margin:auto}
        
        /* FORMS */
        .form-group {margin-bottom: 15px; text-align: left;}
        .form-group label {display: block; font-weight: 600; margin-bottom: 5px; color: #34495e; font-size: 14px;}
        
        input,select,button{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;outline:none;transition:0.3s;font-size:15px}
        input:focus, select:focus{border-color:#27ae60; box-shadow: 0 0 5px rgba(39, 174, 96, 0.2);}
        button{background:#27ae60;color:#fff;font-weight:bold;border:none;cursor:pointer;font-size:16px; margin-top:5px;}
        button:hover{background:#219150}
        
        /* DASHBOARD CARDS */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;padding:25px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.05);border-top:5px solid #2ecc71; transition: transform 0.2s}
        .card:hover {transform: translateY(-5px);}
        .card b {font-size: 24px; display: block; margin-top: 5px;}
        
        /* SIDEBAR */
        #menuBtn{position:fixed;top:20px;left:20px;font-size:28px;color:#fff;cursor:pointer;display:none;z-index:1100}
        #sidebar{position:fixed;top:0;left:-300px;width:280px;height:100%;background:#ffffff;transition:.3s;z-index:1200;padding-top:20px;box-shadow:5px 0 15px rgba(0,0,0,0.05)}
        #sidebar a{display:block;color:#34495e;text-decoration:none;padding:15px 25px;border-bottom:1px solid #f8f9fa;cursor:pointer;font-weight:600; transition: 0.2s}
        #sidebar a:hover{background:#f0fff4;color:#27ae60; padding-left: 30px;}
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;z-index:1150}
        
        /* SECTIONS & TABLES */
        .section{display:none;animation:fadeIn 0.4s ease-in-out}
        @keyframes fadeIn {from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)}}
        
        .table-box{background:#fff;border-radius:12px;overflow-x:auto;box-shadow:0 4px 10px rgba(0,0,0,0.03); border: 1px solid #eee;}
        table{width:100%;border-collapse:collapse;min-width:700px}
        th,td{padding:12px 15px;border-bottom:1px solid #f0f0f0;text-align:left}
        th{background:#f8f9fa;color:#555;font-weight:700;font-size:14px; text-transform: uppercase; letter-spacing: 0.5px;}
        tr:hover {background-color: #fbfbfb;}
        
        /* ACTION BUTTONS */
        .btn-action{padding:6px 10px; font-size:14px; margin:0 3px; border-radius:5px; width: auto; display: inline-block;}
        .btn-del{background:#ffebee; color:#c0392b; border: 1px solid #ffccd5;}
        .btn-del:hover{background:#c0392b; color: white;}
        .btn-edit{background:#fff8e1; color:#f39c12; border: 1px solid #ffe0b2;}
        .btn-edit:hover{background:#f39c12; color: white;}
        .btn-print{background:#e3f2fd; color:#2980b9; border: 1px solid #bbdefb;}
        .btn-print:hover{background:#2980b9; color: white;}
        
        /* CART & MISC */
        .cart-box {margin-top:20px; border:2px dashed #27ae60; padding:20px; border-radius:12px; background:#f9fff9}
        .cart-item {display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; font-size:15px; align-items: center;}
        
        .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;width:600px; max-width: 95%; padding:30px;z-index:1500;box-shadow:0 10px 40px rgba(0,0,0,0.2);border-radius:15px}
        .user-summary-box { background:#fff; padding:20px; border-radius:12px; margin-bottom:25px; border-left: 5px solid #8e44ad; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .low-stock { background-color: #fff0f0; color: #c0392b; font-weight: bold; }
        .service-badge { background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;}

        /* A4 PRINT CSS - STRICT */
        @media print {
            @page { size: A4; margin: 0.8in; }
            body { margin: 0; padding: 0; background: white; font-family: 'Times New Roman', serif; }
            body * { visibility: hidden; }
            
            #memoModal, #memoModal * { visibility: visible !important; }
            #memoModal {
                display: block !important; 
                position: absolute; 
                left: 0; top: 0;
                width: 100% !important;
                margin: 0 !important; 
                padding: 0 !important; 
                transform: none !important; 
                box-shadow: none !important; 
                border: none !important;
                background: transparent !important;
            }
            
            /* Print Specific Typography */
            #memoModal h2 { font-size: 32px !important; margin-bottom: 5px; color: #000 !important; text-align: center; font-family: 'Hind Siliguri', sans-serif;}
            #memoModal p, #memoModal span { color: #000 !important; font-size: 14pt !important; }
            #memoModal .address { font-size: 14px !important; text-align: center; margin-bottom: 30px; }
            
            /* Print Meta Info */
            .memo-meta { display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            
            /* Print Table */
            #memoModal table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14pt; }
            #memoModal th { background: #f0f0f0 !important; color: #000 !important; border: 1px solid #000; padding: 10px; font-weight: bold; text-align: center !important;}
            #memoModal td { border: 1px solid #000; padding: 10px; }
            
            /* Print Totals */
            .memo-total-area { margin-top: 30px; text-align: right; font-size: 16pt !important; }
            
            /* Signature */
            .signature-area { margin-top: 80px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .signature-box { text-align: center; width: 250px; }
            .signature-line { border-top: 1px solid #000; margin-top: 60px; padding-top: 10px; font-size: 14pt; }

            .noPrint { display: none !important; }
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#27ae60; margin-bottom: 20px;">‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ (Admin/Owner/Roky)">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:15px;margin-bottom:10px;border-bottom:2px solid #2ecc71; background: #f0fdf4;" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø / ‡¶∏‡ßá‡¶≤‡¶∏</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
        <a onclick="logout()" style="color:#e74c3c; margin-top:20px; border-top:1px solid #eee;">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>

    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
            <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤ (‡ß≥)<br><b id="cTotal">0</b></div>
            <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡ß≥)<br><b id="cTaken">0</b></div>
            <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cDue">0</b></div>
        </div>

        <div class="user-summary-box">
            <h4 style="margin:0 0 15px 0; color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #eee;">
                <table class="en">
                    <thead><tr><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th><th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th><th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th></tr></thead>
                    <tbody id="userSummaryBody"><tr><td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr></tbody>
                </table>
            </div>
        </div>

        <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05)">
            <canvas id="salesChart" height="80"></canvas>
        </div>
        
        <div class="table-box">
            <h4 style="padding:15px; margin:0; background: #f9f9f9; border-bottom: 1px solid #eee;">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
            <table class="en">
                <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="newEntry" class="section">
        <div style="max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0; color:#2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
            
            <div class="form-group" style="background:#e8f5e9; padding:15px; border:1px dashed #27ae60; border-radius:8px">
                <label>üîç ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö (‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá Enter ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®):</label>
                <input id="searchSerial" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 101 ‡¶Ö‡¶•‡¶¨‡¶æ A4 Paper..." class="en" onkeydown="if(event.key === 'Enter'){ searchProduct(this.value); }">
            </div>

            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                <select id="category" onchange="filterProducts()"><option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option></select>
            </div>

            <div class="form-group">
                <label>‡¶ï‡¶æ‡¶ú/‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="work" onchange="autoFillPrice()"><option value="">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü...</option></select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <div class="form-group"><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label><input id="qty" type="number" value="1" min="1" class="en" onkeydown="if(event.key === 'Enter'){ addToCart(); }"></div>
                <div class="form-group"><label>‡¶¶‡¶∞ (Rate ‡ß≥):</label><input id="rate" type="number" class="en"></div>
            </div>
            
            <button onclick="addToCart()" style="background:#3498db; margin-bottom:20px; padding: 12px;">‚¨áÔ∏è ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add)</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0; border-bottom:1px dashed #aaa; padding-bottom:5px">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                <div id="cartList"></div>
                
                <hr style="border:0; border-top:1px dashed #aaa; margin:15px 0">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (Optional):</label><input id="note" placeholder="‡¶®‡¶æ‡¶Æ..."></div>
                    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (Optional):</label><input id="phone" placeholder="017..." class="en"></div>
                </div>
                
                <div style="background: #f0f0f0; padding: 15px; border-radius: 8px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (Total):</label><input id="total" readonly class="en" value="0" style="background:#fff; font-weight:bold"></div>
                        <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (Paid):</label><input id="taken" type="number" class="en" oninput="calcDue()"></div>
                    </div>
                    <div class="form-group"><label style="color:#e74c3c">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</label><input id="due" readonly class="en" value="0" style="background:#fff; color:#e74c3c; font-weight:bold"></div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                    <button onclick="saveBulkEntry(false)" style="background:#f39c12">üíæ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="saveBulkEntry(true)" style="background:#2ecc71">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory" class="section">
        <div style="max-width:900px;margin:auto;background:#fff;padding:30px;border-radius:15px">
            <h3 style="border-bottom:2px solid #eee; padding-bottom:10px; color:#2c3e50">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px">
                <div class="form-group"><label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶° (Optional):</label><input id="stSerial" class="en" placeholder="Code/Serial"></div>
                <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><input id="stCategory" placeholder="Paper, Khata, Pen..."></div>
                <div class="form-group"><label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="stName" placeholder="Product Name"></div>
            </div>
            
            <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #90caf9;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="stIsService" style="width:20px; height:20px; margin:0" onchange="toggleStockInput()">
                    <label for="stIsService" style="margin:0; cursor:pointer; font-weight:bold; color:#1565c0">‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø, ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®, ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü)</label>
                </div>
                <small style="color:#555; padding-left:34px; display:block; margin-top:5px;">‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶≤‡ßá '‡¶∏‡ßç‡¶ü‡¶ï' ‡¶è‡¶¨‡¶Ç '‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ' ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</small>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end">
                <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label><input id="stQty" type="number" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (Cost):</label><input id="stCost" type="number" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (Sell):</label><input id="stSell" type="number" class="en" placeholder="0"></div>
                <button onclick="addNewProduct()" style="height:48px; margin-bottom:15px; width: 100px;">+ ‡¶∏‡ßá‡¶≠</button>
            </div>

            <div class="table-box" style="margin-top:25px">
                <table>
                    <thead><tr><th>Serial</th><th>Category</th><th>Name</th><th>Stock</th><th>Sell Price</th><th>Action</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="noPrint" style="max-width: 1000px; margin: auto; background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="text-align:center; margin-top:0">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</h3>
            
            <div style="display:flex; gap:10px; margin-bottom: 20px; justify-content: center; background: #f9f9f9; padding: 20px; border-radius: 10px;">
                <input type="date" id="sDate" class="en" style="margin:0; max-width: 200px;">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 25px">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom: 20px;">
                <button onclick="loadReportData()" style="background:#7f8c8d">‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                <button onclick="downloadExcel()" style="background:#2ecc71">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button onclick="window.print()" style="background:#9b59b6;">üñ®Ô∏è ‡¶™‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>
            
            <div class="table-box" style="border:1px solid #ddd">
                <table class="en">
                    <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0; color:#2ecc71; font-weight: 800; font-size: 28px;">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:5px 0 0 0; color:#555">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
    </div>
    
    <div class="memo-meta en" style="margin-top:30px;">
        <div style="text-align:left; float:left; width: 50%;">
            <p style="margin:4px"><strong>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç:</strong> <span id="mId"></span></p>
            <p style="margin:4px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:4px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right; float:right; width: 50%;">
            <p style="margin:4px"><strong>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</strong> <span id="mNote"></span></p>
            <p style="margin:4px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
        
    <table style="width:100%; border-collapse:collapse; margin-top:20px">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd; padding:10px; text-align:left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd; padding:10px; text-align:center; width:100px">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                <th style="border:1px solid #ddd; padding:10px; text-align:right; width:150px">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    
    <div class="memo-total-area en" style="margin-top:25px; text-align:right">
        <p style="margin:5px">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥<b id="mTotal"></b></p>
        <p style="margin:5px">‡¶®‡¶ó‡¶¶ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®: ‡ß≥<span id="mPaid"></span></p>
        <p style="margin:5px; font-size: 18px;">‡¶¨‡¶æ‡¶ï‡¶ø (Due): ‡ß≥<b id="mDueDisplay" style="color:red"></b></p>
    </div>
    
    <div class="signature-area" style="margin-top: 80px; display: flex; justify-content: space-between;">
        <div class="signature-box" style="text-align:center; width:200px">
            <p class="signature-line" style="border-top:1px solid #000; padding-top:10px; margin-top:40px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
        <div class="signature-box" style="text-align:center; width:200px">
            <p style="margin:0; font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000; padding-top:10px; margin-top:5px">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    
    <div style="margin-top:40px; text-align:center; border-top:1px dashed #ccc; padding-top:20px" class="noPrint">
        <button onclick="window.print()" style="width:auto; padding:10px 30px; font-size: 16px;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (A4)</button>
        <button onclick="closeModal('memoModal')" style="background:#e74c3c; width:auto; padding:10px 30px; font-size: 16px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="editModal" class="modal" style="width:400px">
    <h3 style="margin-top:0; color:#f39c12">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="editNote"></div>
    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label><input id="editPhone" class="en"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="editTotal" type="number" class="en"></div>
        <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£:</label><input id="editTaken" type="number" class="en"></div>
    </div>
    <button onclick="updateEntry()" style="background:#f39c12; margin-top:15px">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button onclick="closeModal('editModal')" style="background:#e74c3c">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE VARIABLES ---
let currentUser = "";
let allProducts = [];
let cart = [];
let salesChart = null;

// --- INITIALIZATION ---
window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
};

// --- AUTHENTICATION ---
function login(){
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();
    // HARDCODED PASSWORDS (NOTE: Not secure for high-value targets, okay for internal shop use)
    const users = {admin:"123", owner:"456", roky:"789"};
    
    if(users[u] === p){ 
        localStorage.setItem("loggedInUser", u); 
        setupUser(u); 
    } else { 
        alert("‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); 
    }
}

function setupUser(u) {
    currentUser = u; 
    document.getElementById("loginDiv").style.display = "none"; 
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "block"; 
    document.getElementById("menuBtn").style.display = "block";
    
    const userRole = u === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : (u === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
    document.getElementById("userShow").innerHTML = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <b style="text-transform:uppercase">${u}</b> (${userRole})`;
    
    loadAllProducts(); 
    loadEntries(); 
    showSection('dashboard');
}

function logout() { 
    localStorage.removeItem("loggedInUser"); 
    location.reload(); 
}

// --- PRODUCT & STOCK MANAGEMENT ---

function loadAllProducts(){
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        const stockBody = document.getElementById("stockBody");
        stockBody.innerHTML = "";
        const categories = new Set();
        
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key; // Store firebase key
            allProducts.push(p);
            categories.add(p.category);
            
            let stockDisplay = "";
            let rowClass = "";
            
            if(p.isService) {
                stockDisplay = `<span class="service-badge">Service</span>`;
            } else {
                stockDisplay = `${p.qty} ${p.qty < 5 ? '‚ö†Ô∏è' : ''}`;
                if(p.qty < 5) rowClass = "low-stock";
            }
            
            const btnDel = `<button class="btn-action btn-del" onclick="delProduct('${p.key}')">üóëÔ∏è</button>`;
            
            stockBody.innerHTML += `<tr class="${rowClass}">
                <td>${p.serial || '-'}</td>
                <td>${p.category}</td>
                <td>${p.name}</td>
                <td>${stockDisplay}</td>
                <td>${p.sellPrice}</td>
                <td>${btnDel}</td>
            </tr>`;
        });
        
        // Populate Category Dropdown
        const catSelect = document.getElementById("category");
        const currentCat = catSelect.value;
        catSelect.innerHTML = "<option value=''>‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>";
        categories.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });
        catSelect.value = currentCat; // Restore selection if valid
        
        filterProducts(); // Refresh product dropdown
    });
}

function toggleStockInput(){
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    
    if(isService){
        qtyInput.value = ""; qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; qtyInput.disabled = true; qtyInput.style.background = "#eee";
        costInput.value = ""; costInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; costInput.disabled = true; costInput.style.background = "#eee";
    } else {
        qtyInput.disabled = false; qtyInput.placeholder = "Qty"; qtyInput.style.background = "#fff";
        costInput.disabled = false; costInput.placeholder = "Cost"; costInput.style.background = "#fff";
    }
}

function addNewProduct(){
    const serial = document.getElementById("stSerial").value.trim();
    const cat = document.getElementById("stCategory").value.trim();
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    
    if(!cat || !name || !sell) return alert("Category, Name ‡¶è‡¶¨‡¶Ç Sell Price ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
    
    const newProd = { serial, category: cat, name, qty, isService, costPrice: cost, sellPrice: sell };
    
    db.ref("products").push(newProd).then(()=>{
        alert(isService ? "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!" : "‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        // Clear fields
        document.getElementById("stSerial").value = "";
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stIsService").checked = false;
        toggleStockInput();
    });
}

function delProduct(key){
    if(currentUser === 'owner' || currentUser === 'admin'){ 
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) db.ref("products/"+key).remove(); 
    } else { 
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§"); 
    }
}

// --- SALES & CART LOGIC ---

function filterProducts(){
    const cat = document.getElementById("category").value;
    const workSelect = document.getElementById("work");
    workSelect.innerHTML = "<option value=''>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>";
    
    const filtered = cat ? allProducts.filter(p => p.category === cat) : allProducts;
    
    filtered.forEach(p => { 
        workSelect.innerHTML += `<option value="${p.key}" data-price="${p.sellPrice}">${p.name} (${p.serial || '-'})</option>`; 
    });
    
    // Return promise for better async handling
    return new Promise(resolve => setTimeout(resolve, 50));
}

function autoFillPrice(){
    const workSelect = document.getElementById("work");
    const selectedOption = workSelect.options[workSelect.selectedIndex];
    if(selectedOption && selectedOption.value){
        document.getElementById("rate").value = selectedOption.getAttribute("data-price") || "";
        document.getElementById("qty").focus();
    }
}

// --- FIXED SEARCH FUNCTION ---
function searchProduct(query){
    if(!query || query.trim() === "") return;
    query = query.toString().toLowerCase().trim();
    
    console.log("Searching for:", query);
    
    // Search by Serial, Name OR Firebase Key
    const product = allProducts.find(p => 
        (p.serial && String(p.serial).toLowerCase().includes(query)) || 
        (p.name && p.name.toLowerCase().includes(query)) ||
        (p.key && p.key.toLowerCase().includes(query))
    );

    if(product){
        console.log("Found product:", product.name, "Key:", product.key);
        
        // Clear search input immediately
        document.getElementById("searchSerial").value = "";
        
        // First, set category to empty to show all products
        document.getElementById("category").value = "";
        
        // Wait a bit for category change to take effect
        setTimeout(() => {
            filterProducts().then(() => {
                // After filtering, find and select the product
                const workSelect = document.getElementById("work");
                
                // Try to find the product in dropdown
                for(let i = 0; i < workSelect.options.length; i++){
                    if(workSelect.options[i].value === product.key){
                        workSelect.selectedIndex = i;
                        
                        // Now set the category based on selected product
                        document.getElementById("category").value = product.category;
                        
                        // Fill price
                        document.getElementById("rate").value = product.sellPrice;
                        document.getElementById("qty").value = 1;
                        
                        // Focus on quantity
                        setTimeout(() => {
                            const qtyBox = document.getElementById("qty");
                            qtyBox.focus();
                            qtyBox.select();
                        }, 100);
                        
                        console.log("Product selected successfully");
                        return;
                    }
                }
                
                // If not found, show error
                alert("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            });
        }, 100);

    } else {
        alert("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø! Serial, Name ‡¶Ö‡¶•‡¶¨‡¶æ ID ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        document.getElementById("searchSerial").value = "";
        document.getElementById("searchSerial").focus();
    }
}

// Alternative simpler search function
function searchProductSimple(query){
    if(!query || query.trim() === "") return;
    query = query.toString().toLowerCase().trim();
    
    console.log("Simple search for:", query);
    
    // Find product
    const product = allProducts.find(p => 
        (p.serial && String(p.serial).toLowerCase().includes(query)) || 
        (p.name && p.name.toLowerCase().includes(query)) ||
        (p.key && p.key.toLowerCase().includes(query))
    );

    if(product){
        console.log("Found:", product.name);
        
        // DIRECT APPROACH - Manually create option
        const workSelect = document.getElementById("work");
        
        // Clear and add our product as option
        workSelect.innerHTML = `<option value="${product.key}" data-price="${product.sellPrice}">${product.name} (${product.serial || '-'})</option>`;
        
        // Select it
        workSelect.selectedIndex = 0;
        
        // Set category
        document.getElementById("category").value = product.category;
        
        // Set price and quantity
        document.getElementById("rate").value = product.sellPrice;
        document.getElementById("qty").value = 1;
        document.getElementById("searchSerial").value = "";
        
        // Focus
        setTimeout(() => {
            document.getElementById("qty").focus();
            document.getElementById("qty").select();
        }, 50);
        
    } else {
        alert("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        document.getElementById("searchSerial").focus();
    }
}

// Use this updated version in your HTML
// Change line 180 to: <input id="searchSerial" ... onkeydown="if(event.key === 'Enter'){ searchProductSimple(this.value); }">

function addToCart(){
    const workSelect = document.getElementById("work");
    const pKey = workSelect.value;
    const pNameRaw = workSelect.options[workSelect.selectedIndex]?.text;
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    
    if(!pKey || !r) return alert("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®");
    if(q <= 0) return alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
    
    const stockItem = allProducts.find(p => p.key === pKey);
    const pName = stockItem ? stockItem.name : pNameRaw; // Cleaner name

    // Stock Validation
    if(stockItem && !stockItem.isService && stockItem.qty < q) { 
        if(!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á! (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${stockItem.qty})‡•§ \n‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
    }
    
    cart.push({ 
        key: pKey, 
        work: pName, 
        qty: q, 
        rate: r, 
        sub: q * r, 
        isService: stockItem ? stockItem.isService : false 
    });
    
    renderCart(); 
    // Reset inputs
    document.getElementById("qty").value=1; 
    document.getElementById("searchSerial").focus(); // Ready for next search
}

function renderCart(){
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    
    let grandTotal = 0;
    
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `
            <div class="cart-item">
                <span>${index+1}. ${item.work} <small>(${item.qty} x ${item.rate})</small></span>
                <span>
                    <b>‡ß≥${item.sub}</b> 
                    <span onclick="removeCart(${index})" style="color:#e74c3c;cursor:pointer;margin-left:10px;font-weight:bold" title="Remove">√ó</span>
                </span>
            </div>`;
    });
    
    document.getElementById("total").value = grandTotal; 
    calcDue();
}

function removeCart(index){ 
    cart.splice(index,1); 
    renderCart(); 
}

function calcDue(){ 
    const t = parseFloat(document.getElementById("total").value) || 0;
    const k = parseFloat(document.getElementById("taken").value) || 0;
    document.getElementById("due").value = t - k;
}

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            db.ref("products/" + cItem.key).update({ qty: newQty });
        }
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
    
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"), // DD/MM/YYYY format
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP, // Useful for sorting
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: totalVal - takenVal, // Saved as 'loss' in DB but displayed as 'Due'
        user: currentUser,
        note: document.getElementById("note").value || "General Customer",
        phone: document.getElementById("phone").value || ""
    };
    
    db.ref("entries").push(entryData).then((snap) => {
        deductStock(cart);
        
        if(showMemoFlag) {
             // Pass the ID just generated
             entryData.key = snap.key;
             showMemo(entryData);
        } else {
             alert("‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
        
        // Clear UI
        cart = []; 
        renderCart(); 
        document.getElementById("note").value = ""; 
        document.getElementById("phone").value = ""; 
        document.getElementById("taken").value = ""; 
        document.getElementById("due").value = "0";
    });
}

// --- MEMO & PRINTING ---

function viewMemo(key) { 
    db.ref("entries/" + key).once("value", s => { 
        if(s.val()) {
            let data = s.val();
            data.key = key;
            showMemo(data); 
        }
    }); 
}

function showMemo(e){
    document.getElementById("mId").innerText = (e.key ? e.key.slice(-6).toUpperCase() : '---');
    document.getElementById("mDate").innerText = e.date + " " + e.time;
    document.getElementById("mUser").innerText = e.user;
    document.getElementById("mNote").innerText = e.note;
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total;
    document.getElementById("mPaid").innerText = e.taken;
    document.getElementById("mDueDisplay").innerText = e.loss;
    
    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => {
            mItems.innerHTML += `
            <tr>
                <td style="border:1px solid #ddd; padding:8px">${i.work}</td>
                <td style="text-align:center; border:1px solid #ddd; padding:8px">${i.qty}</td>
                <td style="text-align:right; border:1px solid #ddd; padding:8px">${i.sub}</td>
            </tr>`;
        });
    } else {
        // Legacy support for old data
        mItems.innerHTML += `<tr><td>${e.work}</td><td>-</td><td>${e.total}</td></tr>`;
    }
    
    // Signatures based on User
    const signs = {
        owner: ["Toosher Ahmed", "01913-812765"], 
        admin: ["Arafat Sikder", "016749-44985"], 
        roky: ["Roky", "01878-149052"]
    };
    
    const s = signs[e.user] || [e.user.toUpperCase(), ""];
    document.getElementById("signatureName").innerText = s[0];
    
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(id) { 
    document.getElementById(id).style.display="none"; 
    document.getElementById("overlay").style.display="none"; 
}

// --- EDITING & DELETING (WITH STOCK RESTORE) ---

function openEdit(key) {
    db.ref("entries/" + key).once("value", s => {
        const d = s.val();
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note;
        document.getElementById("editPhone").value = d.phone;
        document.getElementById("editTotal").value = d.total;
        document.getElementById("editTaken").value = d.taken;
        
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    
    db.ref("entries/" + key).update({ 
        note: document.getElementById("editNote").value, 
        phone: document.getElementById("editPhone").value, 
        total: t, 
        taken: k, 
        loss: t - k
    }).then(() => { 
        alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); 
        closeModal("editModal"); 
    });
}

// --- CRITICAL: DELETE WITH STOCK RESTORE ---
function delEntry(key){ 
    db.ref("entries/"+key).once("value", s => { 
        const entry = s.val();
        
        // Security check
        if(entry.user !== currentUser && currentUser !== 'admin' && currentUser !== 'owner') {
             return alert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!");
        }
        
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ (Restore) ‡¶Ü‡¶∏‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            
            // 1. Restore Stock Loop
            if(entry.items && Array.isArray(entry.items)){
                entry.items.forEach(item => {
                    // Only restore if it was a physical product, not service
                    if(item.key && !item.isService){
                         const prod = allProducts.find(p => p.key === item.key);
                         if(prod){
                             const currentQty = parseFloat(prod.qty) || 0;
                             const returnQty = parseFloat(item.qty) || 0;
                             db.ref("products/" + item.key).update({ qty: currentQty + returnQty });
                         }
                    }
                });
            }
            
            // 2. Delete the entry
            db.ref("entries/"+key).remove(); 
        }
    }); 
}

// --- REPORTING & CHARTS ---

function loadEntries(){ 
    // Load last 100 entries automatically
    db.ref("entries").limitToLast(100).on("value", s => renderTable(s.val(), "tableBody")); 
}

function renderTable(data, tableId = "tableBody"){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    
    if(!data) { 
        if(tableId === "reportTableBody") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>"; 
        return; 
    }
    
    let totalSales=0, totalTaken=0, totalDue=0;
    let dailyData = {};
    
    // Convert object to array and reverse (Newest first)
    const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
    
    entriesArr.forEach(e => {
        totalSales += +e.total || 0; 
        totalTaken += +e.taken || 0; 
        totalDue += +e.loss || 0;
        
        // Format Items String
        const itemSummary = (e.items && Array.isArray(e.items)) 
            ? e.items.map(i => `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work} (${i.qty})</span>`).join(" ") 
            : e.work;
            
        const phone = e.phone || "-";
        
        // Buttons
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${e.key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${e.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = `<button class="btn-action btn-del" onclick="delEntry('${e.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>`;
        
        tbody.innerHTML+=`
        <tr>
            <td style="font-size:13px">${e.date}<br>${e.time}</td>
            <td style="font-size:13px"><b>${e.note}</b><br>${itemSummary}</td>
            <td class="en">${phone}</td>
            <td>${e.total}</td>
            <td style="color:#27ae60;font-weight:bold">${e.taken}</td>
            <td style="color:#e74c3c">${e.loss}</td>
            <td style="text-transform:capitalize">${e.user}</td>
            <td class="noPrint" style="white-space:nowrap">${btnMemo}${btnEdit}${btnDel}</td>
        </tr>`;
        
        // Chart Data Prep
        dailyData[e.date] = (dailyData[e.date]||0) + (+e.total||0);
    });
    
    // Update Dashboard Stats (Only if loading main dashboard table)
    if(tableId === "tableBody") { 
        document.getElementById("cCount").innerText = entriesArr.length; 
        document.getElementById("cTotal").innerText = totalSales; 
        document.getElementById("cTaken").innerText = totalTaken; 
        document.getElementById("cDue").innerText = totalDue; 
        
        updateChart(dailyData); 
        renderUserStats(data); 
    }
}

function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {}; 
    let hasData = false;
    
    ['admin', 'owner', 'roky'].forEach(u => stats[u] = {total:0, taken:0, due:0});
    
    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            if(e.date === today) {
                hasData = true; 
                const u = e.user.toLowerCase();
                if(!stats[u]) stats[u] = {total:0, taken:0, due:0}; // Safety init
                stats[u].total += (+e.total || 0); 
                stats[u].taken += (+e.taken || 0); 
                stats[u].due += (+e.loss || 0);
            }
        });
    }
    
    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    
    if(!hasData) { 
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`; 
        return; 
    }
    
    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) { 
            tbody.innerHTML += `
            <tr>
                <td style="text-transform:capitalize; font-weight:bold">${u}</td>
                <td>${stats[u].total}</td>
                <td style="color:#27ae60; font-weight:bold">${stats[u].taken}</td>
                <td style="color:#e74c3c">${stats[u].due}</td>
            </tr>`; 
        }
    });
}

function updateChart(data){
    // Sort dates
    const sortedDates = Object.keys(data).sort((a,b) => {
        const [d1,m1,y1] = a.split('/'); const [d2,m2,y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    });
    
    const labels = sortedDates.slice(-10); // Last 10 days
    const values = labels.map(d => data[d]);
    
    if(salesChart) salesChart.destroy();
    
    const ctx = document.getElementById('salesChart');
    if(ctx) { 
        salesChart = new Chart(ctx, { 
            type: 'bar', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (‡¶ü‡¶æ‡¶ï‡¶æ)', 
                    data: values, 
                    backgroundColor: '#2ecc71',
                    borderRadius: 5
                }] 
            }, 
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } } 
            } 
        }); 
    }
}

// --- UTILITIES ---

function showSection(id){ 
    document.querySelectorAll('.section').forEach(s=>s.style.display="none"); 
    document.getElementById(id).style.display="block"; 
    closeSidebar(); 
}
function closeSidebar(){ document.getElementById("sidebar").style.left="-300px"; document.getElementById("overlay").style.display="none"; }
function openSidebar(){ document.getElementById("sidebar").style.left="0"; document.getElementById("overlay").style.display="block"; }

function searchByDate(){ 
    if(!document.getElementById("sDate").value) return alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
    const d = document.getElementById("sDate").value.split("-").reverse().join("/"); // YYYY-MM-DD to DD/MM/YYYY
    
    db.ref("entries").orderByChild("date").equalTo(d).once("value", s => { 
        renderTable(s.val(), "reportTableBody"); 
    }); 
}

function loadReportData() { 
    db.ref("entries").once("value", s => renderTable(s.val(), "reportTableBody")); 
}

function downloadExcel(){
    db.ref("entries").once("value", s => {
        const d = s.val(); 
        if(!d) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
        
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤,‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞\n";
        
        Object.keys(d).forEach(k => { 
            const e = d[k]; 
            // Flatten items for CSV
            const items = (e.items && Array.isArray(e.items)) 
                ? e.items.map(i=>`${i.work} (${i.qty}pc)`).join(" + ") 
                : e.work;
            
            // Handle commas in content
            const safeNote = e.note.replace(/,/g, " ");
            
            csv += `${e.date},${e.time},${safeNote},${e.phone||'-'},"${items}",${e.total},${e.taken},${e.loss},${e.user}\n`; 
        });
        
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); 
        link.download = `Report_${new Date().toLocaleDateString()}.csv`; 
        link.click();
    });
}

// Temporary fix - update the onkeydown event in the HTML
window.addEventListener('load', function() {
    // Update the search input to use the simple function
    const searchInput = document.getElementById("searchSerial");
    if(searchInput) {
        searchInput.onkeydown = function(event) {
            if(event.key === 'Enter') {
                searchProductSimple(this.value);
            }
        };
    }
});
</script>
</body>
</html>
