<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sheikh Computer PRO v7.5 (God Mode Connected)</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- EXCEL & CSV LIBRARY (SheetJS) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<!-- DYNAMIC CSS FROM ADMIN -->
<style id="adminDynamicStyle"></style>

<style>
/* --- PREMIUM THEME (ORIGINAL 3D GRADIENT EDITION) --- */
:root {
    --primary: #4f46e5;
    --primary-dark: #3730a3;
    --accent: #06b6d4;
    --bg-gradient: linear-gradient(135deg, #0f172a 0%, #172554 100%);
    --sidebar-bg: rgba(15, 23, 42, 0.98);
    --text-main: #1e293b;
    --text-light: #64748b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --glass-bg: linear-gradient(160deg, #ffffff 40%, #f0f9ff 100%);
    --font-main: 'Hind Siliguri', sans-serif;
}

/* LIGHT THEME SUPPORT */
body.light-theme {
    --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    --sidebar-bg: #ffffff;
    --text-main: #0f172a;
}
body.light-theme #sidebar { border-right: 1px solid #cbd5e1; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
body.light-theme #sidebar a { color: #475569; }
body.light-theme #sidebar a:hover { background: #f8fafc; color: var(--primary); }
body.light-theme #sidebar a.active { background: #e0f2fe; color: var(--primary); border-left-color: var(--primary); }
body.light-theme #userShow { color: #334155; border-bottom: 1px solid #e2e8f0; }
body.light-theme .sidebar-footer { background: #f8fafc; border-top: 1px solid #e2e8f0; }
body.light-theme .footer-label { color: #64748b; }
body.light-theme .footer-val { color: #0f172a; }

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body {
    font-family: var(--font-main);
    background: var(--bg-gradient);
    color: var(--text-main);
    font-size: 15px;
    min-height: 100vh;
    background-attachment: fixed;
    overflow-x: hidden;
}
.en { font-family: 'Poppins', sans-serif; }

/* --- CUSTOM SCROLLBAR --- */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

/* --- TOAST --- */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
.toast {
    min-width: 300px; margin-bottom: 12px; background: #fff; padding: 16px 20px;
    border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: space-between;
    animation: slideIn 0.3s ease-out forwards; border-left: 6px solid #333; font-weight: 600;
}
.toast.success { border-left-color: var(--success); color: var(--success); }
.toast.error { border-left-color: var(--danger); color: var(--danger); }
.toast.warning { border-left-color: var(--warning); color: #d97706; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }

/* --- ADMIN NOTICE BAR --- */
#adminTicker {
    background: #f59e0b;
    color: #000;
    text-align: center;
    padding: 8px;
    font-weight: bold;
    font-size: 14px;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 9000;
    display: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

/* --- HEADER (Mobile Only) --- */
header {
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    color: #fff; padding: 0 60px;
    text-align: center; font-size: 18px; font-weight: 700;
    display: none; position: fixed; top: 0; width: 100%; z-index: 1000;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    height: 60px;
    align-items: center;
    justify-content: center;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* --- LOGIN SCREEN --- */

 /* God Mode Link Button Style */
.god-mode-link {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 10px 18px;
    border-radius: 30px;
    text-decoration: none;
    font-size: 13px;
    font-weight: bold;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: 0.3s;
    z-index: 2100; /* ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ü‡¶ø ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá */
    display: flex;
    align-items: center;
    gap: 8px;
}
.god-mode-link:hover {
    background: white;
    color: #3b82f6;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

#loginDiv {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(180deg, #34d399 0%, #3b82f6 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 2000;
}
.login-card {
    background: #fff;
    width: 85%; max-width: 360px;
    padding: 35px 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    text-align: center;
    font-family: 'Hind Siliguri', sans-serif;
}
.login-title {
    font-size: 28px;
    font-weight: 700;
    color: #10b981;
    margin-bottom: 5px;
}
.login-title span {
    color: #3b82f6;
}
.login-subtitle {
    font-size: 12px;
    color: #9ca3af;
    margin-bottom: 25px;
    font-family: 'Poppins', sans-serif;
}
.login-form-group {
    text-align: left;
    margin-bottom: 15px;
}
.login-label {
    display: block;
    font-weight: 700;
    color: #374151;
    margin-bottom: 8px;
    font-size: 14px;
    display: flex; align-items: center; gap: 5px;
}
.login-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    color: #333;
    outline: none;
    transition: 0.2s;
}
.login-input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}
.login-btn {
    width: 100%;
    padding: 12px;
    background: #22c55e;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 10px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: 0.2s;
}
.login-btn:hover { background: #16a34a; }
.login-footer {
    margin-top: 20px;
    font-size: 11px;
    color: #9ca3af;
    line-height: 1.5;
}

/* --- LAYOUT --- */
#container {
    display: none;
    margin-left: 280px;
    width: calc(100% - 280px);
    padding: 40px;
    max-width: 1400px;
    margin-right: auto;
    transition: 0.3s;
}

/* --- SIDEBAR (SCROLL FIXED FOR PC) --- */
#menuBtn {
    display: none;
    align-items: center; justify-content: center;
    position: fixed; top: 13px; left: 15px;
    height: 34px; width: 40px;
    background: var(--primary); color: #fff; border-radius: 8px;
    z-index: 1100; font-size: 24px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    padding-top: 0; line-height: 34px; cursor: pointer;
}

#sidebar {
    position: fixed; top: 0; left: 0; width: 280px; height: 100%;
    background: var(--sidebar-bg); backdrop-filter: blur(15px);
    border-right: 1px solid rgba(255,255,255,0.1);
    transition: .3s; z-index: 1200; padding-top: 0;
    display: flex; flex-direction: column;
    box-shadow: 5px 0 25px rgba(0,0,0,0.1);
    overflow-y: auto;
}

/* --- SIDEBAR SCROLLBAR UPDATED --- */
#sidebar::-webkit-scrollbar { width: 10px; }
#sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
#sidebar::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box;
}
#sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
    cursor: pointer;
}

.sidebar-header {
    padding: 30px 20px; background: linear-gradient(to right, var(--primary), var(--accent));
    color: #fff; font-size: 22px; font-weight: 800; text-align: center;
    letter-spacing: 1px; margin-bottom: 10px;
}
#userShow {
    text-align: center; padding: 15px; color: #cbd5e1; font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
}
#sidebar a {
    display: block; color: #94a3b8; text-decoration: none; padding: 14px 25px;
    cursor: pointer; font-weight: 500; transition: 0.3s; border-left: 4px solid transparent;
    font-size: 15px;
}
#sidebar a:hover { background: rgba(255,255,255,0.05); color: #fff; border-left-color: var(--accent); padding-left: 30px; }
#sidebar a.active { background: rgba(255,255,255,0.1); color: #fff; border-left-color: var(--accent); padding-left: 30px; font-weight: 700; }

/* --- SIDEBAR FOOTER --- */
.sidebar-footer {
    margin-top: auto; padding: 20px 25px;
    border-top: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.2);
}
.footer-item { margin-bottom: 15px; }
.footer-item:last-child { margin-bottom: 0; }
.footer-label { color: #94a3b8; font-size: 12px; display: block; margin-bottom: 2px; }
.footer-val { color: #fff; font-size: 14px; font-weight: 600; }
.status-online { color: #10b981; font-weight: bold; display: flex; align-items: center; gap: 5px; }
.status-offline { color: #ef4444; font-weight: bold; display: flex; align-items: center; gap: 5px; }

#overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); display: none; z-index: 1150; }

/* --- CARDS & SECTIONS --- */
.section { display: none; animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.card-glass, .card, .table-box, .modal {
    background: var(--glass-bg);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.6);
    position: relative;
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}
.card-glass { padding: 30px; margin-bottom: 30px; }

/* --- DASHBOARD STATS --- */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 35px; }
.card { padding: 30px; text-align: center; border-bottom: 4px solid transparent; background: #fff; }
.card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
.card b { font-size: 32px; display: block; margin-top: 10px; color: var(--text-main); }
.card span { font-size: 14px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }

/* --- FORMS & INPUTS --- */
.form-group { margin-bottom: 20px; text-align: left; }
.form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-main); font-size: 14px; }
input, select, button {
    width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid #cbd5e1;
    outline: none; transition: 0.3s; font-size: 15px; background: #fff;
}
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
input.invalid { border-color: var(--danger); background: #fef2f2; }
input.valid { border-color: var(--success); background: #f0fdf4; }

button {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff; font-weight: 600; border: none; cursor: pointer; font-size: 16px;
    padding: 14px; margin-top: 5px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
}
button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.3); }

/* --- TABLES --- */
.table-box {
    overflow-x: auto;
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
}
table { width: 100%; border-collapse: collapse; }
th, td { padding: 18px 25px; border-bottom: 1px solid #f1f5f9; text-align: left; vertical-align: middle; }
th { background: #f8fafc; color: var(--text-light); font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; }
td { font-size: 15px; color: var(--text-main); }
tr:last-child td { border-bottom: none; }
tr:hover { background-color: #f8fafc; }

/* --- ACTION BUTTONS --- */
.btn-action { padding: 8px 14px; font-size: 15px; margin: 0 4px; border-radius: 8px; width: auto; display: inline-block; box-shadow: none; cursor: pointer; border: none; }
.btn-view { background: #e0f2fe; color: #0284c7; } .btn-view:hover { background: #0284c7; color: #fff; }
.btn-edit { background: #fef3c7; color: #d97706; } .btn-edit:hover { background: #d97706; color: #fff; }
.btn-print { background: #f3e8ff; color: #9333ea; } .btn-print:hover { background: #9333ea; color: #fff; }
.btn-delete { background: #fee2e2; color: #dc2626; } .btn-delete:hover { background: #dc2626; color: #fff; }

/* --- CART & SEARCH --- */
.cart-box { margin-top: 30px; border: 2px dashed var(--primary); padding: 30px; border-radius: 16px; background: #f5f3ff; }
.cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(0,0,0,0.05); align-items: center; }
.live-search-results { position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 12px; max-height: 300px; overflow-y: auto; width: 100%; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; margin-top: 5px; }
.search-item { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
.search-item:hover { background: #f8fafc; padding-left: 25px; }

/* --- MODAL --- */
.modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; max-width: 95%; padding: 40px; z-index: 1500; max-height: 90vh; overflow-y: auto; background: #fff; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
.detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
.detail-label { font-weight: 600; color: var(--text-light); }
.detail-val { color: var(--text-main); font-weight: 600; }

/* --- RESPONSIVE --- */
@media (max-width: 1024px) {
    #container { margin-left: 0; width: 100%; padding: 15px; padding-top: 80px; }
    #sidebar { left: -300px; }
    header { display: flex; }
    #menuBtn { display: flex; }
    #profileBtn { display: flex; align-items: center; position: fixed; top: 13px; right: 15px; height: 34px; padding: 0 15px; font-size: 13px; z-index: 1100; border-radius: 30px; }
    #pIcon { font-size: 14px; margin-right: 5px; }
    #profileMenu { top: 60px; right: 15px; width: 200px; }
    .stats { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    table { min-width: 700px; }
    .card b { font-size: 24px; }
}

/* --- PRINT SETTINGS --- */
@media print {
    @page { size: auto; margin: 0mm; }
    html, body { width: 100%; height: 100%; margin: 0 !important; padding: 0 !important; overflow: hidden !important; background: #fff !important; }
    body * { visibility: hidden; }
    #memoModal, #memoModal * { visibility: visible !important; }
    #memoModal { display: block !important; position: fixed !important; left: 0 !important; top: 0 !important; width: 100% !important; max-width: 100% !important; height: auto !important; margin: 0 !important; padding: 5mm !important; transform: none !important; box-shadow: none !important; border: none !important; background: transparent !important; }
    #memoModal table { width: 100% !important; border-collapse: collapse; }
    .noPrint { display: none !important; }
}

/* --- FLOATING PROFILE BUTTON --- */
#profileBtn { position: fixed; top: 25px; right: 30px; z-index: 1201; background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 600; transition: 0.3s; }
#profileBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5); }
#profileMenu { position: fixed; top: 75px; right: 30px; width: 240px; background: #fff; border-radius: 12px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); display: none; z-index: 1202; overflow: hidden; border: 1px solid #e2e8f0; }
.p-item { padding: 14px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; color: #333; transition: 0.2s; font-weight: 500; }
.p-item:hover { background: #f8fafc; color: var(--primary); padding-left: 25px; }

/* --- GLOBAL STOCK ALERT --- */
#globalStockAlert { position: fixed; bottom: 30px; right: 30px; z-index: 1300; background: #ef4444; color: #fff; padding: 14px 25px; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4); display: none; align-items: center; gap: 10px; font-weight: bold; animation: pulse 2s infinite; }
#globalStockAlert.critical { background: #b91c1c; animation: pulseFast 0.8s infinite; border: 2px solid #fff; }
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
@keyframes pulseFast { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

/* --- CHAT SYSTEM --- */
#chatBtn { position: fixed; bottom: 90px; right: 30px; width: 50px; height: 50px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1290; transition: 0.3s; }
#chatBtn:hover { transform: scale(1.1); }
#chatBadge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #ef4444; border-radius: 50%; border: 2px solid #fff; display: none; }

#chatBox { position: fixed; bottom: 150px; right: 30px; width: 340px; height: 500px; background: #fff; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 1300; border: 1px solid #e2e8f0; overflow: hidden; font-family: 'Poppins', sans-serif; }
.chat-header { padding: 15px; background: linear-gradient(to right, var(--primary), var(--primary-dark)); color: #fff; display: flex; justify-content: space-between; align-items: center; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.chat-body { flex: 1; overflow-y: auto; padding: 15px; background: #f1f5f9; display: flex; flex-direction: column; gap: 8px; }
.chat-date { text-align: center; font-size: 10px; color: #94a3b8; margin: 15px 0 5px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

/* Message Row Container */
.msg-row { display: flex; align-items: flex-end; gap: 5px; margin-bottom: 2px; position: relative; }
.msg-row.me { flex-direction: row-reverse; }
.msg-row.other { flex-direction: row; }

/* Message Bubble */
.msg { max-width: 75%; padding: 8px 12px; border-radius: 18px; font-size: 13px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.msg.me { background: var(--primary); color: #fff; border-bottom-right-radius: 4px; padding-right: 25px; }
.msg.other { background: #fff; color: #333; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; padding-right: 25px; }

/* Meta Info */
.msg-meta { font-size: 9px; opacity: 0.7; display: block; margin-top: 4px; text-align: right; }
.sender-name { font-size: 10px; color: #64748b; margin-bottom: 2px; display: block; font-weight: bold; }

/* Three Dot Menu Button (FIXED VISIBILITY) */
.msg-opt-btn {
    position: relative;
    top: -5px;
    cursor: pointer;
    font-size: 18px;
    color: #94a3b8;
    opacity: 0.5;
    transition: 0.2s;
    line-height: 1;
    padding: 0 5px;
}
.msg-row:hover .msg-opt-btn { opacity: 1; color: #333; }
.msg-row.me .msg-opt-btn { color: #cbd5e1; }
.msg-row.me:hover .msg-opt-btn { color: #64748b; }

/* NEW MODERN MENU STYLE (Screenshot Look) */
.msg-menu-modern {
    position: absolute;
    background: rgba(30, 30, 30, 0.95); /* Dark Glassy Background */
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1500;
    display: none;
    overflow: hidden;
    width: 140px;
    top: 25px;
    right: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    animation: fadeInMenu 0.2s ease-out;
}
@keyframes fadeInMenu { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

.msg-menu-item {
    padding: 12px 15px;
    font-size: 13px;
    color: #fff;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.msg-menu-item:last-child { border-bottom: none; }
.msg-menu-item:hover { background: rgba(255,255,255,0.1); }
.msg-menu-item.del { color: #ff6b6b; }
.msg-menu-item.del:hover { background: rgba(239, 68, 68, 0.2); }

.chat-footer { padding: 10px; background: #fff; border-top: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 5px; }

/* --- DANGEROUS STOCK STYLES --- */
.row-zero { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: bold; }
.badge-out { background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

/* --- SERVICE BADGE DEEP GRADIENT --- */
.service-badge-deep {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white !important;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* --- PERCENTAGE BADGE --- */
.badge-percent {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 5px;
}
</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- ADMIN NOTICE -->
<div id="adminTicker"></div>

<!-- NOTIFICATION SOUND -->
<audio id="chatSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<header id="header">Sheikh Computer PRO</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>

<!-- PROFILE BUTTON -->
<div id="profileBtn" onclick="toggleProfile()">
    <span id="pIcon">üë§</span> <span id="pName">User</span>
</div>

<!-- PROFILE MENU -->
<div id="profileMenu">
    <div class="p-item" onclick="openProfileModal()">üë§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div>
    <div class="p-item" id="logBtn" onclick="openLogModal()" style="display:none">üìã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø ‡¶≤‡¶ó</div>
    <div class="p-item" onclick="openSettingsModal()">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</div>
    <div class="p-item" onclick="exportDataCSV()">üìÑ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü (CSV)</div>
    <div class="p-item" onclick="backupFullData()">üíæ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ (Full)</div>
    <div class="p-item" onclick="logout()" style="color:red; border-top:1px solid #f1f5f9; margin-top:5px">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</div>
</div>

<!-- GLOBAL STOCK ALERT BUTTON -->
<div id="globalStockAlert" onclick="showShortageModal()">
    ‚ö†Ô∏è <span id="alertText">Stock Alert</span>
</div>

<!-- CHAT BUTTON & BOX -->
<div id="chatBtn" onclick="toggleChat()">üí¨ <div id="chatBadge"></div></div>
<div id="chatBox">
    <div class="chat-header">
        <span>Team Notice Board</span>
        <span onclick="toggleChat()" style="cursor:pointer">‚úï</span>
    </div>
    <div class="chat-body" id="msgList"></div>
    <div class="chat-footer">
        <div style="display:flex; align-items:center; gap:5px; margin-bottom:2px">
            <span style="font-size:11px; color:#666; font-weight:bold">To:</span>
            <select id="msgTarget" style="padding:3px; font-size:11px; border:1px solid #ddd; border-radius:4px; background:#f9fafb; outline:none; cursor:pointer">
                <!-- Options loaded via JS -->
            </select>
        </div>
        <div style="display:flex; gap:5px; width:100%">
            <input id="msgInput" placeholder="Type message..." onkeydown="if(event.key==='Enter') sendMsg()" style="padding:10px; border:1px solid #ddd; border-radius:20px; flex:1; outline:none; font-size:13px; padding-left:15px;">
            <button onclick="sendMsg()" style="padding:0 15px; margin:0; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:16px;" id="sendBtnIcon">‚û§</button>
        </div>
    </div>
</div>

<div id="overlay" onclick="closeSidebar(); closeProfile(); closeAllModals()"></div>

<!-- LOGIN SCREEN -->
<div id="loginDiv">
<a href="https://sheikhcomputer.nett.to/maintain" class="god-mode-link">‚öôÔ∏è Admin Access</a>
    <div class="login-card">
        <h2 class="login-title">‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ <span>PRO</span></h2>
        <p class="login-subtitle" id="loginMsgDisplay">v7.5 (God Mode Connected)</p>
        <div class="login-form-group">
            <label class="login-label">üë§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ</label>
            <input id="uName" class="login-input" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ">
        </div>
        <div class="login-form-group">
            <label class="login-label">üîí ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
            <input id="uPass" type="password" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') login()">
        </div>
        <button onclick="login()" class="login-btn">‚ûú ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <p class="login-footer" style="cursor:pointer; color:#3b82f6" onclick="alert('‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§')">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</p>
        <p class="login-footer">‚ÑπÔ∏è ‡¶∏‡¶ï‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶è‡¶ï‡¶á ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶∏ | ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞: ‡¶Ü‡¶∞‡¶æ‡¶´‡¶æ‡¶§ ‡¶∏‡¶ø‡¶ï‡¶¶‡¶æ‡¶∞</p>
    </div>
</div>

<div id="container">
    <div id="sidebar">
        <div class="sidebar-header">Sheikh Computer</div>
        <div style="text-align:right;padding:10px 20px;font-size:24px;cursor:pointer;color:#ef4444; display:none" onclick="closeSidebar()" id="closeBtn">‚úï</div>
        <div id="userShow"></div>

        <!-- DYNAMIC MENU CONTAINER -->
        <div id="dynamicMenuContainer">
            <a id="nav-dashboard" onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (F1)</a>
            <a id="nav-newEntry" onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø (F2)</a>
            <a id="nav-cashDeposit" onclick="openMyCashModal()" style="color: #10b981; font-weight: bold; border-left: 4px solid #10b981;">üí∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ (Alt+C)</a>
            <a id="nav-return" onclick="openReturnModal()" style="color:#ef4444;">üîÑ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® / ‡¶´‡ßá‡¶∞‡¶§</a>
            <a id="nav-customerManager" onclick="showSection('customerManager')">üë• ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
            <a id="nav-inventory" onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</a>
            <a id="nav-stockAdjustment" onclick="showSection('stockAdjustment')" style="color:#f59e0b; font-weight:bold;">üõ†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
            <a id="nav-expenseManager" onclick="showSection('expenseManager')">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
            <!-- NEW ASSET MENU -->
            <a id="nav-assets" onclick="showSection('assetManager')" style="color:#8b5cf6; font-weight:bold;">üè¢ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶æ‡¶Æ‡¶æ‡¶≤ (Assets)</a>
            <a id="nav-analytics" onclick="showSection('analytics')">üìà ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</a>
            <a id="nav-reports" onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
        </div>

        <a onclick="logout()" style="color:#ef4444; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1);">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>

        <!-- SIDEBAR FOOTER -->
        <div class="sidebar-footer">
            <div class="footer-item">
                <span class="footer-label">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</span>
                <div id="connectionStatus" class="footer-val status-online">‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</div>
            </div>
            <div class="footer-item">
                <span class="footer-label">‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£</span>
                <div class="footer-val en">v7.5 | Connected</div>
            </div>
            <div class="footer-item">
                <span class="footer-label">‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞: ‡¶Ü‡¶∞‡¶æ‡¶´‡¶æ‡¶§ ‡¶∏‡¶ø‡¶ï‡¶¶‡¶æ‡¶∞</span>
                <div class="footer-val en">‡ß¶‡ßß‡ß¨‡ß≠‡ß™‡ßØ-‡ß™‡ß™‡ßØ‡ßÆ‡ß´</div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="section" style="padding-top: 20px;">
        <div style="text-align:center; margin-bottom:40px;">
            <button onclick="loadDashboardStats()" style="background:var(--primary); width:auto; padding:12px 30px; font-size: 16px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">üëÅÔ∏è ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
        </div>

        <div class="stats en">
            <div class="card" style="border-bottom-color:#3b82f6">
                <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</span>
                <b id="cCount" style="color:#3b82f6">---</b>
            </div>
            <div class="card" style="border-bottom-color:#10b981">
                <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßá‡¶≤ (‡ß≥)</span>
                <b id="cTotal" style="color:#10b981">---</b>
            </div>
            <div class="card" style="border-bottom-color:#f59e0b">
                <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡ß≥)</span>
                <b id="cTaken" style="color:#f59e0b">---</b>
            </div>
            <div class="card" style="border-bottom-color:#ef4444">
                <span>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</span>
                <b id="cDue" style="color:#ef4444">---</b>
            </div>
        </div>

        <!-- SECTION WISE SALES SUMMARY -->
        <div class="card-glass">
            <h4 style="margin:0 0 20px 0; color:var(--text-main); font-size:18px;">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∏‡ßá‡¶≤ ‡¶ì ‡¶≤‡¶æ‡¶≠ (%)</h4>
            <div id="sectionSummaryContainer" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <!-- Dynamic Sections will load here -->
            </div>
        </div>

        <div class="card-glass">
            <h4 style="margin:0 0 20px 0; color:var(--primary); font-size:18px;">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ì ‡¶≤‡¶æ‡¶≠ (%)</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #e2e8f0;">
                <table class="en">
                    <thead><tr><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th><th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th><th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th><th>‡¶≤‡¶æ‡¶≠ (Profit)</th></tr></thead>
                    <tbody id="userSummaryBody"><tr><td colspan="5" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="card-glass">
            <h4 style="margin:0 0 20px 0; color:var(--text-main)">üìä ‡¶ó‡¶§ ‡ß≠ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü</h4>
            <canvas id="salesChart" height="80"></canvas>
        </div>

        <div class="table-box">
            <h4 style="padding:20px; margin:0; background: transparent; border-bottom: 1px solid #f1f5f9; color:var(--text-main)">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
            <table class="en">
                <thead><tr><th>Memo</th><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- NEW ENTRY (3-STEP) -->
    <div id="newEntry" class="section">
        <div class="card-glass" style="max-width:700px; margin:auto;">
            <h3 style="color:var(--primary);">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>

            <div class="form-group" style="position: relative;">
                <label>üîç ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö (‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤, ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø) [F4]:</label>
                <input id="searchSerial" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 101, A4 Paper, Pen..." class="en" autocomplete="off" style="padding: 16px; border-color: #94a3b8;">
                <div id="liveSearchResults" class="live-search-results"></div>
            </div>

            <!-- MANUAL MODE TOGGLE -->
            <div id="manualModeContainer" style="background:#f0fdf4; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #bbf7d0; display:flex; align-items:center; gap:10px">
                <input type="checkbox" id="manualModeToggle" onchange="toggleManualMode()" style="width:20px; height:20px; margin:0">
                <label for="manualModeToggle" style="margin:0; cursor:pointer; font-weight:bold; color:#166534">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶®‡ßá‡¶á? ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶∏‡ßá‡¶≤ (Manual Sale)</label>
            </div>

            <!-- QUICK ACTION BUTTONS (DYNAMIC) -->
            <div id="quickActionArea" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap">
                <!-- ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
            </div>

            <!-- REGULAR MODE -->
            <div id="regularEntryArea" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
                <div class="form-group">
                    <label>‡ßß. ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó (Section):</label>
                    <select id="sectionSelect" onchange="updateCategories()" style="background:#fffbeb; border-color:#fcd34d; font-weight:bold;">
                        <option value="" disabled selected>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡ß®. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                    <select id="categorySelect" onchange="loadProductsByCategory()" style="background:#f0fdf4; border-color:#10b981; font-weight:600;">
                        <option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡ß©. ‡¶™‡¶£‡ßç‡¶Ø/‡¶ï‡¶æ‡¶ú:</label>
                    <div style="display:flex; gap:5px">
                        <select id="productSelect" onchange="productSelectedFromDropdown()">
                            <option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        </select>
                        <!-- QUICK ADD BUTTON -->
                        <button onclick="openQuickAddModal()" style="width:auto; padding:0 10px; background:#3b82f6; font-size:18px" title="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®">+</button>
                    </div>
                    <input type="hidden" id="selectedProductKey">
                </div>
            </div>

            <!-- MANUAL MODE INPUTS -->
            <div id="manualEntryArea" style="display:none; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px">
                <div class="form-group">
                    <label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó (Section):</label>
                    <select id="manualSection">
                        <option value="General" selected>General</option>
                        <option value="Computer">Computer</option>
                        <option value="Photocopy">Photocopy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (Product Name):</label>
                    <input id="manualName" placeholder="Example: Matador Pen">
                </div>
                <div class="form-group">
                    <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø (Category):</label>
                    <input id="manualCategory" placeholder="Example: Pen">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="form-group">
                    <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label>
                    <input id="qty" type="number" value="1" min="1" class="en" oninput="checkStockLive()" onkeydown="if(event.key === 'Enter'){ addToCart(); }">
                    <span id="stockLiveMsg" class="error-msg" style="color:red; font-size:12px"></span>
                </div>
                <div class="form-group"><label>‡¶¶‡¶∞ (Rate ‡ß≥):</label><input id="rate" type="number" min="0" class="en"></div>
            </div>

            <!-- NEW RECALL BUTTON BEFORE ADD BUTTON -->
            <button onclick="openHoldModal()" style="background: #6366f1; margin-bottom:10px; padding: 12px; font-size: 14px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">üìÇ ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (<span id="holdCountMain">0</span>)</button>

            <button onclick="addToCart()" style="background: linear-gradient(to right, #3b82f6, #2563eb); margin-bottom:25px; padding: 14px;">‚¨áÔ∏è ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add)</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #10b981; padding-bottom:10px; margin-bottom:15px">
                    <h4 style="margin:0; color: #047857;">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                    <div style="display:flex; gap:10px">
                        <button onclick="holdOrder()" style="width:auto; padding:5px 10px; font-size:12px; background:#f59e0b">‚è∏Ô∏è Hold</button>
                        <button onclick="openHoldModal()" style="width:auto; padding:5px 10px; font-size:12px; background:#6366f1">üìÇ Recall (<span id="holdCount">0</span>)</button>
                    </div>
                </div>

                <div id="cartList"></div>

<hr style="border:0; border-top:1px dashed #cbd5e1; margin:20px 0">

<!-- NEW QUICK SALE CHECKBOX -->
<div style="background:#fffbeb; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #fcd34d; display:flex; align-items:center; gap:10px;">
    <input type="checkbox" id="quickSaleToggle" onchange="toggleQuickSaleMode()" style="width:18px; height:18px; margin:0; cursor:pointer">
    <label for="quickSaleToggle" style="margin:0; font-weight:bold; color:#d97706; cursor:pointer; font-size:14px;">‚ö° ‡¶®‡¶æ‡¶Æ/‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶õ‡¶æ‡ßú‡¶æ ‡¶∏‡ßá‡¶≤ (Quick Sale)</label>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div class="form-group">
                        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá 'General Customer'):</label>
                        <input id="note" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)...">
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü):</label>
                        <input id="phone" placeholder="017xxxxxxxx" class="en" maxlength="11" oninput="validatePhoneLive(this)">
                        <span id="phoneError" class="error-msg" style="color:red; font-size:12px; display:none">‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! (013-019 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá)</span>
                        <small style="color:#64748b; display:block; margin-top:5px;">‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶®: <span id="phoneSuggestion"></span></small>
                    </div>
                </div>

                <div style="background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (Total):</label><input id="total" class="en" value="0" oninput="calcDue()" style="background:#fff; font-weight:bold; font-size: 18px; color: var(--text-main);"></div>
                        <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (Paid):</label><input id="taken" type="number" min="0" class="en" oninput="calcDue()" style="font-size: 18px;"></div>
                    </div>
                    <div class="form-group">
                        <label id="dueLabel" style="color:#ef4444">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</label>
                        <input id="due" readonly class="en" value="0" style="background:#fef2f2; color:#ef4444; font-weight:bold; font-size: 18px;">
                    </div>
                </div>

                <!-- QUOTATION MODE TOGGLE (ADDED) -->
                <div style="margin-top:15px; display:flex; align-items:center; gap:10px; background:#eff6ff; padding:10px; border-radius:8px">
                    <input type="checkbox" id="quotationMode" style="width:20px; height:20px; margin:0">
                    <label for="quotationMode" style="margin:0; font-weight:bold; color:#1e40af; cursor:pointer">üñ®Ô∏è ‡¶ï‡ßã‡¶ü‡ßá‡¶∂‡¶® ‡¶Æ‡ßã‡¶° (Quotation Mode - No Save/Stock)</label>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:25px">
                    <button onclick="saveBulkEntry(false)" style="background: linear-gradient(to right, #f59e0b, #d97706)">üíæ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="saveBulkEntry(true)" style="background: linear-gradient(to right, #10b981, #059669)">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOMER MANAGEMENT -->
    <div id="customerManager" class="section">
        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom:25px;">
                <h3 style="margin:0; color:var(--text-main)">üë• ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <div style="display:flex; gap:10px">
                    <button onclick="downloadExcel('customer')" style="width:auto; background:#10b981; padding:10px 20px;">üìä Excel</button>
                    <button onclick="openDueCollectionModal()" style="width:auto; background:#f59e0b; padding:10px 20px;">üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ ‡¶®‡¶ø‡¶®</button>
                    <button onclick="openAddCustomerModal()" style="width:auto; background:var(--primary); padding:10px 20px;">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</button>
                </div>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:20px">
                <div class="form-group" style="flex:2">
                    <label>üîç ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤):</label>
                    <input id="custSearch" placeholder="Search..." class="en" oninput="filterCustomerTable()" style="padding: 14px;">
                </div>
                <div class="form-group" style="flex:1">
                    <label>‡¶∏‡¶æ‡¶ú‡¶æ‡¶® (Sort By):</label>
                    <select id="custSort" onchange="sortCustomers()" style="padding:14px">
                        <option value="default">Default (Oldest First)</option>
                        <option value="newest">Newest First</option>
                        <option value="name">Name (A-Z)</option>
                        <option value="due">Highest Due (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¨‡ßá‡¶∂‡¶ø)</option>
                        <option value="sale">Highest Sale (‡¶∏‡ßá‡¶≤ ‡¶¨‡ßá‡¶∂‡¶ø)</option>
                    </select>
                </div>
            </div>

            <div class="table-box">
                <table class="en">
                    <thead>
                        <tr>
                            <th>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ (‡ß≥)</th>
                            <th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th>
                            <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- INVENTORY -->
    <div id="inventory" class="section">
        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom: 25px;">
                <h3 style="margin:0; color:var(--text-main);">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <div style="display:flex; gap:10px">
                    <button onclick="openManualSalesReport()" style="width:auto; background:#ef4444; padding:10px 20px;">‚ö†Ô∏è ‡¶Ü‡¶®‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
                    <button onclick="downloadExcel('stock')" style="width:auto; background:#10b981; padding:10px 20px;">üìä Excel</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px">
                 <div class="form-group">
                    <label>‡¶∏‡ßá‡¶ï‡¶∂‡¶®/‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó (Main Type):</label>
                    <select id="stMainType" style="background:#fffbeb; font-weight:bold; border-color: #fcd34d;">
                        <!-- Dynamic Sections -->
                    </select>
                </div>
                <div class="form-group"><label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶° (Auto/Manual):</label><input id="stSerial" class="en" placeholder="Auto Generated" style="background:#fff; font-weight:bold"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px">
                <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><input id="stCategory" placeholder="Paper, Khata, Pen..."></div>
                <div class="form-group"><label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="stName" placeholder="Product Name"></div>
            </div>

            <div style="background:#eff6ff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #bfdbfe;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="stIsService" style="width:20px; height:20px; margin:0" onchange="toggleStockInput()">
                    <label for="stIsService" style="margin:0; cursor:pointer; font-weight:bold; color:#1d4ed8">‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßá‡¶á‡¶®‡¶ü‡ßá‡¶á‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ)</label>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:15px; align-items:end">
                <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï (Qty):</label><input id="stQty" type="number" min="0" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤:</label><input id="stAlert" type="number" min="0" class="en" placeholder="5"></div>
                <div class="form-group"><label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ:</label><input id="stCost" type="number" min="0" class="en" placeholder="0"></div>
                <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</label><input id="stSell" type="number" min="0" class="en" placeholder="0"></div>
                <button onclick="addNewProduct()" style="height:48px; margin-bottom:18px; width: 90px; background: var(--text-main);">+ ‡¶∏‡ßá‡¶≠</button>
            </div>

            <div style="margin-top:30px; display:flex; justify-content:flex-end; margin-bottom:10px">
                <select id="stockSort" onchange="updateStockTable()" style="width:200px; padding:8px">
                    <option value="serial">Sort by Serial (Default)</option>
                    <option value="category">Sort by Category</option>
                    <option value="name">Sort by Name</option>
                    <option value="qty">Sort by Stock (Low to High)</option>
                    <option value="type">Sort by Section</option>
                </select>
            </div>

            <div class="table-box">
                <table>
                    <thead><tr><th>Type</th><th>Serial</th><th>Category</th><th>Name</th><th>Stock</th><th>Alert</th><th>Cost Price</th><th>Sell Price</th><th>Action</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- STOCK ADJUSTMENT (INTERNAL USE) SECTION -->
    <div id="stockAdjustment" class="section">
        <div class="card-glass" style="max-width:800px; margin:auto">
            <h3 style="color:var(--warning); margin-bottom:20px">üõ†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Internal Use)</h3>
            <p style="color:var(--text-light); margin-bottom:20px">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞, ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶∑‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶Æ‡¶ø‡ßü‡ßá ‡¶¶‡¶ø‡¶®‡•§ ‡¶è‡¶ü‡¶ø ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ó‡¶£‡ßç‡¶Ø ‡¶π‡¶¨‡ßá‡•§</p>

            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; align-items:end; margin-bottom:20px">
                <div class="form-group" style="position:relative">
                    <label>üîç ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®:</label>
                    <input id="adjSearch" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤..." class="en" oninput="searchAdjProduct(this.value)">
                    <div id="adjSearchResults" class="live-search-results" style="top:70px"></div>
                    <input type="hidden" id="adjProductKey">
                </div>
                <div class="form-group">
                    <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty):</label>
                    <input id="adjQty" type="number" class="en" placeholder="0">
                </div>
                <div class="form-group">
                    <label>‡¶ï‡¶æ‡¶∞‡¶£ (Reason):</label>
                    <select id="adjReason">
                        <option value="Shop Use">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ (Shop Use)</option>
                        <option value="Personal Use">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ (Personal)</option>
                        <option value="Damaged">‡¶®‡¶∑‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá (Damaged)</option>
                    </select>
                </div>
            </div>
            <button onclick="saveStockAdjustment()" style="background:var(--warning); color:#000; font-weight:bold">üíæ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶® (Deduct Stock)</button>

            <h4 style="margin:30px 0 15px 0; color:var(--text-main)">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4>
            <div class="table-box">
                <table class="en">
                    <thead><tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶™‡¶£‡ßç‡¶Ø</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶ï‡¶æ‡¶∞‡¶£</th><th>‡¶ñ‡¶∞‡¶ö (Cost)</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th></tr></thead>
                    <tbody id="adjHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- EXPENSE MANAGEMENT -->
    <div id="expenseManager" class="section">
        <div class="card-glass" style="max-width:900px; margin:auto">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom: 25px;">
                <h3 style="margin:0; color:#ef4444;">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <button onclick="downloadExcel('expense')" style="width:auto; background:#10b981; padding:10px 20px;">üìä Excel</button>
            </div>

            <div style="background:#fef2f2; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #fecaca; text-align:center">
                <h4 style="margin:0; color:#b91c1c; font-size: 20px;">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: ‡ß≥ <span id="totalExpenseDisplay">0</span></h4>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap:15px; align-items:end; margin-bottom:25px;">
                <div class="form-group"><label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label><input id="expDesc" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶≠‡¶æ‡ßú‡¶æ, ‡¶®‡¶æ‡¶∏‡ßç‡¶§‡¶æ..."></div>
                <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                    <select id="expCat">
                        <!-- Dynamic Expense Categories -->
                    </select>
                </div>
                <div class="form-group"><label>‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="expAmount" type="number" class="en" placeholder="0"></div>
                <button onclick="saveExpense()" style="height:48px; margin-bottom:18px; width: 90px; background:#ef4444">+ ‡¶∏‡ßá‡¶≠</button>
            </div>

            <div class="table-box">
                <table class="en">
                    <thead><tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="expenseBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<!-- FIXED ASSET MANAGEMENT (UPDATED DESIGN) -->
    <div id="assetManager" class="section">
        <div class="card-glass" style="max-width:1100px; margin:auto;">

            <!-- ‡ßß. ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® (‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßã‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ) -->
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom: 25px;">
                <h3 style="margin:0; color:#8b5cf6;">üè¢ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ (Fixed Assets)</h3>
                <div style="text-align:right; background:#f5f3ff; padding:10px 20px; border-radius:10px; border:1px solid #ddd6fe">
                    <span style="display:block; font-size:12px; color:#64748b">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßã‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ</span>
                    <b style="font-size:24px; color:#7c3aed">‡ß≥ <span id="totalAssetValue">0</span></b>
                </div>
            </div>

            <!-- ‡ß®. ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ (‡ß®‡¶ü‡¶æ ‡¶â‡¶™‡¶∞‡ßá, ‡ß®‡¶ü‡¶æ ‡¶®‡¶ø‡¶ö‡ßá) -->
            <div style="background:#fff; padding:25px; border-radius:12px; margin-bottom:30px; border:1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <h4 style="margin-top:0; color:#4b5563; margin-bottom:20px; border-bottom:1px dashed #cbd5e1; padding-bottom:10px;">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶æ‡¶≤‡¶æ‡¶Æ‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h4>

                <div style="display:flex; flex-direction:column; gap:15px;">

                    <!-- ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡¶æ‡¶á‡¶®: ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group" style="margin:0">
                            <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label>
                            <input id="assetName" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Epson L130 Printer..." style="border:1px solid #cbd5e1">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                            <input id="assetDate" type="date" class="en" style="border:1px solid #cbd5e1">
                        </div>
                    </div>

                    <!-- ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶≤‡¶æ‡¶á‡¶®: ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶æ‡¶Æ -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group" style="margin:0">
                            <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ:</label>
                            <select id="assetStatus" style="border:1px solid #cbd5e1">
                                <option value="Active">Active (‡¶≠‡¶æ‡¶≤‡ßã)</option>
                                <option value="Repairing">Repairing (‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§)</option>
                                <option value="Damaged">Damaged (‡¶®‡¶∑‡ßç‡¶ü)</option>
                                <option value="Sold">Sold (‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø)</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (Tk):</label>
                            <input id="assetPrice" type="number" class="en" placeholder="0" style="border:1px solid #cbd5e1; font-weight:bold">
                        </div>
                    </div>

                    <!-- ‡¶¨‡¶æ‡¶ü‡¶® (‡¶®‡¶ø‡¶ö‡ßá ‡¶°‡¶æ‡¶®‡¶™‡¶æ‡¶∂‡ßá) -->
                    <div style="text-align:right;">
                        <button onclick="saveAsset()" style="height:45px; width: 150px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color:white; font-weight:bold; border-radius:8px;">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>

                </div>
            </div>

            <!-- ‡ß©. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ (‡¶≤‡¶ø‡¶∏‡ßç‡¶ü) -->
            <div class="table-box">
                <table class="en" style="width:100%">
                    <thead>
                        <tr style="background:#f8fafc; text-transform:uppercase; font-size:12px; letter-spacing:0.5px;">
                            <th style="padding:15px;">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th style="padding:15px;">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                            <th style="padding:15px;">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ (Status)</th>
                            <th style="padding:15px; text-align:right">‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ</th>
                            <th style="padding:15px; text-align:right; color:#7c3aed">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¶‡¶æ‡¶Æ</th>
                            <th style="padding:15px; text-align:center">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="assetBody"></tbody>
                </table>
            </div>

        </div>
    </div>


    <!-- BUSINESS ANALYTICS -->
    <div id="analytics" class="section">
        <div class="card-glass">
            <h3 style="margin-top:0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; color: var(--text-main)">üìà ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶ì ‡¶≤‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</h3>

            <div style="text-align:center; margin-bottom:25px; background:#f8fafc; padding:20px; border-radius:12px; border:1px solid #e2e8f0">
                <p style="color:#64748b; margin-bottom:15px">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶´‡¶æ‡¶∏‡ßç‡¶ü ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <div style="display:flex; gap:15px; justify-content:center">
                    <button onclick="toggleFullHistory(true)" style="background:var(--primary); width:auto; padding:12px 25px; font-size:16px; box-shadow:0 4px 15px rgba(79, 70, 229, 0.3);">üîÑ Load Full History</button>
                    <button onclick="toggleFullHistory(false)" style="background:#ef4444; width:auto; padding:12px 25px; font-size:16px;">‚ùå Unload History</button>
                </div>
                <p id="historyStatus" style="margin-top:10px; font-weight:bold; color:#10b981; display:none">‚úÖ Full History Loaded!</p>
            </div>

            <div class="stats en" style="margin-bottom:30px;">
                <div class="card" style="background:#f8fafc; border-bottom: 4px solid #6366f1;">
                    <span>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤ (‡¶≤‡¶æ‡¶á‡¶´‡¶ü‡¶æ‡¶á‡¶Æ)</span>
                    <b id="lifeSale" style="color:#4f46e5">---</b>
                </div>
                <div class="card" style="background:#f8fafc; border-bottom: 4px solid #ef4444;">
                    <span>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡¶≤‡¶æ‡¶á‡¶´‡¶ü‡¶æ‡¶á‡¶Æ)</span>
                    <b id="lifeDue" style="color:#ef4444">---</b>
                </div>
                <div class="card" style="background:#f8fafc; border-bottom: 4px solid #10b981;">
                    <span>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡¶≤‡¶æ‡¶á‡¶´‡¶ü‡¶æ‡¶á‡¶Æ)</span>
                    <b id="lifeCash" style="color:#10b981">---</b>
                </div>
            </div>

            <div style="display:flex; gap:15px; justify-content:center; align-items:center; margin-bottom:25px; background:#f8fafc; padding:20px; border-radius:12px;">
                <span style="font-weight:bold; color:#666">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞:</span>
                <select id="anMonth" class="en" style="width:160px">
                    <option value="0">All Months</option>
                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
                <select id="anYear" class="en" style="width:110px">
                    <option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
                </select>
                <button onclick="generateAnalytics()" style="margin:0; width:auto; padding:12px 25px; background: var(--text-main);">‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="stats en" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="card" style="border-bottom: 4px solid #3b82f6;">
                    <span>‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶∏‡ßá‡¶≤</span>
                    <b id="anaSale">---</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #94a3b8;">
                    <span>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ ‡¶ñ‡¶∞‡¶ö</span>
                    <b id="anaCost" style="color:#64748b">---</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #f59e0b;">
                    <span>‡¶ó‡ßç‡¶∞‡¶∏ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü (‡¶≤‡¶æ‡¶≠)</span>
                    <b id="anaGross" style="color:#d97706">---</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #ef4444;">
                    <span>‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</span>
                    <b id="anaExpense" style="color:#b91c1c">---</b>
                </div>
                <div class="card" style="border-bottom: 4px solid #10b981; background:#f0fdf4; transform: scale(1.02);">
                    <span id="netProfitTitle">‡¶®‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü (‡¶Ü‡¶∏‡¶≤ ‡¶≤‡¶æ‡¶≠)</span>
                    <b id="anaNet" style="font-size: 28px;">---</b>
                </div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:25px; margin-top:30px;">
                <div style="flex:1; min-width:320px">
                    <h4 style="margin:0 0 15px 0; color: var(--text-main)">üìä ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡¶°‡¶æ‡¶â‡¶®</h4>
                    <div class="table-box">
                        <table class="en">
                            <thead>
                                <tr>
                                    <th>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó (Category)</th>
                                    <th style="text-align:right">‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤</th>
                                    <th style="text-align:right">‡¶ñ‡¶∞‡¶ö (Cost)</th>
                                    <th style="text-align:right">‡¶≤‡¶æ‡¶≠ (Profit)</th>
                                    <th style="text-align:right">Margin %</th>
                                </tr>
                            </thead>
                            <tbody id="anaTableBody">
                                <tr><td colspan="5" style="text-align:center">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="flex:1; min-width:320px">
                    <h4 style="margin:0 0 15px 0; color:#ef4444">üìâ ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶∏‡¶Æ‡ßÇ‡¶π (‡¶¨‡ßç‡¶∞‡ßá‡¶ï‡¶°‡¶æ‡¶â‡¶®)</h4>
                    <div class="table-box" style="max-height: 250px; overflow-y:auto;">
                        <table class="en">
                            <thead><tr><th>Category</th><th style="text-align:right">Amount</th></tr></thead>
                            <tbody id="anaExpBreakdown"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-glass">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:15px; margin-bottom:20px;">
                 <h3 style="margin:0; color: var(--text-main)">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ì ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ‡ßü‡ßá‡¶∂‡¶®</h3>
                 <button onclick="toggleShortageOnly()" id="shortageBtn" style="width:auto; background:#f59e0b;">‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∂‡¶∞‡ßç‡¶ü‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            </div>

            <div class="stats en" style="margin-bottom:20px;">
                 <div class="card" style="background:#f0fdf4; border:1px solid #10b981">
                    <span>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ (‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ‡ßá)</span>
                    <b id="stockValue">0</b>
                 </div>
            </div>

            <div class="table-box">
                <table class="en">
                    <thead>
                        <tr>
                            <th>‡¶™‡¶£‡ßç‡¶Ø</th>
                            <th>‡¶∏‡ßá‡¶ï‡¶∂‡¶®</th>
                            <th>‡¶∏‡ßç‡¶ü‡¶ï</th>
                            <th>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ</th>
                            <th>‡¶Æ‡ßã‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ</th>
                            <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                        </tr>
                    </thead>
                    <tbody id="stockValuationBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="section">
        <div class="card-glass">
            <h3 style="text-align:center; margin-top:0; color: var(--text-main)">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</h3>

            <div style="display:flex; gap:15px; margin-bottom: 25px; justify-content: center; background: #f8fafc; padding: 25px; border-radius: 12px; flex-wrap: wrap;">
                <div>
                    <label style="display:block; font-size:12px; color:#666">From Date:</label>
                    <input type="date" id="rFromDate" class="en" style="margin:0; max-width: 180px;">
                </div>
                <div>
                    <label style="display:block; font-size:12px; color:#666">To Date:</label>
                    <input type="date" id="rToDate" class="en" style="margin:0; max-width: 180px;">
                </div>
                <div style="display:flex; align-items:end">
                    <button onclick="searchByDateRange()" style="width:auto;margin:0;padding:12px 30px; background: var(--text-main);">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom: 25px;">
                <button onclick="loadReportData()" style="background:#64748b">‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (Reset)</button>
                <button onclick="downloadExcel('report')" style="background:#10b981;">üìä Download Excel</button>
                <button onclick="window.print()" style="background:#8b5cf6;">üñ®Ô∏è ‡¶™‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#f1f5f9; padding:10px; border-radius:8px;">
                <button onclick="changeReportPage(-1)" style="width:auto; background:#64748b; padding: 8px 15px; font-size:14px">‚¨ÖÔ∏è ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡ßá‡¶ú</button>
                <span id="pageIndicator" style="font-weight:bold; color:#333;">Page 1</span>
                <button onclick="changeReportPage(1)" style="width:auto; background:#64748b; padding: 8px 15px; font-size:14px">‡¶™‡¶∞‡ßá‡¶∞ ‡¶™‡ßá‡¶ú ‚û°Ô∏è</button>
            </div>

            <div class="table-box" style="border:1px solid #e2e8f0">
                <table class="en">
                    <thead><tr><th>Memo/ID</th><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

--- START OF PART 2 ---

<!-- CASH DEPOSIT MODAL (UPDATED WITH LOGIC) -->

<div id="myCashModal" class="modal" style="width:500px">
    <h3 style="margin-top:0; color:#10b981; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (Net Cash)</h3>
    <div style="background:#f0fdf4; padding:20px; border-radius:12px; text-align:center; margin-bottom:15px; border:1px solid #bbf7d0">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:13px">
            <span>‡¶Ü‡¶ú‡¶ï‡ßá ‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®:</span>
            <span style="font-weight:bold" id="myTotalTaken">0</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px; color:#ef4444">
            <span>‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∏ (-) ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö:</span>
            <span style="font-weight:bold" id="myTotalExpense">0</span>
        </div>
        <div style="border-top:1px dashed #166534; padding-top:10px">
            <span style="color:#15803d; font-size:14px; font-weight:bold">‡¶°‡ßç‡¶∞‡ßü‡¶æ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ:</span>
            <div style="font-size:32px; font-weight:800; color:#16a34a; margin-top:5px">‡ß≥ <span id="myNetCash">0</span></div>
        </div>
    </div>

    <!-- Quick Expense Button Inside Cash Modal -->
    <div style="text-align:center; margin-bottom:20px;">
        <button onclick="closeModal('myCashModal'); showSection('expenseManager')" style="width:auto; padding:5px 15px; font-size:12px; background:#ef4444">üí∏ ‡¶ñ‡¶∞‡¶ö / ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Amount):</label>
        <input id="depositAmount" type="number" class="en" placeholder="‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶°‡ßç‡¶∞‡ßü‡¶æ‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶õ‡ßá‡¶®?" style="font-size:18px; font-weight:bold">
    </div>
    <div class="form-group">
        <label>‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶∞‡¶æ‡¶ñ‡¶õ‡ßá‡¶® / ‡¶®‡ßã‡¶ü:</label>
        <select id="depositTarget">
            <option value="Drawer">‡¶°‡ßç‡¶∞‡ßü‡¶æ‡¶∞‡ßá ‡¶∞‡ßá‡¶ñ‡ßá‡¶õ‡¶ø (Drawer)</option>
            <option value="Owner">‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶ï‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø (To Owner)</option>
            <option value="Roky">‡¶∞‡¶ï‡¶ø‡¶ï‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø (To Roky)</option>
        </select>
    </div>
    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('myCashModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveCashDeposit()" style="background:#10b981; width:auto;">‚úÖ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- SHORTAGE MODAL -->
<div id="shortageModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#ef4444;">‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡¶∞‡ßç‡¶ü‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
        <button onclick="closeModal('shortageModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <div class="table-box">
        <table class="en">
            <thead><tr><th>‡¶™‡¶£‡ßç‡¶Ø</th><th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶≤‡ßá‡¶≠‡ßá‡¶≤</th></tr></thead>
            <tbody id="shortageModalBody"></tbody>
        </table>
    </div>
</div>

<!-- QUICK STOCK ADD MODAL -->
<div id="quickStockModal" class="modal" style="width:400px">
    <div style="text-align:center; margin-bottom:20px">
        <h3 style="color:#ef4444; margin:0">‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑!</h3>
        <p style="color:#64748b; margin-top:5px">‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á‡•§</p>
    </div>
    <div style="background:#fef2f2; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #fecaca">
        <p style="margin:0; font-weight:bold; color:#333">‡¶™‡¶£‡ßç‡¶Ø: <span id="qsName"></span></p>
        <p style="margin:5px 0 0 0; color:#ef4444">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: <span id="qsCurrent"></span></p>
    </div>
    <input type="hidden" id="qsKey">
    <div class="form-group">
        <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add Qty):</label>
        <input id="qsAddQty" type="number" class="en" placeholder="Example: 10, 20..." style="font-size:18px; font-weight:bold" onkeydown="if(event.key==='Enter') saveQuickStock()">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px">
        <button onclick="closeModal('quickStockModal')" style="background:#94a3b8">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveQuickStock()" style="background:#10b981">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- DUE COLLECTION MODAL -->
<div id="dueCollectionModal" class="modal">
    <h3 style="margin-top:0; color:#f59e0b; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶®‡¶ø‡¶®</h3>
    <div class="form-group">
        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="dcName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input id="dcPhone" class="en" maxlength="11" placeholder="017xxxxxxxx" oninput="autoFillDueCustomer(this)">
    </div>
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Amount):</label>
        <input id="dcAmount" type="number" class="en" placeholder="500" style="font-size:18px; font-weight:bold">
    </div>
    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('dueCollectionModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveDueCollection()" style="background:#f59e0b; width:auto;">üíæ ‡¶ú‡¶Æ‡¶æ ‡¶®‡¶ø‡¶®</button>
    </div>
</div>

<!-- SMART SALES RETURN MODAL (UPDATED) -->
<div id="returnModal" class="modal" style="width:700px; max-width:95%">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#ef4444;">üîÑ ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</h3>
        <button onclick="closeModal('returnModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>

    <!-- Search Section -->
    <div style="background:#fef2f2; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #fecaca">
        <label style="font-weight:bold; color:#b91c1c; display:block; margin-bottom:10px">‡ßß. ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (Memo No / Name / Phone):</label>
        <div style="display:flex; gap:10px">
            <input id="retSearchInput" placeholder="Example: 1001, Rahim, 017..." class="en" onkeydown="if(event.key==='Enter') searchInvoiceForReturn()">
            <button onclick="searchInvoiceForReturn()" style="width:auto; background:#ef4444">üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Search Results List (NEW) -->
    <div id="retSearchList" style="display:none; margin-bottom:20px; max-height:200px; overflow-y:auto; border:1px solid #e2e8f0;">
        <table class="en">
            <thead style="background:#f1f5f9; position:sticky; top:0"><tr><th>Memo</th><th>Date</th><th>Customer</th><th>Total</th><th>Action</th></tr></thead>
            <tbody id="retSearchListBody"></tbody>
        </table>
    </div>

    <!-- Selected Invoice Details -->
    <div id="retResultArea" style="display:none; border-top:2px dashed #ccc; padding-top:20px;">
        <div style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bbf7d0">
            <p style="margin:0">
                <strong>Memo:</strong> <span id="retMemoNo"></span> <br>
                <strong>Date:</strong> <span id="retDate"></span> <br>
                <strong>Customer:</strong> <span id="retCustName"></span>
            </p>
        </div>
        <div class="table-box" style="max-height:300px; overflow-y:auto; margin-bottom:20px">
            <table class="en">
                <thead><tr><th>Item</th><th>Sold Qty</th><th>Rate</th><th>Return Qty</th><th>Refund Amount</th></tr></thead>
                <tbody id="retItemsBody"></tbody>
            </table>
        </div>
        <div style="text-align:right; margin-bottom:20px">
            <h3 style="color:#ef4444">Total Refund: ‡ß≥ <span id="retTotalRefund">0</span></h3>
        </div>
        <div class="form-group">
            <label>‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶®‡ßã‡¶ü / ‡¶ï‡¶æ‡¶∞‡¶£:</label>
            <input id="retReason" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶®‡¶∑‡ßç‡¶ü ‡¶õ‡¶ø‡¶≤, ‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø...">
        </div>
        <div style="text-align:right">
            <button onclick="processSmartReturn()" style="background:#ef4444; width:auto">‚úÖ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- HOLD ORDER MODAL -->
<div id="holdOrderModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#6366f1;">üìÇ ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
        <button onclick="closeModal('holdOrderModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <div class="table-box">
        <table class="en">
            <thead><tr><th>Customer</th><th>Items</th><th>Total</th><th>Action</th></tr></thead>
            <tbody id="holdOrderBody"></tbody>
        </table>
    </div>
</div>

<!-- USER PROFILE MODAL -->
<div id="userProfileModal" class="modal" style="text-align:center">
    <div style="width:80px; height:80px; background:var(--primary); color:#fff; font-size:32px; font-weight:bold; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;" id="modalProfileInit">U</div>
    <h2 id="modalProfileName" style="margin-bottom:5px">User Name</h2>
    <p id="modalProfileRole" style="color:var(--text-light); margin-bottom:20px">Role</p>
    <div style="background:#f0fdf4; padding:15px; border-radius:10px; text-align:left; margin-bottom:20px; border:1px solid #bbf7d0">
        <h4 style="margin:0 0 10px 0; color:#15803d">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶≤‡¶®‡¶æ‡¶Æ‡¶æ (Today's Report)</h4>
        <p style="margin:5px 0"><strong>‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø:</strong> <span id="upCount">0</span> ‡¶ü‡¶ø</p>
        <p style="margin:5px 0"><strong>‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤:</strong> ‡ß≥ <span id="upTotal">0</span></p>
    </div>
    <div style="background:#f8fafc; padding:15px; border-radius:10px; text-align:left; margin-bottom:20px">
        <p><strong>Status:</strong> <span style="color:#10b981">Active</span></p>
        <p style="font-size:12px; color:#ef4444; margin-top:5px">‚ÑπÔ∏è ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    </div>
    <button onclick="closeModal('userProfileModal')" style="background:#94a3b8">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<!-- ACTIVITY LOG MODAL -->
<div id="logModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--primary);">üìã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø ‡¶≤‡¶ó (Admin Only)</h3>
        <button onclick="closeModal('logModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <div class="table-box" style="max-height:400px; overflow-y:auto">
        <table class="en">
            <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<!-- ADVANCED SETTINGS MODAL -->
<div id="appSettingsModal" class="modal" style="width:600px">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--text-main);">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</h3>
        <button onclick="closeModal('appSettingsModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>

    <!-- Tabs -->
    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:10px; overflow-x:auto">
        <button onclick="switchTab('tabGeneral')" style="background:#f1f5f9; color:#333; border:none; padding:8px 15px; font-size:13px">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</button>
        <button onclick="switchTab('tabUsers')" style="background:#f1f5f9; color:#333; border:none; padding:8px 15px; font-size:13px">‡¶á‡¶â‡¶ú‡¶æ‡¶∞</button>
        <button onclick="switchTab('tabConfig')" style="background:#f1f5f9; color:#333; border:none; padding:8px 15px; font-size:13px">‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</button>
        <button onclick="switchTab('tabSystem')" style="background:#f1f5f9; color:#333; border:none; padding:8px 15px; font-size:13px">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</button>
        <button onclick="switchTab('tabData')" style="background:#fee2e2; color:#ef4444; border:none; padding:8px 15px; font-size:13px">‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏</button>
    </div>

    <!-- Tab Content: General -->
    <div id="tabGeneral" class="settings-tab">
        <h4 style="margin-bottom:15px; color:var(--text-light)">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø (‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá)</h4>
        <div class="form-group">
            <label>‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
            <input id="shopNameInput" placeholder="Sheikh Computer & Stationery">
        </div>
        <div class="form-group">
            <label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</label>
            <input id="shopAddressInput" placeholder="Kashiani, Gopalganj">
        </div>
        <button onclick="saveShopInfo()" style="width:100%; background:var(--primary)">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Tab Content: Users -->
    <div id="tabUsers" class="settings-tab" style="display:none">
        <h4 style="margin-bottom:15px; color:var(--text-light)">üîê ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h4>
        <div class="form-group">
            <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°:</label>
            <input id="newPassInput" type="password" placeholder="New Password">
        </div>
        <button onclick="changeOwnPassword()" style="width:100%; background:var(--primary); margin-bottom:20px">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>

        <div id="adminUserPanel" style="display:none; border-top:1px solid #e2e8f0; padding-top:20px">
            <h4 style="margin-bottom:10px; color:#ef4444">üëë ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ (‡¶Ö‡¶®‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°)</h4>
            <div class="table-box">
                <table class="en">
                    <thead><tr><th>User</th><th>Role</th><th>Password</th><th>Action</th></tr></thead>
                    <tbody id="userListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab Content: Config -->
    <div id="tabConfig" class="settings-tab" style="display:none">
        <h4 style="margin-bottom:10px; color:var(--text-light)">‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <input id="newSectionInput" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶æ‡¶Æ..." style="margin:0">
            <button onclick="addSection()" style="width:auto; background:#10b981">+</button>
        </div>
        <div id="sectionList" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:20px"></div>

        <h4 style="margin-bottom:10px; color:var(--text-light)">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§ (Expense Categories)</h4>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <input id="newExpCatInput" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶æ‡¶§..." style="margin:0">
            <button onclick="addExpCat()" style="width:auto; background:#10b981">+</button>
        </div>
        <div id="expCatList" style="display:flex; flex-wrap:wrap; gap:5px"></div>

        <!-- NEW QUICK BUTTON SETTINGS -->
        <hr style="border:0; border-top:1px solid #e2e8f0; margin:20px 0">
        <h4 style="margin-bottom:10px; color:var(--primary)">‚ö° ‡¶ï‡ßÅ‡¶á‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ (Quick Buttons)</h4>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <select id="qbProductSelect" style="flex:2">
                <option value="">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</option>
            </select>
            <input id="qbLabelInput" placeholder="‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: A4 Print)" style="flex:1; margin:0">
            <button onclick="addQuickButtonSetting()" style="width:auto; background:#3b82f6">+</button>
        </div>
        <div id="qbSettingsList" style="display:flex; flex-wrap:wrap; gap:8px"></div>
    </div>

    <!-- Tab Content: System -->
    <div id="tabSystem" class="settings-tab" style="display:none">
        <h4 style="margin-bottom:15px; color:var(--text-light)">üé® ‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
        <div style="display:flex; gap:10px; margin-bottom:20px">
            <button onclick="setTheme('dark')" style="background:#0f172a; border:2px solid #334155">Dark Mode</button>
            <button onclick="setTheme('light')" style="background:#f1f5f9; color:#333; border:2px solid #cbd5e1">Light Mode</button>
        </div>

        <h4 style="margin-bottom:15px; color:var(--text-light)">üî¢ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
        <div class="form-group">
            <label>‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
            <input id="memoCounterInput" type="number" placeholder="1001">
        </div>
        <button onclick="saveMemoCounter()" style="background:#6366f1">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Tab Content: Data -->
    <div id="tabData" class="settings-tab" style="display:none">
        <h4 style="color:#ef4444; margin-bottom:10px">‚ö†Ô∏è Danger Zone</h4>
        <p style="font-size:13px; color:#666; margin-bottom:20px">‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>

        <div style="border:1px solid #fecaca; background:#fef2f2; padding:15px; border-radius:8px; margin-bottom:20px">
            <h5 style="margin:0 0 10px 0; color:#b91c1c">Option 1: Clear Sales History Only</h5>
            <p style="font-size:12px; color:#7f1d1d; margin-bottom:10px">‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≤‡¶∏, ‡¶ñ‡¶∞‡¶ö, ‡¶≤‡¶ó ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡•§ <br><strong>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü, ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§</strong></p>
            <button onclick="clearSalesHistory()" style="background:#f59e0b; width:100%; color:#fff">üßπ Clear Sales History Only</button>
        </div>

        <div style="border:1px solid #fecaca; background:#fef2f2; padding:15px; border-radius:8px;">
            <h5 style="margin:0 0 10px 0; color:#b91c1c">Option 2: Factory Reset (All Data)</h5>
            <p style="font-size:12px; color:#7f1d1d; margin-bottom:10px">‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü, ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡¶∏‡¶π ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡•§</p>
            <div class="form-group">
                <label>‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡¶§‡ßá 'DELETE' ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                <input id="deleteConfirmInput" placeholder="DELETE">
            </div>
            <button onclick="factoryReset()" style="background:#ef4444; width:100%">üî• ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- VIEW DETAILS MODAL -->
<div id="viewDetailsModal" class="modal">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--text-main);">üìã ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
        <button onclick="closeModal('viewDetailsModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
        <div class="detail-row"><span class="detail-label">‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</span> <span class="detail-val" id="vId" style="font-size:18px; font-weight:bold; color:#10b981"></span></div>
        <div class="detail-row"><span class="detail-label">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü:</span> <span class="detail-val" id="vDate"></span></div>
        <div class="detail-row"><span class="detail-label">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</span> <span class="detail-val" id="vUser" style="text-transform:capitalize"></span></div>
    </div>
    <div style="background:#eff6ff; padding:20px; border-radius:12px; margin-bottom:20px;">
        <div class="detail-row"><span class="detail-label">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</span> <span class="detail-val" id="vName"></span></div>
        <div class="detail-row"><span class="detail-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</span> <span class="detail-val" id="vPhone"></span></div>
    </div>
    <h4 style="margin:0 0 15px 0; color:var(--text-light);">üõí ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
    <div class="table-box" style="box-shadow:none; border:1px solid #e2e8f0; margin-bottom:20px;">
        <table class="en">
            <thead><tr><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th style="text-align:center">Qty</th><th style="text-align:right">‡¶Æ‡ßã‡¶ü</th></tr></thead>
            <tbody id="vItemsBody"></tbody>
        </table>
    </div>
    <div style="background:#fffbeb; padding:20px; border-radius:12px; border:1px solid #fcd34d">
        <div class="detail-row"><span class="detail-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (Total):</span> <span class="detail-val" style="font-weight:bold">‡ß≥ <span id="vTotal"></span></span></div>
        <div class="detail-row"><span class="detail-label">‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ (Paid):</span> <span class="detail-val" style="color:#10b981; font-weight:bold">‡ß≥ <span id="vPaid"></span></span></div>
        <div class="detail-row"><span class="detail-label">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</span> <span class="detail-val" style="color:#ef4444; font-weight:bold">‡ß≥ <span id="vDue"></span></span></div>
    </div>
    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('viewDetailsModal')" style="background:#94a3b8; width:auto;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- CUSTOMER ADD/EDIT MODAL -->
<div id="customerModal" class="modal">
    <h3 style="margin-top:0; color:var(--primary); border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">üë§ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>
    <input type="hidden" id="custKey">
    <div class="form-group">
        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="custName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input id="custPhone" class="en" maxlength="11" placeholder="017xxxxxxxx">
    </div>
    <div style="margin-top:25px; text-align:right">
        <button onclick="closeModal('customerModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveCustomer()" style="background:var(--primary); width:auto;">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- CUSTOMER HISTORY MODAL -->
<div id="customerHistoryModal" class="modal" style="width:750px">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#3b82f6;">üìú ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
        <button onclick="closeModal('customerHistoryModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <div style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:20px; font-weight:bold; color:var(--text-main)">
        ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: <span id="histName"></span> | ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: <span id="histPhone" class="en"></span>
    </div>
    <div class="table-box" style="max-height:450px; overflow-y:auto">
        <table class="en">
            <thead><tr><th>Memo</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶ú‡¶Æ‡¶æ</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th></tr></thead>
            <tbody id="histBody"></tbody>
        </table>
    </div>
</div>

<!-- MEMO MODAL (PRINT ONLY) -->
<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0; color:#10b981; font-weight: 800; font-size: 24px;" id="printShopName">‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:5px 0 0 0; color:#555; font-size: 13px;" id="printShopAddress">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
        <p style="font-weight:bold; border:1px solid #000; display:inline-block; padding:2px 8px; margin-top:5px; border-radius:4px" id="memoTypeHeader">MEMO / BILL</p>
    </div>
    <div class="memo-meta en" style="margin-top:20px; font-size: 13px;">
        <div style="text-align:left; float:left; width: 50%;">
            <p style="margin:2px"><strong>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç:</strong> <span id="mId" style="font-weight:bold; font-size:16px"></span></p>
            <p style="margin:2px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:2px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right; float:right; width: 50%;">
            <p style="margin:2px"><strong>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</strong> <span id="mNote"></span></p>
            <p style="margin:2px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
    <table style="width:100%; border-collapse:collapse; margin-top:15px; font-size: 13px;">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd; padding:6px; text-align:left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:center; width:60px">Qty</th>
                <th style="border:1px solid #ddd; padding:6px; text-align:right; width:80px">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    <div class="memo-total-area en" style="margin-top:15px; text-align:right; font-size: 14px;">
        <p style="margin:3px">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥<b id="mTotal"></b></p>
        <p style="margin:3px">‡¶®‡¶ó‡¶¶ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®: ‡ß≥<span id="mPaid"></span></p>
        <p style="margin:3px; font-size: 16px;">‡¶¨‡¶æ‡¶ï‡¶ø (Due): ‡ß≥<b id="mDueDisplay" style="color:red"></b></p>
    </div>
    <div class="signature-area" style="margin-top: 60px; display: flex; justify-content: space-between; font-size: 12px;">
        <div class="signature-box" style="text-align:center; width:120px">
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:30px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
        <div class="signature-box" style="text-align:center; width:120px">
            <p style="margin:0; font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:5px">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    <div style="text-align:center; margin-top:15px; font-size:11px; color:#666" id="memoFooterMsg">Thank you!</div>
    <div style="margin-top:30px; text-align:center; border-top:1px dashed #ccc; padding-top:15px" class="noPrint">
        <button onclick="window.print()" style="width:auto; padding:8px 20px; font-size: 14px;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal('memoModal')" style="background:#ef4444; width:auto; padding:8px 20px; font-size: 14px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- ENTRY EDIT MODAL -->
<div id="editEntryModal" class="modal">
    <h3 style="margin-top:0; color:#f59e0b; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">‚úèÔ∏è ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editEntryKey">
    <div class="form-group">
        <label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editEntryNote">
    </div>
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
        <input id="editEntryPhone" class="en" maxlength="11">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
        <div class="form-group">
            <label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ (Total):</label>
            <input id="editEntryTotal" type="number" class="en" oninput="calcEditDue()">
        </div>
        <div class="form-group">
            <label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (Paid):</label>
            <input id="editEntryTaken" type="number" class="en" oninput="calcEditDue()">
        </div>
    </div>
    <div class="form-group">
        <label>‡¶¨‡¶æ‡¶ï‡¶ø (Due):</label>
        <input id="editEntryDue" readonly class="en" style="background:#fef2f2; color:#ef4444; font-weight:bold">
    </div>
    <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f1f5f9; padding-top:20px;">
        <button onclick="deleteFromEdit()" style="background:#ef4444; width:auto;">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <div>
            <button onclick="closeModal('editEntryModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            <button onclick="saveEditEntry()" style="background:var(--primary); width:auto;">üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- PRODUCT EDIT MODAL -->
<div id="editProductModal" class="modal">
    <h3 style="margin-top:0; color:#3b82f6; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px;">üì¶ ‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editProdKey">
    <div class="form-group"><label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="editProdName"></div>
    <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><input id="editProdCat"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
        <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï (Qty):</label><input id="editProdQty" type="number" class="en"></div>
        <div class="form-group"><label>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤:</label><input id="editProdAlert" type="number" class="en"></div>
        <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</label><input id="editProdSell" type="number" class="en"></div>
    </div>
    <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f1f5f9; padding-top:20px;">
        <button onclick="deleteProductFromEdit()" style="background:#ef4444; width:auto;">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <div>
            <button onclick="closeModal('editProductModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            <button onclick="saveEditProduct()" style="background:var(--primary); width:auto;">üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- ADD STOCK MODAL (NEW) -->
<div id="addStockModal" class="modal" style="width:400px">
    <h3 style="margin-top:0; color:#10b981; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px;">üì¶ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="addStockKey">
    <div style="background:#f0fdf4; padding:15px; border-radius:10px; margin-bottom:20px;">
        <p><strong>‡¶™‡¶£‡ßç‡¶Ø:</strong> <span id="addStockName"></span></p>
        <p><strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï:</strong> <span id="addStockCurrent"></span></p>
    </div>
    <div class="form-group">
        <label>‡¶ï‡¶§ ‡¶™‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶® (Qty):</label>
        <input id="addStockQtyInput" type="number" class="en" placeholder="Example: 10, 50..." style="font-size:18px; font-weight:bold">
    </div>
    <div style="text-align:right; margin-top:20px">
        <button onclick="closeModal('addStockModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveAddedStock()" style="background:#10b981; width:auto;">üíæ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- QUICK ADD PRODUCT MODAL (NEW) -->
<div id="quickAddModal" class="modal" style="width:500px">
    <h3 style="margin-top:0; color:#3b82f6; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px;">‚ö° ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
        <div class="form-group">
            <label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó (Section):</label>
            <select id="qaSection">
                <option value="General" selected>General</option>
                <option value="Computer">Computer</option>
                <option value="Photocopy">Photocopy</option>
            </select>
        </div>
        <div class="form-group">
            <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
            <input id="qaCategory" placeholder="Pen, Paper...">
        </div>
    </div>
    <div class="form-group">
        <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="qaName" placeholder="Product Name">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px">
        <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:</label><input id="qaSell" type="number" class="en"></div>
        <div class="form-group"><label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ:</label><input id="qaCost" type="number" class="en"></div>
        <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï (Qty):</label><input id="qaQty" type="number" class="en"></div>
    </div>
    <div style="text-align:right; margin-top:20px">
        <button onclick="closeModal('quickAddModal')" style="background:#94a3b8; width:auto; margin-right:10px">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button onclick="saveQuickProduct()" style="background:#3b82f6; width:auto;">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- MANUAL SALES REPORT MODAL (NEW) -->
<div id="manualSalesModal" class="modal" style="width:800px">
    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:#ef4444;">‚ö†Ô∏è ‡¶Ü‡¶®‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° (‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤) ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
        <button onclick="closeModal('manualSalesModal')" style="background:none; color:#ef4444; font-size:28px; padding:0; width:auto; box-shadow:none;">√ó</button>
    </div>
    <p style="color:#64748b; margin-bottom:15px">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶®‡ßá‡¶á ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßá ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶®‡•§</p>
    <div class="table-box" style="max-height:400px; overflow-y:auto">
        <table class="en">
            <thead><tr><th>Date</th><th>Product Name</th><th>Category</th><th>Qty</th><th>Rate</th><th>Sold By</th></tr></thead>
            <tbody id="manualSalesBody"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- OFFLINE PERSISTENCE ---
try {
    db.setPersistenceEnabled(true);
} catch(e) { console.log("Persistence Error: ", e); }

// --- GOD MODE CONFIGURATION STATE ---
let sysConfig = {
    modules: { chat: true, manual: true, due: true, return: true, expense: true },
    perms: { priceEdit: true, delete: true, viewCost: false },
    rules: { phoneReq: false, negStock: false, dueLimit: 0, stockAlert: 5 },
    ui: { memoLabel: "MEMO / BILL", currency: "‡ß≥", footer: "Thank you!" },
    logic: { vatEnable: false }
};
let translations = {};
let lastPopupTime = 0;

// --- ADMIN CONTROL LISTENERS (GOD MODE) ---
function loadGodModeListeners() {
    // 1. Master Config Listener
    db.ref("settings/masterConfig").on("value", snap => {
    const val = snap.val();
    if(val) {
        sysConfig = val;
        updateModuleVisibility();
        updateUIFromConfig();
        const rateInput = document.getElementById('rate');
        if(rateInput) rateInput.readOnly = !sysConfig.perms.priceEdit;
    }
});

    // 2. App Lock Listener
    db.ref("settings/appLock").on("value", snap => {
        if(snap.val() === true) {
            db.ref("settings/maintMsg").once("value", msgSnap => {
                const msg = msgSnap.val() || "‡¶Æ‡ßá‡¶á‡¶®‡¶ü‡ßá‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶ö‡¶≤‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                document.body.innerHTML = `
                <div style="height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column; background:#0f172a; color:#ef4444; text-align:center; font-family:'Hind Siliguri', sans-serif">
                    <div style="font-size:60px; margin-bottom:20px">‚ö†Ô∏è</div>
                    <h1 style="margin:0; font-size:36px">SYSTEM LOCKED BY ADMIN</h1>
                    <p style="color:#94a3b8">${msg}</p>
                </div>`;
            });
        } else {
            if(document.body.innerText.includes("SYSTEM LOCKED")) location.reload();
        }
    });

    // 3. Admin Notice Listener
    db.ref("settings/notice").on("value", snap => {
        const msg = snap.val();
        const ticker = document.getElementById("adminTicker");
        if(msg && msg.length > 0) {
            ticker.innerText = "üì¢ ADMIN NOTICE: " + msg;
            ticker.style.display = "block";
        } else {
            ticker.style.display = "none";
        }
    });

    // 4. UI Theme Listener
    db.ref("settings/ui").on("value", snap => {
        const ui = snap.val();
        if(ui) {
            const root = document.documentElement;
            if(ui.primary) root.style.setProperty('--primary', ui.primary);
            if(ui.bg1 && ui.bg2) root.style.setProperty('--bg-gradient', `linear-gradient(135deg, ${ui.bg1} 0%, ${ui.bg2} 100%)`);
            if(ui.font) root.style.setProperty('--font-main', ui.font);
            if(ui.loginMsg) {
                const sub = document.querySelector('.login-subtitle');
                if(sub) sub.innerText = ui.loginMsg;
            }
        }
    });

    // 5. Custom CSS Listener
    db.ref("settings/css").on("value", snap => {
        document.getElementById("adminDynamicStyle").innerHTML = snap.val() || "";
    });

    // 6. Force Popup Listener
    db.ref("settings/popup").on("value", snap => {
    const popup = snap.val();
    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá popup.active === true ‡¶ö‡ßá‡¶ï‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    if(popup && popup.active === true && popup.msg && popup.time > lastPopupTime) {
        alert("üì¢ ADMIN ALERT:\n\n" + popup.msg);
        lastPopupTime = popup.time;
    }
});

    // 7. Dynamic Menu Listener
    db.ref("settings/menu").on("value", snap => {
        renderDynamicMenu(snap.val());
    });

    // 8. Language/Translation Listener
    db.ref("settings/translations").on("value", snap => {
        translations = snap.val() || {};
        applyTranslations();
    });
}

function updateModuleVisibility() {
    document.getElementById("chatBtn").style.display = sysConfig.modules.chat ? "flex" : "none";
    document.getElementById("manualModeContainer").style.display = sysConfig.modules.manual ? "flex" : "none";
    document.getElementById("nav-return").style.display = sysConfig.modules.return ? "block" : "none";
    document.getElementById("nav-expenseManager").style.display = sysConfig.modules.expense ? "block" : "none";
    // Due/Credit module control
    const dueButtons = [document.querySelector('[onclick="openDueCollectionModal()"]')];
    dueButtons.forEach(btn => { if(btn) btn.style.display = sysConfig.modules.due ? 'block' : 'none'; });
}

function updateUIFromConfig() {
    const memoLabel = document.getElementById("memoTypeHeader");
    if(memoLabel) memoLabel.innerText = sysConfig.ui.memoLabel || "MEMO / BILL";

    const footer = document.getElementById("memoFooterMsg");
    if(footer) footer.innerText = sysConfig.ui.footer || "Thank you!";
}

// --- DYNAMIC MENU & TRANSLATION ---
function renderDynamicMenu(menuData) {
    const container = document.getElementById("dynamicMenuContainer");
    // Preserve essential menu items and clear the rest
    container.innerHTML = `
        <a id="nav-dashboard" onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (F1)</a>
        <a id="nav-newEntry" onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø (F2)</a>
        <a id="nav-cashDeposit" onclick="openMyCashModal()" style="color: #10b981; font-weight: bold; border-left: 4px solid #10b981;">üí∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ (Alt+C)</a>
        <a id="nav-return" onclick="openReturnModal()" style="color:#ef4444;">üîÑ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® / ‡¶´‡ßá‡¶∞‡¶§</a>
        <a id="nav-customerManager" onclick="showSection('customerManager')">üë• ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
        <a id="nav-inventory" onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</a>
        <a id="nav-stockAdjustment" onclick="showSection('stockAdjustment')" style="color:#f59e0b; font-weight:bold;">üõ†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
        <a id="nav-expenseManager" onclick="showSection('expenseManager')">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
        <a id="nav-assets" onclick="showSection('assetManager')" style="color:#8b5cf6; font-weight:bold;">üè¢ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶æ‡¶Æ‡¶æ‡¶≤ (Assets)</a>
        <a id="nav-analytics" onclick="showSection('analytics')">üìà ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</a>
        <a id="nav-reports" onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
    `;
    if (menuData) {
        Object.values(menuData).forEach(item => {
            container.innerHTML += `<a onclick="alert('Action: ${item.action}')"><i class="${item.icon}"></i> ${item.label}</a>`;
        });
    }
    updateModuleVisibility();
}

function _t(key, fallback) {
    return translations[key] || fallback || key;
}

function applyTranslations() {
    document.querySelector('[onclick="showSection(\'dashboard\')"]').innerHTML = `üè† ${_t('menu_dashboard', '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°')} (F1)`;
    document.querySelector('[onclick="showSection(\'newEntry\')"]').innerHTML = `üìù ${_t('menu_new_entry', '‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø')} (F2)`;
    document.querySelector('.login-title').innerHTML = `${_t('login_title_main', '‡¶∂‡ßá‡¶ñ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞')} <span>${_t('login_title_pro', 'PRO')}</span>`;
}


// --- KEYBOARD SHORTCUTS ---
window.addEventListener('keydown', function(e) {
    if (e.key === 'F1') { e.preventDefault(); showSection('dashboard'); }
    if (e.key === 'F2') { e.preventDefault(); showSection('newEntry'); }
    if (e.key === 'F4') {
        e.preventDefault();
        showSection('newEntry');
        setTimeout(() => document.getElementById('searchSerial').focus(), 100);
    }
    if (e.altKey && e.key.toLowerCase() === 'c') { e.preventDefault(); openMyCashModal(); }
    if (e.key === 'Escape') {
        closeSidebar();
        closeProfile();
        closeAllModals();
    }
});

function closeAllModals() {
    const modals = ['shortageModal', 'quickStockModal', 'userProfileModal', 'appSettingsModal', 'dueCollectionModal', 'returnModal', 'holdOrderModal', 'logModal', 'viewDetailsModal', 'customerModal', 'customerHistoryModal', 'memoModal', 'editEntryModal', 'editProductModal', 'myCashModal', 'addStockModal', 'quickAddModal', 'manualSalesModal'];
    modals.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    document.getElementById('overlay').style.display = 'none';
}

// --- HELPER: SAFE TEXT SETTER ---
function setText(id, val) {
    const el = document.getElementById(id);
    if (el) el.innerText = val;
}

function setHTML(id, val) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = val;
}

// --- SOUND EFFECTS ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        osc.start(now);
        osc.stop(now + 0.5);
    } else if (type === 'error') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(100, now + 0.3);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    } else if (type === 'warning') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(300, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
        osc.start(now);
        osc.stop(now + 0.2);
    }
}

// --- STATE VARIABLES ---
let currentUser = "";
let allProducts = [];
let allEntries = [];
let allCustomers = [];
let allExpenses = [];
let cart = [];
let heldOrders = [];
let salesChart = null;
let isShortageView = false;
let customerStats = [];
let selectedReturnEntry = null;
let appSections = ["General", "Computer", "Photocopy"];
let appExpCats = ["Shop Rent", "Electricity", "Transport", "Food", "Other"];
let isManualMode = false;

// --- LOADING OPTIMIZATION VARIABLES ---
let fullHistoryListener = null;
let recentHistoryListener = null;
let isFullHistoryLoaded = false;

// --- PAGINATION VARIABLES ---
let currentReportPage = 1;
const rowsPerPage = 50;

// --- INITIALIZATION ---
window.onload = function() {
    loadGodModeListeners();

    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);

    const d = new Date();
    document.getElementById("anMonth").value = d.getMonth() + 1;
    document.getElementById("anYear").value = d.getFullYear();

    const rFrom = document.getElementById("rFromDate");
    const rTo = document.getElementById("rToDate");
    if(rFrom && rTo) {
        const today = new Date();
        rFrom.valueAsDate = today;
        rTo.valueAsDate = today;
    }

    const savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);
    loadShopSettings();
    loadDynamicSettings();
    checkFirstTimeSetup();

    const savedHeld = localStorage.getItem("heldOrders");
    if(savedHeld) {
        heldOrders = JSON.parse(savedHeld);
        updateHoldCount();
    }

    updateOnlineStatus();
};

// --- ONLINE STATUS CHECKER ---
function updateOnlineStatus() {
    const statusEl = document.getElementById('connectionStatus');
    if(navigator.onLine) {
        statusEl.innerHTML = '‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®';
        statusEl.className = 'footer-val status-online';
    } else {
        statusEl.innerHTML = '‚óè ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® (Offline Mode)';
        statusEl.className = 'footer-val status-offline';
        showToast("‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®! ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ‡•§ üî¥", "warning");
    }
}
window.addEventListener('online', () => { updateOnlineStatus(); showToast("‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶õ‡ßá üü¢", "success"); });
window.addEventListener('offline', updateOnlineStatus);

// --- TOAST NOTIFICATION SYSTEM ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    let icon = '‚úÖ';
    if(type === 'error') icon = '‚ùå';
    if(type === 'warning') icon = '‚ö†Ô∏è';

    toast.innerHTML = `<span>${icon} ${message}</span>`;
    container.appendChild(toast);

    playSound(type);

    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => { toast.remove(); }, 300);
    }, 3000);
}

// --- AUTHENTICATION ---
function checkFirstTimeSetup() {
    db.ref("users").once("value", snap => {
        if(!snap.exists()) {
            db.ref("users").set({
                admin: { pass: "123", role: "admin" },
                owner: { pass: "456", role: "owner" },
                roky: { pass: "789", role: "staff" }
            });
        }
    });
}

function login(){
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();

    if(!u || !p) return showToast("‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®", "error");

    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    const loginStart = sysConfig.auto?.loginStart || "00:00";
    const loginEnd = sysConfig.auto?.loginEnd || "23:59";

    if (currentTime < loginStart || currentTime > loginEnd) {
        return showToast("‡¶è‡¶á ‡¶∏‡¶Æ‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    }

    db.ref("users/" + u).once("value", snap => {
        if(snap.exists()) {
            const userData = snap.val();
            if(userData.blocked) {
                showToast("üö´ ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßá‡¶õ‡ßá!", "error");
                return;
            }
            if(userData.pass === p) {
                localStorage.setItem("loggedInUser", u);
                showToast(`‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ${u.toUpperCase()}!`, "success");
                setTimeout(() => setupUser(u), 1000);
            } else {
                showToast("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", "error");
            }
        } else {
            showToast("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
        }
    });
}

function setupUser(u) {
    currentUser = u;

    db.ref("users/" + u + "/blocked").on("value", snap => {
        if(snap.val() === true) {
            alert("üö´ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßá‡¶õ‡ßá!");
            logout();
        }
    });

    db.ref("users/" + u + "/forceLogout").on("value", snap => {
        if(snap.val() === true) {
            db.ref("users/" + u + "/forceLogout").set(false);
            alert("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            logout();
        }
    });

    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "flex";
    document.getElementById("menuBtn").style.display = "flex";
    document.getElementById("profileBtn").style.display = "flex";

    db.ref("users/" + u + "/role").once("value", snap => {
        const role = snap.val() || "staff";
        const roleName = role === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : (role === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßá‡¶®‡¶æ‡¶™‡¶§‡¶ø');
        setHTML("userShow", `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <b style="text-transform:uppercase; color:#fff">${u}</b> (${roleName})`);
        setText("modalProfileRole", roleName);

        if(u === 'admin') {
            document.getElementById("logBtn").style.display = "block";
        } else {
            document.getElementById("logBtn").style.display = "none";
        }
    });

    setText("pName", u.toUpperCase());
    setText("modalProfileName", u.toUpperCase());
    setText("modalProfileInit", u.charAt(0).toUpperCase());

    loadAllProducts();
    loadEntries();
    loadAllCustomers();
    loadExpenses();
    loadStockAdjustments();
    loadAssets(); // ADDED: Load Assets
    setupChat();
    showSection('dashboard');
    setupLiveSearch();
}

function logout() {
    localStorage.removeItem("loggedInUser");
    location.reload();
}

// --- PROFILE & SETTINGS LOGIC ---
function toggleProfile() {
    const menu = document.getElementById("profileMenu");
    const overlay = document.getElementById("overlay");
    if(menu.style.display === "block") {
        menu.style.display = "none";
        overlay.style.display = "none";
    } else {
        menu.style.display = "block";
        overlay.style.display = "block";
    }
}
function closeProfile() {
    document.getElementById("profileMenu").style.display = "none";
}

function openProfileModal() {
    closeProfile();
    const today = new Date().toLocaleDateString("en-GB");
    let count = 0;
    let total = 0;
    allEntries.forEach(e => {
        if(e.user === currentUser && e.date === today) {
            count++;
            total += parseFloat(e.total) || 0;
        }
    });
    setText("upCount", count);
    setText("upTotal", total.toLocaleString());
    document.getElementById("userProfileModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// --- CASH DEPOSIT LOGIC ---
function openMyCashModal() {
    const today = new Date().toLocaleDateString("en-GB");
    let myTaken = 0;
    let myExpense = 0;

    allEntries.forEach(e => {
        if(e.user === currentUser && e.date === today) {
            myTaken += parseFloat(e.taken) || 0;
        }
    });

    allExpenses.forEach(exp => {
        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá !exp.isNonCash ‡¶Æ‡¶æ‡¶®‡ßá ‡¶π‡¶≤‡ßã: ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶ü‡¶æ '‡¶®‡¶®-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂' ‡¶®‡¶æ ‡¶π‡ßü, ‡¶§‡¶¨‡ßá‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶æ‡¶ì
        if(exp.user === currentUser && exp.date === today && !exp.isNonCash) {
            myExpense += parseFloat(exp.amount) || 0;
        }
    });

    const netCash = myTaken - myExpense;

    setText("myTotalTaken", myTaken.toLocaleString());
    setText("myTotalExpense", myExpense.toLocaleString());
    setText("myNetCash", netCash.toLocaleString());

    document.getElementById("depositAmount").value = netCash > 0 ? netCash : 0;

    document.getElementById("myCashModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveCashDeposit() {
    const amount = parseFloat(document.getElementById("depositAmount").value);
    const target = document.getElementById("depositTarget").value;
    const today = new Date().toLocaleDateString("en-GB");

    if(!amount || amount <= 0) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®", "error");

    const depositData = {
        user: currentUser,
        amount: amount,
        target: target,
        date: today,
        time: new Date().toLocaleTimeString(),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    db.ref("cash_deposits").push(depositData).then(() => {
        showToast("‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        logActivity("Cash Deposit", `${currentUser} deposited ‡ß≥${amount} to ${target}`);
        closeAllModals();

        db.ref("messages").push({
            sender: "SYSTEM",
            target: "all",
            text: `üì¢ ${currentUser.toUpperCase()} ‡¶Ü‡¶ú ‡ß≥${amount} ‡¶ü‡¶æ‡¶ï‡¶æ ${target}-‡¶è ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®‡•§`,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            fullDate: today
        });
    });
}

// --- ACTIVITY LOG ---
function logActivity(action, details) {
    const log = {
        time: new Date().toLocaleString(),
        user: currentUser,
        action: action,
        details: details
    };
    db.ref("logs").push(log);
}

function openLogModal() {
    closeProfile();
    if(currentUser !== 'admin') {
        showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶è‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá!", "error");
        return;
    }
    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
    db.ref("logs").limitToLast(50).once("value", s => {
        tbody.innerHTML = "";
        const logs = [];
        s.forEach(c => logs.push(c.val()));
        logs.reverse().forEach(l => {
            tbody.innerHTML += `<tr><td><small>${l.time}</small></td><td>${l.user}</td><td style="color:var(--primary); font-weight:bold">${l.action}</td><td>${l.details}</td></tr>`;
        });
    });
    document.getElementById("logModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// --- CHAT SYSTEM ---
let editingMsgKey = null;
let isChatInit = false;

function setupChat() {
    db.ref("messages").limitToLast(50).on("value", s => {
        const div = document.getElementById("msgList");
        div.innerHTML = "";

        let lastDate = "";
        let unread = false;
        let lastMsgSender = "";

        s.forEach(c => {
            const m = c.val();
            const key = c.key;

            if(m.target === 'all' || m.sender === currentUser || m.target === currentUser) {
                const hiddenKey = "hidden_msg_" + key;
                if(localStorage.getItem(hiddenKey)) return;

                const isMe = m.sender === currentUser;
                const isAdmin = (currentUser === 'admin');
                const canEdit = isMe || isAdmin;

                const msgDate = m.fullDate || "Today";
                if(msgDate !== lastDate) {
                    let displayDate = msgDate;
                    const today = new Date().toLocaleDateString("en-GB");
                    const y = new Date(); y.setDate(y.getDate() - 1);
                    const yesterday = y.toLocaleDateString("en-GB");

                    if(msgDate === today) displayDate = "Today";
                    else if(msgDate === yesterday) displayDate = "Yesterday";

                    div.innerHTML += `<div class="chat-date">${displayDate}</div>`;
                    lastDate = msgDate;
                }

                div.innerHTML += `
                <div class="msg-row ${isMe ? 'me' : 'other'}" onmouseleave="hideMsgMenu('${key}')">
                    ${canEdit ? `
                        <div class="msg-opt-btn" onclick="toggleMsgMenu('${key}')">‚ãÆ</div>
                        <div id="menu_${key}" class="msg-menu-modern">
                            <div class="msg-menu-item" onclick="editMsg('${key}', '${m.text}')">‚úèÔ∏è Edit</div>
                            <div class="msg-menu-item del" onclick="deleteMsg('${key}')">üóëÔ∏è Delete</div>
                        </div>
                    ` : ''}
                    <div class="msg ${isMe ? 'me' : 'other'}">
                        ${!isMe ? `<span class="sender-name">${m.sender.toUpperCase()}</span>` : ''}
                        ${m.text}
                        <span class="msg-meta">${m.time} ${m.edited ? '(edited)' : ''}</span>
                    </div>
                </div>`;

                if(!isMe) {
                    unread = true;
                    lastMsgSender = m.sender;
                }
            }
        });

        div.scrollTop = div.scrollHeight;

        if(isChatInit && unread) {
            const audio = document.getElementById("chatSound");
            if(audio) audio.play().catch(e => console.log("Audio play failed", e));

            const box = document.getElementById("chatBox");
            if(box.style.display === "none" || box.style.display === "") {
                box.style.display = "flex";
                document.getElementById("chatBadge").style.display = "none";
            }
        } else if (unread && document.getElementById("chatBox").style.display === "none") {
            document.getElementById("chatBadge").style.display = "block";
        }

        if(!isChatInit) {
            if(lastMsgSender && lastMsgSender !== currentUser) {
                document.getElementById("chatBox").style.display = "flex";
                document.getElementById("chatBadge").style.display = "none";
            }
            isChatInit = true;
        }
    });
    updateChatTargets();
}

function sendMsg() {
    const txtInput = document.getElementById("msgInput");
    const txt = txtInput.value.trim();
    const target = document.getElementById("msgTarget").value;

    if(!txt) return;

    if(editingMsgKey) {
        db.ref("messages/" + editingMsgKey).once('value', snap => {
            const originalMsg = snap.val();
            if(originalMsg) {
                let isEditedFlag = true;
                if(currentUser === 'admin' && originalMsg.sender !== 'admin') {
                    isEditedFlag = false;
                }
                let updateData = { text: txt };
                if(isEditedFlag) updateData.edited = true;

                db.ref("messages/" + editingMsgKey).update(updateData).then(() => {
                    editingMsgKey = null;
                    txtInput.value = "";
                    txtInput.placeholder = "Type message...";
                    document.getElementById("sendBtnIcon").innerText = "‚û§";
                });
            }
        });
    } else {
        const now = new Date();
        db.ref("messages").push({
            sender: currentUser,
            target: target,
            text: txt,
            time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            fullDate: now.toLocaleDateString("en-GB")
        });
        txtInput.value = "";
    }
}

function updateChatTargets() {
    const sel = document.getElementById('msgTarget');
    let html = '<option value="all">All (‡¶∏‡¶¨‡¶æ‡¶á)</option>';
    db.ref("users").once("value", snap => {
        snap.forEach(c => {
            const uName = c.key;
            if(uName !== currentUser) {
                html += `<option value="${uName}">${uName.toUpperCase()}</option>`;
            }
        });
        sel.innerHTML = html;
    });
}

function toggleChat() {
    const box = document.getElementById("chatBox");
    if(box.style.display === "flex") {
        box.style.display = "none";
    } else {
        box.style.display = "flex";
        document.getElementById("chatBadge").style.display = "none";
    }
}

function toggleMsgMenu(key) {
    const menu = document.getElementById("menu_" + key);
    document.querySelectorAll('.msg-menu-modern').forEach(m => {
        if(m.id !== "menu_" + key) m.style.display = 'none';
    });
    if(menu.style.display === "block") {
        menu.style.display = "none";
    } else {
        menu.style.display = "block";
    }
}

function hideMsgMenu(key) {
    const menu = document.getElementById("menu_" + key);
    if(menu) menu.style.display = 'none';
}

function deleteMsg(key) {
    if(confirm("‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        db.ref("messages/" + key).remove();
    }
}

function editMsg(key, oldText) {
    const input = document.getElementById("msgInput");
    input.value = oldText;
    input.focus();
    editingMsgKey = key;
    input.placeholder = "Editing message...";
    document.getElementById("sendBtnIcon").innerText = "‚úì";
}

// --- ADVANCED SETTINGS LOGIC ---
function openSettingsModal() {
    closeProfile();
    document.getElementById("appSettingsModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    switchTab('tabGeneral');

    db.ref("settings/shopInfo").once("value", snap => {
        const info = snap.val() || {};
        document.getElementById("shopNameInput").value = info.name || "Sheikh Computer & Stationery";
        document.getElementById("shopAddressInput").value = info.address || "Kashiani, Gopalganj";
    });

    db.ref("settings/memoCounter").once("value", snap => {
        document.getElementById("memoCounterInput").value = snap.val() || 1000;
    });

    renderSettingsLists();
    loadUserManagement();
}

function switchTab(tabId) {
    document.querySelectorAll('.settings-tab').forEach(t => t.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
}

function changeOwnPassword() {
    const newPass = document.getElementById("newPassInput").value.trim();
    if(!newPass) return showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®", "error");

    db.ref("users/" + currentUser).update({ pass: newPass }).then(() => {
        showToast("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        document.getElementById("newPassInput").value = "";
    });
}

function loadUserManagement() {
    if(currentUser !== 'admin') {
        document.getElementById("adminUserPanel").style.display = "none";
        return;
    }
    document.getElementById("adminUserPanel").style.display = "block";
    const tbody = document.getElementById("userListBody");

    db.ref("users").on("value", snap => {
        tbody.innerHTML = "";
        snap.forEach(child => {
            const u = child.key;
            const data = child.val();
            const passDisplay = (u === 'admin') ? '******' : data.pass;
            tbody.innerHTML += `
            <tr>
                <td style="text-transform:uppercase; font-weight:bold">${u}</td>
                <td>${data.role}</td>
                <td style="font-family:monospace; color:#ef4444">${passDisplay}</td>
                <td>
                    ${u !== 'admin' ? `<button onclick="resetUserPass('${u}')" style="padding:5px 10px; font-size:12px; background:#f59e0b">Reset</button>` : ''}
                </td>
            </tr>`;
        });
    });
}

function resetUserPass(user) {
    const newPass = prompt(`Enter new password for ${user}:`);
    if(newPass) {
        db.ref("users/" + user).update({ pass: newPass }).then(() => {
            showToast(`${user}-‡¶è‡¶∞ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        });
    }
}

function saveShopInfo() {
    const name = document.getElementById("shopNameInput").value;
    const addr = document.getElementById("shopAddressInput").value;
    db.ref("settings/shopInfo").set({ name: name, address: addr }).then(() => {
        showToast("‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        loadShopSettings();
    });
}

function saveMemoCounter() {
    const val = parseInt(document.getElementById("memoCounterInput").value);
    if(val) {
        db.ref("settings/memoCounter").set(val).then(() => showToast("‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success"));
    }
}

function loadShopSettings() {
    db.ref("settings/shopInfo").on("value", snap => {
        const info = snap.val() || {};
        const name = info.name || "Sheikh Computer & Stationery";
        const addr = info.address || "Kashiani, Gopalganj";
        setText("printShopName", name);
        setText("printShopAddress", addr);
        localStorage.setItem("shopName", name);
        localStorage.setItem("shopAddress", addr);
    });
}

function loadDynamicSettings() {
    db.ref("settings/sections").on("value", snap => {
        if(snap.exists()) appSections = snap.val();
        updateSectionDropdowns();
    });

    db.ref("settings/expenseCats").on("value", snap => {
        if(snap.exists()) appExpCats = snap.val();
        updateExpCatDropdown();
    });
}

function updateSectionDropdowns() {
    const sel = document.getElementById("sectionSelect");
    const stSel = document.getElementById("stMainType");
    const qaSel = document.getElementById("qaSection");
    const manSel = document.getElementById("manualSection");

    let html = '<option value="" disabled selected>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>';
    let count = 0;
    appSections.forEach(s => {
        html += `<option value="${s}">${s}</option>`;
        count++;
    });
    if(count === 0) html = '<option value="" disabled>‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</option>';

    sel.innerHTML = html;
    stSel.innerHTML = html;

    let simpleHtml = "";
    appSections.forEach(s => simpleHtml += `<option value="${s}">${s}</option>`);
    qaSel.innerHTML = simpleHtml;
    manSel.innerHTML = simpleHtml;

    const container = document.getElementById("sectionSummaryContainer");
    container.innerHTML = "";
    appSections.forEach(s => {
        container.innerHTML += `
        <div style="background:#f1f5f9; padding:15px; border-radius:10px; border:1px solid #e2e8f0; text-align:center">
            <span style="display:block; color:#475569; font-weight:bold; font-size:14px">${s}</span>
            <b style="font-size:20px; color:#334155; display:block; margin-top:5px" class="en" id="secSum_${s.replace(/\s/g, '')}">‡ß≥ 0</b>
        </div>`;
    });
    updateSectionSummary();
}

function updateExpCatDropdown() {
    const sel = document.getElementById("expCat");
    let html = "";
    appExpCats.forEach(c => {
        html += `<option value="${c}">${c}</option>`;
    });
    sel.innerHTML = html;
}

function renderSettingsLists() {
    const secList = document.getElementById("sectionList");
    secList.innerHTML = "";
    appSections.forEach((s, i) => {
        secList.innerHTML += `<span style="background:#e0f2fe; padding:5px 10px; border-radius:15px; font-size:12px">${s} <b style="color:red; cursor:pointer; margin-left:5px" onclick="removeSection(${i})">x</b></span>`;
    });

    const expList = document.getElementById("expCatList");
    expList.innerHTML = "";
    appExpCats.forEach((c, i) => {
        expList.innerHTML += `<span style="background:#fef3c7; padding:5px 10px; border-radius:15px; font-size:12px">${c} <b style="color:red; cursor:pointer; margin-left:5px" onclick="removeExpCat(${i})">x</b></span>`;
    });
}

function addSection() {
    const val = document.getElementById("newSectionInput").value.trim();
    if(val && !appSections.includes(val)) {
        appSections.push(val);
        db.ref("settings/sections").set(appSections);
        document.getElementById("newSectionInput").value = "";
        renderSettingsLists();
    }
}

function removeSection(index) {
    if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
        appSections.splice(index, 1);
        db.ref("settings/sections").set(appSections);
        renderSettingsLists();
    }
}

function addExpCat() {
    const val = document.getElementById("newExpCatInput").value.trim();
    if(val && !appExpCats.includes(val)) {
        appExpCats.push(val);
        db.ref("settings/expenseCats").set(appExpCats);
        document.getElementById("newExpCatInput").value = "";
        renderSettingsLists();
    }
}

function removeExpCat(index) {
    if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
        appExpCats.splice(index, 1);
        db.ref("settings/expenseCats").set(appExpCats);
        renderSettingsLists();
    }
}

function factoryReset() {
    const confirmText = document.getElementById("deleteConfirmInput").value;
    if(confirmText === "DELETE") {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!")) {
            db.ref("products").remove();
            db.ref("entries").remove();
            db.ref("customers").remove();
            db.ref("expenses").remove();
            db.ref("logs").remove();
            db.ref("cash_deposits").remove();
            db.ref("stock_adjustments").remove();
            showToast("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "warning");
            setTimeout(() => location.reload(), 2000);
        }
    } else {
        showToast("DELETE ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
    }
}

function clearSalesHistory() {
    if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø, ‡¶ñ‡¶∞‡¶ö, ‡¶≤‡¶ó ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡¶Æ‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡•§ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
        db.ref("entries").remove();
        db.ref("expenses").remove();
        db.ref("logs").remove();
        db.ref("cash_deposits").remove();
        db.ref("stock_adjustments").remove();
        showToast("‡¶∏‡ßá‡¶≤‡¶∏ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        setTimeout(() => location.reload(), 2000);
    }
}

function setTheme(themeName) {
    const body = document.body;
    if(themeName === 'light') {
        body.classList.add('light-theme');
    } else {
        body.classList.remove('light-theme');
    }
    localStorage.setItem("theme", themeName);
}

// --- CATEGORY & DROPDOWN ---
function updateCategories() {
    const section = document.getElementById("sectionSelect").value;
    const catSelect = document.getElementById("categorySelect");
    const prodSelect = document.getElementById("productSelect");

    catSelect.innerHTML = '<option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
    prodSelect.innerHTML = '<option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>';

    if(!section) return;

    const filtered = allProducts.filter(p => p.mainType === section);
    const uniqueCategories = [...new Set(filtered.map(p => p.category))].filter(Boolean).sort();

    let html = '<option value="" disabled selected>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>';
    let count = 0;
    uniqueCategories.forEach(c => {
        html += `<option value="${c}">${c}</option>`;
        count++;
    });

    if(count === 0) html = '<option value="" disabled>‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</option>';
    catSelect.innerHTML = html;
}

function loadProductsByCategory() {
    const selectedCat = document.getElementById("categorySelect").value;
    const selectedSection = document.getElementById("sectionSelect").value;
    const prodSelect = document.getElementById("productSelect");

    prodSelect.innerHTML = '<option value="" disabled selected>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>';

    if (!selectedCat) {
        prodSelect.innerHTML = '<option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
        return;
    }

    const filteredProducts = allProducts.filter(p => p.category === selectedCat && p.mainType === selectedSection);

    let html = '<option value="" disabled selected>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>';
    let count = 0;
    filteredProducts.forEach(p => {
        html += `<option value="${p.key}">${p.name} (‡¶∏‡ßç‡¶ü‡¶ï: ${p.isService ? 'Service' : p.qty})</option>`;
        count++;
    });

    if(count === 0) html = '<option value="" disabled>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</option>';
    prodSelect.innerHTML = html;
}

function productSelectedFromDropdown() {
    const prodKey = document.getElementById("productSelect").value;
    if (!prodKey) return;
    selectProductFromSearch(prodKey);
}

// --- LIVE SEARCH ---
function setupLiveSearch() {
    const searchInput = document.getElementById("searchSerial");
    const liveResults = document.getElementById("liveSearchResults");
    searchInput.addEventListener('input', function(e) {
        const query = this.value.trim();
        if(query.length === 0) {
            liveResults.style.display = 'none';
            return;
        }
        const productResults = allProducts.filter(p =>
            (p.serial && String(p.serial).toLowerCase().includes(query.toLowerCase())) ||
            (p.name && p.name.toLowerCase().includes(query.toLowerCase())) ||
            (p.category && p.category.toLowerCase().includes(query.toLowerCase()))
        );
        if(productResults.length > 0) {
            let html = '';
            productResults.forEach(p => {
                const alertLevel = p.alertLevel || 5;
                const isLowStock = !p.isService && p.qty <= alertLevel;
                const typeIcon = p.mainType === 'Computer' ? 'üíª' : (p.mainType === 'Photocopy' ? 'üìÑ' : 'üõçÔ∏è');

                let statusBadge = '';
                if(!p.isService) {
                    if(p.qty <= 0) statusBadge = '<span class="badge-out">‚ùå STOCK OUT</span>';
                    else if(p.qty <= (p.alertLevel||5)) statusBadge = '<span style="color:orange; font-weight:bold; font-size:11px">‚ö†Ô∏è Low Stock</span>';
                }

                html += `
                <div class="search-item" onclick="selectProductFromSearch('${p.key}')">
                    <div>
                        <div style="font-weight:bold; color:var(--text-main)">${typeIcon} ${p.name} ${statusBadge}</div>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <span class="serial" style="color:#64748b; font-size:12px">${p.serial || 'No Serial'}</span>
                            <span class="category" style="background:#f1f5f9; padding:2px 6px; border-radius:4px; font-size:12px">${p.category}</span>
                            ${!p.isService ? `<span class="stock" style="font-size:12px">‡¶∏‡ßç‡¶ü‡¶ï: ${p.qty}</span>` : '<span class="category" style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:12px">Service</span>'}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:bold; color:#10b981">‡ß≥${p.sellPrice}</div>
                    </div>
                </div>`;
            });
            liveResults.innerHTML = html;
            liveResults.style.display = 'block';
        } else {
            liveResults.innerHTML = '<div class="search-item" style="color:#666; justify-content:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</div>';
            liveResults.style.display = 'block';
        }
    });
    document.addEventListener('click', function(e) {
        if(!searchInput.contains(e.target) && !liveResults.contains(e.target)) {
            liveResults.style.display = 'none';
        }
    });
}

function selectProductFromSearch(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if(!product) return;

    if(isManualMode) {
        document.getElementById("manualModeToggle").checked = false;
        toggleManualMode();
    }

    const typeName = product.mainType === 'Computer' ? 'Computer Side' : (product.mainType === 'Photocopy' ? 'Photocopy Side' : 'General Sales');
    const msg = `‡¶™‡¶£‡ßç‡¶Ø: ${product.name}\n‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó: ${typeName}\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø: ${product.category}\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
    if(!confirm(msg)) return;
    document.getElementById('selectedProductKey').value = productKey;
    const sectionSelect = document.getElementById("sectionSelect");
    const catSelect = document.getElementById("categorySelect");
    const prodSelect = document.getElementById("productSelect");
    sectionSelect.value = product.mainType;
    updateCategories();
    catSelect.value = product.category;
    loadProductsByCategory();
    prodSelect.value = productKey;
    document.getElementById('rate').value = product.sellPrice;
    document.getElementById('qty').value = 1;
    document.getElementById('liveSearchResults').style.display = 'none';
    document.getElementById('searchSerial').value = '';
    document.getElementById('stockLiveMsg').innerText = "";
    setTimeout(() => {
        document.getElementById('qty').focus();
        document.getElementById('qty').select();
        checkStockLive();
    }, 100);
}

// --- PRODUCT & STOCK ---
function loadAllProducts(){
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        let maxSerial = 0;
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key;
            allProducts.push(p);
            const s = parseInt(p.serial);
            if(!isNaN(s) && s > maxSerial) maxSerial = s;
        });
        const serialInput = document.getElementById("stSerial");
        if(serialInput && serialInput.value === "") {
            serialInput.value = maxSerial + 1;
        }
        updateStockTable();
        updateStockValuationTable();
        checkGlobalStockStatus();
        updateQuickButtonDropdown();
        loadQuickButtons();
    });
}

function checkGlobalStockStatus() {
    const zeroStock = allProducts.filter(p => !p.isService && p.qty <= 0);
    const lowStock = allProducts.filter(p => !p.isService && p.qty > 0 && p.qty <= (p.alertLevel || 5));

    const alertBtn = document.getElementById("globalStockAlert");
    const alertText = document.getElementById("alertText");

    if (zeroStock.length > 0) {
        alertBtn.style.display = "flex";
        alertBtn.className = "critical";
        alertText.innerText = `‚ùå ${zeroStock.length} EMPTY | ‚ö†Ô∏è ${lowStock.length} LOW`;
    } else if (lowStock.length > 0) {
        alertBtn.style.display = "flex";
        alertBtn.className = "";
        alertText.innerText = `‚ö†Ô∏è ${lowStock.length} Low Stock`;
    } else {
        alertBtn.style.display = "none";
    }
}

function showShortageModal() {
    const shortages = allProducts.filter(p => !p.isService && p.qty <= (p.alertLevel || 5));
    const tbody = document.getElementById("shortageModalBody");
    tbody.innerHTML = "";
    shortages.forEach(p => {
        const isZero = p.qty <= 0;
        tbody.innerHTML += `
        <tr class="${isZero ? 'row-zero' : ''}">
            <td>${p.name} <br><small style="color:#666">${p.category}</small></td>
            <td style="color:${isZero ? '#b91c1c' : '#ef4444'}; font-weight:bold">${p.qty}</td>
            <td>${p.alertLevel || 5}</td>
        </tr>`;
    });
    document.getElementById("shortageModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function openQuickStockModal(key, name, currentQty) {
    document.getElementById("qsKey").value = key;
    document.getElementById("qsName").innerText = name;
    document.getElementById("qsCurrent").innerText = currentQty;
    document.getElementById("qsAddQty").value = "";
    document.getElementById("quickStockModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    document.getElementById("qsAddQty").focus();
}

function saveQuickStock() {
    const key = document.getElementById("qsKey").value;
    const addQty = parseFloat(document.getElementById("qsAddQty").value);
    if(!addQty || addQty <= 0) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");

    db.ref("products/" + key + "/qty").transaction((currentQty) => {
        return (currentQty || 0) + addQty;
    }).then(() => {
        showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§", "success");
        closeModal("quickStockModal");
        checkStockLive();
    });
}

function toggleStockInput(){
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    const alertInput = document.getElementById("stAlert");
    if(isService){
        qtyInput.value = ""; qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; qtyInput.disabled = true; qtyInput.style.background = "#f1f5f9";
        alertInput.disabled = true; alertInput.style.background = "#f1f5f9";
        costInput.disabled = true; costInput.style.background = "#f1f5f9"; costInput.value = "";
    } else {
        qtyInput.disabled = false; qtyInput.placeholder = "Qty"; qtyInput.style.background = "#fff";
        alertInput.disabled = false; alertInput.style.background = "#fff";
        costInput.disabled = false; costInput.placeholder = "Cost"; costInput.style.background = "#fff";
    }
}

function addNewProduct(){
    const serialInput = document.getElementById("stSerial").value.trim();
    const mainType = document.getElementById("stMainType").value;
    const cat = document.getElementById("stCategory").value.trim();
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    const alertLvl = parseFloat(document.getElementById("stAlert").value) || 5;
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    if(!cat || !name || !sell) return showToast("Category, Name ‡¶è‡¶¨‡¶Ç Sell Price ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "error");
    const targetSerial = parseInt(serialInput);
    const conflict = allProducts.find(p => parseInt(p.serial) === targetSerial);
    if(conflict) {
        if(confirm(`‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ${targetSerial} ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶ø‡ßü‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡ßß ‡¶ò‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            allProducts.forEach(p => {
                const pSerial = parseInt(p.serial);
                if(!isNaN(pSerial) && pSerial >= targetSerial) {
                    db.ref("products/" + p.key).update({ serial: pSerial + 1 });
                }
            });
        } else {
            return;
        }
    }
    const newProd = { serial: targetSerial, mainType, category: cat, name, qty, isService, costPrice: cost, sellPrice: sell, alertLevel: alertLvl };
    db.ref("products").push(newProd).then(()=>{
        showToast("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stAlert").value = "";
        document.getElementById("stSerial").value = targetSerial + 1;
        logActivity("Add Product", `Added ${name} (${mainType})`);
    });
}

function updateStockTable() {
    const stockBody = document.getElementById("stockBody");
    stockBody.innerHTML = "";

    const criteria = document.getElementById("stockSort").value;
    let sortedProducts = [...allProducts];

    if(criteria === 'serial') {
        sortedProducts.sort((a, b) => (parseInt(a.serial) || 999999) - (parseInt(b.serial) || 999999));
    } else if(criteria === 'category') {
        sortedProducts.sort((a, b) => a.category.localeCompare(b.category));
    } else if(criteria === 'name') {
        sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
    } else if(criteria === 'qty') {
        sortedProducts.sort((a, b) => (a.qty || 0) - (b.qty || 0));
    } else if(criteria === 'type') {
        sortedProducts.sort((a, b) => (a.mainType || "").localeCompare(b.mainType || ""));
    }

    sortedProducts.forEach(p => {
        const stockDisplay = p.isService ? `<span class="service-badge-deep">SERVICE</span>` : p.qty;
        const typeBadge = p.mainType === 'Computer' ? 'üíª Comp' : (p.mainType === 'Photocopy' ? 'üìÑ Photo' : 'üõçÔ∏è Gen');
        const alertDisplay = p.isService ? '-' : (p.alertLevel || 5);

        const addStockBtn = !p.isService ? `<button class="btn-action" style="background:#dcfce7; color:#166534" onclick="openAddStockModal('${p.key}')" title="‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®">‚ûï</button>` : '';

        stockBody.innerHTML += `<tr>
            <td><small>${typeBadge}</small></td>
            <td>${p.serial || '-'}</td>
            <td>${p.category}</td>
            <td>${p.name}</td>
            <td style="font-weight:bold; font-size:16px">${stockDisplay}</td>
            <td>${alertDisplay}</td>
            <td>${sysConfig.perms.viewCost ? (p.costPrice || 0) : '***'}</td>
            <td>${p.sellPrice}</td>
            <td>
                ${addStockBtn}
                <button class="btn-action btn-edit" onclick="openProductEdit('${p.key}')">‚úèÔ∏è</button>
            </td>
        </tr>`;
    });
}

function openProductEdit(key) {
    const p = allProducts.find(x => x.key === key);
    if(!p) return;
    document.getElementById("editProdKey").value = key;
    document.getElementById("editProdName").value = p.name;
    document.getElementById("editProdCat").value = p.category;
    document.getElementById("editProdQty").value = p.qty;
    document.getElementById("editProdSell").value = p.sellPrice;
    document.getElementById("editProdAlert").value = p.alertLevel || 5;
    if(p.isService) {
        document.getElementById("editProdQty").disabled = true;
        document.getElementById("editProdQty").value = "";
        document.getElementById("editProdAlert").disabled = true;
    } else {
        document.getElementById("editProdQty").disabled = false;
        document.getElementById("editProdAlert").disabled = false;
    }
    document.getElementById("editProductModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveEditProduct() {
    const key = document.getElementById("editProdKey").value;
    const name = document.getElementById("editProdName").value;
    const cat = document.getElementById("editProdCat").value;
    const sell = parseFloat(document.getElementById("editProdSell").value);
    const qty = parseFloat(document.getElementById("editProdQty").value) || 0;
    const alertLvl = parseFloat(document.getElementById("editProdAlert").value) || 5;
    db.ref("products/" + key).update({
        name: name,
        category: cat,
        sellPrice: sell,
        qty: qty,
        alertLevel: alertLvl
    }).then(() => {
        showToast("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        closeModal("editProductModal");
        logActivity("Edit Product", `Updated ${name}`);
    });
}

function deleteProductFromEdit() {
    if (!sysConfig.perms.delete) {
        return showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    }
    const key = document.getElementById("editProdKey").value;
    if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        const p = allProducts.find(x => x.key === key);
        db.ref("products/"+key).remove();
        closeModal("editProductModal");
        showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "warning");
        logActivity("Delete Product", `Deleted ${p ? p.name : 'Product'}`);
    }
}

// --- STOCK ADJUSTMENT LOGIC (NEW) ---
function searchAdjProduct(query) {
    const resultsDiv = document.getElementById("adjSearchResults");
    if(!query) { resultsDiv.style.display = "none"; return; }

    const matches = allProducts.filter(p =>
        !p.isService && (
            p.name.toLowerCase().includes(query.toLowerCase()) ||
            String(p.serial).includes(query)
        )
    );

    if(matches.length > 0) {
        let html = "";
        matches.forEach(p => {
            html += `<div class="search-item" onclick="selectAdjProduct('${p.key}', '${p.name}')">
                <span>${p.name} (Stock: ${p.qty})</span>
                <b>‡ß≥${p.sellPrice}</b>
            </div>`;
        });
        resultsDiv.innerHTML = html;
        resultsDiv.style.display = "block";
    } else {
        resultsDiv.style.display = "none";
    }
}

function selectAdjProduct(key, name) {
    document.getElementById("adjProductKey").value = key;
    document.getElementById("adjSearch").value = name;
    document.getElementById("adjSearchResults").style.display = "none";
    document.getElementById("adjQty").focus();
}

function saveStockAdjustment() {
    const key = document.getElementById("adjProductKey").value;
    const qty = parseFloat(document.getElementById("adjQty").value);
    const reason = document.getElementById("adjReason").value;

    if(!key || !qty || qty <= 0) return showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");

    const product = allProducts.find(p => p.key === key);
    if(!product) return;

    if(product.qty < qty) return showToast("‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á!", "error");

    const costPrice = parseFloat(product.costPrice) || 0;
    const totalCost = costPrice * qty;
    const today = new Date().toLocaleDateString("en-GB");

    // 1. Deduct Stock
    db.ref("products/" + key + "/qty").transaction(current => (current || 0) - qty).then(() => {

        // 2. Add to Expense (Auto)
        const expData = {
            date: today,
            desc: `Internal Out: ${product.name} (${reason})`,
            category: "Stock Adjustment",
            amount: totalCost,
            user: currentUser
        };
        db.ref("expenses").push(expData);

        // 3. Save Adjustment History
        const adjData = {
            date: today,
            time: new Date().toLocaleTimeString(),
            productName: product.name,
            qty: qty,
            reason: reason,
            cost: totalCost,
            user: currentUser
        };
        db.ref("stock_adjustments").push(adjData);

        showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤! ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "success");
        logActivity("Stock Adjustment", `${reason}: ${qty} ${product.name}`);

        // Reset
        document.getElementById("adjProductKey").value = "";
        document.getElementById("adjSearch").value = "";
        document.getElementById("adjQty").value = "";
    });
}

function loadStockAdjustments() {
    db.ref("stock_adjustments").limitToLast(20).on("value", snap => {
        const tbody = document.getElementById("adjHistoryBody");
        tbody.innerHTML = "";
        const data = [];
        snap.forEach(c => data.push(c.val()));
        data.reverse().forEach(adj => {
            tbody.innerHTML += `<tr>
                <td><small>${adj.date}</small></td>
                <td>${adj.productName}</td>
                <td>${adj.qty}</td>
                <td><span style="color:var(--warning)">${adj.reason}</span></td>
                <td>‡ß≥${adj.cost}</td>
                <td>${adj.user}</td>
            </tr>`;
        });
    });
}

// --- SALES & CART ---
function checkStockLive() {
    if(isManualMode) {
        document.getElementById("stockLiveMsg").style.display = "none";
        return;
    }
    const productKey = document.getElementById("selectedProductKey").value;
    const qtyInput = document.getElementById("qty");
    const msgSpan = document.getElementById("stockLiveMsg");
    if(!productKey) return;
    const product = allProducts.find(p => p.key === productKey);
    if(!product || product.isService) {
        msgSpan.style.display = "none";
        return;
    }
    const reqQty = parseFloat(qtyInput.value) || 0;
    if(reqQty > product.qty) {
        msgSpan.innerText = `‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á! ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${product.qty}`;
        msgSpan.style.display = "block";
        qtyInput.classList.add("invalid");
    } else {
        msgSpan.style.display = "none";
        qtyInput.classList.remove("invalid");
    }
}

function toggleManualMode() {
    isManualMode = document.getElementById("manualModeToggle").checked;
    const regArea = document.getElementById("regularEntryArea");
    const manArea = document.getElementById("manualEntryArea");

    if(isManualMode) {
        regArea.style.display = "none";
        manArea.style.display = "grid";
        document.getElementById("selectedProductKey").value = "";
        document.getElementById("stockLiveMsg").style.display = "none";
        document.getElementById("qty").classList.remove("invalid");
    } else {
        regArea.style.display = "grid";
        manArea.style.display = "none";
    }
}

function addToCart(){
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);

    if(!r || r <= 0) return showToast("‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®", "error");
    if(q <= 0) return showToast("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá", "error");

    let item = {};

    if(isManualMode) {
        const name = document.getElementById("manualName").value.trim();
        const cat = document.getElementById("manualCategory").value.trim() || "General";
        const section = document.getElementById("manualSection").value;

        if(!name) return showToast("‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!", "error");

        item = {
            key: null,
            work: name,
            category: cat,
            mainType: section,
            cost: 0,
            qty: q,
            rate: r,
            sub: q * r,
            isService: true,
            isManual: true
        };

        document.getElementById("manualName").value = "";
        document.getElementById("manualCategory").value = "";
    } else {
        const productKey = document.getElementById("selectedProductKey").value;
        if(!productKey) return showToast("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!", "error");
        const product = allProducts.find(p => p.key === productKey);
        if(!product) return showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");

        if(!product.isService) {
            let currentCartQty = 0;
            const existingItemIndex = cart.findIndex(item => item.key === productKey);
            if(existingItemIndex !== -1) {
                currentCartQty = cart[existingItemIndex].qty;
            }
            const totalReq = currentCartQty + q;

            if(!sysConfig.rules.negStock && (product.qty <= 0 || totalReq > product.qty)) {
                playSound('error');
                showToast(`‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á! ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®: ${totalReq}, ‡¶Ü‡¶õ‡ßá: ${product.qty}‡•§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`, "warning");
                openQuickStockModal(product.key, product.name, product.qty);
                return;
            }
        }

        item = {
            key: productKey,
            work: product.name,
            category: product.category,
            mainType: product.mainType || "General",
            cost: product.costPrice || 0,
            qty: q,
            rate: r,
            sub: q * r,
            isService: product.isService,
            isManual: false
        };

        document.getElementById("selectedProductKey").value = "";
        document.getElementById("sectionSelect").value = "";
        document.getElementById("categorySelect").innerHTML = '<option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
        document.getElementById("productSelect").innerHTML = '<option value="" disabled selected>‡¶Ü‡¶ó‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
    }

    const existingItemIndex = cart.findIndex(i => i.key === item.key && i.work === item.work && !isManualMode);
    if(existingItemIndex !== -1 && !isManualMode) {
        cart[existingItemIndex].qty += q;
        cart[existingItemIndex].sub = cart[existingItemIndex].qty * cart[existingItemIndex].rate;
    } else {
        cart.push(item);
    }

    renderCart();
    document.getElementById("rate").value = "";
    document.getElementById("qty").value = 1;
    document.getElementById("stockLiveMsg").style.display = "none";
    document.getElementById("qty").classList.remove("invalid");

    if(!isManualMode) document.getElementById("searchSerial").focus();
    else document.getElementById("manualName").focus();

    showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
}

function renderCart(){
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    let grandTotal = 0;
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `
            <div class="cart-item">
                <div>
                    <div style="font-weight:bold; color:var(--text-main)">${item.work} ${item.isManual ? '<span style="color:red; font-size:10px">(Manual)</span>' : ''}</div>
                    <div style="font-size:12px; color:#64748b">${item.mainType} | ${item.qty} x ‡ß≥${item.rate}</div>
                </div>
                <div>
                    <b style="color:var(--primary)">‡ß≥${item.sub}</b>
                    <span onclick="removeCart(${index})" style="color:#ef4444;cursor:pointer;margin-left:10px;font-weight:bold">‚úï</span>
                </div>
            </div>`;
    });
    document.getElementById("total").value = grandTotal;
    calcDue();
}

function removeCart(index){
    cart.splice(index,1);
    renderCart();
}

function calcDue(){
    const t = parseFloat(document.getElementById("total").value) || 0;
    const k = parseFloat(document.getElementById("taken").value) || 0;
    const diff = t - k;
    const dueLabel = document.getElementById("dueLabel");
    const dueInput = document.getElementById("due");
    if(diff < 0) {
        dueLabel.innerText = "‡¶´‡ßá‡¶∞‡¶§ (Change):";
        dueLabel.style.color = "#10b981";
        dueInput.style.color = "#10b981";
        dueInput.style.background = "#f0fdf4";
        dueInput.value = Math.abs(diff).toFixed(2);
    } else {
        dueLabel.innerText = "‡¶¨‡¶æ‡¶ï‡¶ø (Due):";
        dueLabel.style.color = "#ef4444";
        dueInput.style.color = "#ef4444";
        dueInput.style.background = "#fef2f2";
        dueInput.value = diff.toFixed(2);
    }
}

function validatePhoneLive(input) {
    const val = input.value.replace(/\D/g, '');
    input.value = val;
    const errorSpan = document.getElementById("phoneError");
    const bdPhoneRegex = /^01[3-9][0-9]{8}$/;

    if(val.length > 0) {
        if(!val.startsWith("01")) {
            errorSpan.style.display = "block";
            input.classList.add("invalid");
            input.classList.remove("valid");
        } else if(val.length === 11) {
            if(bdPhoneRegex.test(val)) {
                errorSpan.style.display = "none";
                input.classList.remove("invalid");
                input.classList.add("valid");
                autoFormatPhone(input);
            } else {
                errorSpan.style.display = "block";
                input.classList.add("invalid");
            }
        } else {
            errorSpan.style.display = "none";
            input.classList.remove("invalid");
            input.classList.remove("valid");
        }
    } else {
        errorSpan.style.display = "none";
        input.classList.remove("invalid");
    }
}

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        if(!cItem.isManual && cItem.key) {
            const product = allProducts.find(p => p.key === cItem.key);
            if(product && !product.isService) {
                db.ref("products/" + cItem.key + "/qty").transaction((currentQty) => {
                    if (currentQty === null) return 0;
                    return currentQty - parseFloat(cItem.qty);
                });
            }
        }
    });
}

// --- HOLD & RECALL LOGIC ---
function holdOrder() {
    if(cart.length === 0) return showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!", "error");
    const note = document.getElementById("note").value || "Unknown";
    const phone = document.getElementById("phone").value || "";
    const order = {
        items: [...cart],
        note: note,
        phone: phone,
        time: new Date().toLocaleTimeString()
    };
    heldOrders.push(order);
    localStorage.setItem("heldOrders", JSON.stringify(heldOrders));
    cart = [];
    renderCart();
    document.getElementById("note").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("taken").value = "";
    updateHoldCount();
    showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚è∏Ô∏è", "warning");
}

function updateHoldCount() {
    setText("holdCount", heldOrders.length);
    setText("holdCountMain", heldOrders.length);
}

function openHoldModal() {
    if(heldOrders.length === 0) return showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡ßá‡¶á!", "error");
    const tbody = document.getElementById("holdOrderBody");
    tbody.innerHTML = "";
    heldOrders.forEach((order, index) => {
        const total = order.items.reduce((sum, i) => sum + i.sub, 0);
        const itemsSummary = order.items.map(i => i.work).join(", ");
        tbody.innerHTML += `
        <tr>
            <td>${order.note} <br><small>${order.time}</small></td>
            <td><small>${itemsSummary}</small></td>
            <td style="font-weight:bold">‡ß≥${total}</td>
            <td>
                <button onclick="recallOrder(${index})" style="background:#10b981; padding:5px 10px; font-size:12px">Restore</button>
                <button onclick="deleteHeldOrder(${index})" style="background:#ef4444; padding:5px 10px; font-size:12px">X</button>
            </td>
        </tr>`;
    });
    document.getElementById("holdOrderModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function recallOrder(index) {
    if(cart.length > 0) {
        if(!confirm("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
    }
    const order = heldOrders[index];
    cart = order.items;
    document.getElementById("note").value = order.note;
    document.getElementById("phone").value = order.phone;
    heldOrders.splice(index, 1);
    localStorage.setItem("heldOrders", JSON.stringify(heldOrders));
    renderCart();
    updateHoldCount();
    closeModal("holdOrderModal");
    showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ", "success");
}

function deleteHeldOrder(index) {
    if(confirm("‡¶è‡¶á ‡¶π‡ßã‡¶≤‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
        heldOrders.splice(index, 1);
        localStorage.setItem("heldOrders", JSON.stringify(heldOrders));
        updateHoldCount();
        openHoldModal();
    }
}
// --- QUICK SALE TOGGLE FUNCTION (NEW) ---
function toggleQuickSaleMode() {
    const isQuick = document.getElementById("quickSaleToggle").checked;
    const phoneInput = document.getElementById("phone");
    const errorSpan = document.getElementById("phoneError");

    if (isQuick) {
        phoneInput.placeholder = "‡¶Ö‡¶ü‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶¨‡ßá (Auto)";
        phoneInput.disabled = true;
        phoneInput.style.background = "#f1f5f9";
        errorSpan.style.display = "none";
        phoneInput.classList.remove("invalid");
        phoneInput.value = "";
    } else {
        phoneInput.placeholder = "017xxxxxxxx";
        phoneInput.disabled = false;
        phoneInput.style.background = "#fff";
    }
}

// --- SEQUENTIAL MEMO ID LOGIC ---
function saveBulkEntry(showMemoFlag){
    if(!cart.length) return showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!", "error");

    const isQuotation = document.getElementById("quotationMode").checked;
    // ‡¶ï‡ßÅ‡¶á‡¶ï ‡¶∏‡ßá‡¶≤ ‡¶Æ‡ßã‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
    const isQuickSale = document.getElementById("quickSaleToggle") ? document.getElementById("quickSaleToggle").checked : false;

    let noteVal = document.getElementById("note").value.trim();
    let phoneVal = document.getElementById("phone").value.trim();

    // --- QUICK SALE LOGIC (NEW) ---
    if (isQuickSale) {
        if (!noteVal) noteVal = "General Customer";

        // ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶¨‡ßá
        if (!phoneVal) {
            const uniqueId = Math.floor(Date.now() / 1000).toString().slice(-5);
            phoneVal = "QC-" + uniqueId;
        }
    } else {
        // --- NORMAL LOGIC (OLD) ---
        if(!noteVal) noteVal = isQuotation ? "Quotation / Estimate" : "General Customer";

        if(sysConfig.rules.phoneReq && phoneVal.length < 11) {
            showToast("‚ùå ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡¶§‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï (Admin Rule)!", "error");
            return;
        }

        if(phoneVal.length > 0) {
            const bdPhoneRegex = /^01[3-9][0-9]{8}$/;
            if(!bdPhoneRegex.test(phoneVal)) {
                showToast("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! (013-019 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá)", "error");
                return;
            }
        }
    }

    // ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶ó‡ßá ‡¶°‡¶ø‡¶´‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡¶æ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡ßá
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    const dueVal = totalVal - takenVal;

    // --- QUOTATION LOGIC ---
    if(isQuotation) {
        const dummyEntry = {
            date: new Date().toLocaleDateString("en-GB"),
            time: new Date().toLocaleTimeString(),
            memoId: "QTN",
            user: currentUser,
            note: noteVal,
            phone: phoneVal,
            total: totalVal,
            taken: 0,
            loss: totalVal,
            items: cart,
            isQuotation: true
        };
        showMemo(dummyEntry);
        return;
    }

    // --- DUE LIMIT CHECK ---
    const dueLimit = parseFloat(sysConfig.rules.dueLimit);
    if(dueLimit > 0 && dueVal > dueLimit) {
        showToast(`‚ùå ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá! ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${dueLimit}`, "error");
        return;
    }

    // --- SAVE TO DATABASE ---
    if (!navigator.onLine) {
        const offlineId = "OFF-" + Date.now().toString().slice(-6);
        processEntry(offlineId, totalVal, takenVal, noteVal, phoneVal, showMemoFlag);
        showToast("‚ö†Ô∏è ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°: ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶¨‡ßá‡•§", "warning");
    } else {
        db.ref("settings/memoCounter").transaction((current_value) => {
            return (current_value || 1000) + 1;
        }).then((result) => {
            if (!result.committed) {
                showToast("‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "error");
                return;
            }
            const newMemoId = result.snapshot.val();
            processEntry(newMemoId, totalVal, takenVal, noteVal, phoneVal, showMemoFlag);
        });
    }
}

function processEntry(memoId, totalVal, takenVal, noteVal, phoneVal, showMemoFlag) {
    const now = new Date();
    const isoDate = now.toISOString().split('T')[0];
    let actualDue = totalVal - takenVal;
    if(actualDue < 0) actualDue = 0;
    actualDue = parseFloat(actualDue.toFixed(2));

    const entryData = {
        date: now.toLocaleDateString("en-GB"),
        isoDate: isoDate,
        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: actualDue,
        user: currentUser,
        note: noteVal,
        phone: phoneVal,
        memoId: memoId
    };

    if(phoneVal) {
        const customerExists = allCustomers.some(c => c.phone === phoneVal);
        if(!customerExists) {
            db.ref("customers").push({ name: noteVal, phone: phoneVal });
        }
    }

    db.ref("entries").push(entryData).then((snap) => {
        deductStock(cart);
        if(showMemoFlag) {
             entryData.key = snap.key;
             showMemo(entryData);
        } else {
             showToast(`‚úÖ ‡¶Æ‡ßá‡¶Æ‡ßã #${memoId} ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
        }
        cart = [];
        renderCart();
        document.getElementById("note").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("taken").value = "";
        document.getElementById("due").value = "0";
        document.getElementById("phoneSuggestion").textContent = "";
        document.getElementById("phone").classList.remove("valid");
        document.getElementById("quotationMode").checked = false;

        if(isManualMode) {
            document.getElementById("manualModeToggle").checked = false;
            toggleManualMode();
        }
    });
}

// --- EXPENSE MANAGEMENT ---
function saveExpense() {
    const desc = document.getElementById("expDesc").value.trim();
    const cat = document.getElementById("expCat").value;
    const amount = parseFloat(document.getElementById("expAmount").value);
    if(!desc && isNaN(amount)) {
        showToast("‚ö†Ô∏è ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");
        return;
    }
    if(!desc) {
        showToast("‚ö†Ô∏è ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!", "error");
        return;
    }
    if(isNaN(amount) || amount <= 0) {
        showToast("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");
        return;
    }
    const expenseData = {
        date: new Date().toLocaleDateString("en-GB"),
        desc: desc,
        category: cat,
        amount: amount,
        user: currentUser
    };
    db.ref("expenses").push(expenseData).then(() => {
        showToast("‡¶ñ‡¶∞‡¶ö ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        document.getElementById("expDesc").value = "";
        document.getElementById("expAmount").value = "";
    });
}

function loadExpenses() {
    db.ref("expenses").on("value", s => {
        allExpenses = [];
        let totalExp = 0;
        const tbody = document.getElementById("expenseBody");
        tbody.innerHTML = "";
        s.forEach(c => {
            let e = c.val();
            e.key = c.key;
            allExpenses.push(e);
            totalExp += parseFloat(e.amount) || 0;
            tbody.innerHTML += `
            <tr>
                <td>${e.date}</td>
                <td>${e.desc}</td>
                <td>${e.category}</td>
                <td>${e.amount}</td>
                <td><button class="btn-action btn-delete" onclick="deleteExpense('${e.key}')">üóëÔ∏è</button></td>
            </tr>`;
        });
        setText("totalExpenseDisplay", totalExp);
    });
}

function deleteExpense(key) {
    if (!sysConfig.perms.delete) {
        return showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    }
    if(confirm("‡¶ñ‡¶∞‡¶ö‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        db.ref("expenses/"+key).remove();
        showToast("‡¶ñ‡¶∞‡¶ö ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "warning");
    }
}

// --- ANALYTICS ---
function generateAnalytics() {
    if(!isFullHistoryLoaded) {
        showToast("‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶ó‡ßá 'Load Full History' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!", "warning");
        return;
    }

    showToast("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "success");

    let lifeSale = 0, lifeDue = 0, lifeCash = 0;
    allEntries.forEach(e => {
        lifeSale += parseFloat(e.total) || 0;
        lifeCash += parseFloat(e.taken) || 0;
        lifeDue += parseFloat(e.loss) || 0;
    });
    setText("lifeSale", lifeSale.toLocaleString());
    setText("lifeDue", lifeDue.toLocaleString());
    setText("lifeCash", lifeCash.toLocaleString());

    const month = parseInt(document.getElementById("anMonth").value);
    const year = parseInt(document.getElementById("anYear").value);
    let totalSale = 0, totalProductCost = 0;
    let cats = {};
    appSections.forEach(s => cats[s] = {sale:0, cost:0});
    cats["Other"] = {sale:0, cost:0};

    allEntries.forEach(entry => {
        const [d, m, y] = entry.date.split('/');
        if(parseInt(y) !== year) return;
        if(month !== 0 && parseInt(m) !== month) return;

        if(entry.items && Array.isArray(entry.items)) {
            entry.items.forEach(item => {
                const iSale = parseFloat(item.sub) || 0;
                const iCost = (parseFloat(item.cost) || 0) * (parseFloat(item.qty) || 0);
                let type = item.mainType || "Other";
                if(!cats[type]) type = "Other";
                cats[type].sale += iSale;
                cats[type].cost += iCost;
                totalSale += iSale;
                totalProductCost += iCost;
            });
        } else {
            totalSale += parseFloat(entry.total) || 0;
        }
    });

    let totalExpense = 0;
    let expenseByCat = {};
    allExpenses.forEach(exp => {
        const [d, m, y] = exp.date.split('/');
        if(parseInt(y) !== year) return;
        if(month !== 0 && parseInt(m) !== month) return;
        const amount = parseFloat(exp.amount) || 0;
        totalExpense += amount;
        if(!expenseByCat[exp.category]) expenseByCat[exp.category] = 0;
        expenseByCat[exp.category] += amount;
    });

    const grossProfit = totalSale - totalProductCost;
    const netProfit = grossProfit - totalExpense;

    let grossMargin = (totalSale > 0) ? ((grossProfit / totalSale) * 100).toFixed(1) : 0;
    let netMargin = (totalSale > 0) ? ((netProfit / totalSale) * 100).toFixed(1) : 0;

    setText("anaSale", totalSale.toLocaleString());
    setText("anaCost", totalProductCost.toLocaleString());

    const grossEl = document.getElementById("anaGross");
    grossEl.innerHTML = `${grossProfit.toLocaleString()} <span class="badge-percent" style="background:${grossProfit>=0?'#dcfce7':'#fee2e2'}; color:${grossProfit>=0?'#166534':'#b91c1c'}">${grossMargin}%</span>`;

    setText("anaExpense", totalExpense.toLocaleString());

    const netEl = document.getElementById("anaNet");
    const netTitle = document.getElementById("netProfitTitle");

    if(netEl) {
        netEl.innerHTML = `${netProfit.toLocaleString()} <span class="badge-percent" style="background:${netProfit>=0?'#dcfce7':'#fee2e2'}; color:${netProfit>=0?'#166534':'#b91c1c'}; font-size:16px">${netMargin}%</span>`;
    }

    if(netProfit < 0) {
        if(netTitle) { netTitle.innerText = "NET LOSS ‚ö†Ô∏è"; netTitle.style.color = "#ef4444"; }
        if(netEl) netEl.style.color = "#ef4444";
    } else {
        if(netTitle) { netTitle.innerText = "NET PROFIT"; netTitle.style.color = "#64748b"; }
        if(netEl) netEl.style.color = "#10b981";
    }

    const tbody = document.getElementById("anaTableBody");
    tbody.innerHTML = "";
    Object.keys(cats).forEach(key => {
        if(cats[key].sale > 0 || cats[key].cost > 0) {
            const p = cats[key].sale - cats[key].cost;
            const margin = (cats[key].sale > 0) ? ((p / cats[key].sale) * 100).toFixed(1) : 0;

            tbody.innerHTML += `
            <tr>
                <td>${key}</td>
                <td style="text-align:right">${cats[key].sale.toLocaleString()}</td>
                <td style="text-align:right">${cats[key].cost.toLocaleString()}</td>
                <td style="text-align:right; font-weight:bold; color:${p>=0?'#10b981':'#ef4444'}">${p.toLocaleString()}</td>
                <td style="text-align:right">
                    <span class="badge-percent" style="background:${p>=0?'#dcfce7':'#fee2e2'}; color:${p>=0?'#166534':'#b91c1c'}">${margin}%</span>
                </td>
            </tr>`;
        }
    });

    const expBody = document.getElementById("anaExpBreakdown");
    if(expBody) {
        expBody.innerHTML = "";
        if(totalExpense === 0) expBody.innerHTML = "<tr><td colspan='2' style='text-align:center; color:#aaa'>‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á</td></tr>";
        else Object.keys(expenseByCat).forEach(cat => expBody.innerHTML += `<tr><td>${cat}</td><td style="text-align:right; font-weight:bold">‡ß≥ ${expenseByCat[cat].toLocaleString()}</td></tr>`);
    }
}

// --- STOCK VALUATION ---
function updateStockValuationTable() {
    const tbody = document.getElementById("stockValuationBody");
    tbody.innerHTML = "";
    let totalVal = 0;
    allProducts.forEach(p => {
        if(p.isService) return;
        const cost = parseFloat(p.costPrice) || 0;
        const qty = parseFloat(p.qty) || 0;
        const val = cost * qty;
        totalVal += val;
        const alertLevel = p.alertLevel || 5;
        const isLow = qty <= alertLevel;
        if(isShortageView && !isLow) return;
        tbody.innerHTML += `
        <tr class="${isLow ? 'low-stock' : ''}">
            <td>${p.name}</td>
            <td>${p.mainType || '-'}</td>
            <td>${qty}</td>
            <td>${cost}</td>
            <td>${val.toFixed(0)}</td>
            <td>${isLow ? '‚ö†Ô∏è Shortage' : 'OK'}</td>
        </tr>`;
    });
    setText("stockValue", "‡ß≥ " + totalVal.toLocaleString());
}

// --- MEMO & PRINT ---
function showMemo(e){
    const memoId = e.memoId ? e.memoId : (e.key ? e.key.slice(-4).toUpperCase() : '---');

    const header = document.getElementById("memoTypeHeader");
    if(e.isQuotation) {
        header.innerText = "ESTIMATE / QUOTATION";
        header.style.borderColor = "#f59e0b";
        header.style.color = "#d97706";
        setText("mId", "---");
    } else {
        header.innerText = sysConfig.ui.memoLabel || "MEMO / BILL";
        header.style.borderColor = "#000";
        header.style.color = "#000";
        setText("mId", memoId);
    }

    setText("mDate", e.date + " " + e.time);
    setText("mUser", e.user);
    setText("mNote", e.note);
    setText("mPhoneDisp", e.phone ? `(${e.phone})` : "");
    setText("mTotal", e.total);
    setText("mPaid", e.taken);
    const due = e.total - e.taken;
    if(due < 0) {
        setText("mDueDisplay", "0 (‡¶´‡ßá‡¶∞‡¶§: " + Math.abs(due) + ")");
    } else {
        setText("mDueDisplay", due);
    }

    const footerMsg = document.getElementById("memoFooterMsg");
    if(footerMsg) footerMsg.innerText = sysConfig.ui.footer || "Thank you!";

    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => {
            let displayName = i.work;
            if(i.category && !i.work.toLowerCase().includes(i.category.toLowerCase())) {
                displayName = `<span style="font-weight:600">${i.category}</span> - ${i.work}`;
            }
            mItems.innerHTML += `
            <tr>
                <td style="border:1px solid #ddd; padding:6px">${displayName}</td>
                <td style="text-align:center; border:1px solid #ddd; padding:6px">${i.qty}</td>
                <td style="text-align:right; border:1px solid #ddd; padding:6px">${i.sub}</td>
            </tr>`;
        });
    }
    const signs = { owner: ["Toosher Ahmed", "01913-812765"], admin: ["Arafat Sikder", "016749-44985"], roky: ["Roky", "01878-149052"] };
    const s = signs[e.user] || [e.user.toUpperCase(), ""];
    setText("signatureName", s[0]);
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function viewMemo(key){
    const entry = allEntries.find(e => e.key === key);
    if(!entry) return showToast("‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
    const memoId = entry.memoId ? entry.memoId : entry.key.slice(-4).toUpperCase();
    setText("vId", memoId);
    setText("vDate", entry.date + " " + entry.time);
    setText("vUser", entry.user);
    setText("vName", entry.note);
    setText("vPhone", entry.phone || "N/A");
    const tbody = document.getElementById("vItemsBody");
    tbody.innerHTML = "";
    if(entry.items && Array.isArray(entry.items)){
        entry.items.forEach(i => {
            tbody.innerHTML += `
            <tr>
                <td>${i.work} <br><small style="color:#777">${i.category}</small></td>
                <td style="text-align:center">${i.qty}</td>
                <td style="text-align:right">${i.sub}</td>
            </tr>`;
        });
    }
    setText("vTotal", entry.total);
    setText("vPaid", entry.taken);
    const due = entry.total - entry.taken;
    const vDue = document.getElementById("vDue");
    if(due < 0) {
        vDue.innerText = "0 (‡¶´‡ßá‡¶∞‡¶§: " + Math.abs(due) + ")";
        vDue.style.color = "green";
    } else {
        vDue.innerText = due;
        vDue.style.color = "red";
    }
    document.getElementById("viewDetailsModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function printEntry(key) {
    const entry = allEntries.find(e => e.key === key);
    if(entry) {
        showMemo(entry);
    }
}

function closeModal(id) { document.getElementById(id).style.display="none"; document.getElementById("overlay").style.display="none"; }

// --- EDIT ENTRY LOGIC ---
function openEditModal(key) {
    const entry = allEntries.find(e => e.key === key);
    if(!entry) return;
    document.getElementById("editEntryKey").value = key;
    document.getElementById("editEntryNote").value = entry.note;
    document.getElementById("editEntryPhone").value = entry.phone || "";
    document.getElementById("editEntryTotal").value = entry.total;
    document.getElementById("editEntryTaken").value = entry.taken;
    calcEditDue();
    document.getElementById("editEntryModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function calcEditDue() {
    const t = parseFloat(document.getElementById("editEntryTotal").value) || 0;
    const p = parseFloat(document.getElementById("editEntryTaken").value) || 0;
    document.getElementById("editEntryDue").value = t - p;
}

function saveEditEntry() {
    const key = document.getElementById("editEntryKey").value;
    const note = document.getElementById("editEntryNote").value;
    const phone = document.getElementById("editEntryPhone").value;
    const total = parseFloat(document.getElementById("editEntryTotal").value);
    const taken = parseFloat(document.getElementById("editEntryTaken").value);
    const loss = total - taken;
    db.ref("entries/" + key).update({
        note: note,
        phone: phone,
        total: total,
        taken: taken,
        loss: loss
    }).then(() => {
        showToast("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        closeModal("editEntryModal");
    });
}

function deleteFromEdit() {
    if (!sysConfig.perms.delete) {
        return showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    }
    const key = document.getElementById("editEntryKey").value;
    if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
        db.ref("entries/"+key).once("value", s => {
            const entry = s.val();
            if(entry.items) entry.items.forEach(i => {
                if(!i.isService && !i.isManual) {
                     const p = allProducts.find(x => x.key === i.key);
                     if(p) {
                         db.ref("products/"+i.key+"/qty").transaction(current => (current||0) + parseFloat(i.qty));
                     }
                }
            });
            db.ref("entries/"+key).remove();
            closeModal("editEntryModal");
            logActivity("Delete Entry", `Deleted Memo ${entry.memoId || key.slice(-4)}`);
            showToast("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "warning");
        });
    }
}

// --- REPORTING CORE ---
function loadEntries(){
    recentHistoryListener = db.ref("entries").limitToLast(100).on("value", s => {
        if(isFullHistoryLoaded) return;

        const val = s.val();
        allEntries = [];
        if(val) {
             Object.keys(val).forEach(k => {
                 let e = val[k]; e.key = k;
                 allEntries.push(e);
             });
        }
        const recent = allEntries.slice().reverse();
        renderTable(recent, "tableBody");
        updateUserSummary();
        updateSectionSummary();
        renderChart();
        loadCustomerManager();
    });
}

function toggleFullHistory(load) {
    const statusEl = document.getElementById("historyStatus");

    if(load) {
        if(isFullHistoryLoaded) return showToast("‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá!", "success");

        showToast("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®", "warning");

        if(recentHistoryListener) db.ref("entries").off("value", recentHistoryListener);

        fullHistoryListener = db.ref("entries").on("value", s => {
            const val = s.val();
            allEntries = [];
            if(val) {
                 Object.keys(val).forEach(k => {
                     let e = val[k]; e.key = k;
                     allEntries.push(e);
                 });
            }
            isFullHistoryLoaded = true;
            statusEl.style.display = "block";
            showToast("‚úÖ ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!", "success");

            renderTable(allEntries.slice().reverse().slice(0, 100), "tableBody");
            updateUserSummary();
            updateSectionSummary();
            renderChart();
            loadCustomerManager();
            generateAnalytics();
        });
    } else {
        if(!isFullHistoryLoaded) return;

        if(fullHistoryListener) db.ref("entries").off("value", fullHistoryListener);
        isFullHistoryLoaded = false;
        statusEl.style.display = "none";
        allEntries = [];

        showToast("‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        loadEntries();

        setText("lifeSale", "---");
        setText("lifeDue", "---");
        setText("lifeCash", "---");
        setText("anaSale", "---");
        setText("anaNet", "---");
    }
}

function updateSectionSummary() {
    const today = new Date().toLocaleDateString("en-GB");
    let summary = {};
    appSections.forEach(s => summary[s] = {sale: 0, cost: 0});

    allEntries.forEach(e => {
        if (e.date === today && e.items) {
            e.items.forEach(i => {
                const amount = parseFloat(i.sub) || 0;
                const cost = (parseFloat(i.cost) || 0) * (parseFloat(i.qty) || 0);
                if(summary[i.mainType] !== undefined) {
                    summary[i.mainType].sale += amount;
                    summary[i.mainType].cost += cost;
                }
            });
        }
    });

    appSections.forEach(s => {
        const elId = `secSum_${s.replace(/\s/g, '')}`;
        const el = document.getElementById(elId);
        if(el) {
            const sale = summary[s].sale;
            const cost = summary[s].cost;
            const profit = sale - cost;
            const margin = (sale > 0) ? ((profit / sale) * 100).toFixed(1) : 0;

            el.innerHTML = `‡ß≥ ${sale.toLocaleString()} <br>
            <small style="font-size:12px; color:${profit>=0?'#166534':'#b91c1c'}">
                ${profit>=0?'Profit':'Loss'}: ${margin}%
            </small>`;
        }
    });
}

function loadReportData() {
    if(!isFullHistoryLoaded) {
        if(confirm("‡¶™‡ßÅ‡¶∞‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
            toggleFullHistory(true);
        }
        return;
    }
    currentReportPage = 1;
    renderReportWithPagination();
}

function changeReportPage(direction) {
    const totalPages = Math.ceil(allEntries.length / rowsPerPage);
    if (direction === -1 && currentReportPage > 1) {
        currentReportPage--;
    } else if (direction === 1 && currentReportPage < totalPages) {
        currentReportPage++;
    }
    renderReportWithPagination();
}

function renderReportWithPagination() {
    const sortedEntries = allEntries.slice().reverse();
    const startIndex = (currentReportPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const paginatedData = sortedEntries.slice(startIndex, endIndex);
    renderTable(paginatedData, "reportTableBody");
    const totalPages = Math.ceil(allEntries.length / rowsPerPage) || 1;
    setText("pageIndicator", `Page ${currentReportPage} of ${totalPages}`);
}

function renderTable(data, tableId){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML="";
    if(!data || data.length === 0) { tbody.innerHTML = "<tr><td colspan='9' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>"; return; }

    data.forEach(e => {
        const itemSummary = (e.items && Array.isArray(e.items))
            ? e.items.map(i => `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work}</span>`).join(" ")
            : e.work;
        const memoNo = e.memoId ? e.memoId : e.key.slice(-4).toUpperCase();
        const btnView = `<button class="btn-action btn-view" onclick="viewMemo('${e.key}')" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®">üëÅÔ∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEditModal('${e.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnPrint = `<button class="btn-action btn-print" onclick="printEntry('${e.key}')" title="‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü">üñ®Ô∏è</button>`;
        tbody.innerHTML+=`
        <tr>
            <td style="font-weight:bold; color:#10b981">${memoNo}</td>
            <td style="font-size:13px">${e.date}<br>${e.time}</td>
            <td style="font-size:13px"><b>${e.note}</b><br>${itemSummary}</td>
            <td class="en">${e.phone||"-"}</td>
            <td>${e.total}</td>
            <td style="color:#10b981;font-weight:bold">${e.taken}</td>
            <td style="color:#ef4444">${e.loss}</td>
            <td style="text-transform:capitalize">${e.user}</td>
            <td class="noPrint" style="white-space:nowrap">${btnView}${btnEdit}${btnPrint}</td>
        </tr>`;
    });
}

function searchByDateRange() {
    if(!isFullHistoryLoaded) {
        alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá 'Load Full History' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
    }
    const fromDate = document.getElementById("rFromDate").value;
    const toDate = document.getElementById("rToDate").value;
    if(!fromDate || !toDate) return showToast("‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶á ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
    const filtered = allEntries.filter(e => {
        let entryDate = e.isoDate;
        if(!entryDate) {
            const parts = e.date.split('/');
            entryDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        return entryDate >= fromDate && entryDate <= toDate;
    });
    renderTable(filtered, "reportTableBody");
    setText("pageIndicator", `Found: ${filtered.length}`);
}

function updateUserSummary() {
    const today = new Date().toLocaleDateString("en-GB");
    const todayEntries = allEntries.filter(e => e.date === today);
    const users = {};

    todayEntries.forEach(e => {
        const u = e.user || "Unknown";
        if(!users[u]) users[u] = { total: 0, cash: 0, due: 0, cost: 0 };

        users[u].total += (+e.total || 0);
        users[u].cash += (+e.taken || 0);
        users[u].due += (+e.loss || 0);

        if(e.items) {
            e.items.forEach(i => {
                users[u].cost += ((+i.cost || 0) * (+i.qty || 0));
            });
        }
    });

    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    if(Object.keys(users).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>';
        return;
    }
    Object.keys(users).forEach(u => {
        const profit = users[u].total - users[u].cost;
        const margin = (users[u].total > 0) ? ((profit / users[u].total) * 100).toFixed(1) : 0;

        tbody.innerHTML += `
        <tr>
            <td style="text-transform:capitalize; font-weight:bold">${u}</td>
            <td>${users[u].total}</td>
            <td style="color:#10b981">${users[u].cash}</td>
            <td style="color:#ef4444">${users[u].due}</td>
            <td>
                <span class="badge-percent" style="background:${profit>=0?'#dcfce7':'#fee2e2'}; color:${profit>=0?'#166534':'#b91c1c'}">
                    ${profit>=0?'+':''}${margin}%
                </span>
            </td>
        </tr>`;
    });
}

function renderChart() {
    const canvas = document.getElementById('salesChart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const labels = [];
    const dataPoints = [];
    for(let i=6; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString("en-GB");
        labels.push(dateStr.slice(0,5));
        const dayTotal = allEntries
            .filter(e => e.date === dateStr)
            .reduce((sum, e) => sum + (+e.total || 0), 0);
        dataPoints.push(dayTotal);
    }
    if(salesChart) salesChart.destroy();
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∏‡ßá‡¶≤ (‡ß≥)',
                data: dataPoints,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function loadCustomerManager() {
    const stats = {};
    allCustomers.forEach(c => {
        const key = c.phone || c.name;
        stats[key] = {
            name: c.name,
            phone: c.phone || "N/A",
            total: 0,
            paid: 0,
            due: 0,
            dbKey: c.key
        };
    });
    allEntries.forEach(e => {
        const key = e.phone ? e.phone : e.note;
        if(!stats[key]) {
            stats[key] = {
                name: e.note,
                phone: e.phone || "N/A",
                total: 0,
                paid: 0,
                due: 0,
                dbKey: null
            };
        }
        stats[key].total += (parseFloat(e.total) || 0);
        stats[key].paid += (parseFloat(e.taken) || 0);
        stats[key].due += (parseFloat(e.loss) || 0);
    });
    customerStats = Object.values(stats);
    renderCustomerTable(customerStats);
}

function sortCustomers() {
    const criteria = document.getElementById("custSort").value;
    let sorted = [...customerStats];

    if(criteria === 'name') {
        sorted.sort((a, b) => a.name.localeCompare(b.name));
    } else if(criteria === 'due') {
        sorted.sort((a, b) => b.due - a.due);
    } else if(criteria === 'sale') {
        sorted.sort((a, b) => b.total - a.total);
    } else if(criteria === 'newest') {
        sorted.reverse();
    }

    renderCustomerTable(sorted);
}

function renderCustomerTable(data) {
    const tbody = document.getElementById("customerTableBody");
    tbody.innerHTML = "";
    if(data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>";
        return;
    }
    data.forEach(c => {
        const safeName = c.name.replace(/'/g, "\\'");
        const safePhone = c.phone === "N/A" ? "" : c.phone;
        const dbKey = c.dbKey || "";
        tbody.innerHTML += `
        <tr>
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.total}</td>
            <td style="color:#10b981">${c.paid}</td>
            <td style="color:#ef4444; font-weight:bold">${c.due}</td>
            <td>
                <button class="btn-action btn-view" onclick="viewCustomerHistory('${safePhone}', '${safeName}')" title="‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®">üëÅÔ∏è</button>
                <button class="btn-action btn-edit" onclick="openEditCustomerModal('${dbKey}', '${safeName}', '${safePhone}')" title="‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">‚úèÔ∏è</button>
            </td>
        </tr>`;
    });
}

function filterCustomerTable() {
    const q = document.getElementById("custSearch").value.toLowerCase();
    const filtered = customerStats.filter(c =>
        c.name.toLowerCase().includes(q) ||
        c.phone.includes(q)
    );
    renderCustomerTable(filtered);
}

function openAddCustomerModal() {
    document.getElementById("custKey").value = "";
    document.getElementById("custName").value = "";
    document.getElementById("custPhone").value = "";
    document.getElementById("customerModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function openEditCustomerModal(key, name, phone) {
    if(!key) {
        if(confirm("‡¶è‡¶á ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡¶ü‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            openAddCustomerModal();
            document.getElementById("custName").value = name;
            document.getElementById("custPhone").value = phone;
        }
        return;
    }
    document.getElementById("custKey").value = key;
    document.getElementById("custName").value = name;
    document.getElementById("custPhone").value = phone;
    document.getElementById("customerModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveCustomer() {
    const key = document.getElementById("custKey").value;
    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    if(!name) return showToast("‡¶®‡¶æ‡¶Æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "error");

    if(phone.length > 0) {
        const bdPhoneRegex = /^01[3-9][0-9]{8}$/;
        if(!bdPhoneRegex.test(phone)) {
            showToast("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! (013-019 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá)", "error");
            return;
        }
    }

    const data = { name: name, phone: phone };
    if(key) {
        db.ref("customers/" + key).update(data).then(() => {
            showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            closeModal("customerModal");
        });
    } else {
        db.ref("customers").push(data).then(() => {
            showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            closeModal("customerModal");
        });
    }
}

function viewCustomerHistory(phone, name) {
    setText("histName", name);
    setText("histPhone", phone || "N/A");
    const tbody = document.getElementById("histBody");
    tbody.innerHTML = "";
    const history = allEntries.filter(e => {
        if(phone && phone !== "N/A") return e.phone === phone;
        return e.note === name;
    }).reverse();
    if(history.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>";
    } else {
        history.forEach(e => {
            const items = e.items ? e.items.map(i => i.work).join(", ") : e.work;
            const memoNo = e.memoId ? e.memoId : e.key.slice(-4).toUpperCase();
            tbody.innerHTML += `
            <tr>
                <td style="font-weight:bold; color:#10b981">${memoNo}</td>
                <td style="font-size:13px">${e.date}</td>
                <td style="font-size:13px">${items}</td>
                <td>${e.total}</td>
                <td style="color:#10b981">${e.taken}</td>
                <td style="color:#ef4444">${e.loss}</td>
            </tr>`;
        });
    }
    document.getElementById("customerHistoryModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function openDueCollectionModal() {
    document.getElementById("dcName").value = "";
    document.getElementById("dcPhone").value = "";
    document.getElementById("dcAmount").value = "";
    document.getElementById("dueCollectionModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function autoFillDueCustomer(input) {
    const val = input.value;
    if(val.length >= 3) {
        const c = allCustomers.find(c => c.phone && c.phone.includes(val));
        if(c) { document.getElementById("dcName").value = c.name; }
    }
}

function saveDueCollection() {
    const name = document.getElementById("dcName").value.trim();
    const phone = document.getElementById("dcPhone").value.trim();
    const amount = parseFloat(document.getElementById("dcAmount").value);
    if(!name || !amount || amount <= 0) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!", "error");

    if(phone.length > 0) {
        const bdPhoneRegex = /^01[3-9][0-9]{8}$/;
        if(!bdPhoneRegex.test(phone)) {
            showToast("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! (013-019 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá)", "error");
            return;
        }
    }

    const now = new Date();
    const isoDate = now.toISOString().split('T')[0];
    const entryData = {
        date: now.toLocaleDateString("en-GB"),
        isoDate: isoDate,
        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: [],
        work: "Due Collection (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ)",
        total: 0,
        taken: amount,
        loss: -amount,
        user: currentUser,
        note: name,
        phone: phone
    };
    db.ref("entries").push(entryData).then(() => {
        showToast("‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        closeModal("dueCollectionModal");
    });
}

function openReturnModal() {
    document.getElementById("retSearchInput").value = "";
    document.getElementById("retResultArea").style.display = "none";
    document.getElementById("retSearchList").style.display = "none";
    document.getElementById("returnModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    document.getElementById("retSearchInput").focus();
}

function searchInvoiceForReturn() {
    const q = document.getElementById("retSearchInput").value.trim().toLowerCase();
    if(!q) return showToast("‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®!", "error");

    const matches = allEntries.filter(e =>
        (e.memoId && String(e.memoId).includes(q)) ||
        e.key.toLowerCase().includes(q) ||
        e.note.toLowerCase().includes(q) ||
        (e.phone && e.phone.includes(q))
    );

    const listArea = document.getElementById("retSearchList");
    const listBody = document.getElementById("retSearchListBody");
    const resultArea = document.getElementById("retResultArea");

    if(matches.length === 0) {
        listArea.style.display = "none";
        resultArea.style.display = "none";
        return showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");
    }

    if(matches.length === 1) {
        listArea.style.display = "none";
        selectReturnInvoice(matches[0].key);
    } else {
        listBody.innerHTML = "";
        matches.reverse().forEach(e => {
            const memo = e.memoId || e.key.slice(-4).toUpperCase();
            listBody.innerHTML += `
            <tr style="cursor:pointer; hover:background:#f1f5f9">
                <td>${memo}</td>
                <td>${e.date}</td>
                <td>${e.note}</td>
                <td>${e.total}</td>
                <td><button onclick="selectReturnInvoice('${e.key}')" style="padding:5px 10px; background:#3b82f6; font-size:12px">Select</button></td>
            </tr>`;
        });
        listArea.style.display = "block";
        resultArea.style.display = "none";
    }
}

function selectReturnInvoice(key) {
    const entry = allEntries.find(e => e.key === key);
    if(!entry) return;

    selectedReturnEntry = entry;
    document.getElementById("retSearchList").style.display = "none";

    const memoNo = entry.memoId ? entry.memoId : entry.key.slice(-4).toUpperCase();
    setText("retMemoNo", memoNo);
    setText("retDate", entry.date + " (" + entry.time + ")");
    setText("retCustName", entry.note);

    document.getElementById("retResultArea").style.display = "block";

    const tbody = document.getElementById("retItemsBody");
    tbody.innerHTML = "";
    if(entry.items && Array.isArray(entry.items)) {
        entry.items.forEach((item, index) => {
            tbody.innerHTML += `
            <tr>
                <td>${item.work}</td>
                <td>${item.qty}</td>
                <td>${item.rate}</td>
                <td>
                    <input type="number" id="retQty_${index}"
                           min="0" max="${item.qty}" value="0"
                           style="width:60px; padding:5px"
                           oninput="calcReturnTotal(${index}, ${item.qty})">
                </td>
                <td id="retAmt_${index}">0</td>
            </tr>`;
        });
    } else {
        tbody.innerHTML = "<tr><td colspan='5'>No items found.</td></tr>";
    }
    calcReturnTotal();
}

function calcReturnTotal(index, maxQty) {
    let totalRefund = 0;
    if(selectedReturnEntry && selectedReturnEntry.items) {
        selectedReturnEntry.items.forEach((item, idx) => {
            const qtyInput = document.getElementById(`retQty_${idx}`);
            if(qtyInput) {
                let rQty = parseFloat(qtyInput.value) || 0;
                if(rQty > item.qty) {
                    showToast(`‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${item.qty} ‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá!`, "warning");
                    qtyInput.value = item.qty;
                    rQty = item.qty;
                }
                const refund = rQty * item.rate;
                setText(`retAmt_${idx}`, refund);
                totalRefund += refund;
            }
        });
    }
    setText("retTotalRefund", totalRefund);
}

function processSmartReturn() {
    if(!selectedReturnEntry) return;
    const reason = document.getElementById("retReason").value.trim();
    let returnItems = [];
    let totalRefund = 0;
    let validationError = false;
    selectedReturnEntry.items.forEach((item, index) => {
        const qtyInput = document.getElementById(`retQty_${index}`);
        if(qtyInput) {
            const rQty = parseFloat(qtyInput.value) || 0;
            if(rQty > item.qty) {
                validationError = true;
            }
        }
    });
    if(validationError) return showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!", "error");
    selectedReturnEntry.items.forEach((item, index) => {
        const qtyInput = document.getElementById(`retQty_${index}`);
        if(qtyInput) {
            const rQty = parseFloat(qtyInput.value) || 0;
            if(rQty > 0) {
                returnItems.push({
                    key: item.key,
                    work: item.work + " (RETURN)",
                    qty: -rQty,
                    rate: item.rate,
                    sub: -(rQty * item.rate),
                    isService: item.isService
                });
                if(!item.isService && item.key) {
                    db.ref("products/" + item.key + "/qty").transaction(current => (current||0) + rQty);
                }
                totalRefund += (rQty * item.rate);
            }
        }
    });
    if(returnItems.length === 0) return showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø!", "error");
    const now = new Date();
    const memoRef = selectedReturnEntry.memoId ? selectedReturnEntry.memoId : selectedReturnEntry.key.slice(-4).toUpperCase();
    const entryData = {
        date: now.toLocaleDateString("en-GB"),
        isoDate: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: returnItems,
        work: "Sales Return",
        total: -totalRefund,
        taken: -totalRefund,
        loss: 0,
        user: currentUser,
        note: `Return: ${reason} (Ref: ${memoRef})`,
        phone: selectedReturnEntry.phone
    };
    db.ref("entries").push(entryData).then(() => {
        showToast("‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        closeModal("returnModal");
    });
}

function exportDataCSV() {
    if(allEntries.length === 0) {
        showToast("‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á!", "error");
        return;
    }
    const data = allEntries.map(e => {
        const itemsStr = (e.items && Array.isArray(e.items))
            ? e.items.map(i => `${i.work} (${i.qty})`).join("; ")
            : e.work;
        return {
            "Memo No": e.memoId ? e.memoId : (e.key ? e.key.slice(-4).toUpperCase() : ''),
            "Date": e.date,
            "Time": e.time,
            "Customer Name": e.note,
            "Phone": e.phone || "",
            "Items": itemsStr,
            "Total Amount": e.total,
            "Paid Amount": e.taken,
            "Due Amount": e.loss,
            "Served By": e.user
        };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const csvOutput = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csvOutput], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "Sales_Report_" + new Date().toISOString().slice(0,10) + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
}

function backupFullData() {
    const fullBackup = {
        meta: {
            app: "Sheikh Photocopy PRO",
            version: "5.6.0",
            backupDate: new Date().toLocaleString(),
            exportedBy: currentUser
        },
        products: allProducts,
        entries: allEntries,
        customers: allCustomers,
        expenses: allExpenses
    };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullBackup, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "Full_Backup_" + new Date().toISOString().slice(0,10) + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    showToast("‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! üíæ", "success");
}

function downloadExcel(type) {
    let data = [];
    let filename = "";
    if (type === 'report') {
        filename = "Sales_Report_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allEntries.map(e => {
            const itemsStr = (e.items && Array.isArray(e.items))
                ? e.items.map(i => `${i.work} (${i.qty})`).join(", ")
                : e.work;
            return {
                "Date": e.date,
                "Time": e.time,
                "Memo No": e.memoId ? e.memoId : e.key.slice(-4).toUpperCase(),
                "Customer": e.note,
                "Phone": e.phone || "",
                "Items": itemsStr,
                "Total (Tk)": e.total,
                "Paid (Tk)": e.taken,
                "Due (Tk)": e.loss,
                "User": e.user
            };
        });
    }
    else if (type === 'stock') {
        filename = "Stock_Inventory_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allProducts.map(p => ({
            "Serial": p.serial || "",
            "Section": p.mainType,
            "Category": p.category,
            "Product Name": p.name,
            "Stock Qty": p.isService ? "Service" : p.qty,
            "Cost Price": p.costPrice || 0,
            "Sell Price": p.sellPrice,
            "Alert Level": p.alertLevel || 5
        }));
    }
    else if (type === 'expense') {
        filename = "Expense_List_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = allExpenses.map(e => ({
            "Date": e.date,
            "Description": e.desc,
            "Category": e.category,
            "Amount (Tk)": e.amount,
            "User": e.user
        }));
    }
    else if (type === 'customer') {
        filename = "Customer_List_" + new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
        data = customerStats.map(c => ({
            "Customer Name": c.name,
            "Phone": c.phone,
            "Total Work (Tk)": c.total,
            "Total Paid (Tk)": c.paid,
            "Current Due (Tk)": c.due
        }));
    }
    if(data.length === 0) {
        showToast("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á!", "error");
        return;
    }
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename + ".xlsx");
    showToast("Excel ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá...", "success");
}

function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";

    document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
    const navId = 'nav-' + id;
    const activeLink = document.getElementById(navId);
    if(activeLink) activeLink.classList.add('active');

    closeSidebar();

    if(id === 'customerManager') loadCustomerManager();
}
function closeSidebar(){ document.getElementById("sidebar").style.left="-300px"; document.getElementById("overlay").style.display="none"; }
function openSidebar(){ document.getElementById("sidebar").style.left="0"; document.getElementById("overlay").style.display="block"; }

function autoFormatPhone(input) {
    let value = input.value.replace(/\D/g, '');
    if(value.length >= 3) {
        const c = allCustomers.find(c => c.phone && c.phone.includes(value));
        if(c) { document.getElementById('note').value = c.name; document.getElementById('phoneSuggestion').innerText = c.name; }
    }
}
function loadAllCustomers() {
    db.ref("customers").on("value", s => {
        allCustomers = [];
        s.forEach(c => {
            let cust = c.val();
            cust.key = c.key;
            allCustomers.push(cust);
        });
        if(document.getElementById("customerManager").style.display === "block") {
            loadCustomerManager();
        }
    });
}

function loadDashboardStats() {
    if(!allEntries || allEntries.length === 0) {
        showToast("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...", "warning");
        return;
    }

    showToast("‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "success");

    const today = new Date().toLocaleDateString("en-GB");
    let totalSales = 0;
    let totalTaken = 0;
    let totalDue = 0;
    let count = 0;

    allEntries.forEach(e => {
        if(e.date === today) {
            totalSales += parseFloat(e.total) || 0;
            totalTaken += parseFloat(e.taken) || 0;
            totalDue += parseFloat(e.loss) || 0;
            count++;
        }
    });

    setText("cCount", count);
    setText("cTotal", totalSales.toLocaleString());
    setText("cTaken", totalTaken.toLocaleString());
    setText("cDue", totalDue.toLocaleString());

    setTimeout(() => {
        setText("cCount", "---");
        setText("cTotal", "---");
        setText("cTaken", "---");
        setText("cDue", "---");
        showToast("‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (Security)", "warning");
    }, 10000);
}


// --- NEW STOCK ADD FUNCTIONS ---
function openAddStockModal(key) {
    const p = allProducts.find(x => x.key === key);
    if(!p) return;

    document.getElementById("addStockKey").value = key;
    setText("addStockName", p.name);
    setText("addStockCurrent", p.qty);
    document.getElementById("addStockQtyInput").value = "";

    document.getElementById("addStockModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
    setTimeout(() => document.getElementById("addStockQtyInput").focus(), 100);
}

function saveAddedStock() {
    const key = document.getElementById("addStockKey").value;
    const addQty = parseFloat(document.getElementById("addStockQtyInput").value);

    if(!addQty || addQty <= 0) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");

    db.ref("products/" + key + "/qty").transaction((currentQty) => {
        return (currentQty || 0) + addQty;
    }).then(() => {
        showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ", "success");
        closeModal("addStockModal");
        logActivity("Stock In", `Added ${addQty} pcs to product ID ${key}`);
    });
}

// --- QUICK ADD PRODUCT LOGIC ---
function openQuickAddModal() {
    document.getElementById("qaName").value = "";
    document.getElementById("qaCategory").value = "";
    document.getElementById("qaSell").value = "";
    document.getElementById("qaCost").value = "";
    document.getElementById("qaQty").value = "";
    document.getElementById("quickAddModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function saveQuickProduct() {
    const section = document.getElementById("qaSection").value;
    const cat = document.getElementById("qaCategory").value.trim();
    const name = document.getElementById("qaName").value.trim();
    const sell = parseFloat(document.getElementById("qaSell").value);
    const cost = parseFloat(document.getElementById("qaCost").value) || 0;
    const qty = parseFloat(document.getElementById("qaQty").value) || 0;

    if(!name || !sell) return showToast("‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "error");

    let maxSerial = 0;
    allProducts.forEach(p => {
        const s = parseInt(p.serial);
        if(!isNaN(s) && s > maxSerial) maxSerial = s;
    });

    const newProd = {
        serial: maxSerial + 1,
        mainType: section,
        category: cat || "General",
        name: name,
        qty: qty,
        isService: false,
        costPrice: cost,
        sellPrice: sell,
        alertLevel: 5
    };

db.ref("products").push(newProd).then((snap) => {
        showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ", "success");
        closeModal("quickAddModal");

        // ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
        const key = snap.key;
        setTimeout(() => {
            selectProductFromSearch(key);
        }, 500);
    });
}

// --- MANUAL SALES REPORT LOGIC ---
function openManualSalesReport() {
    if(!isFullHistoryLoaded) {
        if(confirm("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
            toggleFullHistory(true);
        }
        return;
    }

    const tbody = document.getElementById("manualSalesBody");
    tbody.innerHTML = "";

    let found = false;
    allEntries.forEach(e => {
        if(e.items && Array.isArray(e.items)) {
            e.items.forEach(item => {
                if(item.isManual) {
                    found = true;
                    tbody.innerHTML += `
                    <tr>
                        <td>${e.date}</td>
                        <td style="font-weight:bold; color:#ef4444">${item.work}</td>
                        <td>${item.category}</td>
                        <td>${item.qty}</td>
                        <td>${item.rate}</td>
                        <td>${e.user}</td>
                    </tr>`;
                }
            });
        }
    });

    if(!found) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶∏‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>";
    }

    document.getElementById("manualSalesModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// --- STOCK ADJUSTMENT LOGIC (NEW FEATURE) ---
function searchAdjProduct(query) {
    const resultsDiv = document.getElementById("adjSearchResults");
    if(!query) { resultsDiv.style.display = "none"; return; }

    const matches = allProducts.filter(p =>
        !p.isService && (
            p.name.toLowerCase().includes(query.toLowerCase()) ||
            String(p.serial).includes(query)
        )
    );

    if(matches.length > 0) {
        let html = "";
        matches.forEach(p => {
            html += `<div class="search-item" onclick="selectAdjProduct('${p.key}', '${p.name}')">
                <span>${p.name} (Stock: ${p.qty})</span>
                <b>‡ß≥${p.sellPrice}</b>
            </div>`;
        });
        resultsDiv.innerHTML = html;
        resultsDiv.style.display = "block";
    } else {
        resultsDiv.style.display = "none";
    }
}

function selectAdjProduct(key, name) {
    document.getElementById("adjProductKey").value = key;
    document.getElementById("adjSearch").value = name;
    document.getElementById("adjSearchResults").style.display = "none";
    document.getElementById("adjQty").focus();
}

function saveStockAdjustment() {
    const key = document.getElementById("adjProductKey").value;
    const qty = parseFloat(document.getElementById("adjQty").value);
    const reason = document.getElementById("adjReason").value;

    if(!key || !qty || qty <= 0) return showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!", "error");

    const product = allProducts.find(p => p.key === key);
    if(!product) return;

    if(product.qty < qty) return showToast("‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á!", "error");

    const costPrice = parseFloat(product.costPrice) || 0;
    const totalCost = costPrice * qty;
    const today = new Date().toLocaleDateString("en-GB");

    // ‡ßß. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã (Transaction ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá)
    db.ref("products/" + key + "/qty").transaction(current => (current || 0) - qty).then(() => {

        // ‡ß®. ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö (Expense) ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
        const expData = {
            date: today,
            desc: `Internal Out: ${product.name} (${reason})`,
            category: "Stock Adjustment",
            amount: totalCost,
            user: currentUser
        };
        db.ref("expenses").push(expData);

        // ‡ß©. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        const adjData = {
            date: today,
            time: new Date().toLocaleTimeString(),
            productName: product.name,
            qty: qty,
            reason: reason,
            cost: totalCost,
            user: currentUser
        };
        db.ref("stock_adjustments").push(adjData);

        showToast("‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤! ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "success");
        logActivity("Stock Adjustment", `${reason}: ${qty} ${product.name}`);

        // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        document.getElementById("adjProductKey").value = "";
        document.getElementById("adjSearch").value = "";
        document.getElementById("adjQty").value = "";
    });
}

function loadStockAdjustments() {
    db.ref("stock_adjustments").limitToLast(20).on("value", snap => {
        const tbody = document.getElementById("adjHistoryBody");
        tbody.innerHTML = "";
        const data = [];
        snap.forEach(c => data.push(c.val()));
        data.reverse().forEach(adj => {
            tbody.innerHTML += `<tr>
                <td><small>${adj.date}</small></td>
                <td>${adj.productName}</td>
                <td>${adj.qty}</td>
                <td><span style="color:var(--warning)">${adj.reason}</span></td>
                <td>‡ß≥${adj.cost}</td>
                <td>${adj.user}</td>
            </tr>`;
        });
    });
}

// --- DYNAMIC QUICK BUTTONS LOGIC ---
function loadQuickButtons() {
    db.ref("settings/quickButtons").on("value", snap => {
        const area = document.getElementById("quickActionArea");
        const settingsList = document.getElementById("qbSettingsList");

        if(area) area.innerHTML = "";
        if(settingsList) settingsList.innerHTML = "";

        const buttons = snap.val() || [];

        const colors = [
            {bg: "#e0f2fe", text: "#0369a1", border: "#bae6fd"},
            {bg: "#f0fdf4", text: "#15803d", border: "#bbf7d0"},
            {bg: "#fff7ed", text: "#c2410c", border: "#fed7aa"},
            {bg: "#f3e8ff", text: "#7e22ce", border: "#d8b4fe"},
            {bg: "#fce7f3", text: "#be185d", border: "#fbcfe8"},
            {bg: "#ccfbf1", text: "#0f766e", border: "#99f6e4"},
        ];

        buttons.forEach((btn, index) => {
            const color = colors[index % colors.length];

            if(area) {
                area.innerHTML += `
                <button onclick="executeQuickAdd('${btn.key}')"
                    style="background:${color.bg}; color:${color.text}; padding:10px 15px; width:auto; font-size:13px; border:1px solid ${color.border}; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.05)">
                    ‚ö° ${btn.label}
                </button>`;
            }

            if(settingsList) {
                settingsList.innerHTML += `
                <span style="background:#f1f5f9; padding:5px 10px; border-radius:15px; font-size:12px; border:1px solid #cbd5e1">
                    ${btn.label} <b style="color:red; cursor:pointer; margin-left:5px" onclick="removeQuickButton(${index})">x</b>
                </span>`;
            }
        });

        if(buttons.length === 0 && area) {
            area.innerHTML = `<span style="color:#94a3b8; font-size:12px">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßÅ‡¶á‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®...</span>`;
        }
    });
}

function executeQuickAdd(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if(!product) return showToast("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "error");

    if(!product.isService) {
        let currentCartQty = 0;
        const existingItem = cart.find(i => i.key === productKey);
        if(existingItem) currentCartQty = existingItem.qty;

        if(product.qty <= currentCartQty) {
            playSound('error');
            showToast(`‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑! ‡¶Ü‡¶õ‡ßá: ${product.qty} ‡¶™‡¶ø‡¶∏‡•§`, "warning");
            return;
        }
    }

    const itemIndex = cart.findIndex(i => i.key === productKey);
    if(itemIndex !== -1) {
        cart[itemIndex].qty += 1;
        cart[itemIndex].sub = cart[itemIndex].qty * cart[itemIndex].rate;
    } else {
        cart.push({
            key: product.key,
            work: product.name,
            category: product.category,
            mainType: product.mainType || "General",
            cost: product.costPrice || 0,
            qty: 1,
            rate: parseFloat(product.sellPrice),
            sub: parseFloat(product.sellPrice),
            isService: product.isService,
            isManual: false
        });
    }

    renderCart();
    playSound('success');
    showToast(`${product.name} ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!`, "success");
}

function addQuickButtonSetting() {
    const prodKey = document.getElementById("qbProductSelect").value;
    const label = document.getElementById("qbLabelInput").value.trim();

    if(!prodKey || !label) return showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!", "error");

    db.ref("settings/quickButtons").once("value", snap => {
        const buttons = snap.val() || [];
        buttons.push({ key: prodKey, label: label });
        db.ref("settings/quickButtons").set(buttons).then(() => {
            showToast("‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            document.getElementById("qbLabelInput").value = "";
        });
    });
}

function removeQuickButton(index) {
    if(confirm("‡¶è‡¶á ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        db.ref("settings/quickButtons").once("value", snap => {
            const buttons = snap.val() || [];
            buttons.splice(index, 1);
            db.ref("settings/quickButtons").set(buttons);
        });
    }
}

function updateQuickButtonDropdown() {
    const sel = document.getElementById("qbProductSelect");
    if(!sel) return;

    let html = '<option value="" disabled selected>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>';
    const sorted = [...allProducts].sort((a,b) => a.name.localeCompare(b.name));

    sorted.forEach(p => {
        html += `<option value="${p.key}">${p.name} (${p.category}) - ‡ß≥${p.sellPrice}</option>`;
    });
    sel.innerHTML = html;
}

// --- FIXED ASSET MANAGEMENT WITH DEPRECIATION ---
let allAssets = [];

function saveAsset() {
    const name = document.getElementById("assetName").value.trim();
    const date = document.getElementById("assetDate").value;
    const status = document.getElementById("assetStatus").value;
    const price = parseFloat(document.getElementById("assetPrice").value) || 0;

    if(!name) return showToast("‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "error");

    const assetData = {
        name: name,
        date: date || new Date().toISOString().split('T')[0],
        status: status,
        originalPrice: price, // ‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
        currentValue: price,  // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¶‡¶æ‡¶Æ ‡¶ï‡¶Æ‡¶¨‡ßá
        addedBy: currentUser,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    db.ref("fixed_assets").push(assetData).then(() => {
        showToast("‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        document.getElementById("assetName").value = "";
        document.getElementById("assetPrice").value = "";
    });
}

function loadAssets() {
    db.ref("fixed_assets").on("value", s => {
        allAssets = [];
        let totalCurrentValue = 0;
        const tbody = document.getElementById("assetBody");
        tbody.innerHTML = "";

        s.forEach(c => {
            let a = c.val();
            a.key = c.key;
            // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
            if(!a.originalPrice) a.originalPrice = a.price;
            if(!a.currentValue) a.currentValue = a.price;

            allAssets.push(a);

            if(a.status === 'Active' || a.status === 'Repairing') {
                totalCurrentValue += parseFloat(a.currentValue) || 0;
            }

            let statusColor = '#10b981';
            if(a.status === 'Repairing') statusColor = '#f59e0b';
            if(a.status === 'Damaged') statusColor = '#ef4444';
            if(a.status === 'Sold') statusColor = '#64748b';

            tbody.innerHTML += `
            <tr>
                <td>${a.date}</td>
                <td>
                    <span style="font-weight:bold">${a.name}</span>
                    ${a.lastDepreciation ? `<br><small style="color:#ef4444; font-size:10px">Last Dep: ${a.lastDepreciation}</small>` : ''}
                </td>
                <td><span style="background:${statusColor}20; color:${statusColor}; padding:3px 8px; border-radius:4px; font-size:12px; font-weight:bold">${a.status}</span></td>
                <td style="color:#64748b">‡ß≥ ${a.originalPrice}</td>
                <td style="font-weight:bold; color:#3b82f6">‡ß≥ ${a.currentValue}</td>
                <td>
                    <button onclick="openDepreciationModal('${a.key}', '${a.name}', ${a.currentValue})" style="padding:5px 10px; background:#f59e0b; color:#fff; border:none; border-radius:4px; font-size:12px; cursor:pointer" title="‡¶Æ‡¶æ‡¶® ‡¶ï‡¶Æ‡¶æ‡¶® (Depreciation)">üìâ ‡¶Æ‡¶æ‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®</button>
                    <button class="btn-action btn-delete" onclick="deleteAsset('${a.key}')">üóëÔ∏è</button>
                </td>
            </tr>`;
        });

        setText("totalAssetValue", totalCurrentValue.toLocaleString());
    });
}

// --- DEPRECIATION LOGIC ---
function openDepreciationModal(key, name, currentVal) {
    const percent = prompt(`"${name}" ‡¶è‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¶‡¶æ‡¶Æ ‡ß≥${currentVal}‡•§\n\n‡¶ï‡¶§ ‡¶™‡¶æ‡¶∞‡¶∏‡ßá‡¶®‡ßç‡¶ü (%) ‡¶¶‡¶æ‡¶Æ ‡¶ï‡¶Æ‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶Ø‡ßá‡¶Æ‡¶®: 10, 20)`);

    if(percent) {
        const p = parseFloat(percent);
        if(isNaN(p) || p <= 0 || p > 100) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶æ‡¶∞‡¶∏‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶ú ‡¶¶‡¶ø‡¶®!", "error");

        const lossAmount = Math.round(currentVal * (p / 100));
        const newValue = currentVal - lossAmount;

        if(confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?\n\n‡¶ï‡¶Æ‡¶æ‡¶®‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ‡ß≥${lossAmount} (${p}%)\n‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡¶æ‡¶Æ ‡¶π‡¶¨‡ßá: ‡ß≥${newValue}\n\n‡¶è‡¶ü‡¶ø ‡¶ñ‡¶∞‡¶ö (Expense) ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá‡•§`)) {
            applyDepreciation(key, name, lossAmount, newValue, p);
        }
    }
}

function applyDepreciation(key, name, lossAmount, newValue, percent) {
    const today = new Date().toLocaleDateString("en-GB");

    // ‡ßß. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ü‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    db.ref("fixed_assets/" + key).update({
        currentValue: newValue,
        lastDepreciation: `${today} (-${percent}%)`
    });

    // ‡ß®. ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
    const expData = {
        date: today,
        desc: `Asset Depreciation: ${name} (-${percent}%)`,
        category: "Depreciation Cost", // ‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶ü‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá
        amount: lossAmount,
        user: currentUser,
        isNonCash: true // ‡¶è‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ‡¶¨‡ßá ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶Æ‡¶¨‡ßá
    };

    db.ref("expenses").push(expData).then(() => {
        showToast(`‡¶∏‡¶´‡¶≤! ‡ß≥${lossAmount} ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, "success");
        logActivity("Depreciation", `Reduced value of ${name} by ‡ß≥${lossAmount}`);
    });
}

function deleteAsset(key) {
    if (!sysConfig.perms.delete) return showToast("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    if(confirm("‡¶è‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶‡¶ü‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        db.ref("fixed_assets/"+key).remove();
        showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "warning");
    }
}

window.onbeforeunload = function() {
    if (cart.length > 0) {
        return "‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶õ‡ßá‡•§ ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶¶‡¶ø‡¶≤‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§";
    }
};
</script>
</body>
</html>
