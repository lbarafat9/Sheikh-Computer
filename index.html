<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø - ‡¶™‡ßç‡¶∞‡ßã</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }
        
        body {
            margin: 0;
            background: #f4f7f6;
            color: #2c3e50;
        }
        
        .en {
            font-family: Arial, sans-serif;
        }
        
        header {
            background: #27ae60;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
        }
        
        #loginDiv {
            max-width: 400px;
            margin: 120px auto;
            background: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.1);
            text-align: center;
        }
        
        #loginDiv input {
            margin-bottom: 15px;
        }
        
        #container {
            display: none;
            padding: 20px;
            padding-top: 90px;
            max-width: 1300px;
            margin: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
            position: relative;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 14px;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            outline: none;
            transition: .3s;
            font-size: 15px;
        }
        
        input:focus, select:focus {
            border-color: #27ae60;
            box-shadow: 0 0 5px rgba(39,174,96,.2);
        }
        
        button {
            background: #27ae60;
            color: #fff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 5px;
        }
        
        button:hover {
            background: #219150;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,.05);
            border-top: 5px solid #2ecc71;
            transition: .2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card b {
            font-size: 24px;
            display: block;
            margin-top: 5px;
        }
        
        #menuBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 28px;
            color: #fff;
            cursor: pointer;
            display: none;
            z-index: 1100;
        }
        
        #sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: #fff;
            transition: .3s;
            z-index: 1200;
            padding-top: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,.05);
        }
        
        #sidebar a {
            display: block;
            color: #34495e;
            text-decoration: none;
            padding: 15px 25px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            transition: .2s;
        }
        
        #sidebar a:hover {
            background: #f0fff4;
            color: #27ae60;
            padding-left: 30px;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.4);
            display: none;
            z-index: 1150;
        }
        
        .section {
            display: none;
            animation: fadeIn .4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table-box {
            background: #fff;
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,.03);
            border: 1px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }
        
        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            color: #555;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        
        tr:hover {
            background-color: #fbfbfb;
        }
        
        .btn-action {
            padding: 6px 10px;
            font-size: 14px;
            margin: 0 3px;
            border-radius: 5px;
            width: auto;
            display: inline-block;
        }
        
        .btn-del {
            background: #ffebee;
            color: #c0392b;
            border: 1px solid #ffccd5;
        }
        
        .btn-del:hover {
            background: #c0392b;
            color: #fff;
        }
        
        .btn-edit {
            background: #fff8e1;
            color: #f39c12;
            border: 1px solid #ffe0b2;
        }
        
        .btn-edit:hover {
            background: #f39c12;
            color: #fff;
        }
        
        .btn-print {
            background: #e3f2fd;
            color: #2980b9;
            border: 1px solid #bbdefb;
        }
        
        .btn-print:hover {
            background: #2980b9;
            color: #fff;
        }
        
        .cart-box {
            margin-top: 20px;
            border: 2px dashed #27ae60;
            padding: 20px;
            border-radius: 12px;
            background: #f9fff9;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 15px;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            background: #fff;
            width: 600px;
            max-width: 95%;
            padding: 30px;
            z-index: 1500;
            box-shadow: 0 10px 40px rgba(0,0,0,.2);
            border-radius: 15px;
        }
        
        .user-summary-box {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #8e44ad;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
        }
        
        .low-stock {
            background-color: #fff0f0;
            color: #c0392b;
            font-weight: bold;
        }
        
        .service-badge {
            background: #3498db;
            color: #fff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            z-index: 1000;
            display: none;
        }
        
        .search-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background .2s;
        }
        
        .search-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-item.active {
            background-color: #e8f5e9;
        }
        
        .search-item .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .search-item .product-details {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .no-results {
            padding: 15px;
            text-align: center;
            color: #777;
            font-style: italic;
        }
        
        .temp-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #2ecc71;
            color: #fff;
            border-radius: 6px;
            z-index: 2000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
            animation: slideIn .3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .customer-summary {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
            border-left: 5px solid #3498db;
        }
        
        .customer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }
        
        .due-alert {
            background: #fff0f0;
            border-left: 5px solid #e74c3c;
        }
        
        .paid-alert {
            background: #f0fff4;
            border-left: 5px solid #27ae60;
        }
        
        .validation-warning {
            background: #fff8e1;
            border-left: 5px solid #f39c12;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .validation-error {
            background: #ffebee;
            border-left: 5px solid #e74c3c;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .validation-success {
            background: #e8f5e9;
            border-left: 5px solid #2ecc71;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .phone-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .due-warning {
            color: #e74c3c;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        #stockBody tr.low-stock {
            animation: pulseWarning 2s infinite;
        }
        
        @keyframes pulseWarning {
            0%, 100% { background-color: #fff0f0; }
            50% { background-color: #ffe0e0; }
        }
        
        #stockBody tr.low-stock:hover {
            background-color: #ffd9d9 !important;
        }
        
        .zero-stock {
            background-color: #ffcccc !important;
            color: #b33939;
        }
        
        .stock-alert-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 999;
            font-size: 14px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stock-alert-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
            color: white;
        }
        
        @media (max-width: 768px) {
            .table-box {
                overflow-x: auto;
            }
            table {
                min-width: 800px;
            }
            
            .mobile-stock-form .form-row {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .mobile-stock-form .form-group {
                margin-bottom: 10px;
            }
            
            .mobile-stock-form button {
                height: 50px;
                margin-top: 10px;
            }
            
            .stock-alert-bar {
                bottom: 10px;
                right: 10px;
                left: 10px;
                font-size: 12px;
            }
            
            .stock-alert-notification {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        @media print {
            @page {
                size: A4;
                margin: .8in;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: #fff;
                font-family: 'Times New Roman', serif;
            }
            
            body * {
                visibility: hidden;
            }
            
            #memoModal, #memoModal * {
                visibility: visible !important;
            }
            
            #memoModal {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                box-shadow: none !important;
                border: none !important;
                background: transparent !important;
            }
            
            #memoModal h2 {
                font-size: 32px !important;
                margin-bottom: 5px;
                color: #000 !important;
                text-align: center;
                font-family: 'Hind Siliguri', sans-serif;
            }
            
            #memoModal p, #memoModal span {
                color: #000 !important;
                font-size: 14pt !important;
            }
            
            #memoModal .address {
                font-size: 14px !important;
                text-align: center;
                margin-bottom: 30px;
            }
            
            .memo-meta {
                display: flex;
                justify-content: space-between;
                margin-bottom: 25px;
                border-bottom: 2px solid #000;
                padding-bottom: 15px;
            }
            
            #memoModal table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 14pt;
            }
            
            #memoModal th {
                background: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #000;
                padding: 10px;
                font-weight: bold;
                text-align: center !important;
            }
            
            #memoModal td {
                border: 1px solid #000;
                padding: 10px;
            }
            
            .memo-total-area {
                margin-top: 30px;
                text-align: right;
                font-size: 16pt !important;
            }
            
            .signature-area {
                margin-top: 80px;
                display: flex;
                justify-content: space-between;
                page-break-inside: avoid;
            }
            
            .signature-box {
                text-align: center;
                width: 250px;
            }
            
            .signature-line {
                border-top: 1px solid #000;
                margin-top: 60px;
                padding-top: 10px;
                font-size: 14pt;
            }
            
            .noPrint {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#27ae60;margin-bottom:20px">‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ (Admin/Owner/Roky)">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:15px;margin-bottom:10px;border-bottom:2px solid #2ecc71;background:#f0fdf4" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø / ‡¶∏‡ßá‡¶≤‡¶∏</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</a>
        <a onclick="showSection('customers')">üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</a>
        <a onclick="showSection('expenses')">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</a>
        
        <!-- ‡¶Ü‡ßü-‡¶¨‡ßç‡¶Ø‡ßü ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ -->
        <div style="padding:15px;border-top:1px solid #eee;margin-top:20px;background:#f8f9fa">
            <h5 style="margin:0 0 10px 0;color:#2c3e50">üí∞ ‡¶Ü‡ßü-‡¶¨‡ßç‡¶Ø‡ßü ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h5>
            <div style="margin-bottom:10px">
                <small style="color:#666">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü:</small>
                <div style="font-weight:bold;color:#27ae60" id="monthlySales">‡ß≥ ‡ß¶</div>
            </div>
            <div style="margin-bottom:10px">
                <small style="color:#666">‡¶è‡¶á ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü:</small>
                <div style="font-weight:bold;color:#3498db" id="yearlySales">‡ß≥ ‡ß¶</div>
            </div>
            <div style="margin-bottom:10px">
                <small style="color:#666">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö:</small>
                <div style="font-weight:bold;color:#e74c3c" id="monthlyCost">‡ß≥ ‡ß¶</div>
            </div>
            <div>
                <small style="color:#666">‡¶®‡ßá‡¶ü ‡¶≤‡¶æ‡¶≠:</small>
                <div style="font-weight:bold;color:#9b59b6" id="netProfitSide">‡ß≥ ‡ß¶</div>
            </div>
        </div>
        
        <a onclick="logout()" style="color:#e74c3c;margin-top:20px;border-top:1px solid #eee">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>
    <div id="dashboard" class="section">
    <div class="stats en">
        <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
        <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßá‡¶≤ (‡ß≥)<br><b id="cTotal">0</b></div>
        <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ (‡ß≥)<br><b id="cTaken">0</b></div>
        <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cDue">0</b></div>
    </div>
    
    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó: ‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ -->
    <div class="table-box" style="margin-bottom:25px;border-left:5px solid #e74c3c">
        <h4 style="padding:15px;margin:0;background:#f9f9f9;border-bottom:1px solid #eee;color:#e74c3c">
            ‚ö†Ô∏è ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡ßß‡ß¶)
        </h4>
        <table>
            <thead>
                <tr>
                    <th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>
                    <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                    <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                    <th>‡¶∏‡¶Æ‡ßü</th>
                    <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
            </thead>
            <tbody id="dueListBody">
                <tr><td colspan="5" style="text-align:center;padding:20px;color:#777">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:25px">
        <div class="card" style="border-top-color:#9b59b6">
            <div style="font-size:14px;color:#666">‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶á‡¶°</div>
            <b id="computerSales">‡ß≥ ‡ß¶</b>
        </div>
        <div class="card" style="border-top-color:#3498db">
            <div style="font-size:14px;color:#666">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶æ‡¶á‡¶°</div>
            <b id="photocopySales">‡ß≥ ‡ß¶</b>
        </div>
        <div class="card" style="border-top-color:#e67e22">
            <div style="font-size:14px;color:#666">‡¶ú‡¶ø‡¶®‡¶ø‡¶∏‡¶™‡¶§‡ßç‡¶∞ ‡¶∏‡¶æ‡¶á‡¶°</div>
            <b id="stationerySales">‡ß≥ ‡ß¶</b>
        </div>
        <div class="card" style="border-top-color:#2ecc71">
            <div style="font-size:14px;color:#666">‡¶®‡ßá‡¶ü ‡¶≤‡¶æ‡¶≠</div>
            <b id="netProfit">‡ß≥ ‡ß¶</b>
        </div>
    </div>
    
    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó: ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® -->
    <div style="background:#e8f5e9;padding:20px;border-radius:12px;margin-bottom:25px;border:2px dashed #27ae60">
        <h4 style="margin-top:0;color:#27ae60">‚ö° ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:10px">
            <button onclick="quickSale('A4 ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø', 2, 10)" style="background:#3498db">A4 ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø<br><small>‡ß® ‡¶ü‡¶æ‡¶ï‡¶æ √ó ‡ßß‡ß¶‡¶™‡ßá‡¶á‡¶ú = ‡ß®‡ß¶‡ß≥</small></button>
            <button onclick="quickSale('‡¶ï‡¶æ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 3, 1)" style="background:#2c3e50;color:white">‡¶ï‡¶æ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü<br><small>‡ß© ‡¶ü‡¶æ‡¶ï‡¶æ/‡¶™‡ßá‡¶á‡¶ú</small></button>
            <button onclick="quickSale('‡¶∞‡¶ô‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 10, 1)" style="background:#e74c3c;color:white">‡¶∞‡¶ô‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü<br><small>‡ßß‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ/‡¶™‡ßá‡¶á‡¶ú</small></button>
            <button onclick="quickSale('‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø (‡¶è‡¶ï‡¶™‡¶æ‡¶∂)', 1.5, 20)" style="background:#27ae60">‡¶è‡¶ï‡¶™‡¶æ‡¶∂ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø<br><small>‡ßß.‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ √ó ‡ß®‡ß¶ = ‡ß©‡ß¶‡ß≥</small></button>
            <button onclick="quickSale('‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø (‡¶¶‡ßÅ‡¶á‡¶™‡¶æ‡¶∂)', 2.5, 10)" style="background:#f39c12">‡¶¶‡ßÅ‡¶á‡¶™‡¶æ‡¶∂ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø<br><small>‡ß®.‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ √ó ‡ßß‡ß¶ = ‡ß®‡ß´‡ß≥</small></button>
            <button onclick="showSection('newEntry')" style="background:#9b59b6">‚ûï ‡¶Ü‡¶∞‡ßã ‡¶™‡¶£‡ßç‡¶Ø<br><small>‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</small></button>
        </div>
    </div>
    
    <div class="user-summary-box">
        <h4 style="margin:0 0 15px 0;color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
        <div class="table-box" style="box-shadow:none;border:1px solid #eee">
            <table class="en">
                <thead>
                    <tr>
                        <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                        <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th>
                        <th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th>
                        <th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th>
                    </tr>
                </thead>
                <tbody id="userSummaryBody">
                    <tr>
                        <td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05)">
        <canvas id="salesChart" height="80"></canvas>
    </div>
    
    <div class="table-box">
        <h4 style="padding:15px;margin:0;background:#f9f9f9;border-bottom:1px solid #eee">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
        <table class="en">
            <thead>
                <tr>
                    <th>‡¶∏‡¶Æ‡ßü</th>
                    <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                    <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                    <th>‡¶Æ‡ßã‡¶ü</th>
                    <th>‡¶®‡¶ó‡¶¶</th>
                    <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                    <th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                    <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>
    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
    <div id="newEntry" class="section">
        <div style="max-width:600px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0;color:#2c3e50;border-bottom:2px solid #eee;padding-bottom:10px">
                ‚ö° ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶´‡¶∞‡ßç‡¶Æ
                <span style="float:right;font-size:14px;color:#27ae60">üî¥ ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∏‡ßç‡¶ü‡¶ï</span>
            </h3>
            
            <!-- ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó -->
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label>
                <select id="saleType" onchange="changeSaleType()">
                    <option value="photocopy">üì∑ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶æ‡¶á‡¶°</option>
                    <option value="computer">üíª ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶á‡¶°</option>
                    <option value="stationery">üìö ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏‡¶™‡¶§‡ßç‡¶∞ ‡¶∏‡¶æ‡¶á‡¶°</option>
                </select>
            </div>
            
            <!-- ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö -->
            <div class="form-group" style="background:#e8f5e9;padding:15px;border:1px dashed #27ae60;border-radius:8px;margin-bottom:20px">
                <label>üîç ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö (‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤/‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®):</label>
                <input id="searchSerial" type="text" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: A4, Pen, CV Print..." 
                       class="en" autocomplete="off" onkeyup="quickSearchProduct()">
                <div id="searchResults" class="search-results"></div>
                <small style="color:#666;display:block;margin-top:5px">‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá Enter ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</small>
            </div>
            
            <!-- ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶æ‡¶ü‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó) -->
            <div style="background:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #3498db">
                <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px">
                    <button type="button" onclick="addQuickProduct('A4 ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø', 2)" style="padding:10px;font-size:13px">
                        A4 ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø<br><small>‡ß® ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                    <button type="button" onclick="addQuickProduct('A4 ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 3)" style="padding:10px;font-size:13px;background:#2c3e50;color:white">
                        A4 ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü<br><small>‡ß© ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                    <button type="button" onclick="addQuickProduct('‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø (‡¶¶‡ßÅ‡¶á‡¶™‡¶æ‡¶∂)', 2.5)" style="padding:10px;font-size:13px;background:#f39c12">
                        ‡¶¶‡ßÅ‡¶á‡¶™‡¶æ‡¶∂<br><small>‡ß®.‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                    <button type="button" onclick="addQuickProduct('CV ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 30)" style="padding:10px;font-size:13px;background:#9b59b6;color:white">
                        CV ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü<br><small>‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                    <button type="button" onclick="addQuickProduct('‡¶´‡¶ü‡ßã ‡ß™R', 15)" style="padding:10px;font-size:13px;background:#e74c3c;color:white">
                        ‡¶´‡¶ü‡ßã ‡ß™R<br><small>‡ßß‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                    <button type="button" onclick="addQuickProduct('‡¶≤‡ßá‡¶Æ‡¶ø‡¶®‡ßá‡¶∂‡¶®', 20)" style="padding:10px;font-size:13px;background:#1abc9c;color:white">
                        ‡¶≤‡ßá‡¶Æ‡¶ø‡¶®‡ßá‡¶∂‡¶®<br><small>‡ß®‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</small>
                    </button>
                </div>
            </div>
            
            <!-- ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶´‡¶∞‡ßç‡¶Æ -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
                <div class="form-group">
                    <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                    <select id="category" onchange="filterProducts()">
                        <option value="">=== ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>
                        <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú/‡¶™‡ßá‡¶™‡¶æ‡¶∞</option>
                        <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                        <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                        <option value="Service">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</option>
                        <option value="Stationery">‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>‡¶™‡¶£‡ßç‡¶Ø:</label>
                    <select id="work" onchange="autoFillPrice()">
                        <option value="">‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                    </select>
                </div>
            </div>
            
            <!-- ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶ì ‡¶¶‡¶∞ -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                <div class="form-group">
                    <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                    <input id="qty" type="number" value="1" min="1" class="en" 
                           onkeydown="if(event.key==='Enter') addToCart()">
                </div>
                <div class="form-group">
                    <label>‡¶¶‡¶∞ (‡ß≥):</label>
                    <input id="rate" type="number" class="en" 
                           onkeydown="if(event.key==='Enter') addToCart()">
                </div>
            </div>
            
            <!-- ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ‡¶ü‡¶® -->
            <button onclick="addToCart()" style="background:#3498db;margin-bottom:20px;padding:12px;font-size:16px">
                üõí ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (Add to Cart)
            </button>
            
            <!-- ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0;border-bottom:1px dashed #aaa;padding-bottom:5px">
                    üõí ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
                    <span style="float:right;font-size:14px;color:#27ae60" id="cartCount">‡ß¶‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</span>
                </h4>
                <div id="cartList"></div>
                
                <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø -->
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #ddd">
                    <h4 style="margin-top:0;color:#2c3e50;font-size:16px">üë§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                        <div class="form-group">
                            <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
                            <input id="note" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                                   oninput="checkCustomerName()">
                            <small style="color:#666">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶π‡¶≤‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
                        </div>
                        <div class="form-group">
                            <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
                            <input id="phone" placeholder="017-XXXX-XXXX" class="en" 
                                   maxlength="13" onblur="autoFillCustomerName(this.value)">
                            <small style="color:#666">‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶∏‡¶¨‡ßá</small>
                        </div>
                    </div>
                    
                    <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ö‡¶ü‡ßã-‡¶´‡¶ø‡¶≤ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú -->
                    <div id="customerValidation"></div>
                </div>
                
                <!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø -->
                <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin-bottom:15px">
                    <h4 style="margin-top:0;color:#2c3e50;font-size:16px">üíµ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                        <div class="form-group">
                            <label>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</label>
                            <input id="total" readonly class="en" value="0" 
                                   style="background:#fff;font-weight:bold;font-size:16px">
                        </div>
                        <div class="form-group">
                            <label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ:</label>
                            <input id="taken" type="number" class="en" value="0" 
                                   oninput="validatePayment()" onkeyup="validatePayment()">
                            <small style="color:#666">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶® ‡¶ï‡¶ø‡¶®‡¶æ</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="color:#e74c3c">‡¶¨‡¶æ‡¶ï‡¶ø:</label>
                        <input id="due" readonly class="en" value="0" 
                               style="background:#fff;color:#e74c3c;font-weight:bold;font-size:16px">
                        <div id="paymentValidation"></div>
                    </div>
                </div>
                
                <!-- ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç -->
                <div id="finalWarning" style="display:none"></div>
                
                <!-- ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px">
                    <button onclick="validateAndSave(false)" style="background:#f39c12;padding:12px">
                        üíæ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button onclick="validateAndSave(true)" style="background:#2ecc71;padding:12px">
                        üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
                    </button>
                </div>
                
                <!-- ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶´‡ßá‡¶∞‡¶§ ‡¶¨‡¶æ‡¶ü‡¶® (‡¶®‡¶§‡ßÅ‡¶®) -->
                <div style="margin-top:15px;text-align:center">
                    <button onclick="returnLastSale()" style="background:#e74c3c;padding:10px 20px;font-size:14px;width:auto">
                        ‚Ü©Ô∏è ‡¶∂‡ßá‡¶∑ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶®
                    </button>
                    <small style="display:block;color:#666;margin-top:5px">
                        ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶≤‡ßá ‡¶∂‡ßá‡¶∑ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï/‡¶è‡¶°‡¶Æ‡¶ø‡¶®)
                    </small>
                </div>
            </div>
        </div>
    </div>
    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ -->
        <!-- ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
    <div id="inventory" class="section">
        <div style="max-width:1200px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05)">
            <h3 style="border-bottom:2px solid #3498db;padding-bottom:10px;color:#2c3e50;margin-top:0">
                üì¶ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
                <span id="stockAlertBar" class="stock-alert-bar" style="display:none;position:relative;top:0;right:0;margin-left:20px"></span>
            </h3>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
            <div id="liveStockAlert" style="display:none;background:#fff8e1;padding:15px;border-radius:8px;border-left:5px solid #f39c12;margin-bottom:25px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong style="color:#e74c3c">‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!</strong>
                        <span id="alertMessage">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                    </div>
                    <button onclick="showSection('inventory')" style="background:#f39c12;color:white;padding:5px 15px;border-radius:4px">
                        ‡¶∏‡ßç‡¶ü‡¶ï ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </button>
                </div>
            </div>
            
            <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶´‡¶∞‡ßç‡¶Æ -->
            <div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:30px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#3498db;display:flex;align-items:center;gap:10px">
                    <span>‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    <span style="font-size:14px;color:#666;background:#e3f2fd;padding:3px 10px;border-radius:12px">
                        <span id="productCount">0</span>‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø
                    </span>
                </h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px">
                    <div class="form-group">
                        <label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶°:</label>
                        <input id="stSerial" class="en" placeholder="P-001, S-002">
                    </div>
                    <div class="form-group">
                        <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                        <select id="stCategory">
                            <option value="">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú/‡¶™‡ßá‡¶™‡¶æ‡¶∞</option>
                            <option value="Pen">‡¶ï‡¶≤‡¶Æ/‡¶™‡ßá‡¶®</option>
                            <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ/‡¶®‡ßã‡¶ü‡¶¨‡ßÅ‡¶ï</option>
                            <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                            <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                            <option value="Service">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</option>
                            <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
                        <input id="stName" placeholder="A4 Paper, Matador Pen, Student Khata">
                    </div>
                </div>
                
                <!-- ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ö‡ßá‡¶ï‡¶¨‡¶ï‡ßç‡¶∏ -->
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #90caf9">
                    <div style="display:flex;align-items:center;gap:10px">
                        <input type="checkbox" id="stIsService" style="width:20px;height:20px;margin:0" onchange="toggleStockInput()">
                        <label for="stIsService" style="margin:0;cursor:pointer;font-weight:bold;color:#1565c0">
                            üì± ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü)
                        </label>
                    </div>
                </div>
                
                <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®‡¶™‡ßÅ‡¶ü -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                    <div class="form-group">
                        <label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                        <input id="stQty" type="number" class="en" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï:</label>
                        <input id="stMinStock" type="number" class="en" placeholder="5" min="1" value="5">
                        <small style="color:#666">‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶§ ‡¶π‡¶≤‡ßá ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶¨‡ßá</small>
                    </div>
                </div>
                
                <!-- ‡¶¶‡¶æ‡¶Æ -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                    <div class="form-group">
                        <label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (‡ß≥):</label>
                        <input id="stCost" type="number" class="en" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥):</label>
                        <input id="stSell" type="number" class="en" placeholder="0" min="0">
                    </div>
                </div>
                
                <!-- ‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ‡¶ü‡¶® -->
                <div style="display:flex;justify-content:flex-end;gap:10px">
                    <button onclick="clearStockForm()" style="background:#95a5a6;width:120px">
                        ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞
                    </button>
                    <button onclick="addNewProduct()" style="background:#2ecc71;width:150px;font-weight:bold">
                        ‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ì ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ -->
            <div style="display:flex;gap:10px;margin-bottom:20px;align-items:flex-end">
                <div style="flex:1">
                    <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞:</label>
                    <select id="filterCategory" style="width:100%" onchange="filterStockTable()">
                        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>
                        <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú</option>
                        <option value="Pen">‡¶ï‡¶≤‡¶Æ</option>
                        <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ</option>
                        <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                        <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                        <option value="Service">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®:</label>
                    <input type="text" id="stockSearch" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                           style="width:100%" onkeyup="filterStockTable()">
                </div>
                <button onclick="exportStockToExcel()" style="height:46px;background:#27ae60;width:120px">
                    üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤
                </button>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
            <div class="table-box" style="margin-top:10px">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-bottom:1px solid #eee">
                    <h4 style="margin:0">‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</h4>
                    <div style="color:#666;font-size:14px">
                        ‡¶Æ‡ßã‡¶ü: <span id="totalProducts">0</span> | 
                        ‡¶ï‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï: <span id="lowStockCount" style="color:#f39c12;font-weight:bold">0</span> | 
                        ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø: <span id="zeroStockCount" style="color:#e74c3c;font-weight:bold">0</span>
                    </div>
                </div>
                
                <div style="overflow-x:auto">
                    <table style="min-width:1000px">
                        <thead>
                            <tr>
                                <th width="80">‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</th>
                                <th width="120">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th>
                                <th>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                <th width="80">‡¶∏‡ßç‡¶ü‡¶ï</th>
                                <th width="80">‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ</th>
                                <th width="100">‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ</th>
                                <th width="100">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                                <th width="150" class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="stockBody" class="en">
                            <tr>
                                <td colspan="8" style="text-align:center;padding:30px;color:#777">
                                    ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø -->
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-top:30px">
                <div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #2ecc71">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶™‡¶£‡ßç‡¶Ø ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</div>
                    <div style="font-size:24px;font-weight:bold;color:#27ae60">‡ß≥<span id="totalStockValue">0</span></div>
                </div>
                <div style="background:#fff8e1;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #f39c12">
                    <div style="font-size:14px;color:#666">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</div>
                    <div style="font-size:24px;font-weight:bold;color:#f39c12"><span id="totalItemsCount">0</span></div>
                </div>
                <div style="background:#ffebee;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #e74c3c">
                    <div style="font-size:14px;color:#666">‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï</div>
                    <div style="font-size:24px;font-weight:bold;color:#e74c3c"><span id="zeroStockItems">0</span></div>
                </div>
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #3498db">
                    <div style="font-size:14px;color:#666">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</div>
                    <div style="font-size:24px;font-weight:bold;color:#3498db"><span id="serviceItemsCount">0</span></div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ -->
        <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
    <div id="customers" class="section">
        <div style="max-width:1200px;margin:auto">
            <h3 style="border-bottom:2px solid #3498db;padding-bottom:10px;color:#2c3e50;margin-top:0">
                üë• ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
                <span style="font-size:14px;color:#666;background:#f0f7ff;padding:3px 10px;border-radius:12px;margin-left:10px">
                    ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç
                </span>
            </h3>
            
            <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö -->
            <div style="background:#e8f5e9;padding:20px;border-radius:10px;margin-bottom:20px;border:1px solid #27ae60">
                <h4 style="margin-top:0;color:#27ae60">üîç ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h4>
                <p style="margin-top:0;color:#666;font-size:14px">
                    ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                </p>
                
                <div style="display:flex;gap:10px;align-items:flex-end">
                    <div style="flex:1">
                        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                        <input type="text" id="searchCustomerInput" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 017... ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡¶π‡¶ø‡¶Æ..." 
                               style="width:100%" onkeydown="if(event.key==='Enter') searchCustomer()">
                    </div>
                    <button onclick="searchCustomer()" style="width:120px;height:46px;margin-top:20px">
                        üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                    </button>
                </div>
                
                <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
                    <button onclick="loadAllCustomers()" style="background:#3498db;padding:8px 15px;font-size:13px;width:auto">
                        üë• ‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï
                    </button>
                    <button onclick="showDueCustomers()" style="background:#e74c3c;padding:8px 15px;font-size:13px;width:auto">
                        ‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶ï‡¶ø‡¶∞‡¶æ
                    </button>
                    <button onclick="showCustomersWithPhone()" style="background:#9b59b6;padding:8px 15px;font-size:13px;width:auto">
                        üì± ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶π
                    </button>
                </div>
            </div>
            
            <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ -->
            <div id="customerDetails" style="display:none;background:#fff;padding:25px;border-radius:10px;margin-bottom:20px;border:1px solid #ddd;box-shadow:0 4px 6px rgba(0,0,0,.05)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h4 style="margin:0;color:#3498db" id="customerNameTitle">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                    <div style="display:flex;gap:10px">
                        <button onclick="printCustomerReceipt()" style="background:#3498db;padding:8px 16px;width:auto;font-size:14px">
                            üñ®Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶∂‡¶ø‡¶¶
                        </button>
                        <button onclick="addPayment()" style="background:#2ecc71;padding:8px 16px;width:auto;font-size:14px">
                            üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ
                        </button>
                        <button onclick="editCustomer()" style="background:#f39c12;padding:8px 16px;width:auto;font-size:14px">
                            ‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü
                        </button>
                        <button onclick="clearCustomerSearch()" style="background:#e74c3c;padding:8px 16px;width:auto;font-size:14px">
                            ‚úñÔ∏è ‡¶¨‡¶®‡ßç‡¶ß
                        </button>
                    </div>
                </div>
                <div id="customerInfo"></div>
            </div>
            
            <!-- ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ -->
            <div id="customerHistorySection" style="display:none;margin-bottom:30px">
                <h4 style="border-bottom:1px solid #eee;padding-bottom:8px;color:#2c3e50">
                    üìú ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏
                    <span style="float:right;font-size:14px;color:#666" id="historyCount"></span>
                </h4>
                <div class="table-box">
                    <table>
                        <thead>
                            <tr>
                                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç</th>
                                <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</th>
                                <th>‡¶ú‡¶Æ‡¶æ</th>
                                <th>‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="customerTransactions"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
            <div class="table-box">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-bottom:1px solid #eee">
                    <h4 style="margin:0">‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡¶π)</h4>
                    <div style="color:#666;font-size:14px">
                        ‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: <span id="totalCustomerCount">0</span> | 
                        ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: <span id="totalDueAmount" style="color:#e74c3c;font-weight:bold">‡ß≥0</span>
                    </div>
                </div>
                
                <div style="overflow-x:auto">
                    <table style="min-width:1000px">
                        <thead>
                            <tr>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                                <th>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</th>
                                <th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                <th>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</th>
                                <th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="allCustomers">
                            <tr>
                                <td colspan="7" style="text-align:center;padding:20px;color:#777">
                                    ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ú‡¶Æ‡¶æ ‡¶´‡¶∞‡ßç‡¶Æ -->
            <div style="background:#fff8e1;padding:20px;border-radius:10px;margin-top:30px;border:1px solid #f39c12">
                <h4 style="margin-top:0;color:#f39c12">üíµ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:10px">
                    <div class="form-group">
                        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
                        <input id="quickCustomerName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
                        <input id="quickCustomerPhone" placeholder="017-XXXX-XXXX" class="en">
                    </div>
                    <div class="form-group">
                        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
                        <input id="quickPaymentAmount" type="number" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" class="en">
                    </div>
                </div>
                <button onclick="quickPayment()" style="background:#f39c12;padding:12px">
                    üí∞ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <small style="display:block;color:#666;margin-top:10px">
                    ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø "‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø" ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                </small>
            </div>
        </div>
    </div>
    <!-- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ -->
        <!-- ‡¶ñ‡¶∞‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
    <div id="expenses" class="section">
        <div style="max-width:1200px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0;color:#2c3e50;border-bottom:2px solid #eee;padding-bottom:10px">
                üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
                <span style="float:right;font-size:14px;color:#666;background:#ffeaa7;padding:3px 10px;border-radius:12px">
                    ‡¶®‡ßá‡¶ü ‡¶≤‡¶æ‡¶≠ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞
                </span>
            </h3>
            
            <!-- ‡¶ñ‡¶∞‡¶ö ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ -->
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:25px">
                <div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #27ae60">
                    <div style="font-size:14px;color:#666">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</div>
                    <div style="font-size:24px;font-weight:bold;color:#27ae60">‡ß≥<span id="monthlySalesExpense">0</span></div>
                </div>
                <div style="background:#ffebee;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #e74c3c">
                    <div style="font-size:14px;color:#666">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</div>
                    <div style="font-size:24px;font-weight:bold;color:#e74c3c">‡ß≥<span id="monthlyExpenseTotal">0</span></div>
                </div>
                <div style="background:#fff8e1;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #f39c12">
                    <div style="font-size:14px;color:#666">‡¶®‡ßá‡¶ü ‡¶≤‡¶æ‡¶≠</div>
                    <div style="font-size:24px;font-weight:bold;color:#f39c12">‡ß≥<span id="netProfitDisplay">0</span></div>
                </div>
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #3498db">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö (‡¶¨‡¶õ‡¶∞)</div>
                    <div style="font-size:24px;font-weight:bold;color:#3498db">‡ß≥<span id="yearlyExpenseTotal">0</span></div>
                </div>
            </div>
            
            <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶´‡¶∞‡ßç‡¶Æ -->
            <div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:30px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#e74c3c;display:flex;align-items:center;gap:10px">
                    <span>‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    <span style="font-size:14px;color:#666;background:#ffebee;padding:3px 10px;border-radius:12px">
                        <span id="expenseCount">0</span>‡¶ü‡¶ø ‡¶ñ‡¶∞‡¶ö
                    </span>
                </h4>
                
                <div class="form-group">
                    <label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label>
                    <input id="expenseDesc" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤, ‡¶≠‡¶æ‡ßú‡¶æ, ‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§, ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞">
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px">
                    <div class="form-group">
                        <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
                        <input id="expenseAmount" type="number" class="en" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input id="expenseDate" type="date" class="en" value="">
                    </div>
                    <div class="form-group">
                        <label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£:</label>
                        <select id="expenseCategory">
                            <option value="utility">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏/‡¶™‡¶æ‡¶®‡¶ø</option>
                            <option value="rent">‡¶≠‡¶æ‡ßú‡¶æ</option>
                            <option value="salary">‡¶¨‡ßá‡¶§‡¶®</option>
                            <option value="maintenance">‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§</option>
                            <option value="purchase">‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡¶æ</option>
                            <option value="transport">‡¶Ø‡¶æ‡¶®‡¶¨‡¶æ‡¶π‡¶®</option>
                            <option value="other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex;justify-content:flex-end;gap:10px">
                    <button onclick="clearExpenseForm()" style="background:#95a5a6;width:120px">
                        ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞
                    </button>
                    <button onclick="addExpense()" style="background:#e74c3c;width:150px;font-weight:bold">
                        ‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
            
            <!-- ‡¶ñ‡¶∞‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ -->
            <div style="display:flex;gap:10px;margin-bottom:20px;align-items:flex-end">
                <div style="flex:1">
                    <label>‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:</label>
                    <select id="expenseMonthFilter" style="width:100%" onchange="filterExpenses()">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶Æ‡¶æ‡¶∏</option>
                        <option value="01">‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø</option>
                        <option value="02">‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø</option>
                        <option value="03">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</option>
                        <option value="04">‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</option>
                        <option value="05">‡¶Æ‡ßá</option>
                        <option value="06">‡¶ú‡ßÅ‡¶®</option>
                        <option value="07">‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</option>
                        <option value="08">‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</option>
                        <option value="09">‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                        <option value="10">‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞</option>
                        <option value="11">‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                        <option value="12">‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞</option>
                    </select>
                </div>
                <div style="flex:2">
                    <label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£:</label>
                    <select id="expenseTypeFilter" style="width:100%" onchange="filterExpenses()">
                        <option value="all">‡¶∏‡¶¨ ‡¶ß‡¶∞‡¶£</option>
                        <option value="utility">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏/‡¶™‡¶æ‡¶®‡¶ø</option>
                        <option value="rent">‡¶≠‡¶æ‡ßú‡¶æ</option>
                        <option value="salary">‡¶¨‡ßá‡¶§‡¶®</option>
                        <option value="maintenance">‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§</option>
                        <option value="purchase">‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡¶æ</option>
                        <option value="transport">‡¶Ø‡¶æ‡¶®‡¶¨‡¶æ‡¶π‡¶®</option>
                        <option value="other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
                    </select>
                </div>
                <button onclick="exportExpensesToExcel()" style="height:46px;background:#27ae60;width:120px">
                    üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤
                </button>
            </div>
            
            <!-- ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ -->
            <div class="table-box" style="margin-bottom:30px">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-bottom:1px solid #eee">
                    <h4 style="margin:0">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h4>
                    <div style="color:#666;font-size:14px">
                        ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: <span id="filteredExpenseTotal" style="color:#e74c3c;font-weight:bold">‡ß≥0</span>
                    </div>
                </div>
                
                <div style="overflow-x:auto">
                    <table style="min-width:800px">
                        <thead>
                            <tr>
                                <th width="100">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th width="120">‡¶ß‡¶∞‡¶£</th>
                                <th width="120">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                <th width="120" class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="expenseList">
                            <tr>
                                <td colspan="5" style="text-align:center;padding:30px;color:#777">
                                    ‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶ñ‡¶∞‡¶ö ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ -->
            <div style="background:#f8f9fa;padding:25px;border-radius:10px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#2c3e50">üìä ‡¶ñ‡¶∞‡¶ö ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px">
                    <div>
                        <h5 style="color:#666;margin-bottom:15px">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ</h5>
                        <canvas id="expenseChart" height="200"></canvas>
                    </div>
                    <div>
                        <h5 style="color:#666;margin-bottom:15px">‡¶Æ‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ñ‡¶∞‡¶ö</h5>
                        <canvas id="monthlyExpenseChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‡¶ñ‡¶∞‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ -->
        <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
    <div id="reports" class="section">
        <div class="noPrint" style="max-width:1200px;margin:auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="text-align:center;margin-top:0;color:#2c3e50;border-bottom:2px solid #eee;padding-bottom:15px">
                üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞
            </h3>
            
            <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡ßÅ‡¶≤‡¶∏ -->
            <div style="background:#f8f9fa;padding:25px;border-radius:10px;margin-bottom:30px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#3498db;margin-bottom:20px">üîç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px">
                    <div class="form-group">
                        <label>‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input type="date" id="startDate" class="en" style="margin:0">
                    </div>
                    <div class="form-group">
                        <label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input type="date" id="endDate" class="en" style="margin:0">
                    </div>
                    <div class="form-group">
                        <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label>
                        <select id="reportSaleType" style="margin:0">
                            <option value="all">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option>
                            <option value="photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                            <option value="computer">‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞</option>
                            <option value="stationery">‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                    <div class="form-group">
                        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
                        <input type="text" id="reportCustomerSearch" placeholder="‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." style="margin:0">
                    </div>
                    <div class="form-group">
                        <label>‡¶á‡¶â‡¶ú‡¶æ‡¶∞:</label>
                        <select id="reportUserFilter" style="margin:0">
                            <option value="all">‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</option>
                            <option value="admin">Admin</option>
                            <option value="owner">Owner</option>
                            <option value="roky">Roky</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;justify-content:center">
                    <button onclick="generateReport()" style="background:#3498db;padding:12px 30px;width:auto">
                        üîç ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button onclick="resetReportFilter()" style="background:#95a5a6;padding:12px 30px;width:auto">
                        üîÑ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
                    </button>
                </div>
            </div>
            
            <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø -->
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:25px">
                <div style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #27ae60">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</div>
                    <div style="font-size:24px;font-weight:bold;color:#27ae60">‡ß≥<span id="reportTotalSales">0</span></div>
                </div>
                <div style="background:#fff8e1;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #f39c12">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶®‡¶ó‡¶¶</div>
                    <div style="font-size:24px;font-weight:bold;color:#f39c12">‡ß≥<span id="reportTotalCash">0</span></div>
                </div>
                <div style="background:#ffebee;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #e74c3c">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø</div>
                    <div style="font-size:24px;font-weight:bold;color:#e74c3c">‡ß≥<span id="reportTotalDue">0</span></div>
                </div>
                <div style="background:#e3f2fd;padding:15px;border-radius:8px;text-align:center;border-top:4px solid #3498db">
                    <div style="font-size:14px;color:#666">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</div>
                    <div style="font-size:24px;font-weight:bold;color:#3498db"><span id="reportTotalEntries">0</span></div>
                </div>
            </div>
            
            <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
            <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:10px;margin-bottom:20px">
                <button onclick="loadReportData()" style="background:#7f8c8d">
                    üìã ‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ
                </button>
                <button onclick="downloadExcel()" style="background:#2ecc71">
                    üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                </button>
                <button onclick="printReport()" style="background:#9b59b6">
                    üñ®Ô∏è ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
                </button>
                <button onclick="showDailyReport()" style="background:#3498db">
                    üìÖ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
                </button>
                <button onclick="showMonthlyReport()" style="background:#f39c12">
                    üìà ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
                </button>
            </div>
            
            <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ -->
            <div class="table-box" style="border:1px solid #ddd;margin-bottom:30px">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-bottom:1px solid #eee">
                    <h4 style="margin:0">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h4>
                    <div style="color:#666;font-size:14px">
                        ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã: <span id="reportShowingCount">0</span>‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø
                    </div>
                </div>
                
                <div style="overflow-x:auto">
                    <table class="en" style="min-width:1000px">
                        <thead>
                            <tr>
                                <th width="120">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ/‡¶∏‡¶Æ‡ßü</th>
                                <th width="150">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï/‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th width="100">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                                <th width="80">‡¶Æ‡ßã‡¶ü</th>
                                <th width="80">‡¶®‡¶ó‡¶¶</th>
                                <th width="80">‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                <th width="80">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</th>
                                <th width="80">‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th>
                                <th width="150" class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr>
                                <td colspan="9" style="text-align:center;padding:30px;color:#777">
                                    ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ -->
            <div style="background:#f8f9fa;padding:25px;border-radius:10px;border:1px solid #ddd">
                <h4 style="margin-top:0;color:#2c3e50;margin-bottom:20px">üìà ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px">
                    <div>
                        <h5 style="color:#666;margin-bottom:15px">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</h5>
                        <canvas id="salesByCategoryChart" height="200"></canvas>
                    </div>
                    <div>
                        <h5 style="color:#666;margin-bottom:15px">‡¶Æ‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</h5>
                        <canvas id="monthlySalesChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ -->
    <!-- ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∂‡ßÅ‡¶∞‡ßÅ -->
<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0;color:#2ecc71;font-weight:800;font-size:28px">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:5px 0 0 0;color:#555">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
        <p class="address" style="margin:5px 0 20px 0;color:#555;font-size:14px">
            üìû 01913-812765 | 016749-44985 | 01878-149052
        </p>
    </div>
    
    <div class="memo-meta en" style="margin-top:20px">
        <div style="text-align:left;float:left;width:50%">
            <p style="margin:4px"><strong>‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Ç:</strong> <span id="mId" style="color:#e74c3c;font-weight:bold"></span></p>
            <p style="margin:4px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:4px"><strong>‡¶∏‡¶Æ‡ßü:</strong> <span id="mTime"></span></p>
            <p style="margin:4px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right;float:right;width:50%">
            <p style="margin:4px"><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï:</strong> <span id="mNote" style="font-weight:bold"></span></p>
            <p style="margin:4px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
            <p style="margin:4px"><strong>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ß‡¶∞‡¶£:</strong> <span id="mSaleType"></span></p>
        </div>
        <div style="clear:both"></div>
    </div>
    
    <table style="width:100%;border-collapse:collapse;margin-top:20px;border:1px solid #000">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd;padding:10px;text-align:left;width:60%">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd;padding:10px;text-align:center;width:15%">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                <th style="border:1px solid #ddd;padding:10px;text-align:center;width:15%">‡¶¶‡¶∞</th>
                <th style="border:1px solid #ddd;padding:10px;text-align:right;width:20%">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    
    <div class="memo-total-area en" style="margin-top:25px;text-align:right">
        <p style="margin:5px;font-size:16px">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: <b>‡ß≥<span id="mTotal"></span></b></p>
        <p style="margin:5px;font-size:16px">‡¶®‡¶ó‡¶¶ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®: ‡ß≥<span id="mPaid"></span></p>
        <p style="margin:5px;font-size:18px;color:red;font-weight:bold">
            ‡¶¨‡¶æ‡¶ï‡¶ø (Due): ‡ß≥<span id="mDueDisplay"></span>
        </p>
        <div id="memoDueWarning" style="display:none;background:#ffebee;padding:10px;border-radius:5px;margin-top:10px;text-align:center">
            ‚ö†Ô∏è ‡¶è‡¶á ‡¶¨‡¶ø‡¶≤‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá! ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡ßü ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§
        </div>
    </div>
    
    <div class="signature-area" style="margin-top:60px;display:flex;justify-content:space-between">
        <div class="signature-box" style="text-align:center;width:200px">
            <p class="signature-line" style="border-top:1px solid #000;padding-top:10px;margin-top:40px">
                ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
            </p>
        </div>
        <div class="signature-box" style="text-align:center;width:200px">
            <p style="margin:0;font-weight:bold" id="signatureName" class="en"></p>
            <p style="margin:0;font-size:14px" id="signaturePhone"></p>
            <p class="signature-line" style="border-top:1px solid #000;padding-top:10px;margin-top:5px">
                ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
            </p>
        </div>
    </div>
    
    <div style="margin-top:40px;text-align:center;border-top:1px dashed #ccc;padding-top:20px" class="noPrint">
        <button onclick="window.print()" style="width:auto;padding:12px 30px;font-size:16px;background:#2ecc71;margin-right:10px">
            üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (A4)
        </button>
        <button onclick="closeModal('memoModal')" style="background:#e74c3c;width:auto;padding:12px 30px;font-size:16px">
            ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <div style="margin-top:15px">
            <small style="color:#666">
                ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (A4 ‡¶∏‡¶æ‡¶á‡¶ú, ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶®: 0.8in)
            </small>
        </div>
    </div>
</div>
<!-- ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶∂‡ßá‡¶∑ -->

<!-- ‡¶è‡¶°‡¶ø‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="editModal" class="modal" style="width:500px">
    <h3 style="margin-top:0;color:#f39c12">‚úèÔ∏è ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    
    <div class="form-group">
        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editNote">
    </div>
    
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input id="editPhone" class="en">
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
        <div class="form-group">
            <label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ (‡ß≥):</label>
            <input id="editTotal" type="number" class="en">
        </div>
        <div class="form-group">
            <label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥):</label>
            <input id="editTaken" type="number" class="en" oninput="calculateEditDue()">
        </div>
    </div>
    
    <div class="form-group">
        <label>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ:</label>
        <input id="editDue" readonly style="background:#f5f5f5;color:#e74c3c;font-weight:bold">
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="updateEntry()" style="background:#f39c12;flex:1">
            üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button onclick="closeModal('editModal')" style="background:#e74c3c;width:100px">
            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
        </button>
    </div>
</div>

<!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="paymentModal" class="modal" style="width:500px">
    <h3 style="margin-top:0;color:#2ecc71">üí∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</h3>
    
    <div class="form-group">
        <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="payCustomerName" readonly style="background:#f5f5f5">
    </div>
    
    <div class="form-group">
        <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input id="payCustomerPhone" readonly style="background:#f5f5f5">
    </div>
    
    <div class="form-group">
        <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø:</label>
        <input id="payCurrentDue" readonly style="background:#f5f5f5;color:#e74c3c;font-weight:bold">
    </div>
    
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
        <input id="payAmount" type="number" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="en">
    </div>
    
    <div class="form-group">
        <label>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
        <input id="payDate" type="date" class="en" value="">
    </div>
    
    <div class="form-group">
        <label>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</label>
        <input id="payComment" placeholder="‡¶â‡¶¶‡¶æ: ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø, ‡¶Ü‡¶Ç‡¶∂‡¶ø‡¶ï ‡¶ú‡¶Æ‡¶æ">
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="processPayment()" style="background:#2ecc71;flex:1">
            üíæ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button onclick="closeModal('paymentModal')" style="background:#e74c3c;width:100px">
            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
        </button>
    </div>
</div>

<!-- ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="editStockModal" class="modal" style="width:600px">
    <h3 style="margin-top:0;color:#3498db">üì¶ ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editStockKey">
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
        <div class="form-group">
            <label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ï‡ßã‡¶°:</label>
            <input id="editSerial" class="en">
        </div>
        <div class="form-group">
            <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
            <select id="editCategory">
                <option value="Paper">‡¶ï‡¶æ‡¶ó‡¶ú/‡¶™‡ßá‡¶™‡¶æ‡¶∞</option>
                <option value="Pen">‡¶ï‡¶≤‡¶Æ/‡¶™‡ßá‡¶®</option>
                <option value="Khata">‡¶ñ‡¶æ‡¶§‡¶æ/‡¶®‡ßã‡¶ü‡¶¨‡ßÅ‡¶ï</option>
                <option value="Print">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡¶ø‡¶Ç</option>
                <option value="Photocopy">‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø</option>
                <option value="Service">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏</option>
                <option value="Other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input id="editName">
    </div>
    
    <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:15px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <input type="checkbox" id="editIsService" style="width:20px;height:20px;margin:0" onchange="toggleEditStockInput()">
            <label for="editIsService" style="margin:0;cursor:pointer;font-weight:bold;color:#1565c0">
                ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏
            </label>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
            <div class="form-group">
                <label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                <input id="editQty" type="number" class="en" placeholder="0" min="0">
            </div>
            <div class="form-group">
                <label>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï:</label>
                <input id="editMinStock" type="number" class="en" placeholder="5" min="1" value="5">
            </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div class="form-group">
                <label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (‡ß≥):</label>
                <input id="editCost" type="number" class="en" placeholder="0" min="0">
            </div>
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥):</label>
                <input id="editSell" type="number" class="en" placeholder="0" min="0">
            </div>
        </div>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="updateStockItem()" style="background:#2ecc71;flex:1">
            üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button onclick="closeModal('editStockModal')" style="background:#e74c3c;width:100px">
            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
        </button>
    </div>
</div>

<!-- ‡¶ñ‡¶∞‡¶ö ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
<div id="editExpenseModal" class="modal" style="width:500px">
    <h3 style="margin-top:0;color:#e74c3c">üí∏ ‡¶ñ‡¶∞‡¶ö ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editExpenseKey">
    
    <div class="form-group">
        <label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label>
        <input id="editExpenseDesc">
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
        <div class="form-group">
            <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥):</label>
            <input id="editExpenseAmount" type="number" class="en">
        </div>
        <div class="form-group">
            <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
            <input id="editExpenseDate" type="date" class="en">
        </div>
    </div>
    
    <div class="form-group">
        <label>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£:</label>
        <select id="editExpenseCategory">
            <option value="utility">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏/‡¶™‡¶æ‡¶®‡¶ø</option>
            <option value="rent">‡¶≠‡¶æ‡ßú‡¶æ</option>
            <option value="salary">‡¶¨‡ßá‡¶§‡¶®</option>
            <option value="maintenance">‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§</option>
            <option value="purchase">‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡¶æ</option>
            <option value="transport">‡¶Ø‡¶æ‡¶®‡¶¨‡¶æ‡¶π‡¶®</option>
            <option value="other">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
        </select>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
        <button onclick="updateExpense()" style="background:#2ecc71;flex:1">
            üíæ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button onclick="closeModal('editExpenseModal')" style="background:#e74c3c;width:100px">
            ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
        </button>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Main JavaScript Code -->
<script>
// ============================================
// ‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ - Main JavaScript File
// Version 2.0 - Enhanced with Quick Sales
// ============================================

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain: "sheikh-computer-b41d5.firebaseapp.com",
    databaseURL: "https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sheikh-computer-b41d5"
};

// Firebase Initialization
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.log("Firebase already initialized");
}
const db = firebase.database();

// ============================================
// GLOBAL VARIABLES
// ============================================
let currentUser = "";
let allProducts = [];
let cart = [];
let salesChart = null;
let expenseChart = null;
let searchResultsDiv = null;
let selectedSearchIndex = -1;
let currentCustomerData = null;
let customerCache = {};
let existingCustomers = {};
let inactivityTimer;

// ============================================
// INITIALIZATION FUNCTIONS
// ============================================

// Page Load Event
window.onload = function() {
    console.log("‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
    
    // Check for saved user
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) {
        setupUser(savedUser);
    }
    
    // Initialize search functionality
    searchResultsDiv = document.getElementById("searchResults");
    if(searchResultsDiv) {
        setupSearchFunctionality();
    }
    
    // Set today's date in date fields
    const today = new Date().toISOString().split('T')[0];
    const dateFields = ['payDate', 'expenseDate', 'startDate', 'endDate'];
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field) field.value = today;
    });
    
    // Load existing customers
    loadExistingCustomers();
    
    // Setup auto logout
    setupAutoLogout();
    
    // Initialize phone input formatting
    initPhoneInput();
    
    console.log("‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§!");
};

// Initialize Phone Input
function initPhoneInput() {
    const phoneInput = document.getElementById("phone");
    if(!phoneInput) return;
    
    phoneInput.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if(value.length > 11) value = value.substring(0, 11);
        
        if(value.length >= 11) {
            this.value = formatPhoneNumber(value);
            autoFillCustomerName(this.value);
            
            setTimeout(() => {
                const noteInput = document.getElementById("note");
                if(noteInput && noteInput.value.trim()) {
                    noteInput.focus();
                    noteInput.select();
                }
            }, 100);
        } else {
            this.value = value;
        }
    });
    
    phoneInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pastedText.replace(/\D/g, '');
        
        if(numbers.length >= 11) {
            const formatted = formatPhoneNumber(numbers.substring(0, 11));
            this.value = formatted;
            autoFillCustomerName(formatted);
            
            setTimeout(() => {
                const noteInput = document.getElementById("note");
                if(noteInput && noteInput.value.trim()) {
                    noteInput.focus();
                    noteInput.select();
                }
            }, 100);
        } else {
            this.value = numbers;
        }
    });
}

// Format Phone Number
function formatPhoneNumber(phone) {
    const clean = phone.replace(/\D/g, '');
    
    if(clean.length === 11 && clean.startsWith("01")) {
        return clean.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    else if(clean.length === 10 && clean.startsWith("1")) {
        const formatted = "0" + clean;
        return formatted.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    else if(clean.length === 13 && clean.startsWith("880")) {
        const formatted = "0" + clean.slice(3);
        return formatted.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    }
    
    return clean;
}

// ============================================
// AUTHENTICATION FUNCTIONS
// ============================================

// Login Function
function login() {
    const u = document.getElementById("uName").value.toLowerCase().trim();
    const p = document.getElementById("uPass").value.trim();
    const users = {admin: "123", owner: "456", roky: "789"};
    
    if(users[u] === p) {
        localStorage.setItem("loggedInUser", u);
        setupUser(u);
        showTempMessage("‚úÖ ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!", "success");
    } else {
        showTempMessage("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", "error");
    }
}

// Setup User Session
function setupUser(u) {
    currentUser = u;
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("container").style.display = "block";
    document.getElementById("header").style.display = "block";
    document.getElementById("menuBtn").style.display = "block";
    
    const userRole = u === 'admin' ? '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' : (u === 'owner' ? '‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï' : '‡¶∏‡ßç‡¶ü‡¶æ‡¶´');
    document.getElementById("userShow").innerHTML = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <b style="text-transform:uppercase">${u}</b> (${userRole})`;
    
    // Load all data
    loadAllProducts();
    loadEntries();
    loadSalesAnalytics();
    loadAllCustomers();
    loadExpenses();
    loadSalesByType();
    
    // Show dashboard by default
    showSection('dashboard');
    
    console.log(`User ${u} logged in successfully`);
}

// Logout Function
function logout() {
    if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        localStorage.removeItem("loggedInUser");
        location.reload();
    }
}

// Auto Logout Setup
function setupAutoLogout() {
    const events = ['click', 'keypress', 'mousemove', 'touchstart'];
    events.forEach(event => {
        document.addEventListener(event, () => {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if(currentUser && confirm("30 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶á‡¶®‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠! ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                    logout();
                }
            }, 30 * 60 * 1000);
        });
    });
}

// ============================================
// UI HELPER FUNCTIONS
// ============================================

// Show Section
function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display = "none");
    document.getElementById(id).style.display = "block";
    closeSidebar();
    
    // Load specific data for section
    if(id === 'customers') {
        loadAllCustomers();
    }
    if(id === 'expenses') {
        loadExpenses();
    }
    if(id === 'dashboard') {
        loadSalesAnalytics();
        loadSalesByType();
        loadTodayDueList();
    }
    if(id === 'inventory') {
        checkLowStock();
    }
}

// Sidebar Functions
function openSidebar() {
    document.getElementById("sidebar").style.left = "0";
    document.getElementById("overlay").style.display = "block";
}

function closeSidebar() {
    document.getElementById("sidebar").style.left = "-300px";
    document.getElementById("overlay").style.display = "none";
}

// Modal Functions
function closeModal(id) {
    document.getElementById(id).style.display = "none";
    document.getElementById("overlay").style.display = "none";
}

// Show Temporary Message
function showTempMessage(message, type = "success") {
    const existingMsg = document.querySelector('.temp-message');
    if(existingMsg) {
        existingMsg.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => existingMsg.remove(), 300);
    }
    
    const msgDiv = document.createElement("div");
    msgDiv.className = "temp-message";
    msgDiv.textContent = message;
    msgDiv.style.background = type === "success" ? "#2ecc71" : 
                              type === "error" ? "#e74c3c" : 
                              type === "info" ? "#3498db" : "#f39c12";
    
    document.body.appendChild(msgDiv);
    
    setTimeout(() => {
        if(msgDiv.parentNode) {
            msgDiv.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => msgDiv.remove(), 300);
        }
    }, 3000);
}

// ============================================
// DATA LOADING FUNCTIONS
// ============================================

// Load All Products
function loadAllProducts() {
    db.ref("products").on("value", snapshot => {
        allProducts = [];
        const stockBody = document.getElementById("stockBody");
        const categories = new Set();
        
        let totalStockValue = 0;
        let totalItems = 0;
        let lowStockCount = 0;
        let zeroStockCount = 0;
        let serviceItems = 0;
        
        if(!snapshot.exists()) {
            if(stockBody) {
                stockBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:30px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</td></tr>`;
            }
            return;
        }
        
        snapshot.forEach(child => {
            const p = child.val();
            p.key = child.key;
            allProducts.push(p);
            categories.add(p.category);
            
            // Calculate stock value
            if(!p.isService && p.qty && p.costPrice) {
                totalStockValue += (p.qty * p.costPrice);
                totalItems++;
            }
            if(p.isService) serviceItems++;
        });
        
        // Update stock table
        if(stockBody) {
            stockBody.innerHTML = "";
            allProducts.forEach(p => {
                const minStock = p.minStock || 5;
                const currentStock = p.qty || 0;
                let rowClass = "";
                let stockDisplay = "";
                
                if(!p.isService) {
                    if(currentStock <= 0) {
                        rowClass = "zero-stock";
                        zeroStockCount++;
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">0 üö®</span>`;
                    } else if(currentStock <= minStock) {
                        rowClass = "low-stock";
                        lowStockCount++;
                        stockDisplay = `<span style="color:#e74c3c;font-weight:bold">${currentStock} ‚ö†Ô∏è</span>`;
                    } else {
                        stockDisplay = currentStock;
                    }
                } else {
                    stockDisplay = `Service`;
                }
                
                // Action buttons
                const btnEdit = `<button class="btn-action btn-edit" onclick="editStockItem('${p.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
                const btnDel = currentUser === 'owner' || currentUser === 'admin' 
                    ? `<button class="btn-action btn-del" onclick="delProduct('${p.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">üóëÔ∏è</button>`
                    : `<button class="btn-action btn-del" disabled title="‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï/‡¶è‡¶°‡¶Æ‡¶ø‡¶®" style="opacity:0.5">üóëÔ∏è</button>`;
                
                stockBody.innerHTML += `<tr class="${rowClass}">
                    <td>${p.serial || '-'}</td>
                    <td>${p.category}</td>
                    <td>${p.name}</td>
                    <td style="text-align:center">${stockDisplay}</td>
                    <td style="text-align:center">${!p.isService ? minStock : '-'}</td>
                    <td style="text-align:right">${!p.isService ? (p.costPrice || '0') : '-'}</td>
                    <td style="text-align:right">${p.sellPrice}</td>
                    <td class="noPrint" style="text-align:center">${btnEdit} ${btnDel}</td>
                </tr>`;
            });
        }
        
        // Update summary
        updateElement("totalProducts", allProducts.length);
        updateElement("lowStockCount", lowStockCount);
        updateElement("zeroStockCount", zeroStockCount);
        updateElement("totalStockValue", totalStockValue.toFixed(2));
        updateElement("totalItemsCount", totalItems);
        updateElement("zeroStockItems", zeroStockCount);
        updateElement("serviceItemsCount", serviceItems);
        updateElement("productCount", allProducts.length);
        
        // Update category dropdown
        const catSelect = document.getElementById("category");
        if(catSelect) {
            catSelect.innerHTML = "<option value=''>=== ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ===</option>";
            Array.from(categories).sort().forEach(c => {
                catSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }
        
        // Check low stock
        checkLowStock();
    });
}

// Helper function to update element text
function updateElement(id, text) {
    const element = document.getElementById(id);
    if(element) element.innerText = text;
}

// Load Entries
function loadEntries() {
    db.ref("entries").limitToLast(100).on("value", snapshot => {
        renderTable(snapshot.val(), "tableBody");
    });
}

// Render Table Data
function renderTable(data, tableId = "tableBody") {
    const tbody = document.getElementById(tableId);
    if(!tbody) return;
    
    tbody.innerHTML = "";
    if(!data) {
        if(tableId === "reportTableBody") {
            tbody.innerHTML = "<tr><td colspan='9' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>";
        }
        return;
    }
    
    let totalSales = 0, totalTaken = 0, totalDue = 0;
    let dailyData = {};
    const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
    
    entriesArr.forEach(e => {
        const total = parseFloat(e.total) || 0;
        const taken = parseFloat(e.taken) || 0;
        const loss = parseFloat(e.loss) || 0;
        
        totalSales += total;
        totalTaken += taken;
        totalDue += loss;
        
        // Item summary
        let itemSummary = "‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶£‡ßç‡¶Ø";
        if(e.items && Array.isArray(e.items)) {
            itemSummary = e.items.slice(0, 2).map(i => 
                `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work} (${i.qty})</span>`
            ).join(" ");
            if(e.items.length > 2) itemSummary += " ...";
        } else if(e.work) {
            itemSummary = e.work;
        }
        
        const phone = e.phone ? formatPhoneNumber(e.phone) : "-";
        
        // Action buttons
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${e.key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${e.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = `<button class="btn-action btn-del" onclick="delEntry('${e.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>`;
        
        // Sale type display
        const saleTypeText = e.saleType === 'computer' ? 'üíª' : 
                            e.saleType === 'photocopy' ? 'üì∑' : 
                            e.saleType === 'stationery' ? 'üìö' : 'üìã';
        
        tbody.innerHTML += `<tr>
            <td style="font-size:13px">${e.date || ''}<br>${e.time || ''}</td>
            <td style="font-size:13px"><b>${e.note || ''}</b><br>${itemSummary}</td>
            <td class="en">${phone}</td>
            <td>${total}</td>
            <td style="color:#27ae60;font-weight:bold">${taken}</td>
            <td style="color:#e74c3c">${loss}</td>
            <td>${saleTypeText}</td>
            <td style="text-transform:capitalize">${e.user || ''}</td>
            <td class="noPrint" style="white-space:nowrap">${btnMemo}${btnEdit}${btnDel}</td>
        </tr>`;
        
        if(e.date) {
            dailyData[e.date] = (dailyData[e.date] || 0) + total;
        }
    });
    
    // Update dashboard stats
    if(tableId === "tableBody") {
        updateElement("cCount", entriesArr.length);
        updateElement("cTotal", totalSales.toFixed(2));
        updateElement("cTaken", totalTaken.toFixed(2));
        updateElement("cDue", totalDue.toFixed(2));
        updateChart(dailyData);
        renderUserStats(data);
        loadTodayDueList();
    }
}

// Render User Statistics
function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {};
    let hasData = false;
    
    // Initialize stats for all users
    ['admin', 'owner', 'roky'].forEach(u => {
        stats[u] = {total: 0, taken: 0, due: 0};
    });
    
    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            if(e.date === today) {
                hasData = true;
                const u = e.user ? e.user.toLowerCase() : '';
                if(!stats[u]) stats[u] = {total: 0, taken: 0, due: 0};
                stats[u].total += (parseFloat(e.total) || 0);
                stats[u].taken += (parseFloat(e.taken) || 0);
                stats[u].due += (parseFloat(e.loss) || 0);
            }
        });
    }
    
    const tbody = document.getElementById("userSummaryBody");
    if(!tbody) return;
    
    tbody.innerHTML = "";
    if(!hasData) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`;
        return;
    }
    
    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) {
            tbody.innerHTML += `<tr>
                <td style="text-transform:capitalize;font-weight:bold">${u}</td>
                <td>${stats[u].total.toFixed(2)}</td>
                <td style="color:#27ae60;font-weight:bold">${stats[u].taken.toFixed(2)}</td>
                <td style="color:#e74c3c">${stats[u].due.toFixed(2)}</td>
            </tr>`;
        }
    });
}

// Update Sales Chart
function updateChart(data) {
    const sortedDates = Object.keys(data).sort((a, b) => {
        const [d1, m1, y1] = a.split('/');
        const [d2, m2, y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    });
    
    const labels = sortedDates.slice(-10);
    const values = labels.map(d => data[d]);
    const ctx = document.getElementById('salesChart');
    
    if(!ctx) return;
    
    if(salesChart) {
        salesChart.destroy();
    }
    
    salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (‡¶ü‡¶æ‡¶ï‡¶æ)',
                data: values,
                backgroundColor: '#2ecc71',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü: ‡ß≥${context.raw}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‡ß≥' + value;
                        }
                    }
                }
            }
        }
    });
}

// Load Today's Due List
function loadTodayDueList() {
    const today = new Date().toLocaleDateString("en-GB");
    db.ref("entries").orderByChild("date").equalTo(today).once("value", snapshot => {
        const data = snapshot.val();
        const tbody = document.getElementById("dueListBody");
        if(!tbody) return;
        
        tbody.innerHTML = "";
        if(!data) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶®‡ßá‡¶á</td></tr>`;
            return;
        }
        
        let dueEntries = [];
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if(entry.loss > 0) {
                dueEntries.push({
                    key: key,
                    customer: entry.note || "Unknown",
                    phone: entry.phone || "",
                    due: entry.loss,
                    time: entry.time || ""
                });
            }
        });
        
        if(dueEntries.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶®‡ßá‡¶á</td></tr>`;
            return;
        }
        
        // Sort by due amount (highest first)
        dueEntries.sort((a, b) => b.due - a.due);
        
        // Show top 10
        dueEntries.slice(0, 10).forEach(entry => {
            tbody.innerHTML += `<tr>
                <td><strong>${entry.customer}</strong></td>
                <td>${entry.phone ? formatPhoneNumber(entry.phone) : '-'}</td>
                <td style="color:#e74c3c;font-weight:bold">‡ß≥${entry.due}</td>
                <td>${entry.time}</td>
                <td class="noPrint">
                    <button class="btn-action btn-print" onclick="viewMemo('${entry.key}')" title="‡¶∞‡¶∂‡¶ø‡¶¶">üñ®Ô∏è</button>
                    <button class="btn-action btn-edit" onclick="addPaymentForCustomer('${entry.phone}', '${entry.customer}', ${entry.due})" title="‡¶ú‡¶Æ‡¶æ">üí∞</button>
                </td>
            </tr>`;
        });
    });
}

// ============================================
// PRODUCT & INVENTORY FUNCTIONS
// ============================================

// Filter Products for Dropdown
function filterProducts() {
    const cat = document.getElementById("category").value;
    const workSelect = document.getElementById("work");
    if(!workSelect) return;
    
    workSelect.innerHTML = "<option value=''>‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®...</option>";
    
    if(!cat) return;
    
    const filtered = allProducts.filter(p => p.category === cat);
    if(filtered.length === 0) {
        workSelect.innerHTML = "<option value=''>‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á</option>";
        return;
    }
    
    // Sort by serial number
    filtered.sort((a, b) => {
        const serialA = a.serial || "999999";
        const serialB = b.serial || "999999";
        return serialA.localeCompare(serialB, undefined, {numeric: true});
    });
    
    filtered.forEach(p => {
        const displayText = p.serial ? `${p.serial} - ${p.name}` : p.name;
        workSelect.innerHTML += `<option value="${p.key}" data-price="${p.sellPrice}">${displayText}</option>`;
    });
}

// Auto Fill Price when product selected
function autoFillPrice() {
    const workSelect = document.getElementById("work");
    if(!workSelect) return;
    
    const selectedOption = workSelect.options[workSelect.selectedIndex];
    if(selectedOption && selectedOption.value) {
        const price = selectedOption.getAttribute("data-price") || "";
        document.getElementById("rate").value = price;
        
        // Focus on quantity
        setTimeout(() => {
            const qtyInput = document.getElementById("qty");
            if(qtyInput) {
                qtyInput.focus();
                qtyInput.select();
            }
        }, 50);
    }
}

// Setup Search Functionality
function setupSearchFunctionality() {
    const searchInput = document.getElementById('searchSerial');
    if(!searchInput) return;
    
    let searchTimer;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimer);
        const query = this.value.trim();
        if(!query) {
            hideSearchResults();
            return;
        }
        searchTimer = setTimeout(() => performSearch(query), 300);
    });
    
    searchInput.addEventListener('keydown', function(e) {
        const results = searchResultsDiv.querySelectorAll('.search-item');
        
        if(e.key === 'ArrowDown') {
            e.preventDefault();
            if(selectedSearchIndex < results.length - 1) {
                selectedSearchIndex++;
                updateSearchSelection();
            }
        } else if(e.key === 'ArrowUp') {
            e.preventDefault();
            if(selectedSearchIndex > 0) {
                selectedSearchIndex--;
                updateSearchSelection();
            }
        } else if(e.key === 'Enter' && selectedSearchIndex >= 0) {
            e.preventDefault();
            const selectedItem = results[selectedSearchIndex];
            if(selectedItem) {
                const productKey = selectedItem.getAttribute('data-key');
                selectProductFromSearch(productKey);
            }
        } else if(e.key === 'Escape') {
            hideSearchResults();
        }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if(!searchResultsDiv.contains(e.target) && e.target !== searchInput) {
            hideSearchResults();
        }
    });
}

// Perform Search
function performSearch(query) {
    if(!query || !searchResultsDiv) return;
    
    const lowerQuery = query.toLowerCase();
    const results = [];
    
    allProducts.forEach(product => {
        let score = 0;
        
        if(product.serial && product.serial.toLowerCase().includes(lowerQuery)) {
            score += 10;
        }
        if(product.name && product.name.toLowerCase().includes(lowerQuery)) {
            score += 5;
        }
        if(product.category && product.category.toLowerCase().includes(lowerQuery)) {
            score += 3;
        }
        
        if(score > 0) {
            results.push({ product: product, score: score });
        }
    });
    
    results.sort((a, b) => b.score - a.score);
    displaySearchResults(results, query);
}

// Display Search Results
function displaySearchResults(results, query) {
    if(!searchResultsDiv) return;
    
    searchResultsDiv.innerHTML = '';
    
    if(results.length === 0) {
        searchResultsDiv.innerHTML = '<div class="no-results">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</div>';
        searchResultsDiv.style.display = 'block';
        return;
    }
    
    const limitedResults = results.slice(0, 10);
    
    limitedResults.forEach(result => {
        const product = result.product;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'search-item';
        itemDiv.setAttribute('data-key', product.key);
        
        // Highlight matching text
        const name = highlightMatch(product.name, query);
        const serial = product.serial ? `<span style="color:#27ae60;font-weight:bold">${product.serial}</span>` : '';
        const stockInfo = product.isService ? 'Service' : 
                         `<span style="color:${product.qty < 5 ? '#e74c3c' : '#27ae60'}">${product.qty}</span>`;
        
        itemDiv.innerHTML = `
            <div class="product-name">${serial} ${name}</div>
            <div class="product-details">
                <span>${product.category}</span>
                <span>‡¶∏‡ßç‡¶ü‡¶ï: ${stockInfo} | ‡ß≥${product.sellPrice}</span>
            </div>
        `;
        
        itemDiv.addEventListener('click', () => selectProductFromSearch(product.key));
        itemDiv.addEventListener('mouseenter', () => {
            const allItems = searchResultsDiv.querySelectorAll('.search-item');
            allItems.forEach(item => item.classList.remove('active'));
            itemDiv.classList.add('active');
            selectedSearchIndex = Array.from(allItems).indexOf(itemDiv);
        });
        
        searchResultsDiv.appendChild(itemDiv);
    });
    
    searchResultsDiv.style.display = 'block';
    selectedSearchIndex = -1;
}

// Highlight matching text
function highlightMatch(text, query) {
    if(!query || !text) return text;
    
    const lowerText = text.toLowerCase();
    const lowerQuery = query.toLowerCase();
    const index = lowerText.indexOf(lowerQuery);
    
    if(index === -1) return text;
    
    const before = text.substring(0, index);
    const match = text.substring(index, index + query.length);
    const after = text.substring(index + query.length);
    
    return `${before}<span class="highlight">${match}</span>${after}`;
}

// Select product from search results
function selectProductFromSearch(productKey) {
    const product = allProducts.find(p => p.key === productKey);
    if(!product) return;
    
    const catSelect = document.getElementById("category");
    const workSelect = document.getElementById("work");
    
    if(!catSelect || !workSelect) return;
    
    // Check if category needs to be changed
    if(catSelect.value === "") {
        if(confirm(`"${product.name}" ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ${product.category} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            catSelect.value = product.category;
        } else {
            hideSearchResults();
            return;
        }
    } else if(catSelect.value !== product.category) {
        const currentCatText = catSelect.options[catSelect.selectedIndex].text;
        if(!confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø "${currentCatText}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®,\n‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${product.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
            hideSearchResults();
            return;
        }
        catSelect.value = product.category;
    }
    
    // Filter products and select the matching one
    setTimeout(() => {
        filterProducts();
        setTimeout(() => {
            for(let i = 0; i < workSelect.options.length; i++) {
                if(workSelect.options[i].value === product.key) {
                    workSelect.selectedIndex = i;
                    document.getElementById("rate").value = product.sellPrice;
                    document.getElementById("qty").value = 1;
                    
                    setTimeout(() => {
                        const qtyInput = document.getElementById("qty");
                        if(qtyInput) {
                            qtyInput.focus();
                            qtyInput.select();
                        }
                    }, 50);
                    
                    showTempMessage(`${product.serial ? product.serial + ' - ' : ''}${product.name} ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
                    document.getElementById("searchSerial").value = "";
                    hideSearchResults();
                    break;
                }
            }
        }, 100);
    }, 100);
}

// Hide search results
function hideSearchResults() {
    if(searchResultsDiv) {
        searchResultsDiv.style.display = 'none';
        selectedSearchIndex = -1;
    }
}

// Update search selection
function updateSearchSelection() {
    if(!searchResultsDiv) return;
    
    const results = searchResultsDiv.querySelectorAll('.search-item');
    results.forEach(item => item.classList.remove('active'));
    
    if(selectedSearchIndex >= 0 && selectedSearchIndex < results.length) {
        results[selectedSearchIndex].classList.add('active');
        results[selectedSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Quick Search Product
function quickSearchProduct() {
    const query = document.getElementById("searchSerial").value.trim();
    if(query) {
        performSearch(query);
    }
}

// ============================================
// CART & SALES FUNCTIONS
// ============================================

// Add to Cart
function addToCart() {
    // Validate category selection
    const catSelect = document.getElementById("category");
    if(!catSelect || catSelect.value === "") {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        catSelect.focus();
        return;
    }
    
    // Validate product selection
    const workSelect = document.getElementById("work");
    const pKey = workSelect.value;
    const pNameRaw = workSelect.options[workSelect.selectedIndex]?.text;
    
    if(!pKey || pKey === "") {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        workSelect.focus();
        return;
    }
    
    // Validate price and quantity
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    
    if(!r || r <= 0) {
        alert("‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®!");
        document.getElementById("rate").focus();
        return;
    }
    
    if(q <= 0) {
        alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        document.getElementById("qty").focus();
        return;
    }
    
    // Find product in inventory
    const stockItem = allProducts.find(p => p.key === pKey);
    const pName = stockItem ? stockItem.name : pNameRaw;
    
    // Check if product category matches selected category
    if(stockItem && catSelect.value !== stockItem.category) {
        alert(`‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø "${stockItem.category}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶õ‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ü‡¶™‡¶®‡¶ø "${catSelect.options[catSelect.selectedIndex].text}" ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!`);
        return;
    }
    
    // Stock validation for physical products
    if(stockItem && !stockItem.isService) {
        const currentStock = parseFloat(stockItem.qty) || 0;
        const requestedQty = parseFloat(q) || 0;
        
        // Check if stock is zero
        if(currentStock <= 0) {
            alert(`‚ùå ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑! "${pName}" ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á‡•§\n\n‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
            return;
        }
        
        // Check if requested quantity exceeds stock
        if(currentStock < requestedQty) {
            let alertMsg = `‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!\n\n`;
            alertMsg += `‡¶™‡¶£‡ßç‡¶Ø: ${pName}\n`;
            alertMsg += `‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß‡¶ï‡ßÉ‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${requestedQty}\n`;
            alertMsg += `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${currentStock}\n\n`;
            
            if(currentStock > 0) {
                alertMsg += `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${currentStock}‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n`;
                alertMsg += `(‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?)`;
                
                if(confirm(alertMsg)) {
                    const newQty = prompt(`‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶õ‡ßá ${currentStock}‡¶ü‡¶ø‡•§ ‡¶ï‡¶§‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`, currentStock);
                    if(newQty && !isNaN(newQty) && newQty > 0 && newQty <= currentStock) {
                        document.getElementById("qty").value = newQty;
                        // Recursive call with updated quantity
                        setTimeout(() => {
                            addToCart();
                        }, 100);
                        return;
                    } else {
                        alert("‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                        return;
                    }
                } else {
                    return;
                }
            } else {
                alert("‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á! ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¨‡¶®‡ßç‡¶ß‡•§");
                return;
            }
        }
    }
    
    // Add to cart
    cart.push({
        key: pKey,
        work: pName,
        qty: q,
        rate: r,
        sub: q * r,
        isService: stockItem ? stockItem.isService : false,
        category: stockItem ? stockItem.category : catSelect.value
    });
    
    // Update cart display
    renderCart();
    
    // Reset form
    document.getElementById("qty").value = 1;
    document.getElementById("searchSerial").focus();
    
    showTempMessage("‚úÖ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
}

// Render Cart
function renderCart() {
    const cartArea = document.getElementById("cartArea");
    const cartList = document.getElementById("cartList");
    const cartCount = document.getElementById("cartCount");
    
    if(!cartArea || !cartList) return;
    
    // Show/hide cart area
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    
    let grandTotal = 0;
    
    // Add each cart item
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        
        cartList.innerHTML += `
            <div class="cart-item">
                <span>
                    ${index + 1}. ${item.work}
                    <small>(${item.qty} x ${item.rate}‡ß≥)</small>
                    ${item.isService ? '<span class="service-badge">Service</span>' : ''}
                </span>
                <span>
                    <b>‡ß≥${item.sub.toFixed(2)}</b>
                    <span onclick="removeCart(${index})" style="color:#e74c3c;cursor:pointer;margin-left:10px;font-weight:bold" title="Remove">√ó</span>
                </span>
            </div>
        `;
    });
    
    // Update totals
    document.getElementById("total").value = grandTotal.toFixed(2);
    
    if(cartCount) {
        cartCount.innerText = `${cart.length}‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ`;
    }
    
    // Calculate due
    calcDue();
}

// Remove from Cart
function removeCart(index) {
    if(index >= 0 && index < cart.length) {
        cart.splice(index, 1);
        renderCart();
        showTempMessage("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá", "info");
    }
}

// Calculate Due Amount
function calcDue() {
    const totalInput = document.getElementById("total");
    const takenInput = document.getElementById("taken");
    const dueInput = document.getElementById("due");
    
    if(!totalInput || !takenInput || !dueInput) return;
    
    const t = parseFloat(totalInput.value) || 0;
    const k = parseFloat(takenInput.value) || 0;
    const due = t - k;
    
    dueInput.value = due.toFixed(2);
}

// Validate Payment
function validatePayment() {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const phone = document.getElementById("phone") ? document.getElementById("phone").value.trim() : "";
    const validationDiv = document.getElementById("paymentValidation");
    const finalWarning = document.getElementById("finalWarning");
    
    // Update due field
    document.getElementById("due").value = due;
    
    if(validationDiv) validationDiv.innerHTML = "";
    if(finalWarning) {
        finalWarning.innerHTML = "";
        finalWarning.style.display = "none";
    }
    
    // Phone validation
    if(phone && phone !== "") {
        const phoneValidation = validatePhoneNumber(phone);
        if(!phoneValidation.isValid && due > 0) {
            if(validationDiv) {
                validationDiv.innerHTML = `<div class="validation-error">${phoneValidation.message}</div>`;
            }
        } else if(phoneValidation.isValid) {
            document.getElementById("phone").value = phoneValidation.formatted;
        }
    }
    
    // Payment validation messages
    if(validationDiv) {
        if(due === 0) {
            validationDiv.innerHTML = `<div class="validation-success">‚úÖ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶π‡ßü‡ßá‡¶õ‡ßá</div>`;
        } else if(due > 0) {
            validationDiv.innerHTML = `<div class="validation-warning">‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due.toFixed(2)}</div>`;
        } else if(due < 0) {
            validationDiv.innerHTML = `<div class="validation-error">‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due.toFixed(2)}</div>`;
        }
        
        if(due > 0 && taken === 0) {
            validationDiv.innerHTML = `<div class="validation-error due-warning">üö® ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø! ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${due.toFixed(2)}</div>`;
        }
    }
}

// Validate Phone Number
function validatePhoneNumber(phone) {
    const cleanPhone = phone.replace(/\D/g, '');
    const patterns = [
        /^01[3-9]\d{8}$/,      // 013-019 (11 digits)
        /^1[3-9]\d{8}$/,       // 13-19 (10 digits - without 0)
        /^8801[3-9]\d{8}$/,    // 88013-88019 (13 digits)
    ];
    
    for(let pattern of patterns) {
        if(pattern.test(cleanPhone)) {
            return {
                isValid: true,
                formatted: formatPhoneNumber(cleanPhone),
                raw: cleanPhone
            };
        }
    }
    
    return {
        isValid: false,
        message: "‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017XXXXXXXX"
    };
}

// Auto Fill Customer Name from Phone
function autoFillCustomerName(phoneInput) {
    const phone = phoneInput.trim();
    const noteInput = document.getElementById("note");
    const validationDiv = document.getElementById("customerValidation");
    
    if(!noteInput || !validationDiv) return;
    
    // Extract only numbers
    const numbers = phone.replace(/\D/g, '');
    
    // Need at least 11 digits
    if(numbers.length < 11) {
        validationDiv.innerHTML = "";
        return;
    }
    
    // Take first 11 digits
    const cleanPhone = numbers.substring(0, 11);
    
    // Format phone number
    let formattedPhone = formatPhoneNumber(cleanPhone);
    
    // Update phone field
    const phoneField = document.getElementById("phone");
    if(phoneField) phoneField.value = formattedPhone;
    
    // Check cache first
    if(customerCache[cleanPhone]) {
        noteInput.value = customerCache[cleanPhone];
        showValidationMessage("‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: " + customerCache[cleanPhone], "success");
        noteInput.focus();
        noteInput.select();
        return;
    }
    
    // Search in Firebase
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if(!data) return;
        
        let foundName = "";
        let foundCount = 0;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const entryPhone = entry.phone || "";
            const entryPhoneClean = entryPhone.replace(/\D/g, '');
            
            if(entryPhoneClean === cleanPhone && entry.note && entry.note !== "General Customer") {
                foundName = entry.note;
                foundCount++;
            }
        });
        
        if(foundName) {
            customerCache[cleanPhone] = foundName;
            noteInput.value = foundName;
            showValidationMessage(`‚úÖ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (${foundCount} ‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ): ${foundName}`, "success");
            noteInput.focus();
            noteInput.select();
        } else {
            showValidationMessage("üÜï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï, ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®", "warning");
            noteInput.focus();
            noteInput.select();
        }
    });
}

// Show Validation Message
function showValidationMessage(message, type) {
    const validationDiv = document.getElementById("customerValidation");
    if(!validationDiv) return;
    
    validationDiv.innerHTML = `<div class="validation-${type}">${message}</div>`;
}

// Check Customer Name
function checkCustomerName() {
    const name = document.getElementById("note") ? document.getElementById("note").value.trim() : "";
    const phone = document.getElementById("phone") ? document.getElementById("phone").value.trim() : "";
    const validationDiv = document.getElementById("customerValidation");
    
    if(!name || !validationDiv) {
        if(validationDiv) validationDiv.innerHTML = "";
        return;
    }
    
    if(phone && phone.length >= 7) {
        const cleanPhone = phone.replace(/\D/g, '');
        if(cleanPhone.length >= 11) {
            customerCache[cleanPhone] = name;
            showValidationMessage("‚úÖ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
        } else {
            showValidationMessage("üì± ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡ßü (‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü)", "warning");
        }
    } else {
        showValidationMessage("üì± ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶™‡¶∞‡ßá ‡¶∏‡¶π‡¶ú‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®", "warning");
    }
}

// Load Existing Customers
function loadExistingCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if(!data) return;
        
        existingCustomers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            const name = entry.note;
            
            if(phone && name && name !== "General Customer") {
                existingCustomers[phone] = name;
                customerCache[phone] = name;
            }
        });
    });
}

// Validate and Save Entry
function validateAndSave(showMemoFlag) {
    const total = parseFloat(document.getElementById("total").value) || 0;
    const taken = parseFloat(document.getElementById("taken").value) || 0;
    const due = total - taken;
    const note = document.getElementById("note") ? document.getElementById("note").value.trim() : "";
    const phone = document.getElementById("phone") ? document.getElementById("phone").value.trim() : "";
    const finalWarning = document.getElementById("finalWarning");
    
    let warnings = [];
    let errors = [];
    
    // Name validation
    if(!note || note === "") {
        errors.push("‚ùå ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");
    }
    
    // Payment validation
    if(taken === 0 && due > 0) {
        errors.push("üö® ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø!");
    }
    if(due < 0) {
        errors.push("‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá!");
    }
    
    // Phone validation
    if(phone && phone !== "") {
        const phoneValidation = validatePhoneNumber(phone);
        if(!phoneValidation.isValid) {
            if(due > 0) {
                errors.push("üö® ‡¶≠‡ßÅ‡¶≤ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞! ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®");
            } else {
                warnings.push("üì± ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü (‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 017XXXXXXXX)");
            }
        }
        
        // Check if phone exists for different customer
        if(phoneValidation.isValid && existingCustomers[phoneValidation.raw] && 
           existingCustomers[phoneValidation.raw] !== note) {
            warnings.push(`üìû ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞: ${existingCustomers[phoneValidation.raw]}`);
        }
    }
    
    // Due warning
    if(due > 0) {
        if(!phone || phone === "") {
            errors.push("üö® ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶π‡¶æ‡¶∞‡¶æ‡¶≤‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®)");
        }
        warnings.push(`‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ‡ß≥${due.toFixed(2)}`);
    }
    
    // Show warnings/errors
    if(errors.length > 0 || warnings.length > 0) {
        let warningHTML = "";
        
        if(errors.length > 0) {
            warningHTML += `<div class="validation-error" style="margin-bottom:10px;">
                <strong>‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:</strong><br>${errors.join('<br>')}
            </div>`;
        }
        
        if(warnings.length > 0) {
            warningHTML += `<div class="validation-warning">
                <strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong><br>${warnings.join('<br>')}
            </div>`;
        }
        
        if(finalWarning) {
            finalWarning.innerHTML = warningHTML;
            finalWarning.style.display = 'block';
        }
        
        // Ask for confirmation if there are errors
        if(errors.length > 0) {
            let errorMessage = "‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶Ü‡¶õ‡ßá:\n\n" + errors.join('\n') + "\n\n";
            if(warnings.length > 0) {
                errorMessage += "‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:\n" + warnings.join('\n') + "\n\n";
            }
            errorMessage += "‡¶§‡¶¨‡ßÅ‡¶ì ‡¶ï‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?";
            
            if(!confirm(errorMessage)) {
                return;
            }
        }
    }
    
    // Save the entry
    saveBulkEntry(showMemoFlag);
}

// Save Bulk Entry
function saveBulkEntry(showMemoFlag) {
    if(!cart.length) {
        alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
        return;
    }
    
    const totalVal = parseFloat(document.getElementById("total").value);
    const takenVal = parseFloat(document.getElementById("taken").value) || 0;
    const dueVal = totalVal - takenVal;
    const note = document.getElementById("note") ? document.getElementById("note").value.trim() : "";
    const phone = document.getElementById("phone") ? document.getElementById("phone").value.trim() : "";
    const saleType = document.getElementById("saleType") ? document.getElementById("saleType").value : "general";
    
    // Clean phone number
    const cleanPhone = phone.replace(/\D/g, '');
    
    // Update customer cache
    if(cleanPhone && note) {
        customerCache[cleanPhone] = note;
        existingCustomers[cleanPhone] = note;
    }
    
    // Prepare entry data
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: cart,
        total: totalVal,
        taken: takenVal,
        loss: dueVal,
        user: currentUser,
        note: note || "General Customer",
        phone: cleanPhone || "",
        saleType: saleType
    };
    
    // Save to Firebase
    db.ref("entries").push(entryData).then((snap) => {
        // Deduct stock
        deductStock(cart);
        
        // Show success message
        if(showMemoFlag) {
            entryData.key = snap.key;
            showMemo(entryData);
        } else {
            showTempMessage("‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
        
        // Reset UI
        resetSalesForm();
        
        // Update customer list
        loadAllCustomers();
        
        // Update analytics
        loadSalesAnalytics();
        loadSalesByType();
        
    }).catch(error => {
        showTempMessage("‚ùå ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Deduct Stock from Inventory
function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            if(newQty >= 0) {
                db.ref("products/" + cItem.key).update({ qty: newQty });
            }
        }
    });
}

// Reset Sales Form
function resetSalesForm() {
    cart = [];
    renderCart();
    
    const fields = ["note", "phone", "taken", "due"];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field) field.value = "";
    });
    
    document.getElementById("due").value = "0";
    
    const validationDivs = ["customerValidation", "paymentValidation", "finalWarning"];
    validationDivs.forEach(divId => {
        const div = document.getElementById(divId);
        if(div) {
            div.innerHTML = "";
            div.style.display = "none";
        }
    });
    
    // Reset search
    const searchInput = document.getElementById("searchSerial");
    if(searchInput) {
        searchInput.value = "";
        searchInput.focus();
    }
}

// Quick Sale Function
function quickSale(productName, rate, qty = 1) {
    // Find product in inventory
    const product = allProducts.find(p => p.name.includes(productName));
    
    if(product) {
        // Set category
        const catSelect = document.getElementById("category");
        if(catSelect) catSelect.value = product.category;
        
        // Filter products and select the matching one
        setTimeout(() => {
            filterProducts();
            setTimeout(() => {
                const workSelect = document.getElementById("work");
                for(let i = 0; i < workSelect.options.length; i++) {
                    if(workSelect.options[i].value === product.key) {
                        workSelect.selectedIndex = i;
                        document.getElementById("rate").value = rate;
                        document.getElementById("qty").value = qty;
                        
                        // Add to cart
                        setTimeout(() => {
                            addToCart();
                        }, 100);
                        break;
                    }
                }
            }, 100);
        }, 100);
    } else {
        // If product not found in inventory, add directly to cart
        cart.push({
            key: "quick_" + Date.now(),
            work: productName,
            qty: qty,
            rate: rate,
            sub: qty * rate,
            isService: true,
            category: "Service"
        });
        
        renderCart();
        showTempMessage(`‚úÖ ${productName} ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
        
        // Focus on customer name field
        setTimeout(() => {
            const noteInput = document.getElementById("note");
            if(noteInput) {
                noteInput.focus();
                noteInput.select();
            }
        }, 100);
    }
}

// Add Quick Product
function addQuickProduct(productName, rate) {
    cart.push({
        key: "quick_" + Date.now(),
        work: productName,
        qty: 1,
        rate: rate,
        sub: rate,
        isService: true,
        category: "Service"
    });
    
    renderCart();
    showTempMessage(`‚úÖ ${productName} ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
}

// ============================================
// MEMO & PRINTING FUNCTIONS
// ============================================

// Show Memo/Receipt
function showMemo(e) {
    const memoModal = document.getElementById("memoModal");
    if(!memoModal) return;
    
    // Set memo details
    document.getElementById("mId").innerText = e.key ? e.key.slice(-6).toUpperCase() : '---';
    document.getElementById("mDate").innerText = e.date || '';
    document.getElementById("mTime").innerText = e.time || '';
    document.getElementById("mUser").innerText = e.user || '';
    document.getElementById("mNote").innerText = e.note || '';
    document.getElementById("mPhoneDisp").innerText = e.phone ? formatPhoneNumber(e.phone) : "";
    
    // Sale type display
    const saleTypeText = e.saleType === 'computer' ? '‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞' : 
                        e.saleType === 'photocopy' ? '‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø' : 
                        e.saleType === 'stationery' ? '‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£';
    document.getElementById("mSaleType").innerText = saleTypeText;
    
    // Set amounts
    document.getElementById("mTotal").innerText = e.total ? e.total.toFixed(2) : '0';
    document.getElementById("mPaid").innerText = e.taken ? e.taken.toFixed(2) : '0';
    document.getElementById("mDueDisplay").innerText = e.loss ? e.loss.toFixed(2) : '0';
    
    // Show due warning if applicable
    const dueWarning = document.getElementById("memoDueWarning");
    if(dueWarning) {
        dueWarning.style.display = e.loss > 0 ? "block" : "none";
    }
    
    // Populate items table
    const mItems = document.getElementById("mItems");
    if(mItems) {
        mItems.innerHTML = "";
        
        if(e.items && Array.isArray(e.items)) {
            e.items.forEach((i, index) => {
                mItems.innerHTML += `
                    <tr>
                        <td style="border:1px solid #ddd;padding:8px">${i.work || ''}</td>
                        <td style="text-align:center;border:1px solid #ddd;padding:8px">${i.qty || '0'}</td>
                        <td style="text-align:center;border:1px solid #ddd;padding:8px">${i.rate || '0'}</td>
                        <td style="text-align:right;border:1px solid #ddd;padding:8px">${i.sub ? i.sub.toFixed(2) : '0'}</td>
                    </tr>
                `;
            });
        } else {
            mItems.innerHTML += `
                <tr>
                    <td style="border:1px solid #ddd;padding:8px">${e.work || ''}</td>
                    <td style="text-align:center;border:1px solid #ddd;padding:8px">-</td>
                    <td style="text-align:center;border:1px solid #ddd;padding:8px">-</td>
                    <td style="text-align:right;border:1px solid #ddd;padding:8px">${e.total || '0'}</td>
                </tr>
            `;
        }
        
        // Add total row
        mItems.innerHTML += `
            <tr style="background:#f9f9f9;font-weight:bold">
                <td colspan="3" style="border:1px solid #ddd;padding:8px;text-align:right">‡¶Æ‡ßã‡¶ü</td>
                <td style="border:1px solid #ddd;padding:8px;text-align:right">‡ß≥${e.total ? e.total.toFixed(2) : '0'}</td>
            </tr>
        `;
    }
    
    // Set signature
    const signs = {
        owner: ["Toosher Ahmed", "01913-812765"],
        admin: ["Arafat Sikder", "016749-44985"],
        roky: ["Roky", "01878-149052"]
    };
    
    const s = signs[e.user] || [e.user ? e.user.toUpperCase() : '', ""];
    document.getElementById("signatureName").innerText = s[0];
    document.getElementById("signaturePhone").innerText = s[1];
    
    // Show modal
    memoModal.style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// View Memo by Key
function viewMemo(key) {
    db.ref("entries/" + key).once("value", snapshot => {
        if(snapshot.exists()) {
            let data = snapshot.val();
            data.key = key;
            showMemo(data);
        } else {
            showTempMessage("‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø", "error");
        }
    });
}

// Print Customer Receipt
function printCustomerReceipt() {
    if(!currentCustomerData || !currentCustomerData.transactions || currentCustomerData.transactions.length === 0) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á!");
        return;
    }
    
    const latestTrans = currentCustomerData.transactions[0];
    viewMemo(latestTrans.key);
}

// ============================================
// EDIT & DELETE FUNCTIONS
// ============================================

// Open Edit Modal
function openEdit(key) {
    db.ref("entries/" + key).once("value", snapshot => {
        const d = snapshot.val();
        if(!d) return;
        
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note || '';
        document.getElementById("editPhone").value = d.phone || '';
        document.getElementById("editTotal").value = d.total || 0;
        document.getElementById("editTaken").value = d.taken || 0;
        
        // Calculate due
        calculateEditDue();
        
        // Show modal
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

// Calculate Edit Due
function calculateEditDue() {
    const total = parseFloat(document.getElementById("editTotal").value) || 0;
    const taken = parseFloat(document.getElementById("editTaken").value) || 0;
    const due = total - taken;
    
    document.getElementById("editDue").value = due.toFixed(2);
}

// Update Entry
function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    const due = t - k;
    
    const updates = {
        note: document.getElementById("editNote").value,
        phone: document.getElementById("editPhone").value,
        total: t,
        taken: k,
        loss: due
    };
    
    db.ref("entries/" + key).update(updates).then(() => {
        showTempMessage("‚úÖ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal("editModal");
        
        // Refresh data
        loadEntries();
        loadAllCustomers();
        loadSalesAnalytics();
        loadSalesByType();
        loadTodayDueList();
        
    }).catch(error => {
        showTempMessage("‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Delete Entry
function delEntry(key) {
    db.ref("entries/" + key).once("value", snapshot => {
        const entry = snapshot.val();
        
        // Permission check
        if(entry.user !== currentUser && currentUser !== 'admin' && currentUser !== 'owner') {
            alert("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!");
            return;
        }
        
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            // Return stock if items exist
            if(entry.items && Array.isArray(entry.items)) {
                entry.items.forEach(item => {
                    if(item.key && !item.isService) {
                        const prod = allProducts.find(p => p.key === item.key);
                        if(prod) {
                            const currentQty = parseFloat(prod.qty) || 0;
                            const returnQty = parseFloat(item.qty) || 0;
                            db.ref("products/" + item.key).update({ qty: currentQty + returnQty });
                        }
                    }
                });
            }
            
            // Delete entry
            db.ref("entries/" + key).remove().then(() => {
                showTempMessage("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "info");
                
                // Refresh data
                loadEntries();
                loadAllCustomers();
                loadSalesAnalytics();
                loadSalesByType();
                loadTodayDueList();
                
            }).catch(error => {
                showTempMessage("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
            });
        }
    });
}

// Return Last Sale
function returnLastSale() {
    if(currentUser !== 'owner' && currentUser !== 'admin') {
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá!");
        return;
    }
    
    if(!confirm("‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§")) {
        return;
    }
    
    db.ref("entries").limitToLast(1).once("value", snapshot => {
        const data = snapshot.val();
        if(!data) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶®‡ßá‡¶á!");
            return;
        }
        
        const key = Object.keys(data)[0];
        const entry = data[key];
        
        // Return stock
        if(entry.items && Array.isArray(entry.items)) {
            entry.items.forEach(item => {
                if(item.key && !item.isService) {
                    const prod = allProducts.find(p => p.key === item.key);
                    if(prod) {
                        const currentQty = parseFloat(prod.qty) || 0;
                        const returnQty = parseFloat(item.qty) || 0;
                        db.ref("products/" + item.key).update({ qty: currentQty + returnQty });
                    }
                }
            });
        }
        
        // Delete entry
        db.ref("entries/" + key).remove().then(() => {
            showTempMessage("‚úÖ ‡¶∂‡ßá‡¶∑ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
            
            // Refresh data
            loadEntries();
            loadAllCustomers();
            loadSalesAnalytics();
            loadSalesByType();
            loadTodayDueList();
            
        }).catch(error => {
            showTempMessage("‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
        });
    });
}

// Delete Product
function delProduct(key) {
    if(currentUser === 'owner' || currentUser === 'admin') {
        if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            db.ref("products/" + key).remove().then(() => {
                showTempMessage("‡¶™‡¶£‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "info");
            }).catch(error => {
                showTempMessage("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
            });
        }
    } else {
        alert("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
    }
}

// ============================================
// INVENTORY MANAGEMENT FUNCTIONS
// ============================================

// Toggle Stock Input
function toggleStockInput() {
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    const minStockInput = document.getElementById("stMinStock");
    
    if(isService) {
        if(qtyInput) {
            qtyInput.value = "";
            qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü";
            qtyInput.disabled = true;
            qtyInput.style.background = "#eee";
        }
        
        if(costInput) {
            costInput.value = "";
            costInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü";
            costInput.disabled = true;
            costInput.style.background = "#eee";
        }
        
        if(minStockInput) {
            minStockInput.value = "";
            minStockInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü";
            minStockInput.disabled = true;
            minStockInput.style.background = "#eee";
        }
    } else {
        if(qtyInput) {
            qtyInput.disabled = false;
            qtyInput.placeholder = "0";
            qtyInput.style.background = "#fff";
        }
        
        if(costInput) {
            costInput.disabled = false;
            costInput.placeholder = "0";
            costInput.style.background = "#fff";
        }
        
        if(minStockInput) {
            minStockInput.disabled = false;
            minStockInput.placeholder = "5";
            minStockInput.style.background = "#fff";
            minStockInput.value = "5";
        }
    }
}

// Add New Product
function addNewProduct() {
    const serial = document.getElementById("stSerial") ? document.getElementById("stSerial").value.trim() : "";
    const cat = document.getElementById("stCategory") ? document.getElementById("stCategory").value : "";
    const name = document.getElementById("stName") ? document.getElementById("stName").value.trim() : "";
    const sell = parseFloat(document.getElementById("stSell") ? document.getElementById("stSell").value : 0) || 0;
    const isService = document.getElementById("stIsService") ? document.getElementById("stIsService").checked : false;
    const minStock = parseFloat(document.getElementById("stMinStock") ? document.getElementById("stMinStock").value : 5) || 5;
    
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty") ? document.getElementById("stQty").value : 0) || 0;
        cost = parseFloat(document.getElementById("stCost") ? document.getElementById("stCost").value : 0) || 0;
    }
    
    // Validation
    if(!cat || cat === "" || !name || !sell) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø, ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
    }
    
    const newProd = {
        serial: serial,
        category: cat,
        name: name,
        qty: qty,
        isService: isService,
        costPrice: cost,
        sellPrice: sell,
        minStock: minStock
    };
    
    db.ref("products").push(newProd).then(() => {
        showTempMessage(isService ? "‚úÖ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!" : "‚úÖ ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        
        // Clear form
        clearStockForm();
        
    }).catch(error => {
        showTempMessage("‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Clear Stock Form
function clearStockForm() {
    const fields = ["stSerial", "stCategory", "stName", "stQty", "stCost", "stSell"];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field) field.value = "";
    });
    
    const isServiceCheck = document.getElementById("stIsService");
    if(isServiceCheck) {
        isServiceCheck.checked = false;
        toggleStockInput();
    }
    
    const minStock = document.getElementById("stMinStock");
    if(minStock) {
        minStock.value = "5";
    }
}

// Edit Stock Item
function editStockItem(key) {
    const product = allProducts.find(p => p.key === key);
    if(!product) return;
    
    document.getElementById("editStockKey").value = key;
    document.getElementById("editSerial").value = product.serial || "";
    document.getElementById("editCategory").value = product.category || "";
    document.getElementById("editName").value = product.name || "";
    
    const isServiceCheck = document.getElementById("editIsService");
    if(isServiceCheck) {
        isServiceCheck.checked = product.isService || false;
        toggleEditStockInput();
    }
    
    document.getElementById("editQty").value = product.qty || 0;
    document.getElementById("editCost").value = product.costPrice || 0;
    document.getElementById("editSell").value = product.sellPrice || 0;
    document.getElementById("editMinStock").value = product.minStock || 5;
    
    // Show modal
    document.getElementById("editStockModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// Toggle Edit Stock Input
function toggleEditStockInput() {
    const isService = document.getElementById("editIsService").checked;
    const qtyInput = document.getElementById("editQty");
    const costInput = document.getElementById("editCost");
    const minStockInput = document.getElementById("editMinStock");
    
    if(isService) {
        if(qtyInput) {
            qtyInput.disabled = true;
            qtyInput.style.background = "#eee";
        }
        if(costInput) {
            costInput.disabled = true;
            costInput.style.background = "#eee";
        }
        if(minStockInput) {
            minStockInput.disabled = true;
            minStockInput.style.background = "#eee";
        }
    } else {
        if(qtyInput) {
            qtyInput.disabled = false;
            qtyInput.style.background = "#fff";
        }
        if(costInput) {
            costInput.disabled = false;
            costInput.style.background = "#fff";
        }
        if(minStockInput) {
            minStockInput.disabled = false;
            minStockInput.style.background = "#fff";
        }
    }
}

// Update Stock Item
function updateStockItem() {
    const key = document.getElementById("editStockKey").value;
    const serial = document.getElementById("editSerial").value.trim();
    const category = document.getElementById("editCategory").value;
    const name = document.getElementById("editName").value.trim();
    const isService = document.getElementById("editIsService").checked;
    const qty = parseFloat(document.getElementById("editQty").value) || 0;
    const costPrice = parseFloat(document.getElementById("editCost").value) || 0;
    const sellPrice = parseFloat(document.getElementById("editSell").value) || 0;
    const minStock = parseFloat(document.getElementById("editMinStock").value) || 5;
    
    if(!category || !name || !sellPrice) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø, ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
        return;
    }
    
    const updates = {
        serial: serial,
        category: category,
        name: name,
        isService: isService,
        sellPrice: sellPrice,
        minStock: minStock
    };
    
    if(!isService) {
        updates.qty = qty;
        updates.costPrice = costPrice;
    } else {
        updates.qty = 0;
        updates.costPrice = 0;
    }
    
    db.ref("products/" + key).update(updates).then(() => {
        showTempMessage("‚úÖ ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal('editStockModal');
    }).catch(error => {
        showTempMessage("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Filter Stock Table
function filterStockTable() {
    const categoryFilter = document.getElementById("filterCategory") ? document.getElementById("filterCategory").value.toLowerCase() : "";
    const searchTerm = document.getElementById("stockSearch") ? document.getElementById("stockSearch").value.toLowerCase() : "";
    const rows = document.querySelectorAll("#stockBody tr");
    
    let visibleCount = 0;
    let lowStockVisible = 0;
    let zeroStockVisible = 0;
    
    rows.forEach(row => {
        if(row.cells.length < 3) return;
        
        const category = row.cells[1].textContent.toLowerCase();
        const name = row.cells[2].textContent.toLowerCase();
        const serial = row.cells[0].textContent.toLowerCase();
        
        const categoryMatch = !categoryFilter || category.includes(categoryFilter);
        const searchMatch = !searchTerm || 
            name.includes(searchTerm) || 
            serial.includes(searchTerm) ||
            category.includes(searchTerm);
        
        if(categoryMatch && searchMatch) {
            row.style.display = "";
            visibleCount++;
            
            // Check stock status
            if(row.classList.contains("low-stock")) {
                lowStockVisible++;
            }
            if(row.classList.contains("zero-stock")) {
                zeroStockVisible++;
            }
        } else {
            row.style.display = "none";
        }
    });
    
    // Update counts
    updateElement("totalProducts", visibleCount);
    updateElement("lowStockCount", lowStockVisible);
    updateElement("zeroStockCount", zeroStockVisible);
}

// Check Low Stock
function checkLowStock() {
    if(!allProducts.length) return;
    
    let lowStockItems = [];
    let zeroStockItems = [];
    let criticalItems = [];
    
    allProducts.forEach(p => {
        if(!p.isService) {
            const minStock = p.minStock || 5;
            const currentStock = p.qty || 0;
            
            if(currentStock <= 0) {
                zeroStockItems.push({
                    name: p.name,
                    category: p.category,
                    stock: currentStock,
                    priority: 4
                });
            } else if(currentStock <= minStock) {
                let priority = 1;
                let warningMsg = "";
                
                if(p.category === "Paper" && currentStock <= 2) {
                    priority = 3;
                    warningMsg = "‡¶ï‡¶æ‡¶ó‡¶ú ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡¶∂‡ßá‡¶∑!";
                } else if(p.category === "Pen" && currentStock <= 10) {
                    priority = 2;
                    warningMsg = "‡¶ï‡¶≤‡¶Æ ‡¶ï‡¶Æ!";
                } else if(p.category === "Khata" && currentStock <= 5) {
                    priority = 2;
                    warningMsg = "‡¶ñ‡¶æ‡¶§‡¶æ ‡¶ï‡¶Æ!";
                } else if(currentStock <= minStock) {
                    priority = 1;
                    warningMsg = "‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶Æ!";
                }
                
                lowStockItems.push({
                    name: p.name,
                    stock: currentStock,
                    min: minStock,
                    category: p.category,
                    priority: priority,
                    warning: warningMsg
                });
                
                if(priority >= 2) {
                    criticalItems.push({
                        name: p.name,
                        message: `${p.name} - ‡¶∏‡ßç‡¶ü‡¶ï: ${currentStock} (${warningMsg})`
                    });
                }
            }
        }
    });
    
    // Show alerts
    if(zeroStockItems.length > 0) {
        showStockAlert(zeroStockItems, "zero");
    }
    
    if(criticalItems.length > 0 && (currentUser === 'owner' || currentUser === 'admin')) {
        showStockAlert(criticalItems, "critical");
    }
    
    // Update stock status bar
    updateStockStatusBar(lowStockItems.length, zeroStockItems.length);
}

// Show Stock Alert
function showStockAlert(items, type) {
    if(items.length === 0) return;
    
    const alertBar = document.getElementById("stockAlertBar");
    if(!alertBar) return;
    
    let alertHTML = "";
    
    if(type === "zero") {
        alertHTML = `<span style="color:#e74c3c">üö® ${items.length}‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑</span>`;
    } else {
        alertHTML = `<span style="color:#f39c12">‚ö†Ô∏è ${items.length}‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶Æ</span>`;
    }
    
    alertBar.innerHTML = alertHTML;
    alertBar.style.display = "flex";
    
    // Auto hide after 10 seconds
    setTimeout(() => {
        alertBar.style.display = "none";
    }, 10000);
}

// Update Stock Status Bar
function updateStockStatusBar(lowCount, zeroCount) {
    const statusBar = document.getElementById('stockAlertBar');
    if(!statusBar) return;
    
    let statusHTML = "";
    
    if(zeroCount > 0) {
        statusHTML += `<span style="background:#e74c3c;color:white;padding:5px 10px;border-radius:4px;margin-right:5px">
            ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø: ${zeroCount}
        </span>`;
    }
    
    if(lowCount > 0) {
        statusHTML += `<span style="background:#f39c12;color:white;padding:5px 10px;border-radius:4px;margin-right:5px">
            ‡¶ï‡¶Æ: ${lowCount}
        </span>`;
    }
    
    if(zeroCount === 0 && lowCount === 0) {
        statusHTML = `<span style="background:#27ae60;color:white;padding:5px 10px;border-radius:4px">
            ‚úÖ ‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá
        </span>`;
    }
    
    statusBar.innerHTML = statusHTML;
    
    if(zeroCount > 0 || lowCount > 0) {
        statusBar.style.display = "flex";
    } else {
        statusBar.style.display = "none";
    }
}

// Export Stock to Excel
function exportStockToExcel() {
    if(allProducts.length === 0) {
        alert("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á!");
        return;
    }
    
    let csv = "\ufeff‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤,‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø,‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ,‡¶∏‡ßç‡¶ü‡¶ï,‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶∏‡ßç‡¶ü‡¶ï,‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ,‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø,‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏\n";
    
    allProducts.forEach(p => {
        const isService = p.isService ? "‡¶π‡ßç‡¶Ø‡¶æ‡¶Å" : "‡¶®‡¶æ";
        const minStock = p.minStock || 5;
        const costPrice = p.isService ? "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü" : (p.costPrice || "0");
        
        csv += `"${p.serial || ''}","${p.category || ''}","${p.name || ''}",${p.qty || 0},${minStock},${costPrice},${p.sellPrice || 0},${isService}\n`;
    });
    
    // Create download link
    const link = document.createElement("a");
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    link.href = url;
    link.download = `‡¶∏‡ßç‡¶ü‡¶ï_‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü_${new Date().toLocaleDateString('bn-BD')}.csv`;
    link.click();
    
    URL.revokeObjectURL(url);
}

// ============================================
// CUSTOMER MANAGEMENT FUNCTIONS
// ============================================

// Search Customer
function searchCustomer() {
    const query = document.getElementById("searchCustomerInput") ? document.getElementById("searchCustomerInput").value.trim() : "";
    if (!query) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    showTempMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...", "info");
    
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        const customers = {};
        let found = false;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone || "";
            const note = entry.note || "";
            
            if (phone.includes(query) || note.toLowerCase().includes(query.toLowerCase())) {
                found = true;
                
                if (!customers[phone]) {
                    customers[phone] = {
                        name: note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: "",
                        transactions: []
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                
                customers[phone].transactions.push({
                    key: key,
                    date: entry.date,
                    time: entry.time,
                    total: entry.total,
                    paid: entry.taken,
                    due: entry.loss,
                    items: entry.items,
                    user: entry.user
                });
            }
        });
        
        if (!found) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }
        
        const customerList = Object.values(customers);
        if (customerList.length === 1) {
            currentCustomerData = customerList[0];
            showCustomerDetails(currentCustomerData);
        } else {
            showCustomerList(customerList);
        }
    });
}

// Show Customer List Modal
function showCustomerList(customers) {
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.width = '500px';
    modal.style.zIndex = '2000';
    
    let html = '<h3 style="margin-top:0;color:#3498db;">‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</h3>';
    html += '<p style="margin-bottom:15px;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</p>';
    html += '<div style="max-height:300px;overflow-y:auto;margin-bottom:20px;">';
    
    customers.forEach((customer, index) => {
        html += `
            <div style="padding:12px;border-bottom:1px solid #eee;cursor:pointer;border-radius:5px;margin-bottom:5px;background:#f8f9fa;" 
                 onclick="selectCustomerFromList('${customer.phone}')" 
                 onmouseover="this.style.background='#e8f5e9'" 
                 onmouseout="this.style.background='#f8f9fa'">
                <div style="font-weight:bold;color:#2c3e50;">${customer.name}</div>
                <div style="font-size:14px;color:#666;">
                    <span>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${customer.phone || '‡¶®‡ßá‡¶á'}</span> | 
                    <span>‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</span> | 
                    <span>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    html += '<button onclick="closeCustomerListModal()" style="background:#e74c3c;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>';
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
    
    // Position modal
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.display = 'block';
    
    // Show overlay
    document.getElementById("overlay").style.display = "block";
    
    // Store modal reference
    window.customerListModal = modal;
}

// Close Customer List Modal
function closeCustomerListModal() {
    if (window.customerListModal && window.customerListModal.parentNode) {
        document.body.removeChild(window.customerListModal);
        window.customerListModal = null;
    }
    document.getElementById("overlay").style.display = "none";
}

// Select Customer from List
function selectCustomerFromList(phone) {
    closeCustomerListModal();
    
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            if (entry.phone === phone) {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: "",
                        transactions: []
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
                
                customers[phone].transactions.push({
                    key: key,
                    date: entry.date,
                    time: entry.time,
                    total: entry.total,
                    paid: entry.taken,
                    due: entry.loss,
                    items: entry.items,
                    user: entry.user
                });
            }
        });
        
        if (customers[phone]) {
            currentCustomerData = customers[phone];
            showCustomerDetails(currentCustomerData);
        }
    });
}

// Show Customer Details
function showCustomerDetails(customer) {
    currentCustomerData = customer;
    
    const customerDetails = document.getElementById("customerDetails");
    const customerHistorySection = document.getElementById("customerHistorySection");
    
    if (customerDetails) {
        customerDetails.style.display = "block";
    }
    
    if (customerHistorySection) {
        customerHistorySection.style.display = "block";
    }
    
    // Update title
    document.getElementById("customerNameTitle").innerText = customer.name;
    
    // Update customer info
    const infoDiv = document.getElementById("customerInfo");
    if (infoDiv) {
        infoDiv.innerHTML = `
            <div class="customer-summary ${customer.totalDue > 0 ? 'due-alert' : 'paid-alert'}">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px;">
                    <div>
                        <strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong><br>
                        <span style="font-size:18px;font-weight:bold;">${customer.name}</span>
                    </div>
                    <div>
                        <strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</strong><br>
                        <span style="font-size:18px;color:#3498db;">${customer.phone || "‡¶®‡ßá‡¶á"}</span>
                    </div>
                </div>
                
                <div class="customer-stats">
                    <div class="stat-box">
                        <div style="font-size:14px;color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ</div>
                        <div class="stat-value" style="color:#2c3e50;">‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</div>
                    </div>
                    <div class="stat-box">
                        <div style="font-size:14px;color:#666;">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</div>
                        <div class="stat-value" style="color:#27ae60;">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</div>
                    </div>
                    <div class="stat-box">
                        <div style="font-size:14px;color:#666;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</div>
                        <div class="stat-value" style="color:${customer.totalDue > 0 ? '#e74c3c' : '#2ecc71'};">‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}</div>
                    </div>
                </div>
                
                <div style="margin-top:15px;color:#666;font-size:14px;">
                    <span>‡¶∂‡ßá‡¶∑ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ: ${customer.lastDate || "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á"}</span>
                    <span style="float:right;">‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®: ${customer.transactions ? customer.transactions.length : 0}‡¶ü‡¶ø</span>
                </div>
            </div>
        `;
    }
    
    // Display transactions
    displayCustomerTransactions(customer.transactions || []);
}

// Display Customer Transactions
function displayCustomerTransactions(transactions) {
    const tbody = document.getElementById("customerTransactions");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    if (transactions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>`;
        return;
    }
    
    // Sort by date (newest first)
    transactions.sort((a, b) => {
        const dateA = a.date ? a.date.split('/').reverse().join('-') : '1970-01-01';
        const dateB = b.date ? b.date.split('/').reverse().join('-') : '1970-01-01';
        return new Date(dateB) - new Date(dateA);
    });
    
    // Update count
    const historyCount = document.getElementById("historyCount");
    if (historyCount) {
        historyCount.innerText = `${transactions.length}‡¶ü‡¶ø ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®`;
    }
    
    // Add transactions to table
    transactions.forEach(trans => {
        const itemSummary = trans.items && Array.isArray(trans.items) 
            ? trans.items.slice(0, 2).map(i => `${i.work}`).join(', ') + (trans.items.length > 2 ? '...' : '')
            : "‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶£‡ßç‡¶Ø";
        
        tbody.innerHTML += `
            <tr>
                <td>${trans.date || ''}<br><small>${trans.time || ''}</small></td>
                <td><small>${trans.key ? trans.key.slice(-6).toUpperCase() : ''}</small></td>
                <td>${itemSummary}</td>
                <td>‡ß≥${trans.total || '0'}</td>
                <td style="color:#27ae60;font-weight:bold">‡ß≥${trans.paid || '0'}</td>
                <td style="color:${trans.due > 0 ? '#e74c3c' : '#27ae60'}">‡ß≥${trans.due || '0'}</td>
                <td class="noPrint">
                    <button class="btn-action btn-print" onclick="viewMemo('${trans.key}')" title="‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®">üñ®Ô∏è</button>
                </td>
            </tr>
        `;
    });
}

// Load All Customers
function loadAllCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            
            if (phone && entry.note && entry.note !== "General Customer") {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: ""
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
            }
        });
        
        displayAllCustomersTable(customers);
    });
}

// Display All Customers Table
function displayAllCustomersTable(customers) {
    const tbody = document.getElementById("allCustomers");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    const customerList = Object.values(customers);
    if (customerList.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
        return;
    }
    
    // Sort by due amount (highest first)
    customerList.sort((a, b) => (b.totalDue || 0) - (a.totalDue || 0));
    
    // Calculate totals
    let totalCustomers = 0;
    let totalDueAmount = 0;
    
    customerList.forEach(customer => {
        totalCustomers++;
        totalDueAmount += customer.totalDue || 0;
        
        // Action buttons
        const btnEdit = `<button class="btn-action btn-edit" onclick="editCustomerDetails('${customer.phone}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnView = `<button class="btn-action btn-print" onclick="viewCustomerDetail('${customer.phone}')" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§">üëÅÔ∏è</button>`;
        
        tbody.innerHTML += `
            <tr style="${customer.totalDue > 0 ? 'background:#fff8f8' : ''}">
                <td><strong>${customer.name}</strong></td>
                <td>${customer.phone}</td>
                <td>‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</td>
                <td style="color:#27ae60">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</td>
                <td style="color:${customer.totalDue > 0 ? '#e74c3c' : '#27ae60'};font-weight:bold">
                    ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'} ${customer.totalDue > 0 ? '‚ö†Ô∏è' : '‚úÖ'}
                </td>
                <td>${customer.lastDate || 'N/A'}</td>
                <td class="noPrint" style="text-align:center">${btnView} ${btnEdit}</td>
            </tr>
        `;
    });
    
    // Update summary
    updateElement("totalCustomerCount", totalCustomers);
    updateElement("totalDueAmount", totalDueAmount.toFixed(2));
}

// Edit Customer Details
function editCustomerDetails(phone) {
    // Set search input
    const searchInput = document.getElementById("searchCustomerInput");
    if (searchInput) {
        searchInput.value = phone;
    }
    
    // Search and show customer
    searchCustomer();
}

// View Customer Detail
function viewCustomerDetail(phone) {
    const searchInput = document.getElementById("searchCustomerInput");
    if (searchInput) {
        searchInput.value = phone;
        searchCustomer();
    }
}

// Clear Customer Search
function clearCustomerSearch() {
    const customerDetails = document.getElementById("customerDetails");
    const customerHistorySection = document.getElementById("customerHistorySection");
    const searchInput = document.getElementById("searchCustomerInput");
    
    if (customerDetails) {
        customerDetails.style.display = "none";
    }
    
    if (customerHistorySection) {
        customerHistorySection.style.display = "none";
    }
    
    if (searchInput) {
        searchInput.value = "";
    }
    
    currentCustomerData = null;
}

// Add Payment for Customer
function addPaymentForCustomer(phone, name, due) {
    if (!phone || !name) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        return;
    }
    
    // Set payment modal values
    document.getElementById("payCustomerName").value = name;
    document.getElementById("payCustomerPhone").value = phone;
    document.getElementById("payCurrentDue").value = due ? due.toFixed(2) : '0.00';
    document.getElementById("payAmount").value = "";
    document.getElementById("payComment").value = "‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø";
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    
    // Show modal
    document.getElementById("paymentModal").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

// Add Payment
function addPayment() {
    if (!currentCustomerData) {
        alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®!");
        return;
    }
    
    addPaymentForCustomer(
        currentCustomerData.phone,
        currentCustomerData.name,
        currentCustomerData.totalDue
    );
}

// Process Payment
function processPayment() {
    const amount = parseFloat(document.getElementById("payAmount").value);
    const date = document.getElementById("payDate").value;
    const comment = document.getElementById("payComment").value || "‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ";
    
    if (!amount || amount <= 0) {
        alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    if (!currentCustomerData) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        return;
    }
    
    // Format date
    const formattedDate = date.split('-').reverse().join('/');
    
    // Create payment entry
    const paymentEntry = {
        date: formattedDate,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: [{ work: comment, qty: 1, rate: amount, sub: amount }],
        total: amount,
        taken: amount,
        loss: 0,
        user: currentUser,
        note: `${currentCustomerData.name} - ${comment}`,
        phone: currentCustomerData.phone,
        isPayment: true
    };
    
    // Save to Firebase
    db.ref("entries").push(paymentEntry).then(() => {
        showTempMessage(`‚úÖ ‡ß≥${amount.toFixed(2)} ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
        closeModal('paymentModal');
        
        // Refresh customer data
        searchCustomer();
        loadAllCustomers();
        loadTodayDueList();
        
    }).catch(error => {
        showTempMessage("‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Quick Payment
function quickPayment() {
    const name = document.getElementById("quickCustomerName") ? document.getElementById("quickCustomerName").value.trim() : "";
    const phone = document.getElementById("quickCustomerPhone") ? document.getElementById("quickCustomerPhone").value.trim() : "";
    const amount = parseFloat(document.getElementById("quickPaymentAmount") ? document.getElementById("quickPaymentAmount").value : 0) || 0;
    
    if (!name) {
        alert("‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!");
        return;
    }
    
    if (!amount || amount <= 0) {
        alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    // Clean phone number
    const cleanPhone = phone.replace(/\D/g, '');
    
    // Create payment entry
    const paymentEntry = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        items: [{ work: "‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ", qty: 1, rate: amount, sub: amount }],
        total: amount,
        taken: amount,
        loss: 0,
        user: currentUser,
        note: `${name} - ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ú‡¶Æ‡¶æ`,
        phone: cleanPhone || "",
        isPayment: true
    };
    
    // Save to Firebase
    db.ref("entries").push(paymentEntry).then(() => {
        showTempMessage(`‚úÖ ‡ß≥${amount.toFixed(2)} ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
        
        // Clear form
        document.getElementById("quickCustomerName").value = "";
        document.getElementById("quickCustomerPhone").value = "";
        document.getElementById("quickPaymentAmount").value = "";
        
        // Refresh data
        loadAllCustomers();
        loadTodayDueList();
        
    }).catch(error => {
        showTempMessage("‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Show Due Customers
function showDueCustomers() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        let totalDue = 0;
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            
            if (phone && entry.note && entry.note !== "General Customer" && entry.loss > 0) {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: ""
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                totalDue += parseFloat(entry.loss) || 0;
                
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
            }
        });
        
        // Display only customers with due
        const dueCustomers = Object.values(customers).filter(c => c.totalDue > 0);
        
        const tbody = document.getElementById("allCustomers");
        if (tbody) {
            tbody.innerHTML = "";
            
            if (dueCustomers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡ßá‡¶á</td></tr>`;
                return;
            }
            
            // Sort by due amount (highest first)
            dueCustomers.sort((a, b) => b.totalDue - a.totalDue);
            
            dueCustomers.forEach(customer => {
                tbody.innerHTML += `
                    <tr style="background:#fff8f8">
                        <td><strong>${customer.name}</strong></td>
                        <td>${customer.phone}</td>
                        <td>‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</td>
                        <td style="color:#27ae60">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</td>
                        <td style="color:#e74c3c;font-weight:bold">
                            ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'} ‚ö†Ô∏è
                        </td>
                        <td>${customer.lastDate || 'N/A'}</td>
                        <td class="noPrint" style="text-align:center">
                            <button class="btn-action btn-edit" onclick="addPaymentForCustomer('${customer.phone}', '${customer.name}', ${customer.totalDue})" title="‡¶ú‡¶Æ‡¶æ">üí∞</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        // Update summary
        updateElement("totalCustomerCount", dueCustomers.length);
        updateElement("totalDueAmount", totalDue.toFixed(2));
    });
}

// Show Customers with Phone
function showCustomersWithPhone() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        if (!data) return;
        
        const customers = {};
        
        Object.keys(data).forEach(key => {
            const entry = data[key];
            const phone = entry.phone;
            
            if (phone && phone.length >= 11 && entry.note && entry.note !== "General Customer") {
                if (!customers[phone]) {
                    customers[phone] = {
                        name: entry.note,
                        phone: phone,
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDue: 0,
                        lastDate: ""
                    };
                }
                
                customers[phone].totalSpent += parseFloat(entry.total) || 0;
                customers[phone].totalPaid += parseFloat(entry.taken) || 0;
                customers[phone].totalDue += parseFloat(entry.loss) || 0;
                
                if (!customers[phone].lastDate || entry.date > customers[phone].lastDate) {
                    customers[phone].lastDate = entry.date;
                }
            }
        });
        
        const phoneCustomers = Object.values(customers);
        
        const tbody = document.getElementById("allCustomers");
        if (tbody) {
            tbody.innerHTML = "";
            
            if (phoneCustomers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡ßá‡¶á</td></tr>`;
                return;
            }
            
            phoneCustomers.sort((a, b) => b.totalSpent - a.totalSpent);
            
            phoneCustomers.forEach(customer => {
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td style="color:#3498db;font-weight:bold">${customer.phone}</td>
                        <td>‡ß≥${customer.totalSpent ? customer.totalSpent.toFixed(2) : '0.00'}</td>
                        <td style="color:#27ae60">‡ß≥${customer.totalPaid ? customer.totalPaid.toFixed(2) : '0.00'}</td>
                        <td style="color:${customer.totalDue > 0 ? '#e74c3c' : '#27ae60'}">
                            ‡ß≥${customer.totalDue ? customer.totalDue.toFixed(2) : '0.00'}
                        </td>
                        <td>${customer.lastDate || 'N/A'}</td>
                        <td class="noPrint" style="text-align:center">
                            <button class="btn-action btn-print" onclick="viewCustomerDetail('${customer.phone}')" title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§">üëÅÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        // Update summary
        updateElement("totalCustomerCount", phoneCustomers.length);
        
        // Calculate total due
        let totalDue = 0;
        phoneCustomers.forEach(c => totalDue += c.totalDue);
        updateElement("totalDueAmount", totalDue.toFixed(2));
    });
}

// ============================================
// EXPENSE MANAGEMENT FUNCTIONS
// ============================================

// Load Expenses
function loadExpenses() {
    db.ref("expenses").orderByChild("timestamp").once("value", snapshot => {
        const expenses = snapshot.val() || {};
        const tbody = document.getElementById("expenseList");
        
        if(!tbody) return;
        
        tbody.innerHTML = "";
        
        let monthlyTotal = 0;
        let yearlyTotal = 0;
        const now = new Date();
        const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
        const currentYear = now.getFullYear().toString();
        
        const expensesArray = Object.keys(expenses).map(key => ({...expenses[key], key})).reverse();
        
        // Update expense count
        updateElement("expenseCount", expensesArray.length);
        
        if(expensesArray.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:30px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</td></tr>`;
            
            // Update totals
            updateElement("monthlyExpenseTotal", "0");
            updateElement("yearlyExpenseTotal", "0");
            updateElement("filteredExpenseTotal", "0");
            return;
        }
        
        // Add expenses to table
        expensesArray.forEach(exp => {
            const categoryName = getExpenseCategoryName(exp.category);
            const btnEdit = `<button class="btn-action btn-edit" onclick="editExpense('${exp.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
            const btnDel = `<button class="btn-action btn-del" onclick="deleteExpense('${exp.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">üóëÔ∏è</button>`;
            
            tbody.innerHTML += `
                <tr>
                    <td>${exp.date}</td>
                    <td>${exp.description}</td>
                    <td>${categoryName}</td>
                    <td style="color:#e74c3c;font-weight:bold">‡ß≥${exp.amount}</td>
                    <td class="noPrint" style="text-align:center">${btnEdit} ${btnDel}</td>
                </tr>
            `;
            
            // Calculate totals
            const amount = parseFloat(exp.amount) || 0;
            
            // Monthly total (current month)
            if(exp.date && exp.date.includes(`/${currentMonth}/${currentYear}`)) {
                monthlyTotal += amount;
            }
            
            // Yearly total (current year)
            if(exp.date && exp.date.includes(`/${currentYear}`)) {
                yearlyTotal += amount;
            }
        });
        
        // Update totals
        updateElement("monthlyExpenseTotal", monthlyTotal.toFixed(2));
        updateElement("yearlyExpenseTotal", yearlyTotal.toFixed(2));
        updateElement("filteredExpenseTotal", monthlyTotal.toFixed(2));
        
        // Update expense chart
        updateExpenseChart();
        
        // Update sales analytics
        loadSalesAnalytics();
    });
}

// Get Expense Category Name
function getExpenseCategoryName(cat) {
    const categories = {
        utility: "‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏/‡¶™‡¶æ‡¶®‡¶ø",
        rent: "‡¶≠‡¶æ‡ßú‡¶æ",
        salary: "‡¶¨‡ßá‡¶§‡¶®",
        maintenance: "‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§",
        purchase: "‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡¶æ",
        transport: "‡¶Ø‡¶æ‡¶®‡¶¨‡¶æ‡¶π‡¶®",
        other: "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø"
    };
    return categories[cat] || cat;
}

// Add Expense
function addExpense() {
    const desc = document.getElementById("expenseDesc") ? document.getElementById("expenseDesc").value.trim() : "";
    const amount = parseFloat(document.getElementById("expenseAmount") ? document.getElementById("expenseAmount").value : 0) || 0;
    const dateInput = document.getElementById("expenseDate") ? document.getElementById("expenseDate").value : "";
    const category = document.getElementById("expenseCategory") ? document.getElementById("expenseCategory").value : "other";
    
    // Validation
    if(!desc) {
        alert("‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®!");
        return;
    }
    
    if(!amount || amount <= 0) {
        alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    // Format date
    const date = dateInput ? dateInput.split('-').reverse().join('/') : new Date().toLocaleDateString("en-GB");
    
    // Prepare expense data
    const expenseData = {
        description: desc,
        amount: amount,
        date: date,
        category: category,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        addedBy: currentUser
    };
    
    // Save to Firebase
    db.ref("expenses").push(expenseData).then(() => {
        showTempMessage("‚úÖ ‡¶ñ‡¶∞‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        
        // Clear form
        clearExpenseForm();
        
        // Reload expenses
        loadExpenses();
        
    }).catch(error => {
        showTempMessage("‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Clear Expense Form
function clearExpenseForm() {
    const fields = ["expenseDesc", "expenseAmount"];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field) field.value = "";
    });
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    const dateField = document.getElementById("expenseDate");
    if(dateField) dateField.value = today;
}

// Edit Expense
function editExpense(key) {
    db.ref("expenses/" + key).once("value", snapshot => {
        const expense = snapshot.val();
        if(!expense) return;
        
        // Fill form
        document.getElementById("editExpenseKey").value = key;
        document.getElementById("editExpenseDesc").value = expense.description || "";
        document.getElementById("editExpenseAmount").value = expense.amount || 0;
        
        // Format date
        let dateValue = expense.date || "";
        if(dateValue.includes('/')) {
            const parts = dateValue.split('/');
            dateValue = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        document.getElementById("editExpenseDate").value = dateValue;
        
        document.getElementById("editExpenseCategory").value = expense.category || "other";
        
        // Show modal
        document.getElementById("editExpenseModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}

// Update Expense
function updateExpense() {
    const key = document.getElementById("editExpenseKey").value;
    const desc = document.getElementById("editExpenseDesc").value.trim();
    const amount = parseFloat(document.getElementById("editExpenseAmount").value) || 0;
    const dateInput = document.getElementById("editExpenseDate").value;
    const category = document.getElementById("editExpenseCategory").value;
    
    // Validation
    if(!desc) {
        alert("‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®!");
        return;
    }
    
    if(!amount || amount <= 0) {
        alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }
    
    // Format date
    const date = dateInput ? dateInput.split('-').reverse().join('/') : new Date().toLocaleDateString("en-GB");
    
    const updates = {
        description: desc,
        amount: amount,
        date: date,
        category: category
    };
    
    db.ref("expenses/" + key).update(updates).then(() => {
        showTempMessage("‚úÖ ‡¶ñ‡¶∞‡¶ö ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal('editExpenseModal');
        loadExpenses();
        
    }).catch(error => {
        showTempMessage("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Delete Expense
function deleteExpense(key) {
    if(confirm("‡¶ñ‡¶∞‡¶ö ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        db.ref("expenses/" + key).remove().then(() => {
            showTempMessage("‡¶ñ‡¶∞‡¶ö ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "info");
            loadExpenses();
            
        }).catch(error => {
            showTempMessage("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
        });
    }
}

// Filter Expenses
function filterExpenses() {
    const monthFilter = document.getElementById("expenseMonthFilter") ? document.getElementById("expenseMonthFilter").value : "all";
    const typeFilter = document.getElementById("expenseTypeFilter") ? document.getElementById("expenseTypeFilter").value : "all";
    
    db.ref("expenses").once("value", snapshot => {
        const expenses = snapshot.val() || {};
        const tbody = document.getElementById("expenseList");
        
        if(!tbody) return;
        
        tbody.innerHTML = "";
        
        let filteredTotal = 0;
        const now = new Date();
        const currentYear = now.getFullYear().toString();
        
        const expensesArray = Object.keys(expenses).map(key => ({...expenses[key], key})).reverse();
        
        // Filter expenses
        const filteredExpenses = expensesArray.filter(exp => {
            let monthMatch = true;
            let typeMatch = true;
            
            // Month filter
            if(monthFilter !== "all" && exp.date) {
                const dateParts = exp.date.split('/');
                if(dateParts.length >= 2) {
                    const month = dateParts[1];
                    monthMatch = month === monthFilter;
                }
            }
            
            // Type filter
            if(typeFilter !== "all") {
                typeMatch = exp.category === typeFilter;
            }
            
            return monthMatch && typeMatch;
        });
        
        if(filteredExpenses.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:30px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
            updateElement("filteredExpenseTotal", "0");
            return;
        }
        
        // Add filtered expenses to table
        filteredExpenses.forEach(exp => {
            const categoryName = getExpenseCategoryName(exp.category);
            const btnEdit = `<button class="btn-action btn-edit" onclick="editExpense('${exp.key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
            const btnDel = `<button class="btn-action btn-del" onclick="deleteExpense('${exp.key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">üóëÔ∏è</button>`;
            
            tbody.innerHTML += `
                <tr>
                    <td>${exp.date}</td>
                    <td>${exp.description}</td>
                    <td>${categoryName}</td>
                    <td style="color:#e74c3c;font-weight:bold">‡ß≥${exp.amount}</td>
                    <td class="noPrint" style="text-align:center">${btnEdit} ${btnDel}</td>
                </tr>
            `;
            
            // Calculate total
            filteredTotal += parseFloat(exp.amount) || 0;
        });
        
        // Update filtered total
        updateElement("filteredExpenseTotal", filteredTotal.toFixed(2));
    });
}

// Export Expenses to Excel
function exportExpensesToExcel() {
    db.ref("expenses").once("value", snapshot => {
        const expenses = snapshot.val() || {};
        
        if(Object.keys(expenses).length === 0) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á!");
            return;
        }
        
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶ß‡¶∞‡¶£,‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£,‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®\n";
        
        Object.keys(expenses).forEach(key => {
            const exp = expenses[key];
            const categoryName = getExpenseCategoryName(exp.category);
            
            csv += `"${exp.date || ''}","${exp.description || ''}","${categoryName}",${exp.amount || 0},"${exp.addedBy || ''}"\n`;
        });
        
        // Create download link
        const link = document.createElement("a");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        link.href = url;
        link.download = `‡¶ñ‡¶∞‡¶ö_‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü_${new Date().toLocaleDateString('bn-BD')}.csv`;
        link.click();
        
        URL.revokeObjectURL(url);
    });
}

// Update Expense Chart
function updateExpenseChart() {
    db.ref("expenses").once("value", snapshot => {
        const expenses = snapshot.val() || {};
        const ctx = document.getElementById('expenseChart');
        
        if(!ctx || Object.keys(expenses).length === 0) return;
        
        // Categorize expenses
        const categories = {
            utility: 0,
            rent: 0,
            salary: 0,
            maintenance: 0,
            purchase: 0,
            transport: 0,
            other: 0
        };
        
        Object.keys(expenses).forEach(key => {
            const exp = expenses[key];
            const category = exp.category || 'other';
            const amount = parseFloat(exp.amount) || 0;
            
            if(categories.hasOwnProperty(category)) {
                categories[category] += amount;
            } else {
                categories.other += amount;
            }
        });
        
        // Filter out zero categories
        const labels = [];
        const data = [];
        const colors = [
            '#3498db', '#2ecc71', '#e74c3c', '#f39c12',
            '#9b59b6', '#1abc9c', '#95a5a6'
        ];
        
        Object.keys(categories).forEach((cat, index) => {
            if(categories[cat] > 0) {
                labels.push(getExpenseCategoryName(cat));
                data.push(categories[cat]);
            }
        });
        
        // Destroy existing chart
        if(expenseChart) {
            expenseChart.destroy();
        }
        
        // Create new chart
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ‡ß≥${context.raw.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    });
}

// ============================================
// SALES ANALYTICS FUNCTIONS
// ============================================

// Load Sales Analytics
function loadSalesAnalytics() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    const currentMonthStr = `${now.getDate().toString().padStart(2, '0')}/${(currentMonth).toString().padStart(2, '0')}/${currentYear}`;
    const currentMonthStrShort = `${(currentMonth).toString().padStart(2, '0')}/${currentYear}`;
    const currentYearStr = `${currentYear}`;
    
    let monthlySales = 0;
    let yearlySales = 0;
    let monthlyCost = 0;
    let yearlyCost = 0;
    
    // Load expenses first
    db.ref("expenses").once("value", expenseSnapshot => {
        const expenses = expenseSnapshot.val() || {};
        
        Object.keys(expenses).forEach(key => {
            const expense = expenses[key];
            const expenseDate = expense.date || "";
            const expenseAmount = parseFloat(expense.amount) || 0;
            
            // Monthly expenses
            if(expenseDate.includes(currentMonthStrShort)) {
                monthlyCost += expenseAmount;
            }
            
            // Yearly expenses
            if(expenseDate.includes(`/${currentYear}`)) {
                yearlyCost += expenseAmount;
            }
        });
        
        // Load sales
        db.ref("entries").once("value", salesSnapshot => {
            const sales = salesSnapshot.val() || {};
            
            Object.keys(sales).forEach(key => {
                const sale = sales[key];
                const saleDate = sale.date || "";
                const saleTotal = parseFloat(sale.total) || 0;
                
                // Monthly sales
                if(saleDate.includes(currentMonthStrShort)) {
                    monthlySales += saleTotal;
                }
                
                // Yearly sales
                if(saleDate.includes(`/${currentYear}`)) {
                    yearlySales += saleTotal;
                }
            });
            
            // Update display
            updateElement("monthlySales", monthlySales.toFixed(2));
            updateElement("yearlySales", yearlySales.toFixed(2));
            updateElement("monthlyCost", monthlyCost.toFixed(2));
            
            // Calculate net profit
            const netProfit = monthlySales - monthlyCost;
            updateElement("netProfitSide", netProfit.toFixed(2));
            updateElement("netProfit", netProfit.toFixed(2));
            updateElement("netProfitDisplay", netProfit.toFixed(2));
            
            // Update expense section displays
            updateElement("monthlySalesExpense", monthlySales.toFixed(2));
            updateElement("monthlyExpenseTotal", monthlyCost.toFixed(2));
            updateElement("yearlyExpenseTotal", yearlyCost.toFixed(2));
        });
    });
}

// Load Sales by Type
function loadSalesByType() {
    const now = new Date();
    const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
    const currentYear = now.getFullYear();
    
    let computerTotal = 0;
    let photocopyTotal = 0;
    let stationeryTotal = 0;
    let generalTotal = 0;
    
    db.ref("entries").once("value", snapshot => {
        const sales = snapshot.val() || {};
        
        Object.keys(sales).forEach(key => {
            const sale = sales[key];
            const saleDate = sale.date || "";
            const saleTotal = parseFloat(sale.total) || 0;
            const saleType = sale.saleType || "general";
            
            // Current month only
            if(saleDate.includes(`/${currentMonth}/${currentYear}`)) {
                if(saleType === "computer") {
                    computerTotal += saleTotal;
                } else if(saleType === "photocopy") {
                    photocopyTotal += saleTotal;
                } else if(saleType === "stationery") {
                    stationeryTotal += saleTotal;
                } else {
                    generalTotal += saleTotal;
                }
            }
        });
        
        // Update dashboard
        updateElement("computerSales", computerTotal.toFixed(2));
        updateElement("photocopySales", photocopyTotal.toFixed(2));
        updateElement("stationerySales", stationeryTotal.toFixed(2));
    });
}

// ============================================
// REPORTING FUNCTIONS
// ============================================

// Generate Report
function generateReport() {
    const startDateInput = document.getElementById("startDate") ? document.getElementById("startDate").value : "";
    const endDateInput = document.getElementById("endDate") ? document.getElementById("endDate").value : "";
    const saleType = document.getElementById("reportSaleType") ? document.getElementById("reportSaleType").value : "all";
    const customerSearch = document.getElementById("reportCustomerSearch") ? document.getElementById("reportCustomerSearch").value.trim() : "";
    const userFilter = document.getElementById("reportUserFilter") ? document.getElementById("reportUserFilter").value : "all";
    
    // Convert dates to DD/MM/YYYY format
    let startDate = "";
    let endDate = "";
    
    if(startDateInput) {
        const parts = startDateInput.split('-');
        startDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    
    if(endDateInput) {
        const parts = endDateInput.split('-');
        endDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        const tbody = document.getElementById("reportTableBody");
        
        if(!tbody) return;
        
        tbody.innerHTML = "";
        
        if(!data) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
            return;
        }
        
        let totalSales = 0;
        let totalCash = 0;
        let totalDue = 0;
        let totalEntries = 0;
        let filteredEntries = [];
        
        // Convert to array and filter
        const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
        
        entriesArr.forEach(entry => {
            let include = true;
            
            // Date filter
            if(startDate && endDate) {
                const entryDate = entry.date || "";
                if(entryDate < startDate || entryDate > endDate) {
                    include = false;
                }
            } else if(startDate && !endDate) {
                const entryDate = entry.date || "";
                if(entryDate !== startDate) {
                    include = false;
                }
            }
            
            // Sale type filter
            if(include && saleType !== "all") {
                if(entry.saleType !== saleType) {
                    include = false;
                }
            }
            
            // Customer search filter
            if(include && customerSearch) {
                const customerName = entry.note || "";
                const customerPhone = entry.phone || "";
                
                if(!customerName.toLowerCase().includes(customerSearch.toLowerCase()) &&
                   !customerPhone.includes(customerSearch)) {
                    include = false;
                }
            }
            
            // User filter
            if(include && userFilter !== "all") {
                if(entry.user !== userFilter) {
                    include = false;
                }
            }
            
            if(include) {
                filteredEntries.push(entry);
                totalSales += parseFloat(entry.total) || 0;
                totalCash += parseFloat(entry.taken) || 0;
                totalDue += parseFloat(entry.loss) || 0;
                totalEntries++;
            }
        });
        
        // Display filtered entries
        if(filteredEntries.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:30px;color:#777">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
        } else {
            filteredEntries.forEach(entry => {
                const itemSummary = entry.items && Array.isArray(entry.items)
                    ? entry.items.slice(0, 2).map(i => 
                        `<span style="background:#f1f1f1;padding:2px 5px;border-radius:4px;font-size:12px">${i.work} (${i.qty})</span>`
                    ).join(" ")
                    : entry.work || "‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶£‡ßç‡¶Ø";
                
                const phone = entry.phone ? formatPhoneNumber(entry.phone) : "-";
                
                // Sale type icon
                const saleTypeIcon = entry.saleType === 'computer' ? 'üíª' :
                                    entry.saleType === 'photocopy' ? 'üì∑' :
                                    entry.saleType === 'stationery' ? 'üìö' : 'üìã';
                
                const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${entry.key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${entry.date || ''}<br><small>${entry.time || ''}</small></td>
                        <td><b>${entry.note || ''}</b><br>${itemSummary}</td>
                        <td>${phone}</td>
                        <td>${entry.total || 0}</td>
                        <td style="color:#27ae60">${entry.taken || 0}</td>
                        <td style="color:#e74c3c">${entry.loss || 0}</td>
                        <td>${saleTypeIcon}</td>
                        <td style="text-transform:capitalize">${entry.user || ''}</td>
                        <td class="noPrint">${btnMemo}</td>
                    </tr>
                `;
            });
        }
        
        // Update summary
        updateElement("reportTotalSales", totalSales.toFixed(2));
        updateElement("reportTotalCash", totalCash.toFixed(2));
        updateElement("reportTotalDue", totalDue.toFixed(2));
        updateElement("reportTotalEntries", totalEntries);
        updateElement("reportShowingCount", filteredEntries.length);
    });
}

// Load Report Data (All)
function loadReportData() {
    // Reset filters
    if(document.getElementById("startDate")) document.getElementById("startDate").value = "";
    if(document.getElementById("endDate")) document.getElementById("endDate").value = "";
    if(document.getElementById("reportSaleType")) document.getElementById("reportSaleType").value = "all";
    if(document.getElementById("reportCustomerSearch")) document.getElementById("reportCustomerSearch").value = "";
    if(document.getElementById("reportUserFilter")) document.getElementById("reportUserFilter").value = "all";
    
    // Generate report with no filters
    generateReport();
}

// Reset Report Filter
function resetReportFilter() {
    const fields = ["startDate", "endDate", "reportCustomerSearch"];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field) field.value = "";
    });
    
    const selects = ["reportSaleType", "reportUserFilter"];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if(select) select.value = "all";
    });
    
    generateReport();
}

// Print Report
function printReport() {
    window.print();
}

// Show Daily Report
function showDailyReport() {
    const today = new Date().toISOString().split('T')[0];
    
    if(document.getElementById("startDate")) {
        document.getElementById("startDate").value = today;
    }
    if(document.getElementById("endDate")) {
        document.getElementById("endDate").value = today;
    }
    
    generateReport();
}

// Show Monthly Report
function showMonthlyReport() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    
    const firstDay = `${year}-${month}-01`;
    const lastDay = new Date(year, now.getMonth() + 1, 0).toISOString().split('T')[0];
    
    if(document.getElementById("startDate")) {
        document.getElementById("startDate").value = firstDay;
    }
    if(document.getElementById("endDate")) {
        document.getElementById("endDate").value = lastDay;
    }
    
    generateReport();
}

// Download Excel
function downloadExcel() {
    db.ref("entries").once("value", snapshot => {
        const data = snapshot.val();
        
        if(!data) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á!");
            return;
        }
        
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤,‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞,‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ß‡¶∞‡¶£\n";
        
        const entriesArr = Object.keys(data).map(key => ({...data[key], key})).reverse();
        
        entriesArr.forEach(entry => {
            const items = entry.items && Array.isArray(entry.items)
                ? entry.items.map(i => `${i.work} (${i.qty}pc)`).join(" + ")
                : entry.work || "";
            
            const safeNote = entry.note ? entry.note.replace(/,/g, " ") : '';
            const saleType = entry.saleType || 'general';
            
            const saleTypeText = saleType === 'computer' ? '‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞' :
                                saleType === 'photocopy' ? '‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø' :
                                saleType === 'stationery' ? '‡¶ú‡¶ø‡¶®‡¶ø‡¶∏‡¶™‡¶§‡ßç‡¶∞' : '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£';
            
            csv += `"${entry.date || ''}","${entry.time || ''}","${safeNote}","${entry.phone || '-'}","${items}",${entry.total || 0},${entry.taken || 0},${entry.loss || 0},"${entry.user || ''}","${saleTypeText}"\n`;
        });
        
        // Create download link
        const link = document.createElement("a");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        link.href = url;
        link.download = `‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü_‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü_${new Date().toLocaleDateString('bn-BD')}.csv`;
        link.click();
        
        URL.revokeObjectURL(url);
    });
}

// ============================================
// CHANGE SALE TYPE
// ============================================

function changeSaleType() {
    const saleType = document.getElementById("saleType") ? document.getElementById("saleType").value : "photocopy";
    
    // Update quick buttons based on sale type
    const quickButtonsContainer = document.querySelector(".quick-items-container");
    
    // You can customize quick buttons based on sale type here
    if(saleType === "photocopy") {
        // Photocopy specific buttons
        console.log("Photocopy mode activated");
    } else if(saleType === "computer") {
        // Computer service specific buttons
        console.log("Computer service mode activated");
    } else if(saleType === "stationery") {
        // Stationery specific buttons
        console.log("Stationery mode activated");
    }
}

// ============================================
// FINAL INITIALIZATION & CLEANUP
// ============================================

// Initialize date fields with today's date
function initializeDateFields() {
    const today = new Date().toISOString().split('T')[0];
    const dateFields = [
        'payDate', 'expenseDate', 'startDate', 'endDate',
        'editExpenseDate'
    ];
    
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field && !field.value) {
            field.value = today;
        }
    });
}

// Check due payments periodically
function checkDuePayments() {
    db.ref("entries").once("value", snapshot => {
        let totalDue = 0;
        let customersWithDue = [];
        
        snapshot.forEach(child => {
            const entry = child.val();
            if(entry.loss > 0) {
                totalDue += entry.loss;
                if(entry.note && entry.note !== "General Customer") {
                    customersWithDue.push({
                        name: entry.note,
                        phone: entry.phone,
                        due: entry.loss
                    });
                }
            }
        });
        
        if(totalDue > 0 && (currentUser === 'owner' || currentUser === 'admin')) {
            console.log(`‚ö†Ô∏è ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${totalDue.toFixed(2)}`);
            console.log(`üìã ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: ${customersWithDue.length} ‡¶ú‡¶®`);
            
            // Show notification if due is high
            if(totalDue > 5000) {
                showTempMessage(`‚ö†Ô∏è ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø ‡ß≥${totalDue.toFixed(2)} - ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ñ‡ßã‡¶Å‡¶ú ‡¶®‡¶ø‡¶®`, "warning");
            }
        }
    });
}

// Export all data backup
function exportDataBackup() {
    // This function can be called manually to backup all data
    Promise.all([
        db.ref("entries").once("value"),
        db.ref("products").once("value"),
        db.ref("expenses").once("value")
    ]).then(([entriesSnap, productsSnap, expensesSnap]) => {
        const backupData = {
            timestamp: new Date().toISOString(),
            entries: entriesSnap.val() || {},
            products: productsSnap.val() || {},
            expenses: expensesSnap.val() || {},
            backupBy: currentUser
        };
        
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.href = url;
        link.download = `‡¶∂‡ßá‡¶ñ_‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø_‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™_${new Date().toLocaleDateString('bn-BD')}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        showTempMessage("‚úÖ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        
    }).catch(error => {
        showTempMessage("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message, "error");
    });
}

// Auto-backup reminder (once per day)
function setupAutoBackupReminder() {
    const lastBackupDate = localStorage.getItem("lastBackupReminder");
    const today = new Date().toLocaleDateString();
    
    if(lastBackupDate !== today && (currentUser === 'owner' || currentUser === 'admin')) {
        if(confirm("üíæ ‡¶Ü‡¶ú‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡ßá‡¶®‡¶®‡¶ø‡•§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            exportDataBackup();
        }
        localStorage.setItem("lastBackupReminder", today);
    }
}

// ============================================
// SYSTEM UTILITIES
// ============================================

// System information display
function showSystemInfo() {
    const info = `
        <strong>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ v2.0</strong><br>
        <small>
            ‡¶≤‡¶ó‡¶á‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${currentUser}<br>
            ‡¶Æ‡ßã‡¶ü ‡¶™‡¶£‡ßç‡¶Ø: ${allProducts.length}<br>
            ‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ${new Date().toLocaleString('bn-BD')}<br>
            Firebase: Connected ‚úì
        </small>
    `;
    
    alert(info);
}

// Quick system test
function runSystemTest() {
    const tests = [];
    
    // Test 1: Firebase connection
    tests.push(new Promise((resolve) => {
        db.ref(".info/connected").once("value", snap => {
            tests[0] = snap.val() === true ? "‚úÖ Firebase Connected" : "‚ùå Firebase Disconnected";
            resolve();
        });
    }));
    
    // Test 2: Products loaded
    tests.push(allProducts.length > 0 ? "‚úÖ Products Loaded" : "‚ùå No Products");
    
    // Test 3: User logged in
    tests.push(currentUser ? "‚úÖ User Logged In" : "‚ùå No User");
    
    // Test 4: Date initialized
    tests.push("‚úÖ System Initialized");
    
    Promise.all(tests).then(() => {
        const testResults = `
            ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:
            
            1. ${tests[1]}
            2. ${tests[2]}
            3. ${tests[3]}
            4. ${tests[4]}
            
            ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‚úÖ
        `;
        
        alert(testResults);
    });
}

// ============================================
// ERROR HANDLING
// ============================================

// Global error handler
window.onerror = function(message, source, lineno, colno, error) {
    console.error("System Error:", message, error);
    
    // Don't show error alerts to regular users
    if(currentUser === 'owner' || currentUser === 'admin') {
        showTempMessage(`System Error: ${message}`, "error");
    }
    
    return true;
};

// Firebase error handling
db.ref(".info/connected").on("value", function(snap) {
    if(snap.val() === true) {
        console.log("Firebase Connected");
    } else {
        console.log("Firebase Disconnected");
        if(currentUser === 'owner' || currentUser === 'admin') {
            showTempMessage("‚ö†Ô∏è Firebase ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°! ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§", "warning");
        }
    }
});

// ============================================
// FINAL SYSTEM INITIALIZATION
// ============================================

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Content Loaded - Initializing System...");
    
    // Set current year in footer if exists
    const yearSpan = document.getElementById("currentYear");
    if(yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
    }
    
    // Initialize tooltips
    initializeTooltips();
    
    // Check for updates
    checkForUpdates();
});

// Initialize tooltips
function initializeTooltips() {
    // This function can be extended to add tooltip functionality
    const tooltipElements = document.querySelectorAll('[title]');
    tooltipElements.forEach(el => {
        el.addEventListener('mouseenter', function(e) {
            // Simple tooltip implementation
            console.log("Tooltip:", this.title);
        });
    });
}

// Check for updates
function checkForUpdates() {
    // This can be extended to check for system updates
    const lastUpdateCheck = localStorage.getItem("lastUpdateCheck");
    const today = new Date().toISOString().split('T')[0];
    
    if(lastUpdateCheck !== today && (currentUser === 'owner' || currentUser === 'admin')) {
        console.log("Checking for updates...");
        localStorage.setItem("lastUpdateCheck", today);
        
        // Simulate update check
        setTimeout(() => {
            console.log("System is up to date! v2.0");
        }, 1000);
    }
}

// ============================================
// SYSTEM SHORTCUTS
// ============================================

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Only when user is logged in
    if(!currentUser) return;
    
    // Ctrl + S = Quick Save
    if(e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if(document.getElementById("cartArea") && 
           document.getElementById("cartArea").style.display !== "none") {
            validateAndSave(false);
        }
    }
    
    // Ctrl + P = Print
    if(e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        if(document.getElementById("cartArea") && 
           document.getElementById("cartArea").style.display !== "none") {
            validateAndSave(true);
        }
    }
    
    // Ctrl + D = Dashboard
    if(e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        showSection('dashboard');
    }
    
    // Ctrl + N = New Entry
    if(e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        showSection('newEntry');
    }
    
    // Ctrl + I = Inventory
    if(e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        showSection('inventory');
    }
    
    // Ctrl + C = Customers
    if(e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        showSection('customers');
    }
    
    // Escape = Close modal/sidebar
    if(e.key === 'Escape') {
        const openModal = document.querySelector('.modal[style*="display: block"]');
        if(openModal) {
            const modalId = openModal.id;
            closeModal(modalId);
        } else if(document.getElementById("sidebar").style.left === "0px") {
            closeSidebar();
        }
    }
});

// ============================================
// FINAL CLEANUP & OPTIMIZATION
// ============================================

// Memory cleanup
function cleanupMemory() {
    // Clear large arrays when not needed
    if(allProducts.length > 1000) {
        console.log("Cleaning up product cache...");
        // Keep only essential product data
        allProducts = allProducts.map(p => ({
            key: p.key,
            name: p.name,
            category: p.category,
            qty: p.qty,
            sellPrice: p.sellPrice,
            isService: p.isService
        }));
    }
    
    // Clear customer cache if too large
    if(Object.keys(customerCache).length > 500) {
        console.log("Cleaning up customer cache...");
        customerCache = {};
    }
}

// Periodic cleanup (every 30 minutes)
setInterval(cleanupMemory, 30 * 60 * 1000);

// ============================================
// SYSTEM READY MESSAGE
// ============================================

// Show system ready message
setTimeout(() => {
    if(currentUser && (currentUser === 'owner' || currentUser === 'admin')) {
        console.log(`
        ===================================
        ‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ v2.0 READY!
        ===================================
        Features:
        1. ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
        2. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
        3. ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç
        4. ‡¶ñ‡¶∞‡¶ö ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ
        5. ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ø‡¶Ç
        
        Shortcuts:
        Ctrl+S = Quick Save
        Ctrl+P = Save & Print
        Ctrl+D = Dashboard
        Ctrl+N = New Entry
        Ctrl+I = Inventory
        Ctrl+C = Customers
        Esc = Close Modal
        
        Firebase: Connected
        User: ${currentUser}
        ===================================
        `);
    }
}, 2000);

// ============================================
// END OF JAVASCRIPT CODE
// ============================================

// Final initialization
initializeDateFields();

// Check due payments every hour
setInterval(checkDuePayments, 60 * 60 * 1000);

// Setup backup reminder (once per day)
setInterval(setupAutoBackupReminder, 24 * 60 * 60 * 1000);

// Initial check
checkDuePayments();
setupAutoBackupReminder();

console.log("‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ v2.0 JavaScript ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£!");
</script>

<!-- System Footer -->
<div style="text-align:center;padding:20px;color:#666;font-size:12px;border-top:1px solid #eee;margin-top:30px;display:none" id="systemFooter">
    ‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ v2.0 | 
    ¬© <span id="currentYear">2024</span> | 
    Developed for Sheikh Photocopy & Stationery
</div>

</body>
</html>
