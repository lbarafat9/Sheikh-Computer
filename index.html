<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{box-sizing:border-box;font-family:'Hind Siliguri', sans-serif}
        body{margin:0;background:#f4f7f6;color:#2c3e50}
        .en{font-family:Arial, sans-serif}
        
        header{background:#2ecc71;color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:bold;display:none;position:fixed;top:0;width:100%;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        
        #loginDiv{max-width:400px;margin:120px auto;background:#fff;padding:35px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center}
        #container{display:none;padding:20px;padding-top:85px;max-width:1200px;margin:auto}
        
        .form-group {margin-bottom: 12px; text-align: left;}
        .form-group label {display: block; font-weight: 600; margin-bottom: 4px; color: #34495e; font-size: 14px;}
        
        input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;outline:none;transition:0.3s;font-size:15px}
        input:focus{border-color:#2ecc71}
        button{background:#2ecc71;color:#fff;font-weight:bold;border:none;cursor:pointer;font-size:16px; margin-top:5px;}
        button:hover{background:#27ae60}
        
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
        .card{background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.05);border-top:4px solid #2ecc71}
        
        #menuBtn{position:fixed;top:18px;left:20px;font-size:28px;color:#fff;cursor:pointer;display:none;z-index:1100}
        #sidebar{position:fixed;top:0;left:-280px;width:280px;height:100%;background:#ffffff;transition:.3s;z-index:1200;padding-top:20px;box-shadow:2px 0 10px rgba(0,0,0,0.1)}
        #sidebar a{display:block;color:#34495e;text-decoration:none;padding:15px 25px;border-bottom:1px solid #f1f1f1;cursor:pointer;font-weight:600}
        #sidebar a:hover{background:#f9f9f9;color:#2ecc71}
        
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:1150}
        .section{display:none;animation:fadeIn 0.5s}
        @keyframes fadeIn {from{opacity:0} to{opacity:1}}
        
        .table-box{background:#fff;border-radius:12px;overflow-x:auto;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
        table{width:100%;border-collapse:collapse;min-width:600px}
        th,td{padding:12px;border-bottom:1px solid #f0f0f0;text-align:left}
        th{background:#f9f9f9;color:#7f8c8d;font-size:13px}
        
        .btn-action{padding:5px 8px; font-size:14px; margin:0 2px; border-radius:4px;}
        .btn-del{background:#e74c3c; color:white;}
        .btn-edit{background:#f39c12; color:white;}
        .btn-print{background:#3498db; color:white;}
        
        .cart-box {margin-top:20px; border:2px dashed #2ecc71; padding:15px; border-radius:12px; background:#f9fff9}
        .cart-item {display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px}
        
        .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;width:600px; max-width: 95%; padding:30px;z-index:1500;box-shadow:0 0 100px rgba(0,0,0,0.5);border-radius:10px}
        .chart-container{background:#fff;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 4px 6px rgba(0,0,0,0.05)}

        .user-summary-box { background:#fff; padding:15px; border-radius:12px; margin-bottom:25px; border-left: 5px solid #9b59b6; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .low-stock { color: #e74c3c; font-weight: bold; }
        .service-badge { background: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        /* A4 PRINT CSS */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
            body * { visibility: hidden; }
            
            #memoModal, #memoModal * { visibility: visible !important; }
            #memoModal {
                display: block !important; 
                position: absolute; 
                left: 0; top: 0;
                width: 100%;
                margin: 0; 
                padding: 0; 
                transform: none; 
                box-shadow: none; 
                border: none;
                background: white;
            }
            
            /* Print Header */
            #memoModal h2 { font-size: 32px !important; margin-bottom: 5px; color: #2c3e50 !important; text-align: center; }
            #memoModal p { color: #34495e !important; }
            #memoModal .address { font-size: 16px !important; text-align: center; margin-bottom: 20px; }
            
            /* Print Meta Info */
            .memo-meta { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
            .memo-meta div { font-size: 16px !important; }

            /* Print Table */
            #memoModal table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 16px; }
            #memoModal th { background: #eee !important; color: #000 !important; border: 1px solid #000; padding: 10px; font-weight: bold; }
            #memoModal td { border: 1px solid #000; padding: 10px; }
            
            /* Print Totals */
            .memo-total-area { margin-top: 20px; text-align: right; font-size: 18px !important; }
            .memo-total-area p { margin: 5px 0; }
            
            /* Signature */
            .signature-area { margin-top: 60px; display: flex; justify-content: space-between; }
            .signature-box { text-align: center; width: 200px; }
            .signature-line { border-top: 1px solid #000; margin-top: 50px; padding-top: 5px; font-size: 14px; }

            .noPrint { display: none !important; }
        }
    </style>
</head>
<body>

<header id="header">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</header>
<div id="menuBtn" onclick="openSidebar()">‚ò∞</div>
<div id="overlay" onclick="closeSidebar()"></div>

<div id="loginDiv">
    <h2 style="color:#2ecc71">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
    <input id="uName" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ">
    <input id="uPass" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
    <button onclick="login()">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div id="container">
    <div id="sidebar">
        <div style="text-align:right;padding:15px;font-size:30px;cursor:pointer;color:#e74c3c" onclick="closeSidebar()">√ó</div>
        <div style="text-align:center;padding:10px;margin-bottom:10px;border-bottom:2px solid #2ecc71" id="userShow"></div>
        <a onclick="showSection('dashboard')">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
        <a onclick="showSection('newEntry')">üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø (‡¶∏‡ßá‡¶≤‡¶∏)</a>
        <a onclick="showSection('inventory')">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
        <a onclick="showSection('reports')">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</a>
        <a onclick="logout()" style="color:#ff7675">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
    </div>

    <div id="dashboard" class="section">
        <div class="stats en">
            <div class="card" style="border-top-color:#3498db">‡¶Æ‡ßã‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br><b id="cCount">0</b></div>
            <div class="card" style="border-top-color:#2ecc71">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü (‡ß≥)<br><b id="cTotal">0</b></div>
            <div class="card" style="border-top-color:#f1c40f">‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)<br><b id="cTaken">0</b></div>
            <div class="card" style="border-top-color:#e74c3c">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)<br><b id="cLoss">0</b></div>
        </div>

        <div class="user-summary-box">
            <h4 style="margin:0 0 10px 0; color:#8e44ad">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h4>
            <div class="table-box" style="box-shadow:none; border:1px solid #eee;">
                <table class="en">
                    <thead><tr><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú (‡ß≥)</th><th>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ (‡ß≥)</th><th>‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th></tr></thead>
                    <tbody id="userSummaryBody"><tr><td colspan="4" style="text-align:center">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="chart-container"><canvas id="salesChart" height="100"></canvas></div>
        
        <div class="table-box">
            <h4 style="padding:15px; margin:0">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ (‡¶∂‡ßá‡¶∑ ‡ßß‡ß¶‡ß¶‡¶ü‡¶ø)</h4>
            <table class="en">
                <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="newEntry" class="section">
        <div style="max-width:550px;margin:auto;background:#fff;padding:25px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="margin-top:0; color:#2c3e50">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
            
            <div class="form-group" style="background:#f0fff4; padding:10px; border:1px dashed #2ecc71; border-radius:8px">
                <label>üîç ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <input id="searchSerial" placeholder="‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="en" oninput="searchProduct(this.value)">
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0">

            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label>
                <select id="category" onchange="filterProducts()"><option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option></select>
            </div>

            <div class="form-group">
                <label>‡¶ï‡¶æ‡¶ú/‡¶™‡¶£‡ßç‡¶Ø:</label>
                <select id="work" onchange="autoFillPrice()"><option value="">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option></select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <div class="form-group"><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label><input id="qty" type="number" value="1" min="1" class="en"></div>
                <div class="form-group"><label>‡¶¶‡¶∞ (‡ß≥):</label><input id="rate" type="number" class="en"></div>
            </div>
            
            <button onclick="addToCart()" style="background:#3498db; margin-bottom:15px">üõí ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

            <div id="cartArea" class="cart-box" style="display:none">
                <h4 style="margin:0 0 10px 0; border-bottom:1px dashed #ccc; padding-bottom:5px">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</h4>
                <div id="cartList"></div>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="note" placeholder="‡¶®‡¶æ‡¶Æ..."></div>
                    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label><input id="phone" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞..." class="en"></div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <div class="form-group"><label>‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</label><input id="total" readonly class="en" value="0" style="background:#f0f0f0"></div>
                    <div class="form-group"><label>‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£:</label><input id="taken" type="number" class="en" oninput="calcLoss()"></div>
                </div>
                 <div class="form-group"><label>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="loss" readonly class="en" value="0" style="background:#f0f0f0"></div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px">
                    <button onclick="saveBulkEntry(false)" style="background:#f39c12">üíæ ‡¶∏‡ßá‡¶≠</button>
                    <button onclick="saveBulkEntry(true)" style="background:#2ecc71">üñ®Ô∏è ‡¶∏‡ßá‡¶≠ ‡¶ì ‡¶Æ‡ßá‡¶Æ‡ßã</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory" class="section">
        <div style="max-width:800px;margin:auto;background:#fff;padding:25px;border-radius:15px">
            <h3 style="border-bottom:2px solid #eee; padding-bottom:10px">üì¶ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px">
                <div class="form-group"><label>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ (Optional):</label><input id="stSerial" class="en" placeholder="Code/Serial"></div>
                <div class="form-group"><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><input id="stCategory" placeholder="e.g. Paper, Service"></div>
                <div class="form-group"><label>‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="stName" placeholder="Product Name"></div>
            </div>
            
            <div style="background:#eaf2f8; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #d6eaf8;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="stIsService" style="width:20px; height:20px; margin:0" onchange="toggleStockInput()">
                    <label for="stIsService" style="margin:0; cursor:pointer; font-weight:bold; color:#2980b9">‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ/‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ (‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø, ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü, ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)</label>
                </div>
                <small style="color:#7f8c8d; padding-left:34px;">‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</small>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end">
                <div class="form-group"><label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label><input id="stQty" type="number" class="en" placeholder="Qty"></div>
                <div class="form-group"><label>‡¶ï‡ßá‡¶®‡¶æ ‡¶¶‡¶æ‡¶Æ (Cost):</label><input id="stCost" type="number" class="en" placeholder="Cost"></div>
                <div class="form-group"><label>‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (Sell):</label><input id="stSell" type="number" class="en" placeholder="Price"></div>
                <button onclick="addNewProduct()" style="height:42px; margin-bottom:12px">+ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button>
            </div>

            <div class="table-box" style="margin-top:20px">
                <table>
                    <thead><tr><th>Serial</th><th>Category</th><th>Name</th><th>Stock</th><th>Sell Price</th><th>Action</th></tr></thead>
                    <tbody id="stockBody" class="en"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="noPrint" style="max-width: 900px; margin: auto; background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h3 style="text-align:center; margin-top:0">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö</h3>
            <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; margin-bottom: 20px">
                <input type="date" id="sDate" class="en" style="margin:0">
                <button onclick="searchByDate()" style="width:auto;margin:0;padding:0 25px">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px">
                <button onclick="loadReportData()" style="background:#95a5a6">‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="downloadExcel()" style="background:#27ae60">üìä ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤</button>
                <button onclick="window.print()" style="background:#9b59b6;">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            </div>
            
            <div class="table-box" style="margin-top:25px; border:1px solid #eee">
                <table class="en">
                    <thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Æ‡ßã‡¶ü</th><th>‡¶®‡¶ó‡¶¶</th><th>‡¶¨‡¶æ‡¶ï‡¶ø</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th class="noPrint">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="memoModal" class="modal">
    <div style="text-align:center">
        <h2 style="margin:0; color:#2ecc71">‡¶∂‡ßá‡¶ñ ‡¶´‡¶ü‡ßã‡¶ï‡¶™‡¶ø ‡¶è‡¶®‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h2>
        <p class="address" style="margin:2px">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ ‡¶â‡¶™‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá, ‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú‡•§</p>
    </div>
    
    <div class="memo-meta en" style="margin-top:20px;">
        <div style="text-align:left">
            <p style="margin:2px"><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="mDate"></span></p>
            <p style="margin:2px"><strong>‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®:</strong> <span id="mUser" style="text-transform:uppercase"></span></p>
        </div>
        <div style="text-align:right">
            <p style="margin:2px"><strong>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</strong> <span id="mNote"></span></p>
            <p style="margin:2px"><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> <span id="mPhoneDisp"></span></p>
        </div>
    </div>
        
    <table style="width:100%; border-collapse:collapse; margin-top:10px">
        <thead>
            <tr style="background:#f9f9f9">
                <th style="border:1px solid #ddd; padding:8px; text-align:left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th style="border:1px solid #ddd; padding:8px; text-align:center; width:100px">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                <th style="border:1px solid #ddd; padding:8px; text-align:right; width:120px">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
        </thead>
        <tbody id="mItems" class="en"></tbody>
    </table>
    
    <div class="memo-total-area en" style="margin-top:15px; text-align:right">
        <p>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥<b id="mTotal"></b></p>
        <p>‡¶ú‡¶Æ‡¶æ/‡¶®‡¶ó‡¶¶: ‡ß≥<span id="mPaid"></span></p>
        <p>‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥<b id="mDue" style="color:red"></b></p>
    </div>
    
    <div class="signature-area" style="margin-top: 50px; display: flex; justify-content: space-between;">
        <div class="signature-box" style="text-align:center; width:200px">
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:40px">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
        <div class="signature-box" style="text-align:center; width:200px">
            <p style="margin:0; font-weight:bold" id="signatureName" class="en"></p>
            <p class="signature-line" style="border-top:1px solid #000; padding-top:5px; margin-top:5px">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</p>
        </div>
    </div>
    
    <div style="margin-top:30px; text-align:center; border-top:1px dashed #ccc; padding-top:10px" class="noPrint">
        <button onclick="window.print()" style="width:auto; padding:8px 25px">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal('memoModal')" style="background:#e74c3c; width:auto; padding:8px 25px">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div id="editModal" class="modal" style="width:350px">
    <h3 style="margin-top:0; color:#f39c12">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <input type="hidden" id="editKey">
    <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input id="editNote"></div>
    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label><input id="editPhone" class="en"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div class="form-group"><label>‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ:</label><input id="editTotal" type="number" class="en"></div>
        <div class="form-group"><label>‡¶®‡¶ó‡¶¶:</label><input id="editTaken" type="number" class="en"></div>
    </div>
    <button onclick="updateEntry()" style="background:#f39c12; margin-top:15px">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button onclick="closeModal('editModal')" style="background:#e74c3c">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyCvNH_VOQm3_FYKQocEVlFN1DTYMy-BPlM",
    authDomain:"sheikh-computer-b41d5.firebaseapp.com",
    databaseURL:"https://sheikh-computer-b41d5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:"sheikh-computer-b41d5"
});
const db=firebase.database();
let user="", allProducts=[], cart=[], salesChart=null;

window.onload = function() {
    const savedUser = localStorage.getItem("loggedInUser");
    if(savedUser) setupUser(savedUser);
};

function login(){
    const u=uName.value.toLowerCase().trim(), p=uPass.value.trim();
    const users={admin:"123",owner:"456",roky:"789"};
    if(users[u]===p){ localStorage.setItem("loggedInUser", u); setupUser(u); }
    else alert("‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø!");
}

function setupUser(u) {
    user = u; loginDiv.style.display="none"; container.style.display="block";
    header.style.display="block"; menuBtn.style.display="block";
    userShow.innerHTML=`‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <b>${u.toUpperCase()}</b>`;
    loadAllProducts(); loadEntries(); showSection('dashboard');
}

// ============== NEW UNIFIED PRODUCT LOGIC ==============

function loadAllProducts(){
    db.ref("products").on("value", s => {
        allProducts = [];
        const stockBody = document.getElementById("stockBody");
        stockBody.innerHTML = "";
        const categories = new Set();
        s.forEach(child => {
            const p = child.val();
            const key = child.key;
            p.key = key; 
            allProducts.push(p);
            categories.add(p.category);
            let stockDisplay = "";
            let rowClass = "";
            if(p.isService) {
                stockDisplay = `<span class="service-badge">Service</span>`;
            } else {
                stockDisplay = `${p.qty} ${p.qty < 5 ? '‚ö†Ô∏è' : ''}`;
                if(p.qty < 5) rowClass = "low-stock";
            }
            stockBody.innerHTML += `<tr class="${rowClass}"><td>${p.serial || '-'}</td><td>${p.category}</td><td>${p.name}</td><td>${stockDisplay}</td><td>${p.sellPrice}</td><td><button class="btn-action btn-del" onclick="delProduct('${key}')">üóëÔ∏è</button></td></tr>`;
        });
        const catSelect = document.getElementById("category");
        catSelect.innerHTML = "<option value=''>‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>";
        categories.forEach(c => { catSelect.innerHTML += `<option value="${c}">${c}</option>`; });
        filterProducts(); 
    });
}

function toggleStockInput(){
    const isService = document.getElementById("stIsService").checked;
    const qtyInput = document.getElementById("stQty");
    const costInput = document.getElementById("stCost");
    if(isService){
        qtyInput.value = ""; qtyInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; qtyInput.disabled = true; qtyInput.style.background = "#eee";
        costInput.value = ""; costInput.placeholder = "‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü"; costInput.disabled = true; costInput.style.background = "#eee";
    } else {
        qtyInput.disabled = false; qtyInput.placeholder = "Qty"; qtyInput.style.background = "#fff";
        costInput.disabled = false; costInput.placeholder = "Cost"; costInput.style.background = "#fff";
    }
}

function addNewProduct(){
    const serial = document.getElementById("stSerial").value.trim();
    const cat = document.getElementById("stCategory").value.trim();
    const name = document.getElementById("stName").value.trim();
    const sell = parseFloat(document.getElementById("stSell").value) || 0;
    const isService = document.getElementById("stIsService").checked;
    let qty = 0, cost = 0;
    if(!isService) {
        qty = parseFloat(document.getElementById("stQty").value) || 0;
        cost = parseFloat(document.getElementById("stCost").value) || 0;
    }
    if(!cat || !name || !sell) return alert("Category, Name ‡¶è‡¶¨‡¶Ç Sell Price ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
    const newProd = { serial: serial, category: cat, name: name, qty: qty, isService: isService, costPrice: cost, sellPrice: sell };
    db.ref("products").push(newProd).then(()=>{
        alert(isService ? "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!" : "‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        document.getElementById("stSerial").value = "";
        document.getElementById("stCategory").value = "";
        document.getElementById("stName").value = "";
        document.getElementById("stQty").value = "";
        document.getElementById("stCost").value = "";
        document.getElementById("stSell").value = "";
        document.getElementById("stIsService").checked = false;
        toggleStockInput();
    });
}

function delProduct(key){
    if(user === 'owner' || user === 'admin'){ if(confirm("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) db.ref("products/"+key).remove(); } 
    else { alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á!"); }
}

function filterProducts(){
    const cat = document.getElementById("category").value;
    const workSelect = document.getElementById("work");
    workSelect.innerHTML = "<option value=''>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>";
    const filtered = cat ? allProducts.filter(p => p.category === cat) : allProducts;
    filtered.forEach(p => { workSelect.innerHTML += `<option value="${p.key}" data-price="${p.sellPrice}">${p.name} (${p.serial || ''})</option>`; });
}

function autoFillPrice(){
    const workSelect = document.getElementById("work");
    const selectedOption = workSelect.options[workSelect.selectedIndex];
    if(selectedOption.value){
        document.getElementById("rate").value = selectedOption.getAttribute("data-price");
        document.getElementById("qty").focus(); 
    }
}

function searchProduct(serial){
    if(!serial) return;
    const product = allProducts.find(p => p.serial && p.serial.toLowerCase() === serial.toLowerCase());
    if(product){
        document.getElementById("category").value = product.category;
        filterProducts();
        document.getElementById("work").value = product.key; 
        document.getElementById("rate").value = product.sellPrice;
        document.getElementById("qty").value = 1;
        document.getElementById("searchSerial").value = ""; 
    }
}

function addToCart(){
    const workSelect = document.getElementById("work");
    const pKey = workSelect.value;
    const pName = workSelect.options[workSelect.selectedIndex]?.text;
    const r = parseFloat(document.getElementById("rate").value);
    const q = parseFloat(document.getElementById("qty").value);
    if(!pKey || !r) return alert("‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®");
    if(q <= 0) return alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ßß ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
    const stockItem = allProducts.find(p => p.key === pKey);
    if(stockItem && !stockItem.isService && stockItem.qty < q) { alert("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á! (‡¶∏‡ßç‡¶ü‡¶ï: " + stockItem.qty + ")"); }
    cart.push({ key: pKey, work: pName.split('(')[0].trim(), qty: q, rate: r, sub: q * r, isService: stockItem ? stockItem.isService : false });
    renderCart(); 
    document.getElementById("qty").value=1; 
}

function renderCart(){
    cartArea.style.display = cart.length ? "block" : "none";
    cartList.innerHTML = "";
    let grandTotal = 0;
    cart.forEach((item, index) => {
        grandTotal += item.sub;
        cartList.innerHTML += `<div class="cart-item"><span>${item.work} (${item.qty} x ${item.rate})</span><span><b>‡ß≥${item.sub}</b> <span onclick="removeCart(${index})" style="color:red;cursor:pointer">√ó</span></span></div>`;
    });
    total.value = grandTotal; calcLoss();
}

function removeCart(index){ cart.splice(index,1); renderCart(); }
function calcLoss(){ loss.value = (parseFloat(total.value) || 0) - (parseFloat(taken.value) || 0); }

function deductStock(cartItems) {
    cartItems.forEach(cItem => {
        const product = allProducts.find(p => p.key === cItem.key);
        if(product && !product.isService) {
            const newQty = parseFloat(product.qty) - parseFloat(cItem.qty);
            db.ref("products/" + cItem.key).update({ qty: newQty });
        }
    });
}

function saveBulkEntry(showMemoFlag){
    if(!cart.length) return;
    const entryData = {
        date: new Date().toLocaleDateString("en-GB"),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        items: cart,
        total: +total.value,
        taken: +taken.value || 0,
        loss: +loss.value || 0,
        user: user,
        note: note.value || "General Customer",
        phone: phone.value || ""
    };
    db.ref("entries").push(entryData).then(() => {
        deductStock(cart);
        if(showMemoFlag) showMemo(entryData);
        else alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        cart = []; renderCart(); note.value = ""; phone.value = ""; taken.value = ""; loss.value="0";
    });
}

function viewMemo(key) { db.ref("entries/" + key).once("value", s => { if(s.val()) showMemo(s.val()); }); }

function showMemo(e){
    document.getElementById("mDate").innerText = e.date;
    document.getElementById("mUser").innerText = e.user;
    document.getElementById("mNote").innerText = e.note;
    document.getElementById("mPhoneDisp").innerText = e.phone ? `(${e.phone})` : "";
    document.getElementById("mTotal").innerText = e.total;
    document.getElementById("mPaid").innerText = e.taken;
    document.getElementById("mDue").innerText = e.loss;
    const mItems = document.getElementById("mItems");
    mItems.innerHTML = "";
    if(e.items && Array.isArray(e.items)){
        e.items.forEach(i => mItems.innerHTML += `<tr><td style="border:1px solid #ddd; padding:8px">${i.work} (${i.rate})</td><td style="text-align:center; border:1px solid #ddd; padding:8px">${i.qty}</td><td style="text-align:right; border:1px solid #ddd; padding:8px">${i.sub}</td></tr>`);
    } else {
        mItems.innerHTML += `<tr><td style="border:1px solid #ddd; padding:8px">${e.work}</td><td style="text-align:center; border:1px solid #ddd; padding:8px">-</td><td style="text-align:right; border:1px solid #ddd; padding:8px">${e.total}</td></tr>`;
    }
    let signs = {owner:["Toosher Ahmed","01913-812765"], admin:["Arafat Sikder","016749-44985"], roky:["Roky","01878-149052"]};
    let s = signs[e.user] || [e.user.toUpperCase(), ""];
    document.getElementById("signatureName").innerText = s[0];
    document.getElementById("memoModal").style.display="block";
    document.getElementById("overlay").style.display="block";
}

function closeModal(id) { document.getElementById(id).style.display="none"; document.getElementById("overlay").style.display="none"; }
function openEdit(key) {
    db.ref("entries/" + key).once("value", s => {
        const d = s.val();
        document.getElementById("editKey").value = key;
        document.getElementById("editNote").value = d.note;
        document.getElementById("editPhone").value = d.phone;
        document.getElementById("editTotal").value = d.total;
        document.getElementById("editTaken").value = d.taken;
        document.getElementById("editModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    });
}
function updateEntry() {
    const key = document.getElementById("editKey").value;
    const t = parseFloat(document.getElementById("editTotal").value) || 0;
    const k = parseFloat(document.getElementById("editTaken").value) || 0;
    db.ref("entries/" + key).update({ note: document.getElementById("editNote").value, phone: document.getElementById("editPhone").value, total: t, taken: k, loss: t - k
    }).then(() => { alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); closeModal("editModal"); });
}
function renderUserStats(data) {
    const today = new Date().toLocaleDateString("en-GB");
    let stats = {}; let hasData = false;
    ['admin', 'owner', 'roky'].forEach(u => stats[u] = {total:0, taken:0, loss:0});
    if(data) {
        Object.keys(data).forEach(key => {
            const e = data[key];
            if(e.date === today) {
                hasData = true; const u = e.user.toLowerCase();
                if(!stats[u]) stats[u] = {total:0, taken:0, loss:0};
                stats[u].total += (+e.total || 0); stats[u].taken += (+e.taken || 0); stats[u].loss += (+e.loss || 0);
            }
        });
    }
    const tbody = document.getElementById("userSummaryBody");
    tbody.innerHTML = "";
    if(!hasData) { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</td></tr>`; return; }
    Object.keys(stats).forEach(u => {
        if(stats[u].total > 0 || stats[u].taken > 0) { tbody.innerHTML += `<tr><td style="text-transform:capitalize; font-weight:bold">${u}</td><td>${stats[u].total}</td><td style="color:#27ae60; font-weight:bold">${stats[u].taken}</td><td style="color:#e74c3c">${stats[u].loss}</td></tr>`; }
    });
}
function renderTable(data, tableId = "tableBody"){
    const tbody = document.getElementById(tableId);
    tbody.innerHTML=""; 
    if(!data) { if(tableId === "reportTableBody") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>"; return; }
    let t=0, k=0, l=0, dailyData={};
    Object.keys(data).reverse().forEach(key=>{
        const e = data[key];
        t += +e.total || 0; k += +e.taken || 0; l += +e.loss || 0;
        const itemNames = (e.items && Array.isArray(e.items)) ? e.items.map(i => i.work).join(", ") : e.work;
        const phone = e.phone || "-";
        const btnMemo = `<button class="btn-action btn-print" onclick="viewMemo('${key}')" title="‡¶Æ‡ßá‡¶Æ‡ßã">üñ®Ô∏è</button>`;
        const btnEdit = `<button class="btn-action btn-edit" onclick="openEdit('${key}')" title="‡¶è‡¶°‡¶ø‡¶ü">‚úèÔ∏è</button>`;
        const btnDel = (user === e.user) ? `<button class="btn-action btn-del" onclick="delEntry('${key}')" title="‡¶°‡¶ø‡¶≤‡¶ø‡¶ü">‚ùå</button>` : ``;
        tbody.innerHTML+=`<tr><td>${e.time}</td><td style="font-size:12px"><b>${e.note}</b><br>${itemNames}</td><td class="en">${phone}</td><td>${e.total}</td><td>${e.taken}</td><td>${e.loss}</td><td>${e.user}</td><td class="noPrint" style="display:flex">${btnMemo}${btnEdit}${btnDel}</td></tr>`;
        dailyData[e.date] = (dailyData[e.date]||0) + (+e.total||0);
    });
    if(tableId === "tableBody") { cCount.innerText=Object.keys(data).length; cTotal.innerText=t; cTaken.innerText=k; cLoss.innerText=l; updateChart(dailyData); renderUserStats(data); }
}
function updateChart(data){
    const labels = Object.keys(data).slice(-7); const values = Object.values(data).slice(-7);
    if(salesChart) salesChart.destroy();
    const ctx = document.getElementById('salesChart');
    if(ctx) { salesChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Sales', data: values, borderColor: '#2ecc71', tension: 0.3, fill:true, backgroundColor:'rgba(46,204,113,0.1)' }] }, options: { responsive: true, plugins: { legend: { display: false } } } }); }
}
function delEntry(key){ db.ref("entries/"+key).once("value", s => { if(s.val().user !== user) return alert("‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!"); if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) db.ref("entries/"+key).remove(); }); }
function loadEntries(){ db.ref("entries").limitToLast(100).on("value", s => renderTable(s.val(), "tableBody")); }
function showSection(id){ document.querySelectorAll('.section').forEach(s=>s.style.display="none"); document.getElementById(id).style.display="block"; closeSidebar(); }
function closeSidebar(){ sidebar.style.left="-280px"; overlay.style.display="none"; }
function openSidebar(){ sidebar.style.left="0"; overlay.style.display="block"; }
function logout() { localStorage.removeItem("loggedInUser"); location.reload(); }
function searchByDate(){ if(!sDate.value) return; const d = sDate.value.split("-").reverse().join("/"); db.ref("entries").orderByChild("date").equalTo(d).once("value",s=>{ renderTable(s.val(), "reportTableBody"); }); }
function loadReportData() { db.ref("entries").once("value", s => renderTable(s.val(), "reportTableBody")); }
function downloadExcel(){
    db.ref("entries").once("value", s => {
        const d = s.val(); if(!d) return alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
        let csv = "\ufeff‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡¶Æ‡ßü,‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡¶ø‡¶¨‡¶∞‡¶£,‡¶Æ‡ßã‡¶ü,‡¶®‡¶ó‡¶¶,‡¶¨‡¶æ‡¶ï‡¶ø,‡¶á‡¶â‡¶ú‡¶æ‡¶∞\n";
        Object.keys(d).forEach(k => { const e = d[k]; const items = (e.items && Array.isArray(e.items)) ? e.items.map(i=>`${i.work}(${i.qty})`).join("+") : e.work; csv += `${e.date},${e.time},${e.note},${e.phone||'-'},"${items}",${e.total},${e.taken},${e.loss},${e.user}\n`; });
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "report.csv"; link.click();
    });
}
</script>
</body>
</html>
